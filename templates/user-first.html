<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Vacation Dashboard</title>
    <!-- Tailwind CSS -->
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet" />
    <style>
        /* Custom animations and styles */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Hamburger Menu Animation */
        .hamburger {
            width: 24px;
            height: 20px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Hide hamburger on large screens */
        @media (min-width: 1024px) {
            .hamburger {
                display: none !important;
            }
        }

        .hamburger span {
            display: block;
            height: 2px;
            width: 100%;
            background-color: #334155;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background-color: white;
            z-index: 100;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-menu.active {
            left: 0;
        }

        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Hide mobile menu on large screens */
        @media (min-width: 1024px) {
            .mobile-menu,
            .mobile-overlay {
                display: none !important;
            }
        }

        /* Glassy Navbar Effect */
        .glass-navbar {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* Enhanced Search Field */
        .glass-search {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .glass-search:focus {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-1px);
        }

        /* Avatar styles */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Status indicator pulse */
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Toast Animations */
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .toast {
            animation: toastSlideIn 0.3s ease-out;
        }

        .toast.removing {
            animation: toastSlideOut 0.3s ease-in;
        }

        /* Modal Animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-backdrop {
            animation: modalFadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: modalSlideIn 0.2s ease-out;
        }

        /* Logout Modal Styles - Glass Morphism */
        .logout-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 9999;
            animation: modalFadeIn 0.3s ease-out;
            padding: 1rem;
        }

        .logout-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-modal {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.25) 0%, 
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
            padding: 2.5rem 2rem;
            text-align: center;
            max-width: 420px;
            width: 100%;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        .logout-modal h2 {
            color: white;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .logout-modal p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.05rem;
            margin-bottom: 1.5rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Gradient Spinner Animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .logout-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #60a5fa 0deg,
                #a78bfa 90deg,
                #f0abfc 180deg,
                #60a5fa 360deg
            );
            animation: spin 1s linear infinite;
            margin: 0 auto;
            position: relative;
        }

        .logout-spinner::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            backdrop-filter: blur(10px);
        }

        /* Decorative dots */
        .logout-dots {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .logout-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .logout-dot:nth-child(2) {
            animation-delay: 0.3s;
        }

        .logout-dot:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.4;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .logout-modal {
                padding: 2rem 1.5rem;
                border-radius: 1.25rem;
                max-width: 90%;
            }
            
            .logout-modal h2 {
                font-size: 1.5rem;
            }
            
            .logout-modal p {
                font-size: 0.95rem;
            }
            
            .logout-spinner {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body class="bg-slate-50 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500">
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center gap-3">
                <div class="avatar bg-blue-500 text-white">{{ user_initials }}</div>
                <div>
                    <div class="text-sm font-semibold text-slate-900">{{ user_full_name }}</div>
                    <div class="text-xs text-slate-500">{{ user_role }}</div>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-1">
            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('overview', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span>Overview</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('activity', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                </svg>
                <span>Activity Log</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('create', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span>Create Request</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('help', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Help Center</span>
            </a>
            
            <div class="border-t border-slate-200 my-2"></div>
            
            <button onclick="openProfileModal(); toggleMobileMenu();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span>My Profile</span>
            </button>
            
            <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span>Logout</span>
            </button>
        </div>

        <div class="p-4 border-t border-slate-200 mt-4">
            <h3 class="text-xs font-semibold text-slate-500 uppercase mb-3 px-4">My Stats</h3>
            <div class="space-y-3 px-4" id="quickStats">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">Days Used</span>
                    <span class="font-bold text-slate-900" id="statDaysUsed">--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">Days Remaining</span>
                    <span class="font-bold text-green-600" id="statDaysRemaining">--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">Pending</span>
                    <span class="font-bold text-yellow-600" id="statPending">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[9999] space-y-2"></div>

    <!-- Top Navigation Bar -->
    <div class="glass-navbar sticky top-0 z-50">
        <!-- Top Row: Logo, User -->
        <div class="flex items-center justify-between px-4 lg:px-6 py-3 border-b border-slate-100/60">
            <div class="flex items-center gap-4">
                <div class="hamburger lg:hidden" id="hamburgerBtn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <h1 class="text-xl lg:text-2xl font-bold text-slate-900">DASHMET</h1>
                <span class="hidden lg:inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">Employee View</span>
            </div>
            
            <div class="flex items-center gap-2 lg:gap-4">
                <!-- Global Search - Hidden on mobile, shown on larger screens -->
                <div class="relative hidden md:block">
                    <input type="text" placeholder="Search..." 
                           class="glass-search pl-10 pr-4 py-2.5 rounded-xl w-48 lg:w-80 focus:outline-none" 
                           id="globalSearch">
                    <svg class="absolute left-3 top-3 w-5 h-5 text-indigo-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>

                <!-- Notifications Bell -->
                <div class="relative">
                    <button id="notificationsButton" onclick="toggleNotifications()" class="relative p-2 hover:bg-slate-50 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <!-- Notification Badge -->
                        <span id="notificationBadge" class="hidden absolute top-1 right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Notifications Dropdown -->
                    <div id="notificationsDropdown" class="hidden fixed lg:absolute right-2 lg:right-0 top-16 lg:top-auto lg:mt-2 w-[calc(100vw-1rem)] sm:w-96 lg:w-96 bg-white rounded-lg shadow-xl border border-slate-200 z-[10001] max-h-[calc(100vh-5rem)] lg:max-h-[500px] overflow-hidden flex flex-col">
                        <div class="p-3 lg:p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50">
                            <h3 class="text-base lg:text-lg font-bold text-slate-900">Notifications</h3>
                            <button onclick="markAllNotificationsRead()" class="text-xs text-blue-600 hover:text-blue-700 font-medium whitespace-nowrap">
                                Mark all read
                            </button>
                        </div>
                        
                        <!-- Notifications List -->
                        <div id="notificationsList" class="overflow-y-auto flex-1">
                            <div class="flex items-center justify-center py-12 text-slate-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Menu with Dropdown -->
                <div class="relative">
                    <button id="userMenuButton" onclick="toggleUserDropdown()" class="flex items-center gap-2 lg:gap-3 cursor-pointer hover:bg-slate-50 rounded-lg p-2 transition-colors">
                        <div class="avatar bg-blue-500 text-white text-sm lg:text-base">{{ user_initials }}</div>
                        <div class="hidden lg:block text-left">
                            <div class="text-sm font-semibold text-slate-900">{{ user_full_name }}</div>
                            <div class="text-xs text-slate-500">{{ user_role }}</div>
                        </div>
                        <svg class="hidden lg:block w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 z-[10001]">
                        <div class="p-3 border-b border-slate-100">
                            <div class="text-sm font-semibold text-slate-900">{{ user_full_name }}</div>
                            <div class="text-xs text-slate-500">{{ session.get('email', '') }}</div>
                        </div>
                        <div class="py-1">
                            <button onclick="openProfileModal()" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-3">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span>My Profile</span>
                            </button>
                            <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs Row - Desktop Only -->
        <div class="hidden lg:flex items-center justify-between px-6 py-2">
            <div class="flex items-center gap-1 overflow-x-auto">
                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 border-b-2 border-blue-700" onclick="showSection('overview', event)" data-section="overview">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Overview</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('activity', event)" data-section="activity">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span>Activity Log</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('create', event)" data-section="create">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span>Create Request</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('help', event)" data-section="help">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Help Center</span>
                </a>
            </div>

            <div class="hidden lg:flex items-center gap-2 ml-4">
                <input type="date" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" id="dateFilterStart">
                <span class="text-slate-400 text-sm">to</span>
                <input type="date" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" id="dateFilterEnd">
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="p-4 lg:p-8">
        <!-- Overview Section -->
        <div id="overview-section" class="animate-slide-in">
            <!-- Quick Stats Card -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Quick Stats</h3>
                    <div id="statsRefreshIndicator" class="hidden">
                        <svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-600">Pending Requests</span>
                        <span id="dashPendingCount" class="text-lg font-bold text-yellow-600">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-600">Approved This Year</span>
                        <span id="dashApprovedCount" class="text-lg font-bold text-green-600">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-600">Days Used</span>
                        <span id="dashDaysUsed" class="text-lg font-bold text-blue-600">0</span>
                    </div>
                </div>
            </div>

            <!-- Tabs for Panels -->
            <div class="mb-6 flex gap-2 bg-slate-100 p-1 rounded-lg overflow-x-auto">
                <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium bg-white text-slate-900 shadow-sm" onclick="showTab('upcoming', event)">Upcoming</button>
                <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium text-slate-700 hover:text-slate-900" onclick="showTab('pending', event)">Pending</button>
                <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium text-slate-700 hover:text-slate-900" onclick="showTab('conflicts', event)">Conflicts</button>
            </div>

            <!-- Tab Content: Upcoming Vacations -->
            <div id="upcoming-tab" class="tab-content bg-white rounded-lg shadow p-4 lg:p-6">
                <!-- Important Notice - Hidden by default, shown when vacations exist -->
                <div id="vacationNotice" class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 hidden">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-800 font-medium">
                                üìã You must meet with your supervisor to fill and sign your Vacation form to finalize your request.
                            </p>
                            <p class="text-sm text-blue-700 mt-1 italic">
                                üìã Debe reunirse con su supervisor para completar y firmar su formulario de vacaciones para finalizar su solicitud.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4 lg:mb-6 gap-3">
                    <h2 class="text-lg lg:text-xl font-bold text-slate-900">My Upcoming Vacations (Next 30 Days)</h2>
                    <div class="flex items-center gap-2">
                        <label for="upcoming-rows-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="upcoming-rows-per-page" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeRowsPerPage('upcoming', this.value)">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </div>
                <div id="myUpcomingVacations" class="space-y-4">
                    <div class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                </div>
                <div id="upcoming-pagination" class="mt-6"></div>
            </div>

            <!-- Tab Content: Pending Requests -->
            <div id="pending-tab" class="tab-content bg-white rounded-lg shadow p-4 lg:p-6 hidden">
                <!-- Important Notice - Hidden by default, shown when pending requests exist -->
                <div id="pendingNotice" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 hidden">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-800 font-medium">
                                ‚è≥ Your request is currently under review by your supervisor and will be approved based on availability and scheduling considerations. If you need to modify your vacation dates, please contact your supervisor directly.
                            </p>
                            <p class="text-sm text-yellow-700 mt-1 italic">
                                ‚è≥ Su solicitud est√° siendo revisada por su supervisor y ser√° aprobada seg√∫n la disponibilidad y consideraciones de programaci√≥n. Si necesita modificar las fechas de sus vacaciones, comun√≠quese directamente con su supervisor.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4 lg:mb-6 gap-3">
                    <h2 class="text-lg lg:text-xl font-bold text-slate-900">My Pending Requests</h2>
                    <div class="flex items-center gap-2">
                        <label for="pending-rows-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="pending-rows-per-page" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeRowsPerPage('pending', this.value)">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </div>
                <div id="myPendingRequests" class="space-y-4">
                    <div class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                </div>
                <div id="pending-pagination" class="mt-6"></div>
            </div>

            <!-- Tab Content: Conflicts -->
            <div id="conflicts-tab" class="tab-content bg-white rounded-lg shadow p-4 lg:p-6 hidden">
                <!-- Conflicts Notice (hidden by default, shown when conflicts exist) -->
                <div id="conflictsNotice" class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-red-800">
                                <strong>English:</strong> A scheduling conflict has been detected with your vacation request. Please contact your supervisor to discuss alternative available dates and resolve this conflict.
                            </p>
                            <p class="text-sm font-medium text-red-800 mt-2">
                                <strong>Espa√±ol:</strong> Se ha detectado un conflicto de programaci√≥n con su solicitud de vacaciones. Comun√≠quese con su supervisor para discutir fechas alternativas disponibles y resolver este conflicto.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4 lg:mb-6 gap-3">
                    <h2 class="text-lg lg:text-xl font-bold text-slate-900">My Scheduling Conflicts & Warnings</h2>
                    <div class="flex items-center gap-2" id="conflictsRowsPerPageContainer" style="display: none;">
                        <label for="conflicts-rows-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="conflicts-rows-per-page" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeConflictsRowsPerPage()">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="conflictsLoading" class="flex items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>

                <!-- Conflicts Container -->
                <div id="conflictsContainer" class="space-y-4 hidden mb-4">
                    <!-- Will be populated dynamically by JavaScript -->
                </div>

                <!-- Pagination Controls -->
                <div id="conflicts-pagination" class="mt-6"></div>

                <!-- Empty State -->
                <div id="conflictsEmpty" class="hidden text-center py-12">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-2">No Conflicts Detected</h3>
                    <p class="text-slate-600">Your vacation requests have no scheduling conflicts.</p>
                </div>
            </div>
        </div>

        <!-- Activity Log Section -->
        <div id="activity-section" class="hidden">
            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-6 gap-4">
                    <h2 class="text-xl lg:text-2xl font-bold text-slate-900">My Activity Log</h2>
                    <div id="activityRowsPerPageContainer" class="flex items-center gap-2" style="display: none;">
                        <label for="activity-rows-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="activity-rows-per-page" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeActivityRowsPerPage()">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </div>

                <div id="activityLogContainer" class="space-y-4 mb-4">
                    <!-- Activity items will be loaded here dynamically -->
                    <div class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div id="activity-pagination" class="mt-6"></div>
            </div>
        </div>

        <!-- Create Request Section -->
        <div id="create-section" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Main Form -->
                <div class="lg:col-span-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-6">Create Vacation Request</h2>
                        
                        <form id="createRequestForm" class="space-y-6" data-employee-id="{{ employee_id }}">
                            <!-- Leave Type -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Leave Type *</label>
                                <select id="leaveType" name="leave_type" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select leave type</option>
                                    <option value="vacation">Vacation</option>
                                </select>
                            </div>

                            <!-- Date Range -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Start Date *</label>
                                    <input type="date" id="startDate" name="start_date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <div id="startDatePastWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Past Date Not Allowed:</span>
                                                Start date cannot be in the past. Please select today or a future date.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="startDateNoticeWarning" class="hidden mt-2 p-3 bg-orange-50 border border-orange-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div class="text-sm text-orange-800">
                                                <span class="font-semibold">Insufficient Notice:</span>
                                                <span id="startDateNoticeMessage"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="startDateWeekendWarning" class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                            </svg>
                                            <div class="text-sm text-amber-800">
                                                <span class="font-semibold">Weekend Selected:</span>
                                                <span id="startDateWeekendDay"></span> is not a working day. Vacation days are counted Monday-Friday only.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="startDateBlackoutWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Blackout Period:</span>
                                                <span id="startDateBlackoutMessage"></span>
                                                <div class="mt-2 text-xs">
                                                    Please choose a different date or contact your direct supervisor if you believe this is a mistake.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">End Date *</label>
                                    <input type="date" id="endDate" name="end_date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <div id="endDatePastWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Past Date Not Allowed:</span>
                                                End date cannot be in the past. Please select today or a future date.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="endDateWeekendWarning" class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                            </svg>
                                            <div class="text-sm text-amber-800">
                                                <span class="font-semibold">Weekend Selected:</span>
                                                <span id="endDateWeekendDay"></span> is not a working day. Vacation days are counted Monday-Friday only.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="endDateBlackoutWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Blackout Period:</span>
                                                <span id="endDateBlackoutMessage"></span>
                                                <div class="mt-2 text-xs">
                                                    Please choose a different date or contact your direct supervisor if you believe this is a mistake.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vacation Days Summary -->
                            <div id="vacationDaysSummary" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-xs font-semibold text-slate-600 mb-1">WORKING DAYS</div>
                                        <div id="workingDaysCount" class="text-2xl font-bold text-blue-900">0</div>
                                    </div>
                                    <div>
                                        <div class="text-xs font-semibold text-slate-600 mb-1">WEEKEND DAYS</div>
                                        <div id="weekendDaysCount" class="text-2xl font-bold text-slate-600">0</div>
                                    </div>
                                    <div id="blackoutDaysSection" class="hidden">
                                        <div class="text-xs font-semibold text-slate-600 mb-1">BLACKOUT DAYS</div>
                                        <div id="blackoutDaysCount" class="text-2xl font-bold text-red-700">0</div>
                                    </div>
                                    <div>
                                        <div class="text-xs font-semibold text-slate-600 mb-1">AUTO RETURN DATE</div>
                                        <div id="returnToWorkDate" class="text-sm font-bold text-green-900">--</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Return to Work Date -->
                            <div id="returnToWorkContainer" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    Return to Work Date
                                    <span class="text-xs text-slate-500 font-normal ml-2">(Auto-filled, editable)</span>
                                </label>
                                <input type="date" id="returnDate" name="return_to_work" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                
                                <!-- Heads-up message for gap days -->
                                <div id="returnDateGapWarning" class="hidden mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="text-sm text-blue-800">
                                            <span class="font-semibold">Heads-Up:</span>
                                            There are <span id="gapDaysCount" class="font-bold">0</span> working day(s) between your requested end date and return to work date. 
                                            Please contact HR to clarify the status of these days (unpaid leave, additional vacation, etc.).
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reason -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Reason *</label>
                                <textarea id="reason" name="reason" rows="3" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Briefly describe the reason for your leave request"></textarea>
                            </div>

                            <!-- Coverage Plan -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Coverage Plan</label>
                                <textarea id="coveragePlan" name="coverage_plan" rows="2" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Who will cover your responsibilities? (Optional)"></textarea>
                            </div>

                            <!-- Emergency Contact -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Emergency Contact Email</label>
                                    <input type="email" id="emergencyEmail" name="emergency_email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="emergency@example.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Emergency Contact Phone</label>
                                    <input type="tel" id="emergencyPhone" name="emergency_phone" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="(555) 123-4567">
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex items-center justify-end gap-4 pt-4 border-t">
                                <button type="button" onclick="resetCreateForm()" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-medium transition-colors">
                                    Reset
                                </button>
                                <button type="submit" id="submitRequestBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors flex items-center justify-center gap-2">
                                    <svg id="submitSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span id="submitBtnText">Submit Request</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sidebar - Quick Stats & Info -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Quick Stats</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-600">Pending Requests</span>
                                <span id="sidebarPendingCount" class="text-lg font-bold text-yellow-600">-</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-600">Approved This Year</span>
                                <span id="sidebarApprovedCount" class="text-lg font-bold text-green-600">-</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-600">Days Used</span>
                                <span id="sidebarDaysUsed" class="text-lg font-bold text-blue-600">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Upcoming Leaves (Preview) -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Upcoming Leaves</h3>
                        <div id="sidebarUpcomingLeaves" class="space-y-2">
                            <p class="text-sm text-slate-500">Loading...</p>
                        </div>
                    </div>

                    <!-- Helpful Tips -->
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h3 class="text-lg font-bold text-blue-900 mb-3">üí° Tips</h3>
                        <ul class="text-sm text-blue-800 space-y-2">
                            <li>‚Ä¢ Submit requests at least 2 weeks in advance</li>
                            <li>‚Ä¢ Check for scheduling conflicts before submitting</li>
                            <li>‚Ä¢ Keep emergency contact info updated</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Center Section -->
    <div id="helpSection" class="hidden p-4 lg:p-8">
        <div class="mb-6">
            <h2 class="text-2xl lg:text-3xl font-bold text-white">Help Center</h2>
            <p class="text-blue-100 mt-2">Find answers to common questions and learn how to use the vacation management system</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Quick Links -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900">Quick Start Guide</h3>
                    </div>
                    <ul class="space-y-2 text-sm text-slate-700">
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>Click "Create Request" to submit a new vacation request</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>View your vacation history in the "Activity Log" tab</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>Check your remaining vacation hours on ADP or contact your direct supervisor</span>
                        </li>
                    </ul>
                </div>

                <!-- Contact Support -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-6 border border-purple-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900">Need Help?</h3>
                    </div>
                    <p class="text-sm text-slate-700 mb-4">Contact your supervisor for assistance with:</p>
                    <ul class="space-y-2 text-sm text-slate-700">
                        <li class="flex items-start gap-2">
                            <span class="text-purple-600">‚Ä¢</span>
                            <span>Vacation policy questions</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-purple-600">‚Ä¢</span>
                            <span>Request status inquiries</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-purple-600">‚Ä¢</span>
                            <span>Account or technical issues</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- FAQ Section -->
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Frequently Asked Questions</h3>
                
                <div class="space-y-4">
                    <!-- FAQ Item 1 -->
                    <div class="border-b border-slate-200 pb-4">
                        <button class="faq-question w-full flex items-center justify-between text-left" onclick="toggleFAQ(this)">
                            <h4 class="font-semibold text-slate-900">How do I submit a vacation request?</h4>
                            <svg class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="faq-answer hidden mt-3 text-sm text-slate-600">
                            <p>Click on the "Create Request" tab, fill in all required fields including start date, end date, leave type, and reason. Make sure to select working days (Monday-Friday) only. Click "Submit Request" when ready.</p>
                        </div>
                    </div>

                    <!-- FAQ Item 2 -->
                    <div class="border-b border-slate-200 pb-4">
                        <button class="faq-question w-full flex items-center justify-between text-left" onclick="toggleFAQ(this)">
                            <h4 class="font-semibold text-slate-900">How far in advance should I submit my request?</h4>
                            <svg class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="faq-answer hidden mt-3 text-sm text-slate-600">
                            <p>We recommend submitting vacation requests at least 2 weeks in advance to allow sufficient time for approval and scheduling adjustments.</p>
                        </div>
                    </div>

                    <!-- FAQ Item 3 -->
                    <div class="border-b border-slate-200 pb-4">
                        <button class="faq-question w-full flex items-center justify-between text-left" onclick="toggleFAQ(this)">
                            <h4 class="font-semibold text-slate-900">Can I select weekend dates for my vacation?</h4>
                            <svg class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="faq-answer hidden mt-3 text-sm text-slate-600">
                            <p>No, the system only counts working days (Monday through Friday). Weekend dates are automatically excluded from vacation calculations.</p>
                        </div>
                    </div>

                    <!-- FAQ Item 4 -->
                    <div class="border-b border-slate-200 pb-4">
                        <button class="faq-question w-full flex items-center justify-between text-left" onclick="toggleFAQ(this)">
                            <h4 class="font-semibold text-slate-900">How do I check my remaining vacation days?</h4>
                            <svg class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="faq-answer hidden mt-3 text-sm text-slate-600">
                            <p>Check on the ADP App or contact your supervisor directly.</p>
                        </div>
                    </div>

                    <!-- FAQ Item 5 -->
                    <div class="border-b border-slate-200 pb-4">
                        <button class="faq-question w-full flex items-center justify-between text-left" onclick="toggleFAQ(this)">
                            <h4 class="font-semibold text-slate-900">What happens after I submit a request?</h4>
                            <svg class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="faq-answer hidden mt-3 text-sm text-slate-600">
                            <p>Your request will be sent to your supervisor for review. You can track the status in the "Pending" tab. You'll receive a notification once your request is approved or denied.</p>
                        </div>
                    </div>

                    <!-- FAQ Item 6 -->
                    <div class="pb-4">
                        <button class="faq-question w-full flex items-center justify-between text-left" onclick="toggleFAQ(this)">
                            <h4 class="font-semibold text-slate-900">Can I cancel or modify my request?</h4>
                            <svg class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div class="faq-answer hidden mt-3 text-sm text-slate-600">
                            <p>Please contact your supervisor directly to cancel or modify a pending vacation request. Once approved, you'll need supervisor approval for any changes.</p>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 z-[10002] flex items-center justify-center p-4" style="backdrop-filter: blur(8px); background-color: rgba(219, 234, 254, 0.5);">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-slate-900">My Profile</h2>
                <button onclick="closeProfileModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 space-y-6">
                <!-- Profile Information -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-100">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="avatar bg-blue-500 text-white text-2xl w-16 h-16 flex items-center justify-center">
                            {{ user_initials }}
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900" id="profileFullName">{{ user_full_name }}</h3>
                            <p class="text-sm text-slate-600" id="profileEmail">{{ session.get('email', '') }}</p>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700 mt-1" id="profileRole">
                                {{ user_role }}
                            </span>
                        </div>
                    </div>

                    <!-- Employee Details Grid -->
                    <div id="employeeDetails" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Loading state -->
                        <div class="col-span-2 text-center py-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="text-sm text-slate-500 mt-2">Loading profile information...</p>
                        </div>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="border-t border-slate-200 pt-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Change Password</h3>
                    
                    <form id="changePasswordForm" onsubmit="handlePasswordChange(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Current Password</label>
                            <input 
                                type="password" 
                                id="currentPassword" 
                                name="current_password"
                                required
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter your current password"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">New Password</label>
                            <input 
                                type="password" 
                                id="newPassword" 
                                name="new_password"
                                required
                                minlength="8"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter new password (min 8 characters)"
                            >
                            <p class="mt-1 text-xs text-slate-500">Password must be at least 8 characters long</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Confirm New Password</label>
                            <input 
                                type="password" 
                                id="confirmPassword" 
                                name="confirm_password"
                                required
                                minlength="8"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Confirm your new password"
                            >
                        </div>

                        <div id="passwordError" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="ml-3 text-sm text-red-800" id="passwordErrorMessage"></p>
                            </div>
                        </div>

                        <div id="passwordSuccess" class="hidden bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="ml-3 text-sm text-green-800">Password changed successfully!</p>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button 
                                type="submit" 
                                id="changePasswordBtn"
                                class="flex-1 bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                            >
                                Change Password
                            </button>
                            <button 
                                type="button"
                                onclick="closeProfileModal()"
                                class="px-6 py-2.5 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors font-medium"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pagination State Management
        const paginationState = {
            upcoming: { currentPage: 1, rowsPerPage: 10, allData: [] },
            pending: { currentPage: 1, rowsPerPage: 10, allData: [] },
            conflicts: { currentPage: 1, rowsPerPage: 5, allData: [] },
            activity: { currentPage: 1, rowsPerPage: 10, allData: [] }
        };

        // Pagination Functions
        function changeRowsPerPage(tab, value) {
            paginationState[tab].rowsPerPage = parseInt(value);
            paginationState[tab].currentPage = 1;
            renderPaginatedData(tab);
        }

        function goToPage(tab, page) {
            const state = paginationState[tab];
            const totalPages = Math.ceil(state.allData.length / state.rowsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            state.currentPage = page;
            renderPaginatedData(tab);
        }

        function renderPaginationControls(tab) {
            const state = paginationState[tab];
            const totalPages = Math.ceil(state.allData.length / state.rowsPerPage);
            const paginationContainer = document.getElementById(`${tab}-pagination`);
            
            if (!paginationContainer || totalPages <= 1) {
                if (paginationContainer) paginationContainer.innerHTML = '';
                return;
            }
            
            const currentPage = state.currentPage;
            const maxVisiblePages = 5;
            
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            let paginationHTML = `
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 border-t border-slate-200 pt-4">
                    <div class="text-sm text-slate-600">
                        Showing ${Math.min((currentPage - 1) * state.rowsPerPage + 1, state.allData.length)} to ${Math.min(currentPage * state.rowsPerPage, state.allData.length)} of ${state.allData.length} results
                    </div>
                    <div class="flex items-center gap-2">
                        <button 
                            onclick="goToPage('${tab}', 1)" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === 1 ? 'disabled' : ''}
                        >
                            First
                        </button>
                        <button 
                            onclick="goToPage('${tab}', ${currentPage - 1})" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === 1 ? 'disabled' : ''}
                        >
                            Previous
                        </button>
                        <div class="flex gap-1">
            `;
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button 
                        onclick="goToPage('${tab}', ${i})" 
                        class="px-3 py-1.5 text-sm border rounded-lg ${i === currentPage ? 'bg-blue-600 text-white border-blue-600' : 'border-slate-300 hover:bg-slate-50'}"
                    >
                        ${i}
                    </button>
                `;
            }
            
            paginationHTML += `
                        </div>
                        <button 
                            onclick="goToPage('${tab}', ${currentPage + 1})" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === totalPages ? 'disabled' : ''}
                        >
                            Next
                        </button>
                        <button 
                            onclick="goToPage('${tab}', ${totalPages})" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === totalPages ? 'disabled' : ''}
                        >
                            Last
                        </button>
                    </div>
                </div>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        function renderPaginatedData(tab) {
            const state = paginationState[tab];
            const startIndex = (state.currentPage - 1) * state.rowsPerPage;
            const endIndex = startIndex + state.rowsPerPage;
            const paginatedData = state.allData.slice(startIndex, endIndex);
            
            // Call the appropriate render function based on tab
            if (tab === 'upcoming') {
                renderMyUpcomingVacations(paginatedData);
            } else if (tab === 'pending') {
                renderMyPendingRequests(paginatedData);
            } else if (tab === 'conflicts') {
                renderConflicts(paginatedData);
            } else if (tab === 'activity') {
                renderActivityLog(paginatedData);
            }
            
            renderPaginationControls(tab);
        }

        // Pagination functions for conflicts
        function changeConflictsRowsPerPage() {
            const value = document.getElementById('conflicts-rows-per-page').value;
            paginationState.conflicts.rowsPerPage = parseInt(value);
            paginationState.conflicts.currentPage = 1;
            renderPaginatedData('conflicts');
        }

        // Pagination functions for activity
        function changeActivityRowsPerPage() {
            const value = document.getElementById('activity-rows-per-page').value;
            paginationState.activity.rowsPerPage = parseInt(value);
            paginationState.activity.currentPage = 1;
            renderPaginatedData('activity');
        }

        // Notifications System
        let notificationsData = [];
        
        // Toggle Notifications Dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            const userDropdown = document.getElementById('userDropdownMenu');
            
            // Close user dropdown if open
            userDropdown.classList.add('hidden');
            
            dropdown.classList.toggle('hidden');
            
            // Load notifications when opening
            if (!dropdown.classList.contains('hidden')) {
                loadNotifications();
            }
        }
        
        // Load Notifications
        async function loadNotifications() {
            const listContainer = document.getElementById('notificationsList');
            
            try {
                const response = await fetch('/api/my-notifications');
                const data = await response.json();
                
                if (data.success && data.notifications) {
                    notificationsData = data.notifications;
                    
                    // Update badge
                    updateNotificationBadge();
                    
                    if (notificationsData.length === 0) {
                        listContainer.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-12 text-slate-500">
                                <svg class="w-16 h-16 mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                                <p class="text-sm font-medium">No notifications</p>
                                <p class="text-xs mt-1">You're all caught up!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Render notifications
                    listContainer.innerHTML = notificationsData.map(notification => {
                        const isUnread = !notification.is_read;
                        const bgClass = isUnread ? 'bg-blue-50' : 'bg-white';
                        const borderClass = isUnread ? 'border-l-4 border-blue-500' : '';
                        
                        let icon = '';
                        let iconColor = '';
                        
                        switch(notification.type) {
                            case 'vacation_approved':
                                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
                                iconColor = 'text-green-500';
                                break;
                            case 'vacation_denied':
                                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
                                iconColor = 'text-red-500';
                                break;
                            case 'vacation_pending':
                                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>';
                                iconColor = 'text-yellow-500';
                                break;
                            case 'vacation_submitted':
                                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
                                iconColor = 'text-blue-500';
                                break;
                            default:
                                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>';
                                iconColor = 'text-slate-500';
                        }
                        
                        const createdDate = new Date(notification.created_at);
                        const timeAgo = getTimeAgo(createdDate);
                        
                        return `
                            <div class="${bgClass} ${borderClass} p-3 lg:p-4 border-b border-slate-100 hover:bg-slate-50 transition-colors">
                                <div class="flex items-start gap-2 lg:gap-3">
                                    <div class="flex-shrink-0 mt-0.5 lg:mt-1">
                                        <svg class="w-5 h-5 lg:w-6 lg:h-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${icon}
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs lg:text-sm font-semibold text-slate-900 mb-1">${notification.title}</p>
                                        <p class="text-xs lg:text-sm text-slate-600 mb-2">${notification.message}</p>
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs text-slate-500">${timeAgo}</span>
                                                ${isUnread ? '<span class="text-xs font-medium text-blue-600">New</span>' : ''}
                                            </div>
                                            <div class="flex gap-2">
                                                ${isUnread ? `<button onclick="event.stopPropagation(); markNotificationRead(${notification.id})" class="text-xs text-blue-600 hover:text-blue-700 font-medium whitespace-nowrap">Mark read</button>` : ''}
                                                <button onclick="event.stopPropagation(); deleteNotification(${notification.id})" class="text-xs text-red-600 hover:text-red-700 font-medium whitespace-nowrap">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listContainer.innerHTML = `
                        <div class="flex items-center justify-center py-12 text-red-500">
                            <p class="text-sm">Error loading notifications</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                listContainer.innerHTML = `
                    <div class="flex items-center justify-center py-12 text-red-500">
                        <p class="text-sm">Error loading notifications</p>
                    </div>
                `;
            }
        }
        
        // Update Notification Badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notificationsData.filter(n => !n.is_read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Mark Notification as Read
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload notifications
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        // Mark All Notifications as Read
        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/api/notifications/mark-all-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload notifications
                    loadNotifications();
                    showToast('All notifications marked as read', 'success');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showToast('Failed to mark notifications as read', 'error');
            }
        }

        // Delete Notification
        async function deleteNotification(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload notifications
                    loadNotifications();
                    showToast('Notification deleted', 'success');
                } else {
                    showToast(data.message || 'Failed to delete notification', 'error');
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                showToast('Failed to delete notification', 'error');
            }
        }
        
        // Close notifications when clicking outside
        document.addEventListener('click', function(event) {
            const notificationsButton = document.getElementById('notificationsButton');
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            
            if (notificationsButton && notificationsDropdown && 
                !notificationsButton.contains(event.target) && 
                !notificationsDropdown.contains(event.target)) {
                notificationsDropdown.classList.add('hidden');
            }
        });
        
        // Global Search Functionality
        let globalSearchData = {
            myVacations: [],
            upcomingVacations: []
        };

        function initGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', debounce(performGlobalSearch, 300));
            searchInput.addEventListener('focus', showSearchResults);
            
            // Close search results when clicking outside
            document.addEventListener('click', function(e) {
                const searchContainer = searchInput.closest('.relative');
                const resultsContainer = document.getElementById('globalSearchResults');
                if (resultsContainer && !searchContainer.contains(e.target)) {
                    resultsContainer.remove();
                }
            });

            // Load search data
            loadGlobalSearchData();
        }

        async function loadGlobalSearchData() {
            try {
                // Load my vacation requests
                const myVacResponse = await fetch('/api/vacation/my-requests');
                const myVacData = await myVacResponse.json();
                if (myVacData.success) {
                    globalSearchData.myVacations = myVacData.requests || [];
                }

                // Load upcoming vacations
                const upcomingResponse = await fetch('/api/vacation/upcoming');
                const upcomingData = await upcomingResponse.json();
                if (upcomingData.success) {
                    globalSearchData.upcomingVacations = upcomingData.vacations || [];
                }
            } catch (error) {
                console.error('Error loading search data:', error);
            }
        }

        function performGlobalSearch(e) {
            const searchTerm = e.target.value.trim().toLowerCase();
            
            if (searchTerm.length < 2) {
                removeSearchResults();
                return;
            }

            const results = {
                myVacations: [],
                colleagues: []
            };

            // Search my vacations
            results.myVacations = globalSearchData.myVacations.filter(vac => {
                const leaveType = (vac.leave_type || '').toLowerCase();
                const status = (vac.status || '').toLowerCase();
                const reason = (vac.reason || '').toLowerCase();
                return leaveType.includes(searchTerm) || status.includes(searchTerm) || reason.includes(searchTerm);
            }).slice(0, 5);

            // Search upcoming vacations (colleagues)
            results.colleagues = globalSearchData.upcomingVacations.filter(vac => {
                const employeeName = `${vac.firstname || ''} ${vac.lastname || ''}`.toLowerCase();
                const department = (vac.department || '').toLowerCase();
                return employeeName.includes(searchTerm) || department.includes(searchTerm);
            }).slice(0, 5);

            displaySearchResults(results, searchTerm);
        }

        function parseLocalDate(dateString) {
            // Parse YYYY-MM-DD format to local date without timezone issues
            if (!dateString || typeof dateString !== 'string') {
                return new Date(); // Return current date as fallback
            }
            const parts = dateString.split('-');
            if (parts.length !== 3) {
                return new Date(); // Return current date as fallback
            }
            const [year, month, day] = parts.map(num => parseInt(num, 10));
            if (isNaN(year) || isNaN(month) || isNaN(day)) {
                return new Date(); // Return current date as fallback
            }
            return new Date(year, month - 1, day);
        }

        function parseLocalDateTime(datetimeString) {
            // Parse YYYY-MM-DD HH:MM:SS format to local datetime without timezone issues
            if (!datetimeString || typeof datetimeString !== 'string') {
                return new Date(); // Return current date as fallback
            }
            const parts = datetimeString.split(' ');
            if (parts.length !== 2) {
                return new Date(); // Return current date as fallback
            }
            const [datePart, timePart] = parts;
            const dateParts = datePart.split('-');
            const timeParts = timePart.split(':');
            
            if (dateParts.length !== 3 || timeParts.length !== 3) {
                return new Date(); // Return current date as fallback
            }
            
            const [year, month, day] = dateParts.map(num => parseInt(num, 10));
            const [hour, minute, second] = timeParts.map(num => parseInt(num, 10));
            
            if (isNaN(year) || isNaN(month) || isNaN(day) || isNaN(hour) || isNaN(minute) || isNaN(second)) {
                return new Date(); // Return current date as fallback
            }
            
            return new Date(year, month - 1, day, hour, minute, second);
        }

        function displaySearchResults(results, searchTerm) {
            removeSearchResults();

            const searchInput = document.getElementById('globalSearch');
            const searchContainer = searchInput.closest('.relative');
            
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'globalSearchResults';
            resultsDiv.className = 'absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-xl border border-slate-200 z-50 max-h-96 overflow-y-auto';

            let html = '';

            // My Vacations Section
            if (results.myVacations.length > 0) {
                html += `
                    <div class="p-3 border-b border-slate-200">
                        <h4 class="text-xs font-semibold text-slate-500 uppercase">My Requests</h4>
                    </div>
                `;
                results.myVacations.forEach(vac => {
                    const startDate = parseLocalDate(vac.start_date);
                    const endDate = parseLocalDate(vac.end_date);
                    const { workingDays } = calculateWorkingDays(startDate, endDate);
                    const formattedDates = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    const statusColors = {
                        'pending': 'bg-yellow-100 text-yellow-700',
                        'approved': 'bg-green-100 text-green-700',
                        'denied': 'bg-red-100 text-red-700'
                    };
                    const statusClass = statusColors[vac.status] || 'bg-slate-100 text-slate-700';
                    html += `
                        <div class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 transition-colors" onclick="viewMyVacationDetails(${vac.id})">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium text-slate-900">${formattedDates}</div>
                                    <div class="text-xs text-slate-500">${vac.leave_type || 'N/A'} ‚Ä¢ ${workingDays} day${workingDays !== 1 ? 's' : ''}</div>
                                </div>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                    ${vac.status.charAt(0).toUpperCase() + vac.status.slice(1)}
                                </span>
                            </div>
                        </div>
                    `;
                });
            }

            // Colleagues' Vacations Section
            if (results.colleagues.length > 0) {
                html += `
                    <div class="p-3 border-b border-slate-200 ${results.myVacations.length > 0 ? 'mt-2' : ''}">
                        <h4 class="text-xs font-semibold text-slate-500 uppercase">Colleagues On Leave</h4>
                    </div>
                `;
                results.colleagues.forEach(vac => {
                    const fullName = `${vac.firstname || ''} ${vac.lastname || ''}`;
                    const initials = `${vac.firstname?.[0] || ''}${vac.lastname?.[0] || ''}`.toUpperCase();
                    const startDate = parseLocalDate(vac.start_date);
                    const endDate = parseLocalDate(vac.end_date);
                    const formattedDates = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    html += `
                        <div class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="avatar bg-blue-500 text-white text-sm">${initials}</div>
                                <div class="flex-1">
                                    <div class="font-medium text-slate-900">${fullName}</div>
                                    <div class="text-xs text-slate-500">${formattedDates}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // No Results
            if (results.myVacations.length === 0 && results.colleagues.length === 0) {
                html = `
                    <div class="p-8 text-center text-slate-500">
                        <svg class="w-12 h-12 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <p class="text-sm">No results found for "${searchTerm}"</p>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
            searchContainer.appendChild(resultsDiv);
        }

        function showSearchResults() {
            const searchInput = document.getElementById('globalSearch');
            if (searchInput.value.trim().length >= 2) {
                performGlobalSearch({ target: searchInput });
            }
        }

        function removeSearchResults() {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (resultsDiv) {
                resultsDiv.remove();
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Load notifications on page load and periodically
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            initGlobalSearch();
            // Refresh notifications every 30 seconds
            setInterval(function() {
                if (document.getElementById('notificationsDropdown').classList.contains('hidden')) {
                    // Only update badge when dropdown is closed
                    fetch('/api/my-notifications')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.notifications) {
                                notificationsData = data.notifications;
                                updateNotificationBadge();
                            }
                        })
                        .catch(error => console.error('Error refreshing notifications:', error));
                }
            }, 30000); // 30 seconds
        });
        
        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const hamburger = document.getElementById('hamburgerBtn');
            
            mobileMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // Section Navigation
        function showSection(sectionName, event) {
            if (event) event.preventDefault();
            
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });
            // Also hide help section specifically
            const helpSection = document.getElementById('helpSection');
            if (helpSection) {
                helpSection.classList.add('hidden');
            }

            // Show selected section
            let targetSection;
            if (sectionName === 'help') {
                targetSection = document.getElementById('helpSection');
            } else {
                targetSection = document.getElementById(sectionName + '-section');
            }
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            // Update desktop nav items
            document.querySelectorAll('.nav-tab').forEach(item => {
                item.classList.remove('bg-blue-50', 'text-blue-700', 'border-b-2', 'border-blue-700');
                item.classList.add('text-slate-700', 'hover:bg-slate-100');
            });
            
            // Find and activate the clicked nav item
            const activeTab = document.querySelector(`.nav-tab[data-section="${sectionName}"]`);
            if (activeTab) {
                activeTab.classList.remove('text-slate-700', 'hover:bg-slate-100');
                activeTab.classList.add('bg-blue-50', 'text-blue-700', 'border-b-2', 'border-blue-700');
            }

            // Load section-specific data
            if (sectionName === 'activity') {
                loadActivityLog();
            } else if (sectionName === 'create') {
                loadCreateSectionStats();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Toast Functionality
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            // Determine toast styling based on type
            let bgColor, iconColor, iconPath;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-600';
                    iconColor = 'text-white';
                    iconPath = 'M5 13l4 4L19 7';
                    break;
                case 'error':
                    bgColor = 'bg-red-600';
                    iconColor = 'text-white';
                    iconPath = 'M6 18L18 6M6 6l12 12';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-600';
                    iconColor = 'text-white';
                    iconPath = 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.863-.833-2.633 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z';
                    break;
                default: // info
                    bgColor = 'bg-blue-600';
                    iconColor = 'text-white';
                    iconPath = 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
            }
            
            toast.className = `toast flex items-center p-4 ${bgColor} text-white rounded-lg shadow-lg max-w-sm`;
            toast.innerHTML = `
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/>
                    </svg>
                </div>
                <div class="ml-3 text-sm font-medium">${message}</div>
                <button class="ml-auto -mx-1.5 -my-1.5 text-white hover:text-gray-200 focus:outline-none" onclick="removeToast(this.parentElement)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove toast after duration
            setTimeout(() => {
                removeToast(toast);
            }, duration);
        }
        
        function removeToast(toast) {
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // FAQ Toggle Functionality
        function toggleFAQ(button) {
            const answer = button.nextElementSibling;
            const icon = button.querySelector('svg');
            
            if (answer.classList.contains('hidden')) {
                answer.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                answer.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        // Load my vacation stats
        // Auto-refresh for stats
        let statsRefreshInterval = null;
        
        function startStatsAutoRefresh() {
            // Clear any existing interval
            if (statsRefreshInterval) {
                clearInterval(statsRefreshInterval);
            }
            
            // Refresh every 10 seconds (10000 ms)
            statsRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing vacation stats...');
                loadMyVacationStats();
            }, 10000);
            
            console.log('Auto-refresh started for vacation stats (10 seconds interval)');
        }
        
        function stopStatsAutoRefresh() {
            if (statsRefreshInterval) {
                clearInterval(statsRefreshInterval);
                statsRefreshInterval = null;
                console.log('Auto-refresh stopped for vacation stats');
            }
        }

        async function loadMyVacationStats() {
            const indicator = document.getElementById('statsRefreshIndicator');
            
            try {
                // Show refresh indicator
                if (indicator) {
                    indicator.classList.remove('hidden');
                }
                
                const response = await fetch('/api/vacation/my-stats');
                const data = await response.json();
                
                console.log('Stats API response:', data);
                
                if (data.success && data.stats) {
                    const stats = data.stats;
                    
                    // Update Quick Stats with smooth transition
                    const pendingEl = document.getElementById('dashPendingCount');
                    const approvedEl = document.getElementById('dashApprovedCount');
                    const daysUsedEl = document.getElementById('dashDaysUsed');
                    
                    // Add a subtle pulse animation when value changes
                    const updateValue = (element, newValue) => {
                        const oldValue = element.textContent;
                        if (oldValue !== String(newValue)) {
                            element.classList.add('animate-pulse');
                            setTimeout(() => element.classList.remove('animate-pulse'), 500);
                        }
                        element.textContent = newValue;
                    };
                    
                    updateValue(pendingEl, stats.pending ?? 0);
                    updateValue(approvedEl, stats.approved_count ?? 0);
                    updateValue(daysUsedEl, stats.days_used ?? 0);
                    
                    console.log('My vacation stats loaded successfully', stats);
                } else {
                    console.error('Failed to load vacation stats:', data.message || data);
                    // Set defaults on error
                    document.getElementById('dashPendingCount').textContent = '0';
                    document.getElementById('dashApprovedCount').textContent = '0';
                    document.getElementById('dashDaysUsed').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading vacation stats:', error);
                // Set defaults on error
                document.getElementById('dashPendingCount').textContent = '0';
                document.getElementById('dashApprovedCount').textContent = '0';
                document.getElementById('dashDaysUsed').textContent = '0';
            } finally {
                // Hide refresh indicator after a brief moment
                setTimeout(() => {
                    if (indicator) {
                        indicator.classList.add('hidden');
                    }
                }, 300);
            }
        }

        // Tab Navigation within Overview
        function showTab(tabName, evt) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab content
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }

            // Update tab buttons - first deactivate all
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-slate-900', 'shadow-sm');
                btn.classList.add('text-slate-700', 'hover:text-slate-900');
            });
            
            // Activate the clicked button
            if (evt && evt.target) {
                evt.target.classList.remove('text-slate-700', 'hover:text-slate-900');
                evt.target.classList.add('bg-white', 'text-slate-900', 'shadow-sm');
            }

            // Load data for specific tabs when they're shown
            if (tabName === 'upcoming') {
                loadMyUpcomingVacations();
            } else if (tabName === 'pending') {
                loadMyPendingRequests();
            } else if (tabName === 'conflicts') {
                loadMyConflicts();
            }
        }

        // Load my upcoming vacations (approved, next 30 days)
        async function loadMyUpcomingVacations() {
            try {
                const response = await fetch('/api/vacation/my-upcoming');
                const data = await response.json();
                
                const noticeElement = document.getElementById('vacationNotice');
                
                if (data.success && data.vacations) {
                    const vacations = data.vacations;
                    
                    // Store data in pagination state
                    paginationState.upcoming.allData = vacations;
                    paginationState.upcoming.currentPage = 1;
                    
                    if (vacations.length === 0) {
                        // Hide notice when no vacations
                        noticeElement.classList.add('hidden');
                    } else {
                        // Show notice when vacations exist
                        noticeElement.classList.remove('hidden');
                    }
                    
                    renderPaginatedData('upcoming');
                } else {
                    // Hide notice on error
                    noticeElement.classList.add('hidden');
                    paginationState.upcoming.allData = [];
                    renderPaginatedData('upcoming');
                }
            } catch (error) {
                console.error('Error loading upcoming vacations:', error);
                const noticeElement = document.getElementById('vacationNotice');
                noticeElement.classList.add('hidden');
                paginationState.upcoming.allData = [];
                renderPaginatedData('upcoming');
            }
        }

        // Render my upcoming vacations
        function renderMyUpcomingVacations(vacations) {
            const container = document.getElementById('myUpcomingVacations');
            if (!container) return;
            
            if (paginationState.upcoming.allData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-lg font-medium">No upcoming vacations</p>
                        <p class="text-sm">You don't have any approved vacations in the next 30 days</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = vacations.map(vac => {
                // Check if dates exist before parsing
                if (!vac.start_date || !vac.end_date) {
                    console.warn('Vacation entry missing dates:', vac);
                    return ''; // Skip invalid entries
                }
                
                try {
                    // Use parseLocalDate to avoid timezone issues
                    const startDate = parseLocalDate(vac.start_date);
                    const endDate = parseLocalDate(vac.end_date);
                    
                    // Validate that dates are valid
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                        console.warn('Invalid dates for vacation:', vac);
                        return '';
                    }
                    
                    const { workingDays } = calculateWorkingDays(startDate, endDate);
                    const formattedStart = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const formattedEnd = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const leaveTypeDisplay = vac.leave_type ? vac.leave_type.charAt(0).toUpperCase() + vac.leave_type.slice(1) : 'Vacation';
                    
                    return `
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg gap-3">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-semibold text-slate-900">${formattedStart} - ${formattedEnd}</div>
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                        <span class="status-indicator bg-green-500"></span>
                                        Approved
                                    </span>
                                </div>
                                <div class="text-sm text-slate-600">${workingDays} day${workingDays !== 1 ? 's' : ''} ‚Ä¢ ${leaveTypeDisplay}</div>
                                ${vac.reason ? `<div class="text-xs text-slate-500 mt-1">${vac.reason}</div>` : ''}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error rendering vacation entry:', error, vac);
                    return '';
                }
            }).join('');
        }

        // Load my pending requests
        async function loadMyPendingRequests() {
            try {
                const response = await fetch('/api/vacation/my-pending');
                const data = await response.json();
                
                const noticeElement = document.getElementById('pendingNotice');
                
                if (data.success && data.vacations) {
                    const vacations = data.vacations;
                    
                    // Store data in pagination state
                    paginationState.pending.allData = vacations;
                    paginationState.pending.currentPage = 1;
                    
                    if (vacations.length === 0) {
                        // Hide notice when no pending requests
                        noticeElement.classList.add('hidden');
                    } else {
                        // Show notice when pending requests exist
                        noticeElement.classList.remove('hidden');
                    }
                    
                    renderPaginatedData('pending');
                } else {
                    // Hide notice on error
                    noticeElement.classList.add('hidden');
                    paginationState.pending.allData = [];
                    renderPaginatedData('pending');
                }
            } catch (error) {
                console.error('Error loading pending requests:', error);
                const noticeElement = document.getElementById('pendingNotice');
                noticeElement.classList.add('hidden');
                paginationState.pending.allData = [];
                renderPaginatedData('pending');
            }
        }

        // Render my pending requests
        function renderMyPendingRequests(vacations) {
            const container = document.getElementById('myPendingRequests');
            if (!container) return;
            
            if (paginationState.pending.allData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-lg font-medium">All caught up!</p>
                        <p class="text-sm">You don't have any pending vacation requests</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = vacations.map(vac => {
                // Check if dates exist before parsing
                if (!vac.start_date || !vac.end_date) {
                    return ''; // Skip invalid entries
                }
                
                // Use parseLocalDate to avoid timezone issues
                const startDate = parseLocalDate(vac.start_date);
                const endDate = parseLocalDate(vac.end_date);
                const { workingDays } = calculateWorkingDays(startDate, endDate);
                const formattedStart = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formattedEnd = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const leaveTypeDisplay = vac.leave_type ? vac.leave_type.charAt(0).toUpperCase() + vac.leave_type.slice(1) : 'Vacation';
                const createdDate = vac.created_at ? new Date(vac.created_at) : new Date();
                const timeAgo = getTimeAgo(createdDate);
                
                return `
                    <div class="border-2 border-yellow-200 bg-yellow-50 rounded-lg p-4 lg:p-5">
                        <div class="flex flex-col lg:flex-row lg:items-start justify-between mb-3 gap-3">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-semibold text-slate-900">${formattedStart} - ${formattedEnd}</div>
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">
                                        <span class="status-indicator bg-yellow-500"></span>
                                        Pending Review
                                    </span>
                                </div>
                                <div class="text-sm text-slate-600 mb-1">${workingDays} day${workingDays !== 1 ? 's' : ''} ‚Ä¢ ${leaveTypeDisplay}</div>
                                <div class="text-xs text-slate-500">Submitted ${timeAgo}</div>
                            </div>
                        </div>
                        ${vac.reason ? `
                        <div class="bg-white rounded-lg p-3 mb-3">
                            <div class="text-xs font-semibold text-slate-600 mb-1">REASON</div>
                            <div class="text-sm text-slate-700">${vac.reason}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Load my conflicts and warnings
        async function loadMyConflicts() {
            const loadingEl = document.getElementById('conflictsLoading');
            const containerEl = document.getElementById('conflictsContainer');
            const emptyEl = document.getElementById('conflictsEmpty');
            const noticeEl = document.getElementById('conflictsNotice');
            const rowsPerPageContainer = document.getElementById('conflictsRowsPerPageContainer');

            try {
                // Show loading state
                loadingEl?.classList.remove('hidden');
                containerEl?.classList.add('hidden');
                emptyEl?.classList.add('hidden');
                noticeEl?.classList.add('hidden');
                rowsPerPageContainer.style.display = 'none';

                const response = await fetch('/api/vacation/my-conflicts');
                const data = await response.json();

                loadingEl?.classList.add('hidden');

                if (data.success && data.conflicts && data.conflicts.length > 0) {
                    // Show notice when conflicts exist
                    noticeEl?.classList.remove('hidden');
                    
                    // Store conflicts in pagination state
                    paginationState.conflicts.allData = data.conflicts;
                    paginationState.conflicts.currentPage = 1;
                    
                    // Show rows per page selector
                    rowsPerPageContainer.style.display = 'flex';
                    
                    // Render paginated conflicts
                    renderPaginatedData('conflicts');
                    
                    containerEl?.classList.remove('hidden');
                } else {
                    // Hide notice when no conflicts
                    noticeEl?.classList.add('hidden');
                    paginationState.conflicts.allData = [];
                    rowsPerPageContainer.style.display = 'none';
                    emptyEl?.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading conflicts:', error);
                loadingEl?.classList.add('hidden');
                // Hide notice on error
                noticeEl?.classList.add('hidden');
                paginationState.conflicts.allData = [];
                rowsPerPageContainer.style.display = 'none';
                containerEl.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <p>Error loading conflicts. Please try again.</p>
                    </div>
                `;
                containerEl?.classList.remove('hidden');
            }
        }

        // Render conflicts with pagination
        function renderConflicts(conflicts) {
            const containerEl = document.getElementById('conflictsContainer');
            
            if (!conflicts || conflicts.length === 0) {
                containerEl.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <p>No conflicts on this page</p>
                    </div>
                `;
                return;
            }
            
            containerEl.innerHTML = '';
            conflicts.forEach(conflict => {
                const conflictCard = createConflictCard(conflict);
                containerEl.innerHTML += conflictCard;
            });
        }

        // Create conflict card HTML
        function createConflictCard(conflict) {
            const isWarning = conflict.severity === 'warning';
            const borderColor = isWarning ? 'border-orange-200' : 'border-red-200';
            const bgColor = isWarning ? 'bg-orange-50' : 'bg-red-50';
            const iconBg = isWarning ? 'bg-orange-100' : 'bg-red-100';
            const iconColor = isWarning ? 'text-orange-600' : 'text-red-600';
            const icon = isWarning ? 
                'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' :
                'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';

            let detailsHtml = '';
            if (conflict.conflicting_requests && conflict.conflicting_requests.length > 0) {
                detailsHtml = `
                    <div class="bg-white rounded-lg p-3 mb-3">
                        <div class="text-xs font-semibold text-slate-600 mb-2">CONFLICTING REQUESTS</div>
                        <div class="space-y-2">
                            ${conflict.conflicting_requests.map(req => `
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-700">${req.employee_name}</span>
                                    <span class="text-slate-600">${formatDateRange(req.start_date, req.end_date)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (conflict.details) {
                detailsHtml = `
                    <div class="bg-white rounded-lg p-3 mb-3">
                        <div class="text-xs font-semibold text-slate-600 mb-2">DETAILS</div>
                        <div class="space-y-2 text-sm">
                            ${Object.entries(conflict.details).map(([key, value]) => `
                                <div class="flex justify-between">
                                    <span class="text-slate-600">${key}:</span>
                                    <span class="text-slate-900 font-medium">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="border-2 ${borderColor} ${bgColor} rounded-lg p-4 lg:p-5">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 ${iconBg} rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-slate-900 mb-2">${conflict.title}</div>
                            <div class="text-sm text-slate-700 mb-3">${conflict.description}</div>
                            ${detailsHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to format date range
        function formatDateRange(startDate, endDate) {
            const start = parseLocalDate(startDate);
            const end = parseLocalDate(endDate);
            const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            return `${startStr} - ${endStr}`;
        }

        // Helper function to calculate time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // difference in seconds
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 2592000) return `${Math.floor(diff / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        // Load my activity log
        async function loadActivityLog() {
            const container = document.getElementById('activityLogContainer');
            const rowsPerPageContainer = document.getElementById('activityRowsPerPageContainer');
            
            try {
                const response = await fetch('/api/vacation/my-activity');
                const data = await response.json();
                
                if (data.success && data.activities) {
                    // Store activities in pagination state
                    paginationState.activity.allData = data.activities;
                    paginationState.activity.currentPage = 1;
                    
                    if (data.activities.length === 0) {
                        rowsPerPageContainer.style.display = 'none';
                        container.innerHTML = `
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-lg font-medium text-slate-500">No activity to display</p>
                                <p class="text-sm text-slate-400 mt-2">Your vacation activities will appear here.</p>
                            </div>
                        `;
                        return;
                    }

                    // Show rows per page selector when data exists
                    rowsPerPageContainer.style.display = 'flex';
                    
                    // Render paginated activity data
                    renderPaginatedData('activity');
                } else {
                    paginationState.activity.allData = [];
                    rowsPerPageContainer.style.display = 'none';
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-slate-500">Error loading activity log</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading activity log:', error);
                paginationState.activity.allData = [];
                rowsPerPageContainer.style.display = 'none';
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-slate-500">Error loading activity log</p>
                        </div>
                    `;
            }
        }        // Render activity log with pagination
        function renderActivityLog(activities) {
            const container = document.getElementById('activityLogContainer');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <p>No activities on this page</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.map(activity => {
                // Check if dates exist
                if (!activity.start_date || !activity.end_date) {
                    return '';
                }

                // Use parseLocalDateTime for timestamp to avoid timezone issues
                const activityDate = parseLocalDateTime(activity.activity_timestamp);
                const formattedDate = activityDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                }) + ' at ' + activityDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });

                // Use parseLocalDate to avoid timezone issues
                const startDate = parseLocalDate(activity.start_date);
                const endDate = parseLocalDate(activity.end_date);
                const { workingDays } = calculateWorkingDays(startDate, endDate);
                const formattedStartDate = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const formattedEndDate = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                const leaveTypeDisplay = activity.leave_type 
                    ? activity.leave_type.charAt(0).toUpperCase() + activity.leave_type.slice(1) 
                    : 'N/A';

                // Determine icon and styling based on activity type
                let iconBg, iconColor, iconPath, activityTitle, activityDescription;
                
                switch (activity.activity_type) {
                    case 'approved':
                        iconBg = 'bg-green-100';
                        iconColor = 'text-green-600';
                        iconPath = 'M5 13l4 4L19 7';
                        activityTitle = 'Request Approved';
                        activityDescription = `Your vacation request for ${formattedStartDate} - ${formattedEndDate} was approved`;
                        break;
                    case 'denied':
                        iconBg = 'bg-red-100';
                        iconColor = 'text-red-600';
                        iconPath = 'M6 18L18 6M6 6l12 12';
                        activityTitle = 'Request Denied';
                        activityDescription = `Your vacation request for ${formattedStartDate} - ${formattedEndDate} was denied`;
                        break;
                    case 'modified':
                        iconBg = 'bg-purple-100';
                        iconColor = 'text-purple-600';
                        iconPath = 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z';
                        activityTitle = 'Request Modified';
                        activityDescription = `You updated your vacation dates to ${formattedStartDate} - ${formattedEndDate}`;
                        break;
                    case 'new_request':
                    default:
                        iconBg = 'bg-blue-100';
                        iconColor = 'text-blue-600';
                        iconPath = 'M12 4v16m8-8H4';
                        activityTitle = 'New Request Submitted';
                        activityDescription = `You submitted a vacation request for ${formattedStartDate} - ${formattedEndDate}`;
                        break;
                }

                // Status badge
                let statusBadge = '';
                if (activity.status === 'pending') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700">Pending</span>';
                }

                // Decision reason
                let decisionReason = '';
                if (activity.decision_reason && activity.activity_type === 'denied') {
                    decisionReason = `<div class="text-xs text-slate-500 italic mb-2">Reason: ${activity.decision_reason}</div>`;
                }

                return `
                    <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-10 h-10 ${iconBg} rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-2 gap-2">
                                    <div class="font-semibold text-slate-900">${activityTitle}</div>
                                    <span class="text-xs text-slate-500">${formattedDate}</span>
                                </div>
                                <div class="text-sm text-slate-600 mb-2">
                                    ${activityDescription}
                                </div>
                                ${decisionReason}
                                <div class="flex flex-wrap gap-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">${workingDays} day${workingDays !== 1 ? 's' : ''}</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700">${leaveTypeDisplay}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                // Close mobile menu if window becomes large
                if (window.innerWidth >= 1024) {
                    const mobileMenu = document.getElementById('mobileMenu');
                    const mobileOverlay = document.getElementById('mobileOverlay');
                    const hamburger = document.getElementById('hamburgerBtn');
                    
                    if (mobileMenu.classList.contains('active')) {
                        mobileMenu.classList.remove('active');
                        mobileOverlay.classList.remove('active');
                        hamburger.classList.remove('active');
                    }
                }
            }, 250);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('User Vacation Dashboard loaded');
            // Load all data when page loads
            loadMyVacationStats();
            loadMyUpcomingVacations(); // Load the default tab (upcoming)
            
            // Start auto-refresh for stats
            startStatsAutoRefresh();
            
            // Pre-load blackout periods for validation
            loadBlackoutPeriodsForValidation();
            // Pre-load vacation settings for validation
            loadVacationSettingsForValidation();
            
            // Attach form submit handler for Create Request
            const createForm = document.getElementById('createRequestForm');
            if (createForm) {
                createForm.addEventListener('submit', handleCreateRequestSubmit);
            }

            // Add event listeners for date validation
            document.getElementById('startDate')?.addEventListener('change', validateAndUpdateDates);
            document.getElementById('endDate')?.addEventListener('change', validateAndUpdateDates);
            document.getElementById('returnDate')?.addEventListener('change', checkReturnDateGap);
        });

        // Weekend detection and working days calculation
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // 0 = Sunday, 6 = Saturday
        }

        function getDayName(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        function parseLocalDate(dateString) {
            // Parse YYYY-MM-DD format to local date without timezone issues
            if (!dateString || typeof dateString !== 'string') {
                return new Date(); // Return current date as fallback
            }
            const parts = dateString.split('-');
            if (parts.length !== 3) {
                return new Date(); // Return current date as fallback
            }
            const [year, month, day] = parts.map(num => parseInt(num, 10));
            if (isNaN(year) || isNaN(month) || isNaN(day)) {
                return new Date(); // Return current date as fallback
            }
            return new Date(year, month - 1, day);
        }

        // Cache for blackout periods
        let cachedBlackoutPeriods = null;

        // Function to load and cache blackout periods
        async function loadBlackoutPeriodsForValidation() {
            try {
                const response = await fetch('/api/vacation/blackout-periods');
                const data = await response.json();
                
                if (data.success && data.periods) {
                    cachedBlackoutPeriods = data.periods.filter(period => period.is_active);
                    return cachedBlackoutPeriods;
                }
                return [];
            } catch (error) {
                console.error('Error loading blackout periods:', error);
                return [];
            }
        }

        // Function to check if a date falls within any blackout period
        function checkDateAgainstBlackouts(dateToCheck) {
            if (!cachedBlackoutPeriods) {
                return null;
            }

            for (const period of cachedBlackoutPeriods) {
                const periodStart = parseLocalDate(period.start_date);
                const periodEnd = parseLocalDate(period.end_date);
                
                if (dateToCheck >= periodStart && dateToCheck <= periodEnd) {
                    return {
                        name: period.name,
                        description: period.description,
                        start: periodStart,
                        end: periodEnd
                    };
                }
            }
            return null;
        }

        // Helper function to check if a date is a blackout day (returns boolean)
        function isBlackoutDay(dateToCheck) {
            return checkDateAgainstBlackouts(dateToCheck) !== null;
        }

        // Cache for vacation settings
        let cachedVacationSettings = null;

        // Function to load and cache vacation settings
        async function loadVacationSettingsForValidation() {
            try {
                const response = await fetch('/api/vacation/settings');
                const data = await response.json();
                
                if (data.success && data.settings) {
                    cachedVacationSettings = data.settings;
                    return cachedVacationSettings;
                }
                return null;
            } catch (error) {
                console.error('Error loading vacation settings:', error);
                return null;
            }
        }

        // Function to calculate working days from today to a given date
        function calculateWorkingDaysFromToday(targetDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const target = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            
            if (target <= today) {
                return 0;
            }
            
            let count = 0;
            let current = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            current.setDate(current.getDate() + 1); // Start from tomorrow
            
            while (current < target) {
                if (!isWeekend(current)) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }

        // Function to check if start date meets minimum notice requirement
        function checkMinimumNotice(startDate) {
            if (!cachedVacationSettings || !cachedVacationSettings.minimum_notice_days) {
                return null; // No validation if settings not loaded
            }
            
            const workingDaysFromToday = calculateWorkingDaysFromToday(startDate);
            const requiredNoticeDays = cachedVacationSettings.minimum_notice_days;
            
            if (workingDaysFromToday < requiredNoticeDays) {
                return {
                    required: requiredNoticeDays,
                    actual: workingDaysFromToday,
                    shortfall: requiredNoticeDays - workingDaysFromToday
                };
            }
            
            return null;
        }

        function calculateWorkingDays(startDate, endDate) {
            let count = 0;
            let weekendCount = 0;
            let blackoutCount = 0;
            const current = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

            while (current <= end) {
                if (isWeekend(current)) {
                    weekendCount++;
                } else if (isBlackoutDay(current)) {
                    // Exclude blackout days from working days count
                    blackoutCount++;
                } else {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }

            return { workingDays: count, weekendDays: weekendCount, blackoutDays: blackoutCount };
        }

        function getReturnToWorkDate(endDate) {
            // Return date is the next day after end date
            const returnDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            returnDate.setDate(returnDate.getDate() + 1);
            
            // Skip weekends for return date
            while (isWeekend(returnDate)) {
                returnDate.setDate(returnDate.getDate() + 1);
            }
            
            return returnDate;
        }

        async function validateAndUpdateDates() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const startPastWarning = document.getElementById('startDatePastWarning');
            const endPastWarning = document.getElementById('endDatePastWarning');
            const startNoticeWarning = document.getElementById('startDateNoticeWarning');
            const startNoticeMessage = document.getElementById('startDateNoticeMessage');
            const startWarning = document.getElementById('startDateWeekendWarning');
            const endWarning = document.getElementById('endDateWeekendWarning');
            const startBlackoutWarning = document.getElementById('startDateBlackoutWarning');
            const endBlackoutWarning = document.getElementById('endDateBlackoutWarning');
            const startBlackoutMessage = document.getElementById('startDateBlackoutMessage');
            const endBlackoutMessage = document.getElementById('endDateBlackoutMessage');
            const startWeekendDay = document.getElementById('startDateWeekendDay');
            const endWeekendDay = document.getElementById('endDateWeekendDay');
            const summaryDiv = document.getElementById('vacationDaysSummary');
            const returnDateInput = document.getElementById('returnDate');
            const returnDateContainer = document.getElementById('returnToWorkContainer');

            // Load blackout periods if not already cached
            if (!cachedBlackoutPeriods) {
                await loadBlackoutPeriodsForValidation();
            }

            // Load vacation settings if not already cached
            if (!cachedVacationSettings) {
                await loadVacationSettingsForValidation();
            }

            if (!startDateInput.value || !endDateInput.value) {
                startPastWarning.classList.add('hidden');
                endPastWarning.classList.add('hidden');
                startNoticeWarning.classList.add('hidden');
                startWarning.classList.add('hidden');
                endWarning.classList.add('hidden');
                startBlackoutWarning.classList.add('hidden');
                endBlackoutWarning.classList.add('hidden');
                summaryDiv.classList.add('hidden');
                returnDateContainer.classList.add('hidden');
                return;
            }

            // Parse dates properly to avoid timezone issues
            const startDate = parseLocalDate(startDateInput.value);
            const endDate = parseLocalDate(endDateInput.value);
            
            // Get today's date at midnight for comparison
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Check if start date is in the past
            let hasError = false;
            if (startDate < today) {
                startPastWarning.classList.remove('hidden');
                startDateInput.classList.add('border-red-500');
                startDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                startPastWarning.classList.add('hidden');
                startDateInput.classList.remove('border-red-500');
                startDateInput.classList.add('border-slate-300');
            }

            // Check if end date is in the past
            if (endDate < today) {
                endPastWarning.classList.remove('hidden');
                endDateInput.classList.add('border-red-500');
                endDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                endPastWarning.classList.add('hidden');
                endDateInput.classList.remove('border-red-500');
                endDateInput.classList.add('border-slate-300');
            }

            // Check minimum notice days requirement
            const noticeViolation = checkMinimumNotice(startDate);
            if (noticeViolation) {
                startNoticeMessage.textContent = `Vacation requests must be submitted at least ${noticeViolation.required} working days in advance. This date is only ${noticeViolation.actual} working day${noticeViolation.actual !== 1 ? 's' : ''} away (${noticeViolation.shortfall} day${noticeViolation.shortfall !== 1 ? 's' : ''} short). Please select a later start date. Contact your direct supervisor to discuss your leave needs and availability.`;
                startNoticeWarning.classList.remove('hidden');
                startDateInput.classList.add('border-orange-500');
                startDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                startNoticeWarning.classList.add('hidden');
                if (!hasError) {
                    startDateInput.classList.remove('border-orange-500');
                }
            }

            // Check for blackout periods
            const startBlackout = checkDateAgainstBlackouts(startDate);
            if (startBlackout) {
                const startFormatted = startBlackout.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endFormatted = startBlackout.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                startBlackoutMessage.textContent = `This date falls within the "${startBlackout.name}" blackout period (${startFormatted} - ${endFormatted}). ${startBlackout.description || ''}`;
                startBlackoutWarning.classList.remove('hidden');
                startDateInput.classList.add('border-red-500');
                startDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                startBlackoutWarning.classList.add('hidden');
            }

            const endBlackout = checkDateAgainstBlackouts(endDate);
            if (endBlackout) {
                const startFormatted = endBlackout.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endFormatted = endBlackout.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                endBlackoutMessage.textContent = `This date falls within the "${endBlackout.name}" blackout period (${startFormatted} - ${endFormatted}). ${endBlackout.description || ''}`;
                endBlackoutWarning.classList.remove('hidden');
                endDateInput.classList.add('border-red-500');
                endDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                endBlackoutWarning.classList.add('hidden');
            }

            // If there are past date or blackout period errors, don't proceed with other validations
            if (hasError) {
                startWarning.classList.add('hidden');
                endWarning.classList.add('hidden');
                summaryDiv.classList.add('hidden');
                returnDateContainer.classList.add('hidden');
                return;
            }

            // Check if start date is weekend
            if (isWeekend(startDate)) {
                startWarning.classList.remove('hidden');
                startWeekendDay.textContent = getDayName(startDate);
            } else {
                startWarning.classList.add('hidden');
            }

            // Check if end date is weekend
            if (isWeekend(endDate)) {
                endWarning.classList.remove('hidden');
                endWeekendDay.textContent = getDayName(endDate);
            } else {
                endWarning.classList.add('hidden');
            }

            // Calculate working days
            if (endDate >= startDate) {
                const { workingDays, weekendDays, blackoutDays } = calculateWorkingDays(startDate, endDate);
                const returnDate = getReturnToWorkDate(endDate);

                // Update summary display
                summaryDiv.classList.remove('hidden');
                document.getElementById('workingDaysCount').textContent = workingDays;
                document.getElementById('weekendDaysCount').textContent = weekendDays;
                
                // Show/hide blackout days section based on whether there are any blackout days
                const blackoutDaysSection = document.getElementById('blackoutDaysSection');
                if (blackoutDays > 0) {
                    document.getElementById('blackoutDaysCount').textContent = blackoutDays;
                    blackoutDaysSection.classList.remove('hidden');
                } else {
                    blackoutDaysSection.classList.add('hidden');
                }
                
                document.getElementById('returnToWorkDate').textContent = returnDate.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });

                // Auto-fill return to work date input field
                const returnDateString = returnDate.toISOString().split('T')[0]; // Format as YYYY-MM-DD
                returnDateInput.value = returnDateString;
                returnDateContainer.classList.remove('hidden');

                // Check for gap days when return date is auto-filled
                checkReturnDateGap();
            } else {
                summaryDiv.classList.add('hidden');
                returnDateContainer.classList.add('hidden');
            }
        }

        function checkReturnDateGap() {
            const endDateInput = document.getElementById('endDate');
            const returnDateInput = document.getElementById('returnDate');
            const gapWarning = document.getElementById('returnDateGapWarning');
            const gapDaysCount = document.getElementById('gapDaysCount');

            if (!endDateInput.value || !returnDateInput.value) {
                gapWarning.classList.add('hidden');
                return;
            }

            const endDate = parseLocalDate(endDateInput.value);
            const returnDate = parseLocalDate(returnDateInput.value);
            const expectedReturnDate = getReturnToWorkDate(endDate);

            // Only show warning if return date is AFTER the expected return date
            if (returnDate > expectedReturnDate) {
                // Calculate working days between expected return and actual return date
                const gapStart = new Date(expectedReturnDate.getFullYear(), expectedReturnDate.getMonth(), expectedReturnDate.getDate());
                const gapEnd = new Date(returnDate.getFullYear(), returnDate.getMonth(), returnDate.getDate());
                gapEnd.setDate(gapEnd.getDate() - 1); // Don't include the actual return date

                const { workingDays } = calculateWorkingDays(gapStart, gapEnd);

                if (workingDays > 0) {
                    gapDaysCount.textContent = workingDays;
                    gapWarning.classList.remove('hidden');
                } else {
                    gapWarning.classList.add('hidden');
                }
            } else {
                gapWarning.classList.add('hidden');
            }
        }

        // Handle Create Request Form Submission
        async function handleCreateRequestSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const employeeId = parseInt(form.getAttribute('data-employee-id'));
            
            // Get button elements
            const submitBtn = document.getElementById('submitRequestBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            // Set loading state
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
            submitBtnText.textContent = 'Submitting...';
            submitSpinner.classList.remove('hidden');
            
            try {
                const startDateValue = document.getElementById('startDate').value;
                const endDateValue = document.getElementById('endDate').value;
                
                // Calculate working days (excluding weekends and blackout periods)
                const durationData = calculateWorkingDays(parseLocalDate(startDateValue), parseLocalDate(endDateValue));
                const calculatedDays = durationData.workingDays;
                
                console.log('Duration calculation:', {
                    start: startDateValue,
                    end: endDateValue,
                    workingDays: calculatedDays,
                    weekendDays: durationData.weekendDays,
                    blackoutDays: durationData.blackoutDays
                });
                
                // Ensure we have at least 1 day
                const finalDays = calculatedDays > 0 ? calculatedDays : 1;
                
                const formData = {
                    employee_id: employeeId,
                    leave_type: document.getElementById('leaveType').value,
                    start_date: startDateValue,
                    end_date: endDateValue,
                    duration_days: finalDays,
                    return_to_work: document.getElementById('returnDate').value || null,
                    reason: document.getElementById('reason').value,
                    coverage_plan: document.getElementById('coveragePlan').value || null,
                    emergency_email: document.getElementById('emergencyEmail').value || null,
                    emergency_phone: document.getElementById('emergencyPhone').value || null
                };
                
                console.log('Submitting vacation request:', formData);
                
                // Check for blackout period violations before submitting
                const startDate = parseLocalDate(formData.start_date);
                const endDate = parseLocalDate(formData.end_date);
                
                // Check minimum notice requirement
                const noticeViolation = checkMinimumNotice(startDate);
                if (noticeViolation) {
                    showToast(`Cannot submit request: Vacation requests must be submitted at least ${noticeViolation.required} working days in advance. Please select a later start date.`, 'error');
                    return;
                }
                
                const startBlackout = checkDateAgainstBlackouts(startDate);
                const endBlackout = checkDateAgainstBlackouts(endDate);
                
                if (startBlackout || endBlackout) {
                    const blackoutPeriod = startBlackout || endBlackout;
                    showToast(`Cannot submit request: Selected dates fall within the "${blackoutPeriod.name}" blackout period. Please choose different dates or contact your supervisor if you believe this is a mistake.`, 'error');
                    return;
                }
                
                // Validate dates
                if (new Date(formData.start_date) > new Date(formData.end_date)) {
                    showToast('End date must be after start date', 'error');
                    return;
                }

                // Check for past dates
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startDateObj = new Date(formData.start_date);
                startDateObj.setHours(0, 0, 0, 0);
                const endDateObj = new Date(formData.end_date);
                endDateObj.setHours(0, 0, 0, 0);

                if (startDateObj < today) {
                    showToast('Cannot submit: Start date cannot be in the past', 'error');
                    return;
                }

                if (endDateObj < today) {
                    showToast('Cannot submit: End date cannot be in the past', 'error');
                    return;
                }

                // Check for weekend warnings
                const startWarning = document.getElementById('startDateWeekendWarning');
                const endWarning = document.getElementById('endDateWeekendWarning');
                
                if (!startWarning.classList.contains('hidden') || !endWarning.classList.contains('hidden')) {
                    showToast('Cannot submit: Weekend dates are not allowed. Please select working days (Monday-Friday) only.', 'error');
                    return;
                }
                
                const response = await fetch('/api/vacation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Vacation request submitted successfully!', 'success');
                    resetCreateForm();
                    // Navigate back to overview and reload data
                    setTimeout(() => {
                        showSection('overview', null);
                        loadMyVacationStats();
                        loadMyUpcomingVacations();
                    }, 1500);
                } else {
                    console.error('Server error:', result);
                    showToast(result.error || result.message || 'Failed to submit request', 'error');
                }
            } catch (error) {
                console.error('Error submitting vacation request:', error);
                showToast('Failed to submit request', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                submitBtnText.textContent = 'Submit Request';
                submitSpinner.classList.add('hidden');
            }
        }

        // Reset Create Request Form
        function resetCreateForm() {
            const form = document.getElementById('createRequestForm');
            if (form) {
                form.reset();
            }
            // Hide all warnings and summary
            document.getElementById('startDateWeekendWarning')?.classList.add('hidden');
            document.getElementById('endDateWeekendWarning')?.classList.add('hidden');
            document.getElementById('vacationDaysSummary')?.classList.add('hidden');
            document.getElementById('returnToWorkContainer')?.classList.add('hidden');
            document.getElementById('returnDateGapWarning')?.classList.add('hidden');
        }

        // Load sidebar stats when Create section is shown
        async function loadCreateSectionStats() {
            try {
                const response = await fetch('/api/vacation/my-stats');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.stats) {
                        const stats = data.stats;
                        document.getElementById('sidebarPendingCount').textContent = stats.pending || 0;
                        document.getElementById('sidebarApprovedCount').textContent = stats.approved_count || 0;
                        document.getElementById('sidebarDaysUsed').textContent = stats.days_used || 0;
                    }
                }
            } catch (error) {
                console.error('Error loading sidebar stats:', error);
            }
            
            // Load upcoming leaves preview
            try {
                const response = await fetch('/api/vacation/my-upcoming');
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('sidebarUpcomingLeaves');
                    if (data.vacations && data.vacations.length === 0) {
                        container.innerHTML = '<p class="text-sm text-slate-500">No upcoming leaves</p>';
                    } else if (data.vacations && data.vacations.length > 0) {
                        container.innerHTML = data.vacations.slice(0, 3).map(v => `
                            <div class="text-sm border-l-2 border-green-500 pl-3 py-1">
                                <div class="font-medium text-slate-900 capitalize">${v.leave_type}</div>
                                <div class="text-slate-600">${formatDateRange(v.start_date, v.end_date)}</div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading upcoming leaves:', error);
                document.getElementById('sidebarUpcomingLeaves').innerHTML = '<p class="text-sm text-slate-500">No upcoming leaves</p>';
            }
        }

        // User Dropdown Toggle
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenuButton = document.getElementById('userMenuButton');
            const dropdown = document.getElementById('userDropdownMenu');
            
            if (userMenuButton && dropdown && !userMenuButton.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Profile Modal Functions
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            const dropdown = document.getElementById('userDropdownMenu');
            
            // Close dropdown
            dropdown.classList.add('hidden');
            
            // Open modal
            modal.classList.remove('hidden');
            
            // Reset form
            document.getElementById('changePasswordForm').reset();
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordSuccess').classList.add('hidden');
            
            // Load profile data
            loadProfileData();
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('hidden');
        }

        // Load Profile Data
        async function loadProfileData() {
            const detailsContainer = document.getElementById('employeeDetails');
            
            try {
                const response = await fetch('/api/my-profile');
                const data = await response.json();
                
                if (data.success && data.profile) {
                    const profile = data.profile;
                    
                    // Build employee details HTML
                    let detailsHTML = '';
                    
                    // Personal Information
                    if (profile.phonenumber) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Phone Number</div>
                                <div class="text-sm font-medium text-slate-900">${profile.phonenumber}</div>
                            </div>
                        `;
                    }
                    
                    // Employment Details
                    if (profile.department) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Department</div>
                                <div class="text-sm font-medium text-slate-900">${profile.department}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.shift) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Shift</div>
                                <div class="text-sm font-medium text-slate-900">${profile.shift}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.workline) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Work Line</div>
                                <div class="text-sm font-medium text-slate-900">${profile.workline}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.workarea) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Work Area</div>
                                <div class="text-sm font-medium text-slate-900">${profile.workarea}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.employee_role) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Position</div>
                                <div class="text-sm font-medium text-slate-900">${profile.employee_role}</div>
                            </div>
                        `;
                    }
                    
                    // Management
                    if (profile.supervisor) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Supervisor</div>
                                <div class="text-sm font-medium text-slate-900">${profile.supervisor}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.manager) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Manager</div>
                                <div class="text-sm font-medium text-slate-900">${profile.manager}</div>
                            </div>
                        `;
                    }
                    
                    // Update the container
                    detailsContainer.innerHTML = detailsHTML || '<p class="text-sm text-slate-500 col-span-2 text-center py-4">No additional employee information available</p>';
                } else {
                    detailsContainer.innerHTML = '<p class="text-sm text-red-500 col-span-2 text-center py-4">Error loading profile information</p>';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                detailsContainer.innerHTML = '<p class="text-sm text-red-500 col-span-2 text-center py-4">Error loading profile information</p>';
            }
        }

        // Close modal when clicking outside
        document.getElementById('profileModal')?.addEventListener('click', function(event) {
            if (event.target === this) {
                closeProfileModal();
            }
        });

        // Handle Password Change
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const errorDiv = document.getElementById('passwordError');
            const errorMessage = document.getElementById('passwordErrorMessage');
            const successDiv = document.getElementById('passwordSuccess');
            const submitBtn = document.getElementById('changePasswordBtn');
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'New passwords do not match.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 8) {
                errorMessage.textContent = 'Password must be at least 8 characters long.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Validate new password is different from current
            if (currentPassword === newPassword) {
                errorMessage.textContent = 'New password must be different from current password.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.textContent = 'Changing Password...';
                
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    successDiv.classList.remove('hidden');
                    
                    // Reset form
                    document.getElementById('changePasswordForm').reset();
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeProfileModal();
                        showToast('Password changed successfully!', 'success');
                    }, 2000);
                } else {
                    errorMessage.textContent = data.message || 'Failed to change password. Please try again.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                errorMessage.textContent = 'An error occurred. Please try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Change Password';
            }
        }

        // Handle Logout
        async function handleLogout() {
            // Show logout modal
            const logoutModal = document.getElementById('logoutModal');
            logoutModal.classList.add('active');
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    // Wait a bit for user to see the message, then redirect
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    logoutModal.classList.remove('active');
                    showToast('Error logging out. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                logoutModal.classList.remove('active');
                showToast('Error logging out. Please try again.', 'error');
            }
        }
    </script>

    <!-- Logout Modal -->
    <div id="logoutModal" class="logout-modal-overlay">
        <div class="logout-modal">
            <h2>Logging You Out</h2>
            <p>Bye! See you again soon.</p>
            <div class="logout-spinner"></div>
            <div class="logout-dots">
                <div class="logout-dot"></div>
                <div class="logout-dot"></div>
                <div class="logout-dot"></div>
            </div>
        </div>
    </div>    <script src="{{ url_for('static', filename='js/professional-translate.js') }}"></script>    <script src="{{ url_for('static', filename='js/auto-translate.js') }}"></script>


</body>
</html>
