<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Overview</title>
  <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 text-gray-900 min-h-screen lg:h-screen lg:overflow-hidden">
  {% extends "dashboard.html" %}
  {% block content %}

  <!-- Main Container -->
  <div class="min-h-full lg:h-full flex flex-col">

    <!-- Enhanced Header Section -->
    <div class="bg-white/80 backdrop-blur-sm shadow-lg border-b border-gray-200/50 px-6 py-6">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div class="flex items-center space-x-4">
          <div
            class="p-4 bg-gradient-to-r from-emerald-500 via-blue-500 to-purple-600 rounded-2xl shadow-lg transform rotate-3 hover:rotate-0 transition-transform duration-300">
            <i data-lucide="package-search" class="w-8 h-8 text-white"></i>
          </div>
          <div>
            <h1
              class="text-3xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-purple-800 bg-clip-text text-transparent">
              Inventory Usage Tracking
            </h1>
            <p class="text-gray-600 mt-1 font-medium">Monitor and analyze inventory transactions across all operations
            </p>
          </div>
        </div>

        <!-- Enhanced Action Buttons -->
        <div class="flex items-center space-x-3">
          <button id="advancedFiltersBtn"
            class="group inline-flex items-center px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
            <i data-lucide="filter" class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"></i>
            Advanced Filters
          </button>
          <button id="mobileFilterToggle"
            class="group inline-flex items-center px-4 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
            <i data-lucide="sliders-horizontal" class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"></i>
            Quick Filters
          </button>
          <button id="exportInventoryBtn"
            class="group inline-flex items-center px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
            <i data-lucide="download" class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"></i>
            Export Data
          </button>
          <button id="refreshInventoryBtn"
            class="group inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
            <i data-lucide="refresh-cw"
              class="w-5 h-5 mr-2 group-hover:rotate-180 transition-transform duration-500"></i>
            Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="flex-1 lg:overflow-hidden">
      <div class="min-h-full lg:h-full flex flex-col">

        <!-- Enhanced Sidebar Filters -->
        <div id="filterSidebar"
          class="w-80 bg-white/90 backdrop-blur-sm shadow-xl border-l border-gray-200/50 flex-col hidden fixed inset-y-0 right-0 z-50 transform translate-x-full transition-transform duration-300">

          <!-- Filter Header -->
          <div class="p-6 border-b border-gray-200/50 bg-gradient-to-r from-gray-50 to-blue-50">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg">
                  <i data-lucide="filter" class="w-5 h-5 text-white"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-900">Quick Filters</h2>
              </div>
              <div class="flex items-center space-x-2">
                <button id="clearAllFiltersBtn"
                  class="text-sm text-blue-600 hover:text-blue-700 font-semibold px-3 py-1 rounded-lg hover:bg-blue-50 transition-colors">
                  Clear All
                </button>
                <button id="closeMobileFilter" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Enhanced Filter Controls -->
          <div class="flex-1 overflow-y-auto p-6 space-y-6">

            <!-- Item Selection -->
            <div class="space-y-3">
              <label class="block text-sm font-bold text-gray-800">
                <div class="flex items-center space-x-2">
                  <div class="p-1 bg-gradient-to-r from-emerald-400 to-teal-500 rounded">
                    <i data-lucide="package" class="w-4 h-4 text-white"></i>
                  </div>
                  <span>Inventory Item</span>
                </div>
              </label>
              <select id="sheetSelect" name="sheet"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm hover:shadow-md transition-all duration-200">
                <option value="">Select an item...</option>
                {% for sheet in sheet_options %}
                <option value="{{ sheet }}">{{ sheet }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Transaction Type -->
            <div class="space-y-3">
              <label class="block text-sm font-bold text-gray-800">
                <div class="flex items-center space-x-2">
                  <div class="p-1 bg-gradient-to-r from-orange-400 to-red-500 rounded">
                    <i data-lucide="activity" class="w-4 h-4 text-white"></i>
                  </div>
                  <span>Transaction Type</span>
                </div>
              </label>
              <select id="filterOption" name="filterOption"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm hover:shadow-md transition-all duration-200">
                <option value="all">All Transactions</option>
                <option value="received">Raw Material Received</option>
                <option value="returned">Raw Material Returned</option>
                <option value="first shift">First Shift Usage</option>
                <option value="second shift">Second Shift Usage</option>
              </select>
            </div>

            <!-- Day Filter -->
            <div class="space-y-3">
              <label class="block text-sm font-bold text-gray-800">
                <div class="flex items-center space-x-2">
                  <div class="p-1 bg-gradient-to-r from-purple-400 to-pink-500 rounded">
                    <i data-lucide="calendar-days" class="w-4 h-4 text-white"></i>
                  </div>
                  <span>Day of Week</span>
                </div>
              </label>
              <select id="dayFilterSelect"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm hover:shadow-md transition-all duration-200">
                <option value="">Any Day</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
              </select>
            </div>

            <!-- Date Range -->
            <div class="space-y-3">
              <label class="block text-sm font-bold text-gray-800">
                <div class="flex items-center space-x-2">
                  <div class="p-1 bg-gradient-to-r from-indigo-400 to-blue-500 rounded">
                    <i data-lucide="calendar-range" class="w-4 h-4 text-white"></i>
                  </div>
                  <span>Date Range</span>
                </div>
              </label>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-2">From</label>
                  <input type="date" id="dateFromSearch"
                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm hover:shadow-md transition-all duration-200">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-2">To</label>
                  <input type="date" id="dateToSearch"
                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm hover:shadow-md transition-all duration-200">
                </div>
              </div>
            </div>

            <!-- Quick Search -->
            <div class="space-y-3">
              <label class="block text-sm font-bold text-gray-800">
                <div class="flex items-center space-x-2">
                  <div class="p-1 bg-gradient-to-r from-green-400 to-emerald-500 rounded">
                    <i data-lucide="search" class="w-4 h-4 text-white"></i>
                  </div>
                  <span>Quick Search</span>
                </div>
              </label>
              <input type="text" id="quickSearchInput" placeholder="Search lot number, user..."
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm hover:shadow-md transition-all duration-200 placeholder-gray-400">
            </div>

          </div>

          <!-- Enhanced Filter Summary -->
          <div id="filterSummary" class="p-6 border-t border-gray-200 bg-gradient-to-r from-gray-50 to-blue-50">
            <div class="text-sm text-gray-700">
              <span class="font-bold text-gray-800">Active Filters:</span>
              <div id="activeFiltersList" class="mt-3 flex flex-wrap gap-2">
                <!-- Active filters will appear here -->
              </div>
            </div>
          </div>

        </div>

        <!-- Enhanced Main Content Area -->
        <div class="w-full flex flex-col lg:overflow-hidden">

          <!-- Enhanced Summary Cards -->
          <div class="p-6 bg-white/80 backdrop-blur-sm border-b border-gray-200/50">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

              <!-- Total Transactions -->
              <div
                class="group relative bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent rounded-2xl"></div>
                <div class="relative flex items-center justify-between">
                  <div>
                    <p class="text-blue-100 text-sm font-semibold uppercase tracking-wide">Total Transactions</p>
                    <p id="totalTransactionsValue" class="text-4xl font-bold mt-2">-</p>
                  </div>
                  <div class="bg-white/20 rounded-2xl p-4 group-hover:scale-110 transition-transform duration-300">
                    <i data-lucide="clipboard-list" class="w-8 h-8"></i>
                  </div>
                </div>
              </div>

              <!-- Total Quantity -->
              <div
                class="group relative bg-gradient-to-br from-emerald-500 via-green-600 to-teal-700 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent rounded-2xl"></div>
                <div class="relative flex items-center justify-between">
                  <div>
                    <p class="text-emerald-100 text-sm font-semibold uppercase tracking-wide">Total Quantity</p>
                    <p id="totalQuantityValue" class="text-4xl font-bold mt-2">-</p>
                  </div>
                  <div class="bg-white/20 rounded-2xl p-4 group-hover:scale-110 transition-transform duration-300">
                    <i data-lucide="trending-up" class="w-8 h-8"></i>
                  </div>
                </div>
              </div>

              <!-- Average Per Day -->
              <div
                class="group relative bg-gradient-to-br from-purple-500 via-violet-600 to-purple-700 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent rounded-2xl"></div>
                <div class="relative flex items-center justify-between">
                  <div>
                    <p class="text-purple-100 text-sm font-semibold uppercase tracking-wide">Avg Per Day</p>
                    <p id="avgPerDayValue" class="text-4xl font-bold mt-2">-</p>
                  </div>
                  <div class="bg-white/20 rounded-2xl p-4 group-hover:scale-110 transition-transform duration-300">
                    <i data-lucide="bar-chart-3" class="w-8 h-8"></i>
                  </div>
                </div>
              </div>

              <!-- Most Active Shift -->
              <div
                class="group relative bg-gradient-to-br from-orange-500 via-red-500 to-pink-600 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent rounded-2xl"></div>
                <div class="relative flex items-center justify-between">
                  <div>
                    <p class="text-orange-100 text-sm font-semibold uppercase tracking-wide">Most Active Shift</p>
                    <p id="mostActiveShiftValue" class="text-2xl font-bold mt-2">-</p>
                  </div>
                  <div class="bg-white/20 rounded-2xl p-4 group-hover:scale-110 transition-transform duration-300">
                    <i data-lucide="clock" class="w-8 h-8"></i>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Advanced Filters Section -->
          <div id="advancedFiltersSection" class="hidden bg-white/90 backdrop-blur-sm border-b border-gray-200/50">
            <div class="p-6">
              <div class="mb-6">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <div class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg">
                      <i data-lucide="filter" class="w-5 h-5 text-white"></i>
                    </div>
                    <h2 class="text-lg font-bold text-gray-900">Advanced Filters</h2>
                  </div>
                  <button id="closeAdvancedFilters"
                    class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Quantity Range -->
                <div class="space-y-3">
                  <label class="block text-sm font-bold text-gray-800">
                    <div class="flex items-center space-x-2">
                      <div class="p-1 bg-gradient-to-r from-emerald-400 to-teal-500 rounded">
                        <i data-lucide="hash" class="w-4 h-4 text-white"></i>
                      </div>
                      <span>Quantity Range</span>
                    </div>
                  </label>
                  <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="quantityMin" placeholder="Min"
                      class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm hover:shadow-md transition-all duration-200">
                    <input type="number" id="quantityMax" placeholder="Max"
                      class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm hover:shadow-md transition-all duration-200">
                  </div>
                </div>

                <!-- Sort Options -->
                <div class="space-y-3">
                  <label class="block text-sm font-bold text-gray-800">
                    <div class="flex items-center space-x-2">
                      <div class="p-1 bg-gradient-to-r from-purple-400 to-pink-500 rounded">
                        <i data-lucide="arrow-up-down" class="w-4 h-4 text-white"></i>
                      </div>
                      <span>Sort By</span>
                    </div>
                  </label>
                  <select id="sortBySelect"
                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm hover:shadow-md transition-all duration-200">
                    <option value="date_desc">Date (Newest First)</option>
                    <option value="date_asc">Date (Oldest First)</option>
                    <option value="quantity_desc">Quantity (High to Low)</option>
                    <option value="quantity_asc">Quantity (Low to High)</option>
                  </select>
                </div>

                <!-- User Filter -->
                <div class="space-y-3">
                  <label class="block text-sm font-bold text-gray-800">
                    <div class="flex items-center space-x-2">
                      <div class="p-1 bg-gradient-to-r from-blue-400 to-indigo-500 rounded">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                      </div>
                      <span>User Filter</span>
                    </div>
                  </label>
                  <input type="text" id="userFilter" placeholder="Filter by user..."
                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm hover:shadow-md transition-all duration-200 placeholder-gray-400">
                </div>

                <!-- Status Filter -->
                <div class="space-y-3">
                  <label class="block text-sm font-bold text-gray-800">
                    <div class="flex items-center space-x-2">
                      <div class="p-1 bg-gradient-to-r from-orange-400 to-red-500 rounded">
                        <i data-lucide="check-circle" class="w-4 h-4 text-white"></i>
                      </div>
                      <span>Status Filter</span>
                    </div>
                  </label>
                  <select id="statusFilter"
                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm hover:shadow-md transition-all duration-200">
                    <option value="">All Statuses</option>
                    <option value="received">Received</option>
                    <option value="returned">Returned</option>
                    <option value="used">Used</option>
                  </select>
                </div>
              </div>

              <!-- Filter Actions -->
              <div class="mt-6 flex items-center justify-between">
                <button id="clearAdvancedFilters"
                  class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 font-semibold hover:bg-gray-100 rounded-lg transition-colors">
                  Clear Advanced Filters
                </button>
                <div class="flex items-center space-x-3">
                  <button id="applyAdvancedFilters"
                    class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl font-semibold">
                    Apply Filters
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Data Table Section -->
          <div class="flex-1 lg:overflow-hidden bg-white/90 backdrop-blur-sm">

            <!-- Enhanced Table Header -->
            <div class="px-6 py-4 border-b border-gray-200/50 bg-gradient-to-r from-gray-50 via-white to-blue-50">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <div class="flex items-center space-x-3">
                    <div class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg">
                      <i data-lucide="database" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Transaction Records</h3>
                  </div>
                  <span id="recordCount"
                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full text-sm font-bold shadow-lg">
                    0 records
                  </span>
                </div>

                <div class="flex items-center space-x-3">
                  <!-- Enhanced View Toggle -->
                  <div class="flex bg-white rounded-xl border-2 border-gray-200 p-1 shadow-md">
                    <button id="tableViewBtn"
                      class="px-4 py-2 text-sm font-bold bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg transition-all duration-200 shadow-md">
                      <i data-lucide="table" class="w-4 h-4 mr-1 inline"></i>
                      Table
                    </button>
                    <button id="chartViewBtn"
                      class="px-4 py-2 text-sm font-bold text-gray-600 hover:text-gray-900 rounded-lg transition-all duration-200 hover:bg-gray-100">
                      <i data-lucide="pie-chart" class="w-4 h-4 mr-1 inline"></i>
                      Chart
                    </button>
                  </div>

                  <!-- Records per page -->
                  <select id="recordsPerPage"
                    class="px-4 py-2 border-2 border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 shadow-md hover:shadow-lg transition-all duration-200">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all">Show all</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Enhanced Table View -->
            <div id="tableView" class="flex-1 lg:overflow-auto">
              <!-- Table wrapper for horizontal scroll on mobile -->
              <div class="overflow-x-auto min-w-full">
                <table class="w-full min-w-max">
                <thead class="bg-gradient-to-r from-gray-100 via-blue-50 to-indigo-100 sticky top-0 z-10">
                  <tr>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      <div class="flex items-center space-x-2">
                        <span>Quantity</span>
                        <button class="sort-btn hover:bg-white/50 p-1 rounded transition-colors" data-column="quantity">
                          <i data-lucide="chevrons-up-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      <div class="flex items-center space-x-2">
                        <span>Lot Number</span>
                        <button class="sort-btn hover:bg-white/50 p-1 rounded transition-colors" data-column="lot">
                          <i data-lucide="chevrons-up-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      <div class="flex items-center space-x-2">
                        <span>Shift</span>
                        <button class="sort-btn hover:bg-white/50 p-1 rounded transition-colors" data-column="shift">
                          <i data-lucide="chevrons-up-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      <div class="flex items-center space-x-2">
                        <span>Day</span>
                        <button class="sort-btn hover:bg-white/50 p-1 rounded transition-colors" data-column="day">
                          <i data-lucide="chevrons-up-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      <div class="flex items-center space-x-2">
                        <span>Date</span>
                        <button class="sort-btn hover:bg-white/50 p-1 rounded transition-colors" data-column="date">
                          <i data-lucide="chevrons-up-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      Time</th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      User</th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      <div class="flex items-center space-x-2">
                        <span>Status</span>
                        <button class="sort-btn hover:bg-white/50 p-1 rounded transition-colors" data-column="status">
                          <i data-lucide="chevrons-up-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-b-2 border-gray-300">
                      Item Code</th>
                  </tr>
                </thead>
                <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-100">
                  <!-- Data will be populated here -->
                </tbody>
                </table>
              </div>
              
              <!-- Enhanced Empty State -->
              <div id="emptyState" class="hidden py-20 text-center">
                <div class="max-w-md mx-auto">
                  <div
                    class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i data-lucide="package-x" class="w-12 h-12 text-gray-500"></i>
                  </div>
                  <h3 class="text-xl font-bold text-gray-900 mb-3">No transactions found</h3>
                  <p class="text-gray-600 mb-8 leading-relaxed">Try adjusting your filters or search criteria to find
                    transactions.</p>
                  <button id="clearFiltersFromEmpty"
                    class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-semibold">
                    Clear All Filters
                  </button>
                </div>
              </div>
            </div>

            <!-- Enhanced Chart View -->
            <div id="chartView" class="hidden p-6">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-[500px]">
                <div
                  class="bg-white rounded-2xl shadow-xl border border-gray-200/50 p-6 hover:shadow-2xl transition-shadow duration-300 h-96">
                  <div class="flex items-center space-x-3 mb-6">
                    <div class="p-2 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg">
                      <i data-lucide="pie-chart" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Transaction Types</h3>
                  </div>
                  <div class="relative h-64">
                    <canvas id="transactionTypeChart" class="w-full h-full"></canvas>
                  </div>
                </div>
                <div
                  class="bg-white rounded-2xl shadow-xl border border-gray-200/50 p-6 hover:shadow-2xl transition-shadow duration-300 h-96">
                  <div class="flex items-center space-x-3 mb-6">
                    <div class="p-2 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-lg">
                      <i data-lucide="bar-chart" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Daily Activity</h3>
                  </div>
                  <div class="relative h-64">
                    <canvas id="dailyActivityChart" class="w-full h-full"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Pagination -->
            <div id="paginationContainer"
              class="border-t border-gray-200 bg-gradient-to-r from-white via-gray-50 to-blue-50 px-6 py-4">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium text-gray-700">
                  Showing <span id="showingFrom" class="font-bold text-gray-900">1</span> to <span id="showingTo"
                    class="font-bold text-gray-900">25</span> of <span id="totalRecords"
                    class="font-bold text-blue-600">0</span> results
                </div>
                <div class="flex items-center space-x-2">
                  <button id="prevPageBtn"
                    class="px-4 py-2 border-2 border-gray-300 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:shadow-md">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                  </button>
                  <div id="pageNumbers" class="flex space-x-1">
                    <!-- Page numbers will be inserted here -->
                  </div>
                  <button id="nextPageBtn"
                    class="px-4 py-2 border-2 border-gray-300 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:shadow-md">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                  </button>
                </div>
              </div>
            </div>

          </div>

        </div>

      </div>
    </div>

  </div>
  <!-- Mobile Filter Overlay -->
  <div id="filterOverlay" class="lg:hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden"></div>
  <!-- Enhanced Loading Overlay -->
  <div id="loadingOverlay"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl p-8 max-w-sm mx-4 text-center shadow-2xl border border-gray-200">
      <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-6"></div>
      <h3 class="text-lg font-bold text-gray-900 mb-3">Loading Data</h3>
      <p class="text-gray-600 leading-relaxed">Please wait while we fetch your inventory data...</p>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Global variables
    let currentData = [];
    let filteredData = [];
    let currentPage = 1;
    let recordsPerPage = 25;
    let sortColumn = 'date';
    let sortDirection = 'desc';

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", () => {
      initializeFilters();
      loadSheetDropdownOptions();
      setupEventListeners();
      fetchInitialData();
    });

    // Load sheet dropdown options
    async function loadSheetDropdownOptions() {
      const sheetDropdown = document.getElementById("sheetSelect");
      try {
        const response = await fetch("/api/inventory-sheets");
        const result = await response.json();
        sheetDropdown.innerHTML = `<option value="">Select an item...</option>`;
        result.sheets.forEach(sheet => {
          const option = document.createElement("option");
          option.value = sheet;
          option.textContent = sheet;
          sheetDropdown.appendChild(option);
        });
      } catch (error) {
        console.error("Failed to load sheet options:", error);
        showNotification("Failed to load inventory items", "error");
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Mobile filter toggle
      document.getElementById("mobileFilterToggle").addEventListener("click", toggleMobileFilter);
      document.getElementById("closeMobileFilter").addEventListener("click", closeMobileFilter);
      document.getElementById("filterOverlay").addEventListener("click", closeMobileFilter);
      // Filter controls
      document.getElementById("sheetSelect").addEventListener("change", applyFilters);
      document.getElementById("filterOption").addEventListener("change", applyFilters);
      document.getElementById("dayFilterSelect").addEventListener("change", applyFilters);
      document.getElementById("dateFromSearch").addEventListener("change", applyFilters);
      document.getElementById("dateToSearch").addEventListener("change", applyFilters);
      document.getElementById("quickSearchInput").addEventListener("input", debounce(applyFilters, 300));
      document.getElementById("quantityMin").addEventListener("input", debounce(applyFilters, 500));
      document.getElementById("quantityMax").addEventListener("input", debounce(applyFilters, 500));
      document.getElementById("sortBySelect").addEventListener("change", applySorting);
      document.getElementById("userFilter").addEventListener("input", debounce(applyFilters, 300));
      document.getElementById("statusFilter").addEventListener("change", applyFilters);

      // Advanced Filters controls
      document.getElementById("advancedFiltersBtn").addEventListener("click", toggleAdvancedFiltersSection);
      document.getElementById("closeAdvancedFilters").addEventListener("click", hideAdvancedFiltersSection);
      document.getElementById("clearAdvancedFilters").addEventListener("click", clearAdvancedFiltersOnly);
      document.getElementById("applyAdvancedFilters").addEventListener("click", applyFilters);

      // View toggles
      document.getElementById("tableViewBtn").addEventListener("click", () => switchView("table"));
      document.getElementById("chartViewBtn").addEventListener("click", () => switchView("chart"));

      // Pagination
      document.getElementById("recordsPerPage").addEventListener("change", changeRecordsPerPage);
      document.getElementById("prevPageBtn").addEventListener("click", () => changePage(currentPage - 1));
      document.getElementById("nextPageBtn").addEventListener("click", () => changePage(currentPage + 1));

      // Action buttons
      document.getElementById("clearAllFiltersBtn").addEventListener("click", clearAllFilters);
      document.getElementById("clearFiltersFromEmpty").addEventListener("click", clearAllFilters);
      document.getElementById("refreshInventoryBtn").addEventListener("click", refreshData);
      document.getElementById("exportInventoryBtn").addEventListener("click", exportData);

      // Sort buttons
      document.querySelectorAll(".sort-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const column = e.currentTarget.dataset.column;
          handleSort(column);
        });
      });
    }

    // Fetch initial data
    async function fetchInitialData() {
      // Auto-select first item if available
      const sheetSelect = document.getElementById("sheetSelect");
      if (sheetSelect.options.length > 1) {
        sheetSelect.selectedIndex = 1;
        await fetchData();
      }
    }

    // Main data fetching function
    async function fetchData() {
      const sheet = document.getElementById("sheetSelect").value;
      const day = document.getElementById("dayFilterSelect").value;
      const status = document.getElementById("filterOption").value;
      const dateFrom = document.getElementById("dateFromSearch").value;
      const dateTo = document.getElementById("dateToSearch").value;

      if (!sheet) {
        updateTable([]);
        return;
      }

      showLoading(true);

      const params = new URLSearchParams();
      params.append("sheet", sheet);
      if (day) params.append("day", day);
      if (status && status !== "all") params.append("status", status);
      if (dateFrom) params.append("date", dateFrom);

      try {
        const response = await fetch(`/api/inventory-overview-data?${params.toString()}`);
        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        currentData = result.rows || [];
        applyClientSideFilters();
        updateSummaryCards();

        showNotification("Data loaded successfully", "success");

      } catch (err) {
        console.error("❌ Error fetching inventory data:", err);
        showNotification("Failed to load inventory data", "error");
        updateTable([]);
      } finally {
        showLoading(false);
      }
    }

    // Apply client-side filters
    function applyClientSideFilters() {
      let filtered = [...currentData];

      // Quick search filter
      const searchTerm = document.getElementById("quickSearchInput").value.toLowerCase();
      if (searchTerm) {
        filtered = filtered.filter(row =>
          Object.values(row).some(val =>
            String(val).toLowerCase().includes(searchTerm)
          )
        );
      }

      // Date range filter
      const dateFrom = document.getElementById("dateFromSearch").value;
      const dateTo = document.getElementById("dateToSearch").value;

      if (dateFrom || dateTo) {
        filtered = filtered.filter(row => {
          const rowDate = row.date;
          if (!rowDate) return false;

          if (dateFrom && rowDate < dateFrom) return false;
          if (dateTo && rowDate > dateTo) return false;
          return true;
        });
      }

      // Quantity range filter
      const quantityMin = parseFloat(document.getElementById("quantityMin").value);
      const quantityMax = parseFloat(document.getElementById("quantityMax").value);

      if (!isNaN(quantityMin) || !isNaN(quantityMax)) {
        filtered = filtered.filter(row => {
          const quantity = parseFloat(row.quantity);
          if (isNaN(quantity)) return false;

          if (!isNaN(quantityMin) && quantity < quantityMin) return false;
          if (!isNaN(quantityMax) && quantity > quantityMax) return false;
          return true;
        });
      }

      // User filter
      const userFilter = document.getElementById("userFilter").value.toLowerCase();
      if (userFilter) {
        filtered = filtered.filter(row =>
          String(row.user || '').toLowerCase().includes(userFilter)
        );
      }

      // Status filter
      const statusFilter = document.getElementById("statusFilter").value.toLowerCase();
      if (statusFilter) {
        filtered = filtered.filter(row =>
          String(row.status || '').toLowerCase() === statusFilter
        );
      }

      filteredData = filtered;
      applySortingToData();
      updateTable(filteredData);
      updateFilterSummary();
    }

    // Apply filters (main filter function)
    function applyFilters() {
      fetchData();
    }

    // Apply sorting to current data
    function applySortingToData() {
      const sortSelect = document.getElementById("sortBySelect").value;
      const [column, direction] = sortSelect.split('_');

      filteredData.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];

        // Handle different data types
        if (column === 'quantity') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else if (column === 'date') {
          aVal = new Date(aVal);
          bVal = new Date(bVal);
        } else {
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }

        if (direction === 'desc') {
          return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        } else {
          return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        }
      });
    }

    // Handle column sorting
    function handleSort(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }

      // Update sort select to match
      document.getElementById("sortBySelect").value = `${column}_${sortDirection}`;
      applySortingToData();
      updateTable(filteredData);
      updateSortIcons();
    }

    // Update sort icons
    function updateSortIcons() {
      document.querySelectorAll('.sort-btn').forEach(btn => {
        const icon = btn.querySelector('i');
        const column = btn.dataset.column;

        if (column === sortColumn) {
          icon.setAttribute('data-lucide', sortDirection === 'asc' ? 'chevron-up' : 'chevron-down');
        } else {
          icon.setAttribute('data-lucide', 'chevrons-up-down');
        }
      });
      lucide.createIcons();
    }

    // Apply sorting from dropdown
    function applySorting() {
      applySortingToData();
      updateTable(filteredData);
    }

    // Update table with data
    function updateTable(data) {
      const tableBody = document.getElementById("inventoryTableBody");
      const emptyState = document.getElementById("emptyState");
      const recordCount = document.getElementById("recordCount");

      if (!data || data.length === 0) {
        tableBody.innerHTML = "";
        emptyState.classList.remove("hidden");
        recordCount.textContent = "0 records";
        updatePagination(0);
        return;
      }

      emptyState.classList.add("hidden");
      recordCount.textContent = `${data.length} record${data.length !== 1 ? 's' : ''}`;

      // Apply pagination
      const startIndex = (currentPage - 1) * recordsPerPage;
      const endIndex = recordsPerPage === 'all' ? data.length : startIndex + recordsPerPage;
      const paginatedData = recordsPerPage === 'all' ? data : data.slice(startIndex, endIndex);

      tableBody.innerHTML = "";

      paginatedData.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200";

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <span class="text-sm font-bold text-gray-900 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">${formatNumber(row.quantity)}</span>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="text-sm font-medium text-gray-900">${row.lot || '-'}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-3 py-1 text-xs font-bold rounded-full ${getShiftBadgeClass(row.shift)}">
              ${row.shift || '-'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="text-sm font-medium text-gray-900">${row.day || '-'}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="text-sm font-medium text-gray-900">${formatDate(row.date)}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="text-sm text-gray-600">${row.time || '-'}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-600 rounded-full flex items-center justify-center mr-3 shadow-md">
                <span class="text-xs font-bold text-white">${getInitials(row.user)}</span>
              </div>
              <span class="text-sm font-medium text-gray-900">${row.user || 'Unknown'}</span>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-3 py-1 text-xs font-bold rounded-full ${getStatusBadgeClass(row.status)}">
              ${row.status || '-'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="text-sm font-mono font-bold text-gray-900 bg-gray-100 px-2 py-1 rounded">${row.item || '-'}</span>
          </td>
        `;

        tableBody.appendChild(tr);
      });

      updatePagination(data.length);
    }

    // Update summary cards
    function updateSummaryCards() {
      if (!filteredData || filteredData.length === 0) {
        document.getElementById("totalTransactionsValue").textContent = "0";
        document.getElementById("totalQuantityValue").textContent = "0";
        document.getElementById("avgPerDayValue").textContent = "0";
        document.getElementById("mostActiveShiftValue").textContent = "-";
        return;
      }

      // Total transactions
      document.getElementById("totalTransactionsValue").textContent = filteredData.length.toLocaleString();

      // Total quantity
      const totalQuantity = filteredData.reduce((sum, row) => sum + (parseFloat(row.quantity) || 0), 0);
      document.getElementById("totalQuantityValue").textContent = formatNumber(totalQuantity);

      // Average per day
      const uniqueDates = [...new Set(filteredData.map(row => row.date).filter(Boolean))];
      const avgPerDay = uniqueDates.length > 0 ? totalQuantity / uniqueDates.length : 0;
      document.getElementById("avgPerDayValue").textContent = formatNumber(avgPerDay);

      // Most active shift
      const shiftCounts = {};
      filteredData.forEach(row => {
        if (row.shift) {
          shiftCounts[row.shift] = (shiftCounts[row.shift] || 0) + 1;
        }
      });

      const mostActiveShift = Object.keys(shiftCounts).reduce((a, b) =>
        shiftCounts[a] > shiftCounts[b] ? a : b, Object.keys(shiftCounts)[0] || '-');

      document.getElementById("mostActiveShiftValue").textContent = mostActiveShift;
    }

    // Update pagination
    function updatePagination(totalRecords) {
      const paginationContainer = document.getElementById("paginationContainer");

      if (recordsPerPage === 'all' || totalRecords <= recordsPerPage) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';

      const totalPages = Math.ceil(totalRecords / recordsPerPage);
      const startRecord = (currentPage - 1) * recordsPerPage + 1;
      const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);

      document.getElementById("showingFrom").textContent = startRecord;
      document.getElementById("showingTo").textContent = endRecord;
      document.getElementById("totalRecords").textContent = totalRecords;

      // Update page buttons
      document.getElementById("prevPageBtn").disabled = currentPage === 1;
      document.getElementById("nextPageBtn").disabled = currentPage === totalPages;

      // Generate page numbers
      const pageNumbers = document.getElementById("pageNumbers");
      pageNumbers.innerHTML = "";

      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement("button");
        pageBtn.className = `px-4 py-2 border-2 rounded-xl text-sm font-bold transition-all duration-200 ${i === currentPage
          ? 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white border-blue-600 shadow-lg'
          : 'text-gray-700 border-gray-300 hover:bg-gray-50 hover:shadow-md'
          }`;
        pageBtn.textContent = i;
        pageBtn.addEventListener("click", () => changePage(i));
        pageNumbers.appendChild(pageBtn);
      }
    }

    // Change page
    function changePage(page) {
      const totalPages = Math.ceil(filteredData.length / recordsPerPage);
      if (page < 1 || page > totalPages) return;

      currentPage = page;
      updateTable(filteredData);
    }

    // Change records per page
    function changeRecordsPerPage() {
      const value = document.getElementById("recordsPerPage").value;
      recordsPerPage = value === 'all' ? 'all' : parseInt(value);
      currentPage = 1;
      updateTable(filteredData);
    }

    // Switch between table and chart view
    function switchView(view) {
      const tableView = document.getElementById("tableView");
      const chartView = document.getElementById("chartView");
      const tableBtn = document.getElementById("tableViewBtn");
      const chartBtn = document.getElementById("chartViewBtn");

      if (view === "table") {
        tableView.classList.remove("hidden");
        chartView.classList.add("hidden");
        tableBtn.className = "px-4 py-2 text-sm font-bold bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg transition-all duration-200 shadow-md";
        chartBtn.className = "px-4 py-2 text-sm font-bold text-gray-600 hover:text-gray-900 rounded-lg transition-all duration-200 hover:bg-gray-100";
      } else {
        tableView.classList.add("hidden");
        chartView.classList.remove("hidden");
        tableBtn.className = "px-4 py-2 text-sm font-bold text-gray-600 hover:text-gray-900 rounded-lg transition-all duration-200 hover:bg-gray-100";
        chartBtn.className = "px-4 py-2 text-sm font-bold bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg transition-all duration-200 shadow-md";

        // Update charts when switching to chart view
        updateCharts();
      }
    }

    // Update charts
    let chartUpdateTimeout;
    function updateCharts() {
      // Debounce chart updates to prevent infinite loops
      if (chartUpdateTimeout) {
        clearTimeout(chartUpdateTimeout);
      }
      
      chartUpdateTimeout = setTimeout(() => {
        updateTransactionTypeChart();
        updateDailyActivityChart();
      }, 100);
    }

    // Update transaction type chart
    function updateTransactionTypeChart() {
      const chartView = document.getElementById("chartView");
      const ctx = document.getElementById("transactionTypeChart");
      
      // Only update if chart view is visible and context is available
      if (!chartView || chartView.classList.contains('hidden') || !ctx) {
        return;
      }
      
      const context = ctx.getContext("2d");

      // Destroy existing chart
      if (window.transactionTypeChartInstance) {
        window.transactionTypeChartInstance.destroy();
      }

      // Count transaction types
      const statusCounts = {};
      filteredData.forEach(row => {
        const status = row.status || 'Unknown';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
      });

      const labels = Object.keys(statusCounts);
      const data = Object.values(statusCounts);
      const colors = [
        'rgba(59, 130, 246, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(239, 68, 68, 0.8)',
        'rgba(139, 92, 246, 0.8)'
      ];

      window.transactionTypeChartInstance = new Chart(context, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 3,
            borderColor: '#ffffff',
            hoverBorderWidth: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 0 // Disable animations to prevent layout thrashing
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                  weight: 'bold'
                }
              }
            }
          }
        }
      });
    }

    // Update daily activity chart
    function updateDailyActivityChart() {
      const chartView = document.getElementById("chartView");
      const ctx = document.getElementById("dailyActivityChart");
      
      // Only update if chart view is visible and context is available
      if (!chartView || chartView.classList.contains('hidden') || !ctx) {
        return;
      }
      
      const context = ctx.getContext("2d");

      // Destroy existing chart
      if (window.dailyActivityChartInstance) {
        window.dailyActivityChartInstance.destroy();
      }

      // Count by day
      const dayCounts = {};
      const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

      // Initialize all days with 0
      dayOrder.forEach(day => dayCounts[day] = 0);

      filteredData.forEach(row => {
        if (row.day && dayOrder.includes(row.day)) {
          dayCounts[row.day]++;
        }
      });

      const labels = dayOrder;
      const data = dayOrder.map(day => dayCounts[day]);

      window.dailyActivityChartInstance = new Chart(context, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Transactions',
            data: data,
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 0 // Disable animations to prevent layout thrashing
          },
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  weight: 'bold'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              ticks: {
                font: {
                  weight: 'bold'
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Update filter summary
    function updateFilterSummary() {
      const activeFiltersList = document.getElementById("activeFiltersList");
      const filters = [];

      // Check each filter
      const sheet = document.getElementById("sheetSelect").value;
      const filterOption = document.getElementById("filterOption").value;
      const day = document.getElementById("dayFilterSelect").value;
      const search = document.getElementById("quickSearchInput").value;
      const dateFrom = document.getElementById("dateFromSearch").value;
      const dateTo = document.getElementById("dateToSearch").value;
      const qtyMin = document.getElementById("quantityMin").value;
      const qtyMax = document.getElementById("quantityMax").value;
      const userFilter = document.getElementById("userFilter").value;
      const statusFilter = document.getElementById("statusFilter").value;

      if (sheet) filters.push({ label: `Item: ${sheet}`, type: 'sheet' });
      if (filterOption && filterOption !== 'all') filters.push({ label: `Type: ${filterOption}`, type: 'type' });
      if (day) filters.push({ label: `Day: ${day}`, type: 'day' });
      if (search) filters.push({ label: `Search: "${search}"`, type: 'search' });
      if (dateFrom) filters.push({ label: `From: ${dateFrom}`, type: 'dateFrom' });
      if (dateTo) filters.push({ label: `To: ${dateTo}`, type: 'dateTo' });
      if (qtyMin) filters.push({ label: `Min Qty: ${qtyMin}`, type: 'qtyMin' });
      if (qtyMax) filters.push({ label: `Max Qty: ${qtyMax}`, type: 'qtyMax' });
      if (userFilter) filters.push({ label: `User: ${userFilter}`, type: 'user' });
      if (statusFilter) filters.push({ label: `Status: ${statusFilter}`, type: 'status' });

      activeFiltersList.innerHTML = "";

      if (filters.length === 0) {
        activeFiltersList.innerHTML = '<span class="text-gray-500 text-sm font-medium">No active filters</span>';
        return;
      }

      filters.forEach(filter => {
        const badge = document.createElement("span");
        badge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 shadow-sm hover:shadow-md transition-shadow";
        badge.innerHTML = `
          ${filter.label}
          <button class="ml-2 hover:text-blue-600 transition-colors" onclick="removeFilter('${filter.type}')">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        `;
        activeFiltersList.appendChild(badge);
      });

      lucide.createIcons();
    }

    // Remove specific filter
    function removeFilter(type) {
      switch (type) {
        case 'sheet':
          document.getElementById("sheetSelect").value = "";
          break;
        case 'type':
          document.getElementById("filterOption").value = "all";
          break;
        case 'day':
          document.getElementById("dayFilterSelect").value = "";
          break;
        case 'search':
          document.getElementById("quickSearchInput").value = "";
          break;
        case 'dateFrom':
          document.getElementById("dateFromSearch").value = "";
          break;
        case 'dateTo':
          document.getElementById("dateToSearch").value = "";
          break;
        case 'qtyMin':
          document.getElementById("quantityMin").value = "";
          break;
        case 'qtyMax':
          document.getElementById("quantityMax").value = "";
          break;
        case 'user':
          document.getElementById("userFilter").value = "";
          break;
        case 'status':
          document.getElementById("statusFilter").value = "";
          break;
      }
      applyFilters();
    }

    // Clear all filters
    function clearAllFilters() {
      document.getElementById("sheetSelect").value = "";
      document.getElementById("filterOption").value = "all";
      document.getElementById("dayFilterSelect").value = "";
      document.getElementById("quickSearchInput").value = "";
      document.getElementById("dateFromSearch").value = "";
      document.getElementById("dateToSearch").value = "";
      document.getElementById("quantityMin").value = "";
      document.getElementById("quantityMax").value = "";
      document.getElementById("sortBySelect").value = "date_desc";
      document.getElementById("userFilter").value = "";
      document.getElementById("statusFilter").value = "";

      currentPage = 1;
      currentData = [];
      filteredData = [];
      updateTable([]);
      updateSummaryCards();
      updateFilterSummary();
    }

    // Initialize filters
    function initializeFilters() {
      updateFilterSummary();
    }

    // Toggle advanced filters section
    function toggleAdvancedFiltersSection() {
      const section = document.getElementById("advancedFiltersSection");
      const btn = document.getElementById("advancedFiltersBtn");
      
      if (section.classList.contains("hidden")) {
        section.classList.remove("hidden");
        btn.innerHTML = `
          <i data-lucide="filter" class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"></i>
          Hide Advanced Filters
        `;
      } else {
        section.classList.add("hidden");
        btn.innerHTML = `
          <i data-lucide="filter" class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"></i>
          Advanced Filters
        `;
      }
      lucide.createIcons();
    }

    // Hide advanced filters section
    function hideAdvancedFiltersSection() {
      const section = document.getElementById("advancedFiltersSection");
      const btn = document.getElementById("advancedFiltersBtn");
      
      section.classList.add("hidden");
      btn.innerHTML = `
        <i data-lucide="filter" class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"></i>
        Advanced Filters
      `;
      lucide.createIcons();
    }

    // Clear only advanced filters
    function clearAdvancedFiltersOnly() {
      document.getElementById("quantityMin").value = "";
      document.getElementById("quantityMax").value = "";
      document.getElementById("sortBySelect").value = "date_desc";
      document.getElementById("userFilter").value = "";
      document.getElementById("statusFilter").value = "";
      
      applyFilters();
    }

    // Refresh data
    async function refreshData() {
      const btn = document.getElementById("refreshInventoryBtn");
      const icon = btn.querySelector("i");

      btn.disabled = true;
      icon.classList.add("animate-spin");

      try {
        await fetchData();
        showNotification("Data refreshed successfully", "success");
      } catch (error) {
        showNotification("Failed to refresh data", "error");
      } finally {
        btn.disabled = false;
        icon.classList.remove("animate-spin");
      }
    }

    // Export data
    function exportData() {
      if (!filteredData || filteredData.length === 0) {
        showNotification("No data to export", "warning");
        return;
      }

      const headers = ["Quantity", "Lot Number", "Shift", "Day", "Date", "Time", "User", "Status", "Item Code"];
      const csvContent = [
        headers.join(","),
        ...filteredData.map(row => [
          row.quantity || "",
          row.lot || "",
          row.shift || "",
          row.day || "",
          row.date || "",
          row.time || "",
          row.user || "",
          row.status || "",
          row.item || ""
        ].map(field => `"${field}"`).join(","))
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `inventory_data_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showNotification("Data exported successfully", "success");
    }

    // Utility functions
    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return "0";
      return parseFloat(num).toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
    }

    function getInitials(name) {
      if (!name) return "?";
      return name.split(" ").map(n => n[0]).join("").toUpperCase().slice(0, 2);
    }

    function getShiftBadgeClass(shift) {
      switch (shift?.toLowerCase()) {
        case 'first': return 'bg-gradient-to-r from-blue-500 to-cyan-600 text-white shadow-md';
        case 'second': return 'bg-gradient-to-r from-purple-500 to-pink-600 text-white shadow-md';
        default: return 'bg-gradient-to-r from-gray-400 to-gray-500 text-white shadow-md';
      }
    }

    function getStatusBadgeClass(status) {
      switch (status?.toLowerCase()) {
        case 'received': return 'bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-md';
        case 'returned': return 'bg-gradient-to-r from-yellow-500 to-orange-600 text-white shadow-md';
        default: return 'bg-gradient-to-r from-gray-400 to-gray-500 text-white shadow-md';
      }
    }

    function showLoading(show) {
      const overlay = document.getElementById("loadingOverlay");
      if (show) {
        overlay.classList.remove("hidden");
      } else {
        overlay.classList.add("hidden");
      }
    }

    function showNotification(message, type = "info") {
      const notification = document.createElement("div");
      const bgColor = {
        success: "bg-gradient-to-r from-emerald-500 to-green-600",
        error: "bg-gradient-to-r from-red-500 to-rose-600",
        warning: "bg-gradient-to-r from-yellow-500 to-orange-600",
        info: "bg-gradient-to-r from-blue-500 to-indigo-600"
      }[type] || "bg-gradient-to-r from-blue-500 to-indigo-600";

      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform translate-x-full transition-transform duration-300`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'alert-triangle' : 'info'}" class="w-5 h-5 mr-3"></i>
          <span class="font-semibold">${message}</span>
        </div>
      `;

      document.body.appendChild(notification);
      lucide.createIcons();

      // Animate in
      setTimeout(() => {
        notification.classList.remove("translate-x-full");
      }, 100);

      // Animate out and remove
      setTimeout(() => {
        notification.classList.add("translate-x-full");
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Mobile filter toggle functions
    function toggleMobileFilter() {
      const filterSidebar = document.getElementById("filterSidebar");
      const filterOverlay = document.getElementById("filterOverlay");

      filterSidebar.classList.toggle("translate-x-full");
      filterSidebar.classList.toggle("flex");
      filterSidebar.classList.toggle("hidden");
      filterOverlay.classList.toggle("hidden");
    }

    function closeMobileFilter() {
      const filterSidebar = document.getElementById("filterSidebar");
      const filterOverlay = document.getElementById("filterOverlay");

      filterSidebar.classList.add("translate-x-full");
      filterSidebar.classList.add("hidden");
      filterSidebar.classList.remove("flex");
      filterOverlay.classList.add("hidden");
    }// Mobile filter toggle
    // Make removeFilter globally accessible
    window.removeFilter = removeFilter;

  </script>

  {% endblock %}
</body>

</html>