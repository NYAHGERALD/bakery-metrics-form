<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bakery Analytics</title>
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="{{ url_for('static', filename='js/timezone-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='global-announcements.js') }}"></script>
    <style>
        /* Custom animations and glassmorphism effects */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .glass-card-dark {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .animated-bg {
            background: linear-gradient(-45deg, #667eea, #764ba2, #6b73ff, #9644ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px 0 rgba(31, 38, 135, 0.25);
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        /* Modal and button styles */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        /* Input icon wrapper - Enhanced for better form styling */
        .input-icon-wrapper {
            position: relative;
            display: block;
        }

        .input-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            pointer-events: none;
            color: #6b7280;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        /* Form styling */
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        @media (min-width: 768px) {
            .form-input {
                padding: 1rem 1.25rem;
            }
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        /* Prevent autocomplete dropdown styling issues */
        .form-input:-webkit-autofill,
        .form-input:-webkit-autofill:hover,
        .form-input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 1000px rgba(255, 255, 255, 0.9) inset;
            -webkit-text-fill-color: #374151;
            transition: background-color 5000s ease-in-out 0s;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        /* Make asterisks red for required fields */
        .form-label:has(+ input[required])::after,
        label:contains('*') {
            color: #ef4444;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }
        
        @media (min-width: 768px) {
            .form-group {
                margin-bottom: 1.5rem;
            }
        }

        .form-help {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Disabled button styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Success and error notification styles */
        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }

        .notification-exit {
            animation: slideOutRight 0.3s ease-in;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Button hover effects */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.4);
        }

        /* Mobile menu animation */
        .mobile-menu-enter {
            animation: slideInRight 0.3s ease-out forwards;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* Additional custom styles for this page */
        .role-admin {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .role-user {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .role-supervisor {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .status-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .status-inactive {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        /* Custom scrollbar for weeks list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Enhanced form validation styles */
        .border-red-300 {
            border-color: #fca5a5 !important;
            box-shadow: 0 0 0 3px rgba(252, 165, 165, 0.1);
        }

        .border-green-300 {
            border-color: #86efac !important;
            box-shadow: 0 0 0 3px rgba(134, 239, 172, 0.1);
        }

        /* Smooth transitions for all interactive elements */
        * {
            transition: all 0.2s ease;
        }

        /* Enhanced hover effects for table rows */
        tbody tr:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Modal backdrop blur effect */
        #userModal.show {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Section management */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Fixed positioning improvements */
        body {
            padding-bottom: 60px; /* Space for footer */
        }

        /* Enhanced modal overlay with light blue glassy blur */
        .modal-overlay-light-blue {
            background: rgba(173, 216, 230, 0.35) !important; /* Light blue with more visible opacity */
            backdrop-filter: blur(15px) !important;
            -webkit-backdrop-filter: blur(15px) !important;
        }

        /* Enhanced modal content styling */
        .modal-content-enhanced {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(173, 216, 230, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15),
                       0 0 0 1px rgba(173, 216, 230, 0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Ensure sidebar stays fixed */
        #sidebar {
            position: fixed !important;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
        }

        /* Main content with proper padding for fixed sidebar on desktop */
        @media (min-width: 1024px) {
            main {
                margin-left: 18rem; /* 72 * 0.25rem = 18rem for w-72 */
            }
        }

        /* Enhanced form styling */
        .form-enhanced input, .form-enhanced textarea, .form-enhanced select {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-enhanced input:focus, .form-enhanced textarea:focus, .form-enhanced select:focus {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
        }

        /* Enhanced Modal Animations and Effects */
        #ticketDetailsModal {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        #ticketDetailsModal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #ticketDetailsModal:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Enhanced Button Hover Effects */
        .enhanced-btn {
            position: relative;
            overflow: hidden;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        /* Timezone Warning Highlight */
        #settingsModal[data-timezone-warning="true"] .border.border-gray-200.rounded-2xl.p-6.bg-white\/50:first-of-type {
            border-color: #f59e0b;
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        /* Subtle pulse animation for warning */
        .animate-pulse-subtle {
            animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-subtle {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.95;
            }
        }

        /* Colorful Badge Gradients */
        .status-open {
            background: linear-gradient(135deg, #dc2626, #f87171) !important;
            color: white !important;
        }

        .status-in_progress {
            background: linear-gradient(135deg, #2563eb, #60a5fa) !important;
            color: white !important;
        }

        .status-waiting {
            background: linear-gradient(135deg, #d97706, #fbbf24) !important;
            color: white !important;
        }

        .status-resolved {
            background: linear-gradient(135deg, #059669, #34d399) !important;
            color: white !important;
        }

        .status-closed {
            background: linear-gradient(135deg, #6b7280, #9ca3af) !important;
            color: white !important;
        }

        .priority-low {
            background: linear-gradient(135deg, #10b981, #6ee7b7) !important;
            color: white !important;
        }

        .priority-medium {
            background: linear-gradient(135deg, #f59e0b, #fcd34d) !important;
            color: white !important;
        }

        .priority-high {
            background: linear-gradient(135deg, #ef4444, #fb7185) !important;
            color: white !important;
        }

        .priority-urgent {
            background: linear-gradient(135deg, #7c2d12, #dc2626) !important;
            color: white !important;
        }

        /* Animated Status Checkbox Styles */
        .status-checkbox-wrapper {
            position: relative;
            display: inline-block;
        }

        .status-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
        }

        .status-checkbox:hover {
            border-color: #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .status-checkbox:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .status-checkbox:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .status-checkbox:checked {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            animation: checkboxActivate 0.3s ease-out;
        }

        .status-checkbox:not(:checked) {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border-color: #6b7280;
            animation: checkboxDeactivate 0.3s ease-out;
        }

        .status-checkbox::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 6px;
            height: 10px;
            border: 2px solid white;
            border-top: 0;
            border-left: 0;
            transform-origin: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-checkbox:checked::after {
            transform: translate(-50%, -50%) rotate(45deg) scale(1);
            animation: checkmarkDraw 0.3s ease-out 0.1s both;
        }

        .status-checkbox:not(:checked)::after {
            content: 'Ã—';
            border: none;
            font-size: 12px;
            font-weight: bold;
            color: white;
            line-height: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        @keyframes checkboxActivate {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes checkboxDeactivate {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes checkmarkDraw {
            0% {
                transform: translate(-50%, -50%) rotate(45deg) scale(0);
            }
            100% {
                transform: translate(-50%, -50%) rotate(45deg) scale(1);
            }
        }

        /* Tooltip styles for checkbox */
        .status-checkbox-wrapper[data-tooltip]::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1000;
            margin-bottom: 4px;
        }

        .status-checkbox-wrapper[data-tooltip]::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.8);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .status-checkbox-wrapper:hover::before,
        .status-checkbox-wrapper:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* User Row Status Styling */
        .user-row {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .user-row.inactive {
            opacity: 0.6;
            background-color: rgba(107, 114, 128, 0.05) !important;
            filter: grayscale(0.3);
        }

        .user-row.inactive:hover {
            background-color: rgba(107, 114, 128, 0.1) !important;
        }

        .user-row.inactive .text-gray-900 {
            color: #6b7280 !important;
        }

        .user-row.inactive .text-gray-500 {
            color: #9ca3af !important;
        }

        /* Updating state styles */
        .user-row.updating {
            position: relative;
            pointer-events: none;
        }

        .user-row.updating::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(1px);
        }

        .user-row.updating::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 11;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Status badge smooth transitions */
        .status-badge {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-badge.updating {
            transform: scale(0.95);
            opacity: 0.7;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Enhanced backdrop blur support */
        .backdrop-blur-md {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .backdrop-blur-lg {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        /* Fallback for browsers that don't support backdrop-filter */
        @supports not (backdrop-filter: blur(12px)) {
            .backdrop-blur-md {
                background: rgba(59, 130, 246, 0.3) !important;
            }
            .backdrop-blur-lg {
                background: rgba(79, 70, 229, 0.3) !important;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-purple-50 min-h-screen">
    <!-- Mobile Header -->
    <div class="lg:hidden fixed top-0 left-0 right-0 z-50 glass-card p-4">
        <div class="flex items-center justify-between">
            <button id="mobileMenuBtn" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
            </button>
            <h1 class="text-lg font-bold text-gray-800">Admin Dashboard</h1>
            <button onclick="openProfileModal()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                <i data-lucide="user-circle" class="w-6 h-6 text-gray-700"></i>
            </button>
        </div>
    </div>

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed lg:static inset-y-0 left-0 z-40 w-72 glass-card-dark transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- Logo Section -->
                <div class="p-6 border-b border-white/10">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl">
                            <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">Admin Panel</h1>
                            <p class="text-slate-400 text-sm">System Management</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 p-6 space-y-2 custom-scrollbar overflow-y-auto">
                    <div class="space-y-1">
                        <a href="#dashboard" onclick="showSection('dashboard')" id="nav-dashboard"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-white bg-white/10 border border-white/20 backdrop-blur-sm">
                            <i data-lucide="layout-dashboard" class="mr-3 h-5 w-5"></i>
                            Dashboard
                            <div class="ml-auto w-2 h-2 bg-blue-400 rounded-full notification-dot"></div>
                        </a>

                        <a href="#user-management" onclick="showSection('user-management')" id="nav-user-management"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="users" class="mr-3 h-5 w-5"></i>
                            User Management
                        </a>

                        <a href="#employee-management" onclick="showSection('employee-management')" id="nav-employee-management"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="user-cog" class="mr-3 h-5 w-5"></i>
                            Employee Management
                        </a>

                        <a href="#announcements" onclick="showSection('announcements')" id="nav-announcements"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="megaphone" class="mr-3 h-5 w-5"></i>
                            Announcements
                        </a>

                        <a href="#reviews" onclick="showSection('reviews')" id="nav-reviews"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="star" class="mr-3 h-5 w-5"></i>
                            Reviews Management 
                        </a>

                        <a href="#support" onclick="showSection('support')" id="nav-support"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="life-buoy" class="mr-3 h-5 w-5"></i>
                            Support Tickets
                            <span id="ticketCount"
                                class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </a>

                        <a href="#faq" onclick="showSection('faq')" id="nav-faq"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="help-circle" class="mr-3 h-5 w-5"></i>
                            FAQ Management
                        </a>

                        <a href="#email-management" onclick="showSection('email-management')" id="nav-email-management"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="mail" class="mr-3 h-5 w-5"></i>
                            Email Management
                        </a>

                        <a href="#contact-details" onclick="showSection('contact-details')" id="nav-contact-details"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="phone" class="mr-3 h-5 w-5"></i>
                            Contact Details
                        </a>

                        <a href="#legal-documents" onclick="showSection('legal-documents')" id="nav-legal-documents"
                            class="nav-item group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all duration-200">
                            <i data-lucide="file-text" class="mr-3 h-5 w-5"></i>
                            Legal Documents
                        </a>
                    </div>

                    <!-- Enhanced System Status -->
                    <div class="mt-8 p-4 bg-white/5 rounded-xl border border-white/10">
                        <h3 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
                            <i data-lucide="activity" class="w-4 h-4"></i>
                            System Status
                        </h3>
                        <div class="space-y-3" id="systemStatusContainer">
                            <!-- Loading state -->
                            <div id="systemStatusLoading" class="flex items-center justify-center py-4">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-slate-400"></div>
                                <span class="ml-2 text-xs text-slate-400">Loading...</span>
                            </div>
                            
                            <!-- Status items (hidden initially) -->
                            <div id="systemStatusContent" class="space-y-3 hidden">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="heart" class="w-3 h-3"></i>
                                        Health
                                    </span>
                                    <span class="flex items-center text-xs" id="healthStatus">
                                        <div class="w-2 h-2 rounded-full mr-1 notification-dot" id="healthIndicator"></div>
                                        <span id="healthText">--</span>
                                    </span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="database" class="w-3 h-3"></i>
                                        Database
                                    </span>
                                    <span class="flex items-center text-xs" id="databaseStatus">
                                        <div class="w-2 h-2 rounded-full mr-1" id="databaseIndicator"></div>
                                        <span id="databaseText">--</span>
                                    </span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="users" class="w-3 h-3"></i>
                                        Users Online
                                    </span>
                                    <span class="text-xs text-slate-300" id="onlineUsers">--</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        Uptime
                                    </span>
                                    <span class="text-xs text-slate-300" id="systemUptime">--</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="cpu" class="w-3 h-3"></i>
                                        CPU
                                    </span>
                                    <span class="text-xs text-slate-300" id="cpuUsage">--</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="hard-drive" class="w-3 h-3"></i>
                                        Memory
                                    </span>
                                    <span class="text-xs text-slate-300" id="memoryUsage">--</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                        <i data-lucide="activity" class="w-3 h-3"></i>
                                        Last Activity
                                    </span>
                                    <span class="text-xs text-slate-300" id="lastActivity">--</span>
                                </div>
                            </div>
                            
                            <!-- Error state -->
                            <div id="systemStatusError" class="hidden text-center py-2">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-red-400 mx-auto mb-1"></i>
                                <span class="text-xs text-red-400">Status unavailable</span>
                            </div>
                        </div>
                        
                        <!-- Refresh button -->
                        <div class="mt-3 pt-3 border-t border-white/10">
                            <button onclick="refreshSystemStatus()" 
                                class="w-full text-xs text-slate-400 hover:text-slate-300 transition-colors flex items-center justify-center gap-1">
                                <i data-lucide="refresh-cw" class="w-3 h-3" id="refreshIcon"></i>
                                Refresh Status
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- User Profile -->
                <div class="p-6 border-t border-white/10">
                    <div class="flex items-center space-x-3 mb-4">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23667eea'/%3E%3Ctext x='50' y='58' text-anchor='middle' fill='white' font-size='36' font-family='Arial'%3EA%3C/text%3E%3C/svg%3E"
                            class="w-10 h-10 rounded-full" alt="Admin Avatar" />
                        <div>
                            <p class="text-sm font-medium text-white">{{ session['user_full_name'] or 'Admin User' }}
                            </p>
                            <p class="text-xs text-slate-400">Administrator</p>
                        </div>
                    </div>
                    
                    <!-- Profile and Logout Buttons -->
                    <div class="space-y-2">
                        <button onclick="openProfileModal()" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="user-circle" class="w-4 h-4 mr-2 inline"></i>
                            Profile Settings
                        </button>
                        <form method="POST" action="/logout">
                            <button type="submit"
                                class="w-full btn-danger text-white px-4 py-2 rounded-lg text-sm font-medium">
                                <i data-lucide="log-out" class="w-4 h-4 mr-2 inline"></i>
                                Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mobile Menu Overlay -->
        <div id="mobileMenuOverlay" class="fixed inset-0 bg-gradient-to-br from-blue-500/20 to-indigo-600/30 backdrop-blur-md z-30 lg:hidden hidden"></div>

        <!-- Main Content -->
        <main class="flex-1 w-full lg:ml-0 min-h-screen">
        
            <!-- Top Header -->
            <header class="fixed top-0 left-0 right-0 lg:left-72 z-40 glass-card shadow-sm border-b border-gray-200/20 mx-4 lg:mx-6 mt-4 lg:mt-6 rounded-2xl">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 id="pageTitle" class="text-2xl font-bold text-gray-900">Dashboard Overview</h1>
                            <p id="pageSubtitle" class="text-sm text-gray-600 mt-1">Manage your bakery analytics system
                            </p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button class="relative p-2 hover:bg-gray-100/50 rounded-lg transition-colors">
                                <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
                                <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full notification-dot">
                                </div>
                            </button>
                            <div class="relative">
                                <button id="settingsDropdownBtn" onclick="toggleSettingsDropdown()" class="p-2 hover:bg-gray-100/50 rounded-lg transition-colors">
                                    <i data-lucide="settings" class="w-5 h-5 text-gray-600"></i>
                                </button>
                                <!-- Settings Dropdown -->
                                <div id="settingsDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
                                    <button onclick="openSettingsModal(); toggleSettingsDropdown();" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                                        Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="p-4 lg:p-6 pt-20 lg:pt-28 w-full">

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section active">
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                        <!-- Stats Cards -->
                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Total Users</p>
                                    <p id="totalUsers" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-sm text-green-600 font-medium">+12%</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl">
                                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.1s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Announcements</p>
                                    <p id="totalAnnouncements" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="megaphone" class="w-4 h-4 text-blue-500 mr-1"></i>
                                        <span class="text-sm text-blue-600 font-medium">Active</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl">
                                    <i data-lucide="megaphone" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Support Tickets</p>
                                    <p id="totalTickets" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="clock" class="w-4 h-4 text-orange-500 mr-1"></i>
                                        <span class="text-sm text-orange-600 font-medium">Pending</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl">
                                    <i data-lucide="life-buoy" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.3s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Reviews</p>
                                    <p id="totalReviews" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="star" class="w-4 h-4 text-yellow-500 mr-1"></i>
                                        <span class="text-sm text-yellow-600 font-medium">4.8 Avg</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-xl">
                                    <i data-lucide="star" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="glass-card rounded-2xl p-6 fade-in" style="animation-delay: 0.4s;">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Recent Activity</h3>
                        <div id="recentActivity" class="space-y-4">
                            <!-- Activity items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="user-management-section" class="section">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Total Users</p>
                                    <p id="totalUsersUM" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="users" class="w-4 h-4 text-blue-500 mr-1"></i>
                                        <span class="text-sm text-blue-600 font-medium">All accounts</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl">
                                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.1s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Active Users</p>
                                    <p id="activeUsers" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-sm text-green-600 font-medium">Currently active</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Administrators</p>
                                    <p id="adminUsers" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="shield" class="w-4 h-4 text-purple-500 mr-1"></i>
                                        <span class="text-sm text-purple-600 font-medium">Admin roles</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl">
                                    <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="glass-card rounded-2xl p-6 fade-in" style="animation-delay: 0.3s;">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">User Management</h3>
                                <p class="text-sm text-gray-600 mt-1">Manage user accounts, roles, and permissions</p>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="showManageAssetsModal()"
                                    class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white px-6 py-3 rounded-xl font-medium transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
                                    <i data-lucide="settings" class="w-4 h-4 mr-2 inline"></i>
                                    Manage Assets
                                </button>
                                <button onclick="showAddUserModal()"
                                    class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                    <i data-lucide="user-plus" class="w-4 h-4 mr-2 inline"></i>
                                    Add User
                                </button>
                            </div>
                        </div>

                        <!-- Search and Filters -->
                        <div class="flex flex-col lg:flex-row gap-4 mb-6">
                            <div class="flex-1">
                                <div class="relative">
                                    <i data-lucide="search"
                                        class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                    <input id="userSearchInput" type="text"
                                        placeholder="Search users by name or email..."
                                        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" />
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <select id="userRoleFilter"
                                    class="px-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[140px]">
                                    <option value="">All Roles</option>
                                    <option value="admin">Administrator</option>
                                    <option value="supervisor">Supervisor</option>
                                    <option value="manager">Manager</option>
                                    <option value="user">User</option>
                                </select>
                                <select id="userStatusFilter"
                                    class="px-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[140px]">
                                    <option value="">All Status</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="overflow-x-auto rounded-xl border border-gray-200">
                            <table class="w-full bg-white">
                                <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            User
                                        </th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Email
                                        </th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Role
                                        </th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Status
                                        </th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Last Login
                                        </th>
                                        <th
                                            class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Manage
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="divide-y divide-gray-200">
                                    <!-- Users will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="hidden text-center py-12">
                            <div
                                class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                                <i data-lucide="users" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No users found</h3>
                            <p class="text-gray-500 mb-6">Get started by adding your first user to the system.</p>
                            <button onclick="showAddUserModal()"
                                class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                <i data-lucide="user-plus" class="w-4 h-4 mr-2 inline"></i>
                                Add First User
                            </button>
                        </div>
                    </div>

                    <!-- Week Management Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                        <!-- Add New Week -->
                        <div class="glass-card rounded-2xl p-6 fade-in" style="animation-delay: 0.4s;">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                                <i data-lucide="calendar-plus" class="w-5 h-5 mr-2 text-blue-500"></i>
                                Add New Week
                            </h3>
                            <form id="addWeekForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                    <input id="weekStartDate" type="date" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                    <input id="weekEndDate" type="date" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Generated Week
                                        Name</label>
                                    <input id="generatedWeekName" type="text" readonly
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100 text-gray-600 cursor-not-allowed" />
                                </div>
                                <button type="submit"
                                    class="w-full btn-primary text-white py-3 rounded-xl transition-all font-medium">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>Add Week
                                </button>
                            </form>
                        </div>

                        <!-- Active Weeks List -->
                        <div class="glass-card rounded-2xl p-6 fade-in" style="animation-delay: 0.5s;">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                                <i data-lucide="calendar" class="w-5 h-5 mr-2 text-green-500"></i>
                                Active Weeks
                            </h3>
                            <div id="activeWeeksList" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                <!-- Weeks will be populated here -->
                            </div>
                            <div id="noWeeksState" class="hidden text-center py-8">
                                <div
                                    class="inline-flex items-center justify-center w-12 h-12 bg-gray-100 rounded-full mb-3">
                                    <i data-lucide="calendar-x" class="w-6 h-6 text-gray-400"></i>
                                </div>
                                <p class="text-gray-500 text-sm">No weeks configured yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employee Management Section -->
                <div id="employee-management-section" class="section hidden">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Total Employees</p>
                                    <p id="totalEmployees" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="users" class="w-4 h-4 text-blue-500 mr-1"></i>
                                        <span class="text-sm text-blue-600 font-medium">All staff</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl">
                                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.1s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Departments</p>
                                    <p id="totalDepartments" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="building" class="w-4 h-4 text-purple-500 mr-1"></i>
                                        <span class="text-sm text-purple-600 font-medium">Active depts</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl">
                                    <i data-lucide="building" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Work Lines</p>
                                    <p id="totalWorkLines" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="factory" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-sm text-green-600 font-medium">Production lines</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl">
                                    <i data-lucide="factory" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.3s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Shifts</p>
                                    <p id="totalShifts" class="text-3xl font-bold text-gray-900">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="clock" class="w-4 h-4 text-orange-500 mr-1"></i>
                                        <span class="text-sm text-orange-600 font-medium">Active shifts</span>
                                    </div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl">
                                    <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Management Card -->
                    <div class="glass-card rounded-2xl p-6 fade-in" style="animation-delay: 0.4s;">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Employee Management</h3>
                                <p class="text-sm text-gray-600 mt-1">Manage employee records, assignments, and details</p>
                            </div>
                            <button onclick="showAddEmployeeModal()"
                                class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                <i data-lucide="user-plus" class="w-4 h-4 mr-2 inline"></i>
                                Add Employee
                            </button>
                        </div>

                        <!-- Search and Filters -->
                        <div class="flex flex-col lg:flex-row gap-4 mb-6">
                            <div class="flex-1">
                                <div class="relative">
                                    <i data-lucide="search"
                                        class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                    <input id="employeeSearchInput" type="text"
                                        placeholder="Search employees by name, email, or phone..."
                                        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" />
                                </div>
                            </div>
                            <div class="flex gap-3 flex-wrap">
                                <select id="employeeDepartmentFilter"
                                    class="px-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[140px]">
                                    <option value="">All Departments</option>
                                </select>
                                <select id="employeeShiftFilter"
                                    class="px-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[140px]">
                                    <option value="">All Shifts</option>
                                </select>
                                <select id="employeeWorkLineFilter"
                                    class="px-4 py-3 border border-gray-300 rounded-xl bg-white/80 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[140px]">
                                    <option value="">All Work Lines</option>
                                </select>
                            </div>
                        </div>

                        <!-- Employees Table -->
                        <div class="overflow-x-auto rounded-xl border border-gray-200">
                            <table class="w-full bg-white">
                                <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Employee
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Contact
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Department
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Role
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Shift
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Work Line
                                        </th>
                                        <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody" class="divide-y divide-gray-200">
                                    <!-- Employees will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Empty State -->
                        <div id="employeesEmptyState" class="hidden text-center py-12">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                                <i data-lucide="user-cog" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No employees found</h3>
                            <p class="text-gray-500 mb-6">Get started by adding your first employee to the system.</p>
                            <button onclick="showAddEmployeeModal()"
                                class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                <i data-lucide="user-plus" class="w-4 h-4 mr-2 inline"></i>
                                Add First Employee
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div id="announcements-section" class="section">
                    <div class="space-y-6">
                        <!-- Create Announcement Form -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6">Create New Announcement</h3>
                            <form id="announcementForm" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                        <input id="announcementTitle" type="text" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                        <select id="announcementType"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="general">General</option>
                                            <option value="system">System</option>
                                            <option value="maintenance">Maintenance</option>
                                            <option value="feature">Feature</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                                        <select id="announcementPriority"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="low">Low</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="high">High</option>
                                            <option value="urgent">Urgent</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                                        <select id="announcementIcon"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="megaphone">Megaphone</option>
                                            <option value="info">Info</option>
                                            <option value="alert-triangle">Alert</option>
                                            <option value="settings">Settings</option>
                                            <option value="star">Feature</option>
                                            <option value="bell">Notification</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                                    <textarea id="announcementContent" rows="4" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Enter announcement content..."></textarea>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input id="announcementActive" type="checkbox" checked
                                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label class="text-sm text-gray-700">Active (visible to users)</label>
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                                    Create Announcement
                                </button>
                            </form>
                        </div>

                        <!-- Announcements List -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-900">Manage Announcements</h3>
                                <div class="flex items-center space-x-2">
                                    <input id="announcementSearch" type="text" placeholder="Search announcements..."
                                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            <div id="announcementsList" class="space-y-4">
                                <!-- Announcements will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div id="reviews-section" class="section">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Total Reviews</p>
                                    <p id="totalReviewsRM" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl">
                                    <i data-lucide="star" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.1s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Approved</p>
                                    <p id="approvedReviews" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-green-500 to-green-600 rounded-xl">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Pending</p>
                                    <p id="pendingReviews" class="text-2xl font-bold text-orange-600">0</p>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl">
                                    <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.3s;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Average Rating</p>
                                    <p id="avgRating" class="text-2xl font-bold text-purple-600">0.0</p>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-6 gap-4">
                            <h3 class="text-lg font-semibold text-gray-900">Reviews Management</h3>
                            <div class="flex flex-wrap items-center gap-3">
                                <select id="reviewsStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">All Status</option>
                                    <option value="approved">Approved</option>
                                    <option value="pending">Pending Approval</option>
                                    <option value="featured">Featured</option>
                                </select>
                                <select id="reviewsRatingFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">All Ratings</option>
                                    <option value="5">5 Stars</option>
                                    <option value="4">4 Stars</option>
                                    <option value="3">3 Stars</option>
                                    <option value="2">2 Stars</option>
                                    <option value="1">1 Star</option>
                                </select>
                                <input id="reviewsSearch" type="text" placeholder="Search reviews, authors..."
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[200px]">
                                <button onclick="clearReviewFilters()" class="px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                                    <i data-lucide="x" class="w-4 h-4 mr-1 inline"></i>
                                    Clear
                                </button>
                                <button onclick="loadReviews()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2 inline"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div id="reviewsList" class="space-y-4">
                            <!-- Reviews will be populated here -->
                        </div>
                        <div id="noReviewsState" class="hidden text-center py-12">
                            <div class="max-w-md mx-auto">
                                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="star" class="w-10 h-10 text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">No Reviews Found</h3>
                                <p class="text-gray-600">No reviews match your current filters.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Support Tickets Section -->
                <div id="support-section" class="section">
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Support Tickets</h3>
                            <div class="flex items-center space-x-2">
                                <select id="ticketsFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Tickets</option>
                                    <option value="open">Open</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="waiting">Waiting</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="closed">Closed</option>
                                </select>
                                <input id="ticketsSearch" type="text" placeholder="Search tickets..."
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div id="ticketsList" class="space-y-4">
                            <!-- Support tickets will be populated here -->
                        </div>
                        <div id="ticketsPagination">
                            <!-- Pagination will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- FAQ Management Section -->
                <div id="faq-section" class="section">
                    <div class="space-y-6">
                        <!-- Create FAQ Form -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6">Add New FAQ</h3>
                            <form id="faqForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Question</label>
                                    <input id="faqQuestion" type="text" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Enter the frequently asked question...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Answer</label>
                                    <textarea id="faqAnswer" rows="4" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Enter the answer to the question..."></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                        <input id="faqCategory" type="text"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="e.g., General, Technical, Billing">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Order</label>
                                        <input id="faqOrder" type="number" value="0"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input id="faqActive" type="checkbox" checked
                                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label class="text-sm text-gray-700">Active (visible to users)</label>
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                                    Add FAQ
                                </button>
                            </form>
                        </div>

                        <!-- FAQ List -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-900">Manage FAQs</h3>
                                <div class="flex items-center space-x-2">
                                    <select id="faqCategoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">All Categories</option>
                                    </select>
                                    <input id="faqSearch" type="text" placeholder="Search FAQs..."
                                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            <div id="faqList" class="space-y-4">
                                <!-- FAQs will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Details Section -->
                <div id="contact-details-section" class="section">
                    <div class="space-y-6">
                        <!-- Contact Details Header Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Total Contacts</p>
                                        <p id="totalContacts" class="text-3xl font-bold text-gray-900">0</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="phone" class="w-4 h-4 text-blue-500 mr-1"></i>
                                            <span class="text-sm text-blue-600 font-medium">All Types</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl">
                                        <i data-lucide="phone" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.1s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Phone Support</p>
                                        <p id="phoneContacts" class="text-3xl font-bold text-gray-900">0</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="phone-call" class="w-4 h-4 text-green-500 mr-1"></i>
                                            <span class="text-sm text-green-600 font-medium">Active</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl">
                                        <i data-lucide="phone-call" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Email Support</p>
                                        <p id="emailContacts" class="text-3xl font-bold text-gray-900">0</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="mail" class="w-4 h-4 text-purple-500 mr-1"></i>
                                            <span class="text-sm text-purple-600 font-medium">Available</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl">
                                        <i data-lucide="mail" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.3s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Live Chat</p>
                                        <p id="chatContacts" class="text-3xl font-bold text-gray-900">0</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="message-circle" class="w-4 h-4 text-orange-500 mr-1"></i>
                                            <span class="text-sm text-orange-600 font-medium">Online</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl">
                                        <i data-lucide="message-circle" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add Contact Form -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i>
                                Add New Contact Information
                            </h3>
                            <form id="contactForm" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Type</label>
                                        <select id="contactType" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="">Select contact type...</option>
                                            <option value="phone">Phone Support</option>
                                            <option value="email">Email Support</option>
                                            <option value="chat">Live Chat</option>
                                        </select>
                                        <p class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                                            <i data-lucide="info" class="w-3 h-3"></i>
                                            Only one contact of each type is allowed
                                        </p>
                                        <p id="noContactTypesMessage" class="mt-1 text-xs text-amber-600 hidden flex items-center gap-1">
                                            <i data-lucide="alert-circle" class="w-3 h-3"></i>
                                            All contact types are already in use. Delete an existing contact to add a new one.
                                        </p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                        <input id="contactTitle" type="text" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="e.g., Phone Support, Email Support">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Value</label>
                                    <input id="contactValue" type="text" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Phone number, email address, or chat URL...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                    <textarea id="contactDescription" rows="3"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Brief description of this contact method..."></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                                        <select id="contactIcon"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="phone">Phone</option>
                                            <option value="mail">Mail</option>
                                            <option value="message-circle">Message Circle</option>
                                            <option value="phone-call">Phone Call</option>
                                            <option value="headphones">Headphones</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Availability</label>
                                        <input id="contactAvailability" type="text"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="e.g., 24/7 Available, Business Hours">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Response Time</label>
                                        <input id="contactResponseTime" type="text"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="e.g., Immediate, Response in 2 hours">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-center space-x-3">
                                        <input id="contactActive" type="checkbox" checked
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label class="text-sm text-gray-700">Active (visible to users)</label>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input id="contactPrimary" type="checkbox"
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label class="text-sm text-gray-700">Primary contact method</label>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between pt-4">
                                    <button type="button" id="resetContactForm" onclick="resetContactForm()"
                                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2 inline"></i>
                                        Reset Form
                                    </button>
                                    <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                                        Add Contact
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Contact List -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                    <i data-lucide="list" class="w-5 h-5 text-gray-600"></i>
                                    Manage Contact Information
                                </h3>
                                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                                    <select id="contactTypeFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">All Contact Types</option>
                                        <option value="phone">Phone Support</option>
                                        <option value="email">Email Support</option>
                                        <option value="chat">Live Chat</option>
                                    </select>
                                    <select id="contactStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">All Status</option>
                                        <option value="active">Active Only</option>
                                        <option value="inactive">Inactive Only</option>
                                    </select>
                                    <input id="contactSearch" type="text" placeholder="Search contacts..."
                                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button onclick="refreshContactList()" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                        Refresh
                                    </button>
                                </div>
                            </div>

                            <!-- Loading State -->
                            <div id="contactListLoading" class="flex items-center justify-center py-12">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                                <span class="text-gray-600">Loading contact information...</span>
                            </div>

                            <!-- Contact List -->
                            <div id="contactList" class="space-y-4 hidden">
                                <!-- Contacts will be populated here -->
                            </div>

                            <!-- Empty State -->
                            <div id="contactListEmpty" class="text-center py-12 hidden">
                                <i data-lucide="phone-off" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No contact information found</h3>
                                <p class="text-gray-600 mb-6">Add your first contact method to get started.</p>
                                <button onclick="document.getElementById('contactTitle').focus()" 
                                    class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>
                                    Add First Contact
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legal Documents Section -->
                <div id="legal-documents-section" class="section">
                    <div class="space-y-6">
                        <!-- Legal Documents Header -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                                        <div class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl">
                                            <i data-lucide="file-text" class="w-6 h-6 text-white"></i>
                                        </div>
                                        Legal Documents Management
                                    </h2>
                                    <p class="text-gray-600 mt-2">Manage privacy policy, terms of service, and other legal documents</p>
                                </div>
                                <button onclick="refreshAllLegalDocuments()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Refresh All
                                </button>
                            </div>
                        </div>

                        <!-- Legal Documents Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Privacy Policy</p>
                                        <p id="privacyVersion" class="text-2xl font-bold text-gray-900">-</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="shield" class="w-4 h-4 text-blue-500 mr-1"></i>
                                            <span id="privacyStatus" class="text-sm text-blue-600 font-medium">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl">
                                        <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.1s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Terms of Service</p>
                                        <p id="termsVersion" class="text-2xl font-bold text-gray-900">-</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="file-check" class="w-4 h-4 text-green-500 mr-1"></i>
                                            <span id="termsStatus" class="text-sm text-green-600 font-medium">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl">
                                        <i data-lucide="file-check" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Cookie Policy</p>
                                        <p id="cookieVersion" class="text-2xl font-bold text-gray-900">-</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="cookie" class="w-4 h-4 text-orange-500 mr-1"></i>
                                            <span id="cookieStatus" class="text-sm text-orange-600 font-medium">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl">
                                        <i data-lucide="cookie" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.3s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Security Policy</p>
                                        <p id="securityVersion" class="text-2xl font-bold text-gray-900">-</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="lock" class="w-4 h-4 text-purple-500 mr-1"></i>
                                            <span id="securityStatus" class="text-sm text-purple-600 font-medium">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl">
                                        <i data-lucide="lock" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card hover-lift p-6 rounded-2xl fade-in" style="animation-delay: 0.4s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 mb-1">Compliance</p>
                                        <p id="complianceVersion" class="text-2xl font-bold text-gray-900">-</p>
                                        <div class="flex items-center mt-2">
                                            <i data-lucide="award" class="w-4 h-4 text-indigo-500 mr-1"></i>
                                            <span id="complianceStatus" class="text-sm text-indigo-600 font-medium">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gradient-to-r from-indigo-500 to-blue-600 rounded-xl">
                                        <i data-lucide="award" class="w-6 h-6 text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Document Tabs -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="border-b border-gray-200 mb-6">
                                <nav class="-mb-px flex space-x-8 overflow-x-auto">
                                    <button onclick="showDocumentTab('privacy')" id="tab-privacy"
                                        class="document-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                                        <i data-lucide="shield" class="w-4 h-4 mr-2 inline"></i>
                                        Privacy Policy
                                    </button>
                                    <button onclick="showDocumentTab('terms')" id="tab-terms"
                                        class="document-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        <i data-lucide="file-check" class="w-4 h-4 mr-2 inline"></i>
                                        Terms of Service
                                    </button>
                                    <button onclick="showDocumentTab('cookie')" id="tab-cookie"
                                        class="document-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        <i data-lucide="cookie" class="w-4 h-4 mr-2 inline"></i>
                                        Cookie Policy
                                    </button>
                                    <button onclick="showDocumentTab('security')" id="tab-security"
                                        class="document-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        <i data-lucide="lock" class="w-4 h-4 mr-2 inline"></i>
                                        Security Policy
                                    </button>
                                    <button onclick="showDocumentTab('compliance')" id="tab-compliance"
                                        class="document-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        <i data-lucide="award" class="w-4 h-4 mr-2 inline"></i>
                                        Compliance Policy
                                    </button>
                                </nav>
                            </div>

                            <!-- Document Content Panels -->
                            <div id="document-content">
                                <!-- Privacy Policy Panel -->
                                <div id="privacy-panel" class="document-panel">
                                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                            <i data-lucide="shield" class="w-5 h-5 text-blue-600"></i>
                                            Privacy Policy Management
                                        </h3>
                                        <div class="flex gap-3">
                                            <button onclick="toggleEditMode('privacy')" id="edit-privacy-btn"
                                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                Edit
                                            </button>
                                            <button onclick="previewDocument('privacy')"
                                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                                Preview
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Content Display -->
                                    <div id="privacy-display" class="mb-6">
                                        <div class="bg-gray-50 rounded-lg p-4 border">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">Current Version</h4>
                                            <div id="privacy-current-content" class="prose max-w-none text-sm text-gray-600">
                                                Loading privacy policy...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Edit Form -->
                                    <form id="privacy-form" class="space-y-4 hidden">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Version (Auto-generated)</label>
                                                <input id="privacy-version" type="text" required readonly
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Effective Date</label>
                                                <input id="privacy-date" type="date" required
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                            <input id="privacy-title" type="text" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Content (Markdown supported)</label>
                                            <textarea id="privacy-content" rows="15" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                                                placeholder="Enter privacy policy content..."></textarea>
                                        </div>
                                        <div class="flex items-center justify-between pt-4">
                                            <button type="button" onclick="cancelEdit('privacy')"
                                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                                                <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                                                Cancel
                                            </button>
                                            <button type="submit"
                                                class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors">
                                                <i data-lucide="save" class="w-4 h-4 mr-2 inline"></i>
                                                Save Privacy Policy
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Terms of Service Panel -->
                                <div id="terms-panel" class="document-panel hidden">
                                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                            <i data-lucide="file-check" class="w-5 h-5 text-green-600"></i>
                                            Terms of Service Management
                                        </h3>
                                        <div class="flex gap-3">
                                            <button onclick="toggleEditMode('terms')" id="edit-terms-btn"
                                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                Edit
                                            </button>
                                            <button onclick="previewDocument('terms')"
                                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                                Preview
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Content Display -->
                                    <div id="terms-display" class="mb-6">
                                        <div class="bg-gray-50 rounded-lg p-4 border">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">Current Version</h4>
                                            <div id="terms-current-content" class="prose max-w-none text-sm text-gray-600">
                                                Loading terms of service...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Edit Form -->
                                    <form id="terms-form" class="space-y-4 hidden">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Version (Auto-generated)</label>
                                                <input id="terms-version" type="text" required readonly
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Effective Date</label>
                                                <input id="terms-date" type="date" required
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                            <input id="terms-title" type="text" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Content (Markdown supported)</label>
                                            <textarea id="terms-content" rows="15" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent font-mono text-sm"
                                                placeholder="Enter terms of service content..."></textarea>
                                        </div>
                                        <div class="flex items-center justify-between pt-4">
                                            <button type="button" onclick="cancelEdit('terms')"
                                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                                                <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                                                Cancel
                                            </button>
                                            <button type="submit"
                                                class="px-6 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors">
                                                <i data-lucide="save" class="w-4 h-4 mr-2 inline"></i>
                                                Save Terms of Service
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Cookie Policy Panel -->
                                <div id="cookie-panel" class="document-panel hidden">
                                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                            <i data-lucide="cookie" class="w-5 h-5 text-orange-600"></i>
                                            Cookie Policy Management
                                        </h3>
                                        <div class="flex gap-3">
                                            <button onclick="toggleEditMode('cookie')" id="edit-cookie-btn"
                                                class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                Edit
                                            </button>
                                            <button onclick="previewDocument('cookie')"
                                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                                Preview
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Content Display -->
                                    <div id="cookie-display" class="mb-6">
                                        <div class="bg-gray-50 rounded-lg p-4 border">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">Current Version</h4>
                                            <div id="cookie-current-content" class="prose max-w-none text-sm text-gray-600">
                                                Loading cookie policy...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Edit Form -->
                                    <form id="cookie-form" class="space-y-4 hidden">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Version (Auto-generated)</label>
                                                <input id="cookie-version" type="text" required readonly
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Effective Date</label>
                                                <input id="cookie-date" type="date" required
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                            <input id="cookie-title" type="text" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Content (Markdown supported)</label>
                                            <textarea id="cookie-content" rows="15" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono text-sm"
                                                placeholder="Enter cookie policy content..."></textarea>
                                        </div>
                                        <div class="flex items-center justify-between pt-4">
                                            <button type="button" onclick="cancelEdit('cookie')"
                                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                                                <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                                                Cancel
                                            </button>
                                            <button type="submit"
                                                class="px-6 py-3 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 transition-colors">
                                                <i data-lucide="save" class="w-4 h-4 mr-2 inline"></i>
                                                Save Cookie Policy
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Security Policy Panel -->
                                <div id="security-panel" class="document-panel hidden">
                                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                            <i data-lucide="lock" class="w-5 h-5 text-purple-600"></i>
                                            Security Policy Management
                                        </h3>
                                        <div class="flex gap-3">
                                            <button onclick="toggleEditMode('security')" id="edit-security-btn"
                                                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                Edit
                                            </button>
                                            <button onclick="previewDocument('security')"
                                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                                Preview
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Content Display -->
                                    <div id="security-display" class="mb-6">
                                        <div class="bg-gray-50 rounded-lg p-4 border">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">Current Version</h4>
                                            <div id="security-current-content" class="prose max-w-none text-sm text-gray-600">
                                                Loading security policy...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Edit Form -->
                                    <form id="security-form" class="space-y-4 hidden">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Version (Auto-generated)</label>
                                                <input id="security-version" type="text" required readonly
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Effective Date</label>
                                                <input id="security-date" type="date" required
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                            <input id="security-title" type="text" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Content (Markdown supported)</label>
                                            <textarea id="security-content" rows="15" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent font-mono text-sm"
                                                placeholder="Enter security policy content..."></textarea>
                                        </div>
                                        <div class="flex items-center justify-between pt-4">
                                            <button type="button" onclick="cancelEdit('security')"
                                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                                                <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                                                Cancel
                                            </button>
                                            <button type="submit"
                                                class="px-6 py-3 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors">
                                                <i data-lucide="save" class="w-4 h-4 mr-2 inline"></i>
                                                Save Security Policy
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Compliance Policy Panel -->
                                <div id="compliance-panel" class="document-panel hidden">
                                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                            <i data-lucide="award" class="w-5 h-5 text-indigo-600"></i>
                                            Compliance Policy Management
                                        </h3>
                                        <div class="flex gap-3">
                                            <button onclick="toggleEditMode('compliance')" id="edit-compliance-btn"
                                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                Edit
                                            </button>
                                            <button onclick="previewDocument('compliance')"
                                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                                Preview
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Content Display -->
                                    <div id="compliance-display" class="mb-6">
                                        <div class="bg-gray-50 rounded-lg p-4 border">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">Current Version</h4>
                                            <div id="compliance-current-content" class="prose max-w-none text-sm text-gray-600">
                                                Loading compliance policy...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Edit Form -->
                                    <form id="compliance-form" class="space-y-4 hidden">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Version (Auto-generated)</label>
                                                <input id="compliance-version" type="text" required readonly
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Effective Date</label>
                                                <input id="compliance-date" type="date" required
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                            <input id="compliance-title" type="text" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Content (Markdown supported)</label>
                                            <textarea id="compliance-content" rows="15" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"
                                                placeholder="Enter compliance policy content..."></textarea>
                                        </div>
                                        <div class="flex items-center justify-between pt-4">
                                            <button type="button" onclick="cancelEdit('compliance')"
                                                class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                                                <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                                                Cancel
                                            </button>
                                            <button type="submit"
                                                class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors">
                                                <i data-lucide="save" class="w-4 h-4 mr-2 inline"></i>
                                                Save Compliance Policy
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Management Section -->
                <div id="email-management-section" class="section">
                    <div class="space-y-6">
                        <!-- Email Management Header -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                                        <div class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl">
                                            <i data-lucide="mail" class="w-6 h-6 text-white"></i>
                                        </div>
                                        Email Alert Management
                                    </h2>
                                    <p class="text-gray-600 mt-2">Manage email recipients and send manual alerts with PDF attachments</p>
                                </div>
                            </div>
                        </div>

                        <!-- Email Recipients Management -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                                <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
                                Email Recipients
                            </h3>
                            
                            <!-- Recipients List -->
                            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Current Email Recipients</h4>
                                <div id="emailRecipientsList" class="space-y-2">
                                    <!-- Recipients will be loaded here -->
                                    <div class="text-sm text-gray-500 italic">Loading recipients...</div>
                                </div>
                            </div>

                            <!-- Recipient Selection -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Select Recipients for Alerts</h4>
                                    <div id="recipientCheckboxes" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                        <!-- User checkboxes will be loaded here -->
                                        <div class="text-sm text-gray-500 italic">Loading users...</div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Quick Actions</h4>
                                    <div class="space-y-3">
                                        <button onclick="selectAllRecipients()" 
                                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                                            Select All
                                        </button>
                                        <button onclick="deselectAllRecipients()" 
                                                class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2">
                                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                                            Deselect All
                                        </button>
                                        <button onclick="saveRecipientSelection()" 
                                                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                            <i data-lucide="save" class="w-4 h-4"></i>
                                            Save Selection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Email Trigger -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                                <i data-lucide="send" class="w-5 h-5 text-purple-600"></i>
                                Manual Email Trigger
                            </h3>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Day Selection -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Week</label>
                                        <select id="emailWeekSelect" 
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            <option value="">Select a week...</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Day</label>
                                        <select id="emailDaySelect" 
                                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            <option value="">Select a day...</option>
                                            <option value="Monday">Monday</option>
                                            <option value="Tuesday">Tuesday</option>
                                            <option value="Wednesday">Wednesday</option>
                                            <option value="Thursday">Thursday</option>
                                            <option value="Friday">Friday</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Send Options -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Options</label>
                                        <div class="space-y-3">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="includeDailyPDF" checked 
                                                       class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                                <span class="ml-2 text-sm text-gray-700">Include Daily Metrics PDF</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="includeWeeklyPDF" checked 
                                                       class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                                <span class="ml-2 text-sm text-gray-700">Include Weekly Summary PDF</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button onclick="sendManualEmail()" 
                                            class="w-full px-6 py-3 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="send" class="w-5 h-5"></i>
                                        Send Email Alert
                                    </button>
                                </div>
                            </div>

                            <!-- Email Preview -->
                            <div id="emailPreview" class="mt-6 p-4 bg-gray-50 rounded-xl hidden">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Email Preview</h4>
                                <div id="emailPreviewContent" class="text-sm text-gray-600">
                                    <!-- Preview content will be generated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Email Status & Logs -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                                <i data-lucide="activity" class="w-5 h-5 text-green-600"></i>
                                Email Activity Log
                            </h3>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date/Time</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recipients</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week/Day</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="emailActivityLog" class="bg-white divide-y divide-gray-200">
                                        <!-- Email activity logs will be loaded here -->
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-sm text-gray-500 text-center italic">
                                                No email activity yet
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Email Activity Log Pagination -->
                            <div id="emailLogPagination" class="mt-4 px-6 py-3 bg-gray-50 rounded-b-lg">
                                <!-- Pagination controls will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
           
        </main>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal"
        class="fixed inset-0 modal-overlay-light-blue flex items-center justify-center z-50 hidden p-4 sm:p-6 lg:p-8">
        <div class="relative w-full max-w-4xl max-h-[95vh] mx-auto">
            <!-- Modal Content with enhanced styling -->
            <div class="modal-content-enhanced rounded-3xl form-enhanced overflow-hidden shadow-2xl border border-white/20">
                <!-- Scrollable Content with proper padding -->
                <div class="max-h-[95vh] overflow-y-auto">
                    <div class="p-6 sm:p-8 md:p-10 lg:p-12">
                        <!-- Header with improved spacing -->
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center space-x-4">
                                <div class="w-14 h-14 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="user-plus" class="w-7 h-7 text-white"></i>
                                </div>
                                <div>
                                    <h3 id="modalTitle" class="text-3xl font-bold text-gray-900">Add New User</h3>
                                    <p class="text-base text-gray-600 mt-1">Create a new user account with role and permissions</p>
                                </div>
                            </div>
                            <button onclick="closeUserModal()"
                                class="p-3 hover:bg-gray-100 rounded-2xl transition-all hover:scale-105 group">
                                <i data-lucide="x" class="w-6 h-6 text-gray-500 group-hover:text-gray-700"></i>
                            </button>
                        </div>

                <form id="userForm" class="space-y-8" autocomplete="off">
                    <input type="hidden" id="userId" value="">

                    <!-- Personal Information Section -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 text-white"></i>
                            </div>
                            <h4 class="text-xl font-semibold text-gray-900">Personal Information</h4>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 lg:gap-8">
                            <div class="form-group">
                                <label class="form-label">First Name <span class="text-red-500">*</span></label>
                                <input id="firstName" type="text" required
                                    class="form-input" placeholder="Enter first name" 
                                    autocomplete="given-name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name <span class="text-red-500">*</span></label>
                                <input id="lastName" type="text" required
                                    class="form-input" placeholder="Enter last name"
                                    autocomplete="family-name">
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="space-y-4">
                        <div class="flex items-center space-x-2 mb-4">
                            <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-teal-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="mail" class="w-4 h-4 text-white"></i>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-900">Contact Information</h4>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div class="form-group">
                                <label class="form-label">Email Address <span class="text-red-500">*</span></label>
                                <input id="email" type="email" required
                                    class="form-input" placeholder="user@example.com"
                                    autocomplete="email">
                                <p class="form-help">This will be used for login</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input id="phone" type="tel" 
                                    class="form-input" placeholder="(555) 123-4567"
                                    autocomplete="tel">
                                <p class="form-help">Optional contact number</p>
                            </div>
                        </div>
                    </div>

                    <!-- Account Settings Section -->
                    <div class="space-y-4">
                        <div class="flex items-center space-x-2 mb-4">
                            <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="settings" class="w-4 h-4 text-white"></i>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-900">Account Settings</h4>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div class="form-group">
                                <label class="form-label">Role <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <select id="role" required class="form-input appearance-none pr-10">
                                        <option value="">Select a role</option>
                                         <option value="employee">employee - Very Basic access</option>
                                         <option value="user">User - Basic access</option>
                                        <option value="supervisor">Supervisor - Extended access</option>
                                        <option value="admin">Administrator - Full access</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account Status</label>
                                <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-2xl">
                                    <input id="isActive" type="checkbox" checked
                                        class="w-5 h-5 text-blue-600 border-gray-300 rounded-lg focus:ring-blue-500 focus:ring-2">
                                    <div>
                                        <label for="isActive" class="text-sm font-medium text-gray-700 cursor-pointer">Active Account</label>
                                        <p class="text-xs text-gray-500">User can log in and access the system</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Password Section -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="lock" class="w-5 h-5 text-white"></i>
                            </div>
                            <h4 class="text-xl font-semibold text-gray-900">Security Settings</h4>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Password <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input id="password" type="text" required readonly
                                    class="form-input bg-gray-50 cursor-default" placeholder="Auto-generated temporary password">
                            </div>
                            <div class="mt-2">
                                <div class="flex items-center space-x-2 mb-2">
                                    <button type="button" onclick="generateSecurePassword()"
                                        class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg font-medium transition-colors">
                                        <i data-lucide="refresh-cw" class="w-3 h-3 mr-1 inline"></i>
                                        Regenerate Password
                                    </button>
                                    <div id="passwordStrength" class="text-xs font-medium"></div>
                                </div>
                                <div id="passwordStrengthBar" class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="passwordStrengthProgress" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Password is auto-generated. User will be prompted to change password on first login.</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Confirm Password <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input id="confirmPassword" type="text" required readonly
                                    class="form-input bg-gray-50 cursor-default" placeholder="Auto-generated confirmation">
                            </div>
                            <div id="passwordMatchStatus" class="text-xs mt-1"></div>
                        </div>
                    </div>

                    <!-- Password Info Section (for new users) -->
                    <div id="passwordInfo" class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl p-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-green-500 rounded-xl flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i data-lucide="shield-check" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <h5 class="font-medium text-green-900 mb-1">Auto-Generated Password Setup</h5>
                                <p class="text-sm text-green-700">A temporary password is automatically created for initial access. The user will be prompted to create a strong password when they first log in. All passwords are securely encrypted before storage.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6 pt-8 mt-8 border-t border-gray-200">
                        <button type="submit"
                            class="flex-1 btn-primary text-white px-10 py-5 rounded-2xl font-bold text-lg hover:scale-105 transition-all shadow-xl">
                            <i data-lucide="user-plus" class="w-6 h-6 mr-3 inline"></i>
                            <span id="submitButtonText">Create User</span>
                        </button>
                        <button type="button" onclick="closeUserModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-10 py-5 rounded-2xl font-semibold text-lg transition-all hover:scale-105">
                            <i data-lucide="x" class="w-6 h-6 mr-3 inline"></i>
                            Cancel
                        </button>
                    </div>
                </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal"
        class="fixed inset-0 modal-overlay-light-blue flex items-center justify-center z-50 hidden p-4 sm:p-6 lg:p-8">
        <div class="relative w-full max-w-3xl max-h-[95vh] mx-auto">
            <!-- Modal Content -->
            <div class="modal-content-enhanced rounded-3xl form-enhanced overflow-hidden shadow-2xl border border-white/20">
                <!-- Scrollable Content -->
                <div class="max-h-[95vh] overflow-y-auto">
                    <div class="p-6 sm:p-8 md:p-10">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center space-x-4">
                                <div class="w-14 h-14 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="settings" class="w-7 h-7 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-gray-900">Settings</h3>
                                    <p class="text-base text-gray-600 mt-1">Configure system preferences</p>
                                </div>
                            </div>
                            <button onclick="closeSettingsModal()"
                                class="p-3 hover:bg-gray-100 rounded-2xl transition-all hover:scale-105 group">
                                <i data-lucide="x" class="w-6 h-6 text-gray-500 group-hover:text-gray-700"></i>
                            </button>
                        </div>

                        <!-- Settings Sections -->
                        <div class="space-y-6">
                            <!-- Timezone Settings -->
                            <div class="border border-gray-200 rounded-2xl p-6 bg-white/50">
                                <div class="flex items-center space-x-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="clock" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Timezone Settings</h4>
                                </div>

                                <div class="space-y-4">
                                    <div class="form-group">
                                        <label class="form-label">Select Timezone</label>
                                        <select id="timezoneSelect" onchange="updateTimezonePreview()" class="form-input">
                                            <optgroup label="US Timezones">
                                                <option value="America/New_York">Eastern Time (ET) - GMT-5</option>
                                                <option value="America/Chicago" selected>Central Time (CT) - GMT-6</option>
                                                <option value="America/Denver">Mountain Time (MT) - GMT-7</option>
                                                <option value="America/Los_Angeles">Pacific Time (PT) - GMT-8</option>
                                                <option value="America/Anchorage">Alaska Time (AKT) - GMT-9</option>
                                                <option value="Pacific/Honolulu">Hawaii Time (HT) - GMT-10</option>
                                            </optgroup>
                                            <optgroup label="Other Timezones">
                                                <option value="UTC">UTC - GMT+0</option>
                                                <option value="Europe/London">London (GMT) - GMT+0</option>
                                                <option value="Europe/Paris">Paris (CET) - GMT+1</option>
                                                <option value="Asia/Tokyo">Tokyo (JST) - GMT+9</option>
                                                <option value="Australia/Sydney">Sydney (AEDT) - GMT+11</option>
                                            </optgroup>
                                        </select>
                                    </div>

                                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                        <div class="flex items-start">
                                            <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2 flex-shrink-0 mt-0.5"></i>
                                            <div class="text-sm text-blue-800">
                                                <p class="font-semibold mb-1">Current Time Preview:</p>
                                                <p id="timezonePreview" class="text-lg font-mono">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Placeholder for Future Settings -->
                            <div class="border border-gray-200 rounded-2xl p-6 bg-white/50 opacity-60">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="bell" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Notification Settings</h4>
                                </div>
                                <p class="text-sm text-gray-500 italic">Coming soon...</p>
                            </div>

                            <div class="border border-gray-200 rounded-2xl p-6 bg-white/50 opacity-60">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="shield" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Security Settings</h4>
                                </div>
                                <p class="text-sm text-gray-500 italic">Coming soon...</p>
                            </div>

                            <div class="border border-gray-200 rounded-2xl p-6 bg-white/50 opacity-60">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="palette" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Appearance Settings</h4>
                                </div>
                                <p class="text-sm text-gray-500 italic">Coming soon...</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6 pt-8 mt-8 border-t border-gray-200">
                            <button onclick="saveSettings()"
                                class="flex-1 btn-primary text-white px-10 py-4 rounded-2xl font-bold text-lg hover:scale-105 transition-all shadow-xl">
                                <i data-lucide="save" class="w-5 h-5 mr-3 inline"></i>
                                Save Settings
                            </button>
                            <button type="button" onclick="closeSettingsModal()"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-10 py-4 rounded-2xl font-semibold text-lg transition-all hover:scale-105">
                                <i data-lucide="x" class="w-5 h-5 mr-3 inline"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast"
        class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 z-[9999]">
        <div class="flex items-center space-x-3">
            <i data-lucide="check-circle" class="w-5 h-5"></i>
            <span id="successMessage">Operation successful!</span>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast"
        class="fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 z-[9999]">
        <div class="flex items-center space-x-3">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <span id="errorMessage">Operation failed!</span>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-gradient-to-br from-blue-500/20 to-indigo-600/30 backdrop-blur-md flex items-center justify-center z-50 hidden">
        <div class="glass-card p-8 rounded-2xl">
            <div class="flex items-center space-x-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <span class="text-gray-700 font-medium">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 modal-overlay-light-blue flex items-center justify-center z-50 hidden">
        <div class="relative max-w-md w-full mx-4">
            <!-- Modal Content -->
            <div class="modal-content-enhanced p-8 rounded-3xl">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-pink-500 rounded-2xl flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Confirm Delete</h3>
                            <p class="text-sm text-gray-600">This action cannot be undone</p>
                        </div>
                    </div>
                </div>

                <p id="deleteModalText" class="text-gray-700 mb-8 leading-relaxed">Are you sure you want to delete this item? This action cannot be undone.</p>
                
                <div class="flex space-x-4">
                    <button id="confirmDeleteBtn" class="flex-1 btn-danger text-white px-6 py-4 rounded-2xl font-bold text-lg hover:scale-105 transition-all shadow-xl">
                        <i data-lucide="trash-2" class="w-5 h-5 mr-2 inline"></i>
                        Delete
                    </button>
                    <button onclick="closeDeleteModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-4 rounded-2xl font-semibold text-lg transition-all hover:scale-105">
                        <i data-lucide="x" class="w-5 h-5 mr-2 inline"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div id="employeeModal"
        class="fixed inset-0 modal-overlay-light-blue flex items-center justify-center z-50 hidden p-4 sm:p-6 lg:p-8">
        <div class="relative w-full max-w-5xl max-h-[95vh] mx-auto">
            <!-- Modal Content with enhanced styling -->
            <div class="modal-content-enhanced rounded-3xl form-enhanced overflow-hidden shadow-2xl border border-white/20">
                <!-- Scrollable Content -->
                <div class="max-h-[95vh] overflow-y-auto">
                    <div class="p-6 sm:p-8 md:p-10 lg:p-12">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center space-x-4">
                                <div class="w-14 h-14 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="user-cog" class="w-7 h-7 text-white"></i>
                                </div>
                                <div>
                                    <h3 id="employeeModalTitle" class="text-3xl font-bold text-gray-900">Add New Employee</h3>
                                    <p class="text-base text-gray-600 mt-1">Create employee record with work assignment details</p>
                                </div>
                            </div>
                            <button onclick="closeEmployeeModal()"
                                class="p-3 hover:bg-gray-100 rounded-2xl transition-all hover:scale-105 group">
                                <i data-lucide="x" class="w-6 h-6 text-gray-500 group-hover:text-gray-700"></i>
                            </button>
                        </div>

                        <form id="employeeForm" class="space-y-8" autocomplete="off">
                            <input type="hidden" id="employeeId" value="">

                            <!-- Personal Information Section -->
                            <div class="space-y-6">
                                <div class="flex items-center space-x-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Personal Information</h4>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-group">
                                        <label class="form-label">First Name <span class="text-red-500">*</span></label>
                                        <input id="empFirstName" type="text" required
                                            class="form-input" placeholder="Enter first name" 
                                            autocomplete="off">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Last Name <span class="text-red-500">*</span></label>
                                        <input id="empLastName" type="text" required
                                            class="form-input" placeholder="Enter last name"
                                            autocomplete="off">
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information Section -->
                            <div class="space-y-6">
                                <div class="flex items-center space-x-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-teal-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="mail" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Contact Information</h4>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-group">
                                        <label class="form-label">Email Address <span class="text-red-500">*</span></label>
                                        <input id="empEmail" type="email" required
                                            class="form-input" placeholder="employee@bakery.com"
                                            autocomplete="off">
                                        <p class="form-help">Work email address</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone Number</label>
                                        <input id="empPhone" type="tel" 
                                            class="form-input" placeholder="(555) 123-4567"
                                            autocomplete="off">
                                        <p class="form-help">Contact phone number</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Work Assignment Section -->
                            <div class="space-y-6">
                                <div class="flex items-center space-x-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="briefcase" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Work Assignment</h4>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-group">
                                        <label class="form-label">Department <span class="text-red-500">*</span></label>
                                        <select id="empDepartment" required class="form-input"> 
                                            <option value="">Select Department</option>
                                            <!-- Will be populated from assets -->
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Role <span class="text-red-500">*</span></label>
                                        <select id="empRole" required class="form-input">
                                            <option value="">Select Role</option>
                                            <!-- Will be populated from assets -->
                                        </select>
                                        <p class="form-help">Job title or position</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Shift <span class="text-red-500">*</span> </label>
                                        <select id="empShift" required class="form-input">
                                            <option value="">Select Shift</option>
                                            <!-- Will be populated from assets -->
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Work Line <span class="text-red-500">*</span></label>
                                        <select id="empWorkLine" required class="form-input">
                                            <option value="">Select Work Line</option>
                                            <!-- Will be populated from assets -->
                                        </select>
                                        <p class="form-help">Production or work line assignment</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Work Area <span class="text-red-500">*</span></label>
                                        <select id="empWorkArea" required class="form-input">
                                            <option value="">Select Work Area</option>
                                            <!-- Will be populated from assets -->
                                        </select>
                                        <p class="form-help">Specific work area or station</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Supervisor <span class="text-red-500">*</span></label>
                                        <select id="empSupervisor" required class="form-input">
                                            <option value="">Select Supervisor</option>
                                            <!-- Will be populated from users with role='supervisor' -->
                                        </select>
                                        <p class="form-help">Assigned supervisor</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Manager <span class="text-red-500">*</span></label>
                                        <select id="empManager" required class="form-input">
                                            <option value="">Select Manager</option>
                                            <!-- Will be populated from users with role='manager' -->
                                        </select>
                                        <p class="form-help">Assigned manager</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Employment Details Section -->
                            <div class="space-y-6">
                                <div class="flex items-center space-x-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="calendar-clock" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">Employment Details</h4>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="form-group">
                                        <label class="form-label">Date of Employment</label>
                                        <input id="empDateOfEmployment" type="date"
                                            class="form-input"
                                            autocomplete="off">
                                        <p class="form-help">Employee start date</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Allocated Vacation Hours</label>
                                        <input id="empVacationHours" type="number" 
                                            class="form-input bg-gray-100" placeholder="Auto-calculated" min="0" step="0.5"
                                            autocomplete="off" readonly>
                                        <p class="form-help">Automatically calculated from vacation schedule and employment date</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Maximum Accumulated Hours <span class="text-red-500">*</span></label>
                                        <input id="empMaxAccumulatedHours" required type="number"
                                            class="form-input" placeholder="0" min="0" step="0.5"
                                            autocomplete="off" onchange="hideVacationScheduleWarning()" oninput="hideVacationScheduleWarning()">
                                        <p class="form-help">Max hours that can be carried over</p>
                                    </div>
                                </div>

                                <!-- Vacation Schedule Section -->
                                <div class="mt-6">
                                    <!-- Warning Message (Hidden by default) -->
                                    <div id="vacationScheduleWarning" class="hidden mb-4 bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-orange-400 p-4 rounded-lg">
                                        <div class="flex items-start space-x-3">
                                            <div class="flex-shrink-0">
                                                <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-600"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h5 class="font-semibold text-orange-900 mb-1">Maximum Accumulated Hours Required</h5>
                                                <p class="text-sm text-orange-800">Please provide a value for Maximum Accumulated Hours before adding vacation schedule years.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-5 rounded-2xl border border-indigo-200">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="flex items-center space-x-2">
                                                <i data-lucide="calendar-days" class="w-5 h-5 text-indigo-600"></i>
                                                <h5 class="font-semibold text-gray-900">Vacation Schedule by Years of Service</h5>
                                            </div>
                                            <button type="button" onclick="addVacationScheduleRow()" 
                                                class="flex items-center space-x-2 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all hover:scale-105">
                                                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                                <span>Add Year</span>
                                            </button>
                                        </div>
                                        
                                        <p class="text-sm text-indigo-700 mb-4">
                                            Define how vacation hours change based on years of employment. For example, year 1 = 80 hours, year 2 = 100 hours, etc.
                                        </p>
                                        
                                        <!-- Table Header -->
                                        <div class="grid grid-cols-12 gap-3 mb-2 px-2">
                                            <div class="col-span-5 text-xs font-semibold text-gray-600 uppercase">
                                                Year
                                            </div>
                                            <div class="col-span-6 text-xs font-semibold text-gray-600 uppercase">
                                                Vacation Hours
                                            </div>
                                            <div class="col-span-1"></div>
                                        </div>
                                        
                                        <!-- Dynamic Rows Container -->
                                        <div id="vacationScheduleRows" class="space-y-2">
                                            <!-- Rows will be added here dynamically -->
                                        </div>
                                        
                                        <!-- Empty State -->
                                        <div id="vacationScheduleEmpty" class="text-center py-8 text-gray-500">
                                            <i data-lucide="calendar-x" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                            <p class="text-sm">No vacation schedule defined. Click "Add Year" to start.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Account Linking Section -->
                            <div class="space-y-6">
                                <div class="flex items-center space-x-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl flex items-center justify-center">
                                        <i data-lucide="link" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-900">User Account Linking</h4>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Link to User Account <span class="text-red-500">*</span></label>
                                    <select id="empUserId" required class="form-input">
                                        <option value="">No user account linked</option>
                                        <!-- Will be populated dynamically with users -->
                                    </select>
                                    <p class="form-help">Link this employee to an existing user account for system access</p>
                                </div>

                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-4">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-8 h-8 bg-blue-500 rounded-xl flex items-center justify-center flex-shrink-0 mt-0.5">
                                            <i data-lucide="info" class="w-4 h-4 text-white"></i>
                                        </div>
                                        <div>
                                            <h5 class="font-medium text-blue-900 mb-1">User Account Linking</h5>
                                            <p class="text-sm text-blue-700">Linking an employee to a user account allows them to log in to the system. Leave unlinked if the employee doesn't need system access. You can link accounts later.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6 pt-8 mt-8 border-t border-gray-200">
                                <button type="submit"
                                    class="flex-1 btn-primary text-white px-10 py-5 rounded-2xl font-bold text-lg hover:scale-105 transition-all shadow-xl">
                                    <i data-lucide="user-plus" class="w-6 h-6 mr-3 inline"></i>
                                    <span id="employeeSubmitButtonText">Create Employee</span>
                                </button>
                                <button type="button" onclick="closeEmployeeModal()"
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-10 py-5 rounded-2xl font-semibold text-lg transition-all hover:scale-105">
                                    <i data-lucide="x" class="w-6 h-6 mr-3 inline"></i>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Assets Modal -->
    <div id="assetsModal"
        class="fixed inset-0 modal-overlay-light-blue flex items-center justify-center z-50 hidden p-4">
        <!-- Modal Container with fixed dimensions -->
        <div class="relative w-full max-w-7xl h-[90vh] mx-auto flex items-center justify-center">
            <!-- Modal Content - Fixed structure -->
            <div class="modal-content-enhanced rounded-3xl form-enhanced shadow-2xl border border-white/20 w-full h-full flex flex-col overflow-hidden">
                <!-- Header - Fixed at top -->
                <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="bg-white/20 backdrop-blur-sm p-2.5 rounded-xl">
                                <i data-lucide="settings" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-white">Manage Assets</h3>
                                <p class="text-emerald-100 text-sm mt-0.5">Configure work roles, lines, areas, departments, and shifts</p>
                            </div>
                        </div>
                        <button onclick="closeAssetsModal()"
                            class="text-white/80 hover:text-white hover:bg-white/20 p-2 rounded-xl transition-all flex-shrink-0">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Form Body - Scrollable content area -->
                <div class="flex-1 overflow-y-auto custom-scrollbar bg-white">
                    <div class="p-6">
                        <form id="assetsForm" class="space-y-6">
                            <!-- Info Alert -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                                <div class="flex items-start">
                                    <i data-lucide="info" class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0"></i>
                                    <div class="text-sm text-blue-700">
                                        <p class="font-semibold mb-1">Asset Management</p>
                                        <p>Add or remove items by editing the text areas below. Separate each item with a new line. These values will be used across the system for dropdowns and selections.</p>
                                    </div>
                                </div>
                            </div>

                        <!-- Work Roles Section -->
                        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-5 rounded-2xl border border-purple-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-purple-100 p-2 rounded-lg mr-3">
                                    <i data-lucide="briefcase" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="form-label text-lg font-semibold text-purple-900 mb-0">Work Roles</label>
                                    <p class="text-sm text-purple-600">Available job roles (e.g., Baker, Packager)</p>
                                </div>
                            </div>
                            <textarea id="assetsWorkRoles" name="workRoles" rows="5"
                                class="form-input w-full resize-none font-mono text-sm"
                                placeholder="Enter each role on a new line...&#10;Baker&#10;Packager&#10;Quality Control"></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                <i data-lucide="list" class="w-3 h-3 inline mr-1"></i>
                                <span id="workRolesCount">0</span> roles
                            </p>
                        </div>

                        <!-- Work Lines Section -->
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-5 rounded-2xl border border-blue-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                    <i data-lucide="git-branch" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="form-label text-lg font-semibold text-blue-900 mb-0">Work Lines</label>
                                    <p class="text-sm text-blue-600">Production or packaging lines (e.g., Line 1, Line 2)</p>
                                </div>
                            </div>
                            <textarea id="assetsWorkLines" name="workLines" rows="5"
                                class="form-input w-full resize-none font-mono text-sm"
                                placeholder="Enter each line on a new line...&#10;Line 1&#10;Line 2&#10;Packaging Line A"></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                <i data-lucide="list" class="w-3 h-3 inline mr-1"></i>
                                <span id="workLinesCount">0</span> lines
                            </p>
                        </div>

                        <!-- Work Areas Section -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-5 rounded-2xl border border-green-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-green-100 p-2 rounded-lg mr-3">
                                    <i data-lucide="map-pin" class="w-5 h-5 text-green-600"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="form-label text-lg font-semibold text-green-900 mb-0">Work Areas</label>
                                    <p class="text-sm text-green-600">Physical work locations (e.g., Production Floor, Packaging Area)</p>
                                </div>
                            </div>
                            <textarea id="assetsWorkAreas" name="workAreas" rows="5"
                                class="form-input w-full resize-none font-mono text-sm"
                                placeholder="Enter each area on a new line...&#10;Production Floor&#10;Packaging Area&#10;Quality Lab"></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                <i data-lucide="list" class="w-3 h-3 inline mr-1"></i>
                                <span id="workAreasCount">0</span> areas
                            </p>
                        </div>

                        <!-- Departments Section -->
                        <div class="bg-gradient-to-br from-orange-50 to-amber-50 p-5 rounded-2xl border border-orange-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-orange-100 p-2 rounded-lg mr-3">
                                    <i data-lucide="building" class="w-5 h-5 text-orange-600"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="form-label text-base sm:text-lg font-semibold text-orange-900 mb-0">Departments</label>
                                    <p class="text-xs sm:text-sm text-orange-600 truncate">Organizational departments (e.g., Production, Quality Assurance)</p>
                                </div>
                            </div>
                            <textarea id="assetsDepartments" name="departments" rows="4"
                                class="form-input w-full resize-none font-mono text-xs sm:text-sm"
                                placeholder="Enter each department on a new line...&#10;Production&#10;Packaging&#10;Quality Assurance"></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                <i data-lucide="list" class="w-3 h-3 inline mr-1"></i>
                                <span id="departmentsCount">0</span> departments
                            </p>
                        </div>

                        <!-- Shifts Names Section -->
                        <div class="bg-gradient-to-br from-pink-50 to-rose-50 p-5 rounded-2xl border border-pink-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-pink-100 p-2 rounded-lg mr-3">
                                    <i data-lucide="clock" class="w-5 h-5 text-pink-600"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="form-label text-lg font-semibold text-pink-900 mb-0">Shift Names</label>
                                    <p class="text-sm text-pink-600">Available work shifts (e.g., Day Shift, Night Shift)</p>
                                </div>
                            </div>
                            <textarea id="assetsShiftsNames" name="shiftsNames" rows="5"
                                class="form-input w-full resize-none font-mono text-sm"
                                placeholder="Enter each shift on a new line...&#10;Day Shift&#10;Night Shift&#10;Evening Shift"></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                <i data-lucide="list" class="w-3 h-3 inline mr-1"></i>
                                <span id="shiftsNamesCount">0</span> shifts
                            </p>
                        </div>

                        <!-- Notes Section (Optional) -->
                        <div class="bg-gray-50 p-5 rounded-2xl border border-gray-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-gray-200 p-2 rounded-lg mr-3">
                                    <i data-lucide="file-text" class="w-5 h-5 text-gray-600"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="form-label text-lg font-semibold text-gray-900 mb-0">Notes (Optional)</label>
                                    <p class="text-sm text-gray-600">Add any notes about this configuration</p>
                                </div>
                            </div>
                            <textarea id="assetsNotes" name="notes" rows="3"
                                class="form-input w-full resize-none text-sm"
                                placeholder="e.g., Updated for Q1 2026, Added new production line..."></textarea>
                        </div>
                    </form>
                </div>

                <!-- Footer - Fixed at bottom -->
                <div class="bg-gradient-to-r from-gray-50 to-slate-50 px-6 py-4 border-t border-gray-200/50 flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <span>Version <span id="assetsVersion">1</span> - Changes create a new version</span>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeAssetsModal()"
                            class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-all">
                            <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                            Cancel
                        </button>
                        <button type="submit" form="assetsForm"
                            class="btn-success px-8 py-2.5 text-white rounded-xl font-medium shadow-lg">
                            <i data-lucide="save" class="w-4 h-4 mr-2 inline"></i>
                            Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ Edit Modal -->
    <div id="faqModal" class="fixed inset-0 modal-overlay-light-blue flex items-center justify-center z-50 hidden">
        <div class="relative max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Modal Content -->
            <div class="modal-content-enhanced p-8 rounded-3xl form-enhanced">
                <!-- Header -->
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center">
                            <i data-lucide="edit" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 id="faqModalTitle" class="text-2xl font-bold text-gray-900">Edit FAQ</h3>
                            <p class="text-sm text-gray-600">Update FAQ information and content</p>
                        </div>
                    </div>
                    <button onclick="closeFAQModal()"
                        class="p-3 hover:bg-gray-100/50 rounded-xl transition-all hover:scale-105">
                        <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                    </button>
                </div>

                <form id="faqEditForm" class="space-y-6">
                    <input type="hidden" id="faqEditId" value="">

                    <!-- Question Field -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-3">
                            <i data-lucide="help-circle" class="w-4 h-4 inline mr-2"></i>
                            Question *
                        </label>
                        <input id="faqEditQuestion" type="text" required
                            class="w-full px-5 py-4 border-2 border-gray-200 rounded-2xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-500 transition-all"
                            placeholder="Enter the frequently asked question...">
                    </div>

                    <!-- Answer Field -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-3">
                            <i data-lucide="message-square" class="w-4 h-4 inline mr-2"></i>
                            Answer *
                        </label>
                        <textarea id="faqEditAnswer" rows="5" required
                            class="w-full px-5 py-4 border-2 border-gray-200 rounded-2xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-500 transition-all resize-none"
                            placeholder="Enter the answer to the question..."></textarea>
                    </div>

                    <!-- Category and Order Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-3">
                                <i data-lucide="tag" class="w-4 h-4 inline mr-2"></i>
                                Category
                            </label>
                            <input id="faqEditCategory" type="text"
                                class="w-full px-5 py-4 border-2 border-gray-200 rounded-2xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-500 transition-all"
                                placeholder="e.g., General, Technical, Billing">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-3">
                                <i data-lucide="hash" class="w-4 h-4 inline mr-2"></i>
                                Display Order
                            </label>
                            <input id="faqEditOrder" type="number" value="0"
                                class="w-full px-5 py-4 border-2 border-gray-200 rounded-2xl focus:ring-3 focus:ring-blue-500/30 focus:border-blue-500 transition-all">
                        </div>
                    </div>

                    <!-- Active Toggle -->
                    <div class="bg-gray-50/70 rounded-2xl p-5">
                        <div class="flex items-center space-x-4">
                            <input id="faqEditActive" type="checkbox" checked
                                class="w-5 h-5 text-blue-600 border-gray-300 rounded-lg focus:ring-blue-500 transition-all">
                            <div class="flex-1">
                                <label class="text-sm font-semibold text-gray-800">Active Status</label>
                                <p class="text-xs text-gray-600 mt-1">FAQ will be visible to users when active</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-4 pt-6 border-t-2 border-gray-100">
                        <button type="submit"
                            class="flex-1 btn-primary text-white px-8 py-4 rounded-2xl font-bold text-lg hover:scale-105 transition-all shadow-xl">
                            <i data-lucide="save" class="w-5 h-5 mr-2 inline"></i>
                            Update FAQ
                        </button>
                        <button type="button" onclick="closeFAQModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-8 py-4 rounded-2xl font-semibold text-lg transition-all hover:scale-105">
                            <i data-lucide="x" class="w-5 h-5 mr-2 inline"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Announcement Modal -->
    <div id="viewAnnouncementModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <!-- Blueish Glassy Overlay -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/20 via-indigo-500/15 to-purple-500/20 backdrop-blur-md"></div>
        
        <!-- Modal Content -->
        <div class="relative bg-white/90 backdrop-blur-xl rounded-3xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden shadow-2xl border border-white/30">
            <!-- Gradient Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-white flex items-center">
                        <i data-lucide="megaphone" class="w-6 h-6 mr-3"></i>
                        Announcement Details
                    </h3>
                    <button onclick="closeViewAnnouncementModal()" class="p-2 text-white/80 hover:text-white hover:bg-white/20 rounded-xl transition-all duration-200" title="Close">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="p-8 space-y-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Title Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl border border-blue-100/50">
                    <label class="block text-sm font-semibold text-blue-700 mb-3 uppercase tracking-wide">Title</label>
                    <h4 id="viewAnnouncementTitle" class="text-2xl font-bold text-gray-900 leading-tight"></h4>
                </div>

                <!-- Content Section -->
                <div class="bg-gradient-to-r from-slate-50 to-gray-50 p-6 rounded-2xl border border-gray-100/50">
                    <label class="block text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Content</label>
                    <p id="viewAnnouncementContent" class="text-gray-800 leading-relaxed text-lg"></p>
                </div>

                <!-- Details Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-5 rounded-xl border border-emerald-100/50">
                        <label class="block text-sm font-semibold text-emerald-700 mb-2 uppercase tracking-wide flex items-center">
                            <i data-lucide="tag" class="w-4 h-4 mr-2"></i>
                            Type
                        </label>
                        <span id="viewAnnouncementType" class="text-gray-900 font-medium capitalize text-lg"></span>
                    </div>
                    
                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-5 rounded-xl border border-amber-100/50">
                        <label class="block text-sm font-semibold text-amber-700 mb-2 uppercase tracking-wide flex items-center">
                            <i data-lucide="flag" class="w-4 h-4 mr-2"></i>
                            Priority
                        </label>
                        <span id="viewAnnouncementPriority" class="text-gray-900 font-medium capitalize text-lg"></span>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-5 rounded-xl border border-purple-100/50">
                        <label class="block text-sm font-semibold text-purple-700 mb-2 uppercase tracking-wide flex items-center">
                            <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                            Author
                        </label>
                        <span id="viewAnnouncementAuthor" class="text-gray-900 font-medium text-lg"></span>
                    </div>
                    
                    <div class="bg-gradient-to-br from-rose-50 to-red-50 p-5 rounded-xl border border-rose-100/50">
                        <label class="block text-sm font-semibold text-rose-700 mb-2 uppercase tracking-wide flex items-center">
                            <i data-lucide="activity" class="w-4 h-4 mr-2"></i>
                            Status
                        </label>
                        <span id="viewAnnouncementStatus" class="px-3 py-1 text-sm font-bold rounded-full"></span>
                    </div>
                    
                    <div class="bg-gradient-to-br from-cyan-50 to-blue-50 p-5 rounded-xl border border-cyan-100/50">
                        <label class="block text-sm font-semibold text-cyan-700 mb-2 uppercase tracking-wide flex items-center">
                            <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                            Created
                        </label>
                        <span id="viewAnnouncementCreated" class="text-gray-900 font-medium text-lg"></span>
                    </div>
                    
                    <div id="viewAnnouncementExpiresRow" class="bg-gradient-to-br from-orange-50 to-red-50 p-5 rounded-xl border border-orange-100/50" style="display: none;">
                        <label class="block text-sm font-semibold text-orange-700 mb-2 uppercase tracking-wide flex items-center">
                            <i data-lucide="clock" class="w-4 h-4 mr-2"></i>
                            Expires
                        </label>
                        <span id="viewAnnouncementExpires" class="text-gray-900 font-medium text-lg"></span>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gradient-to-r from-gray-50 to-slate-50 px-8 py-6 border-t border-gray-200/50">
                <div class="flex justify-end">
                    <button onclick="closeViewAnnouncementModal()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
                        <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variables
        let currentSection = 'dashboard';
        let allAnnouncements = [];
        let allReviews = [];
        let allTickets = [];
        let allFAQs = [];
        let allUsers = [];
        let allWeeks = [];
        let currentEditingUserId = null;
        
        // Get current user ID from session
        const currentUserId = "{{ session.get('user_id', '') }}";

        // System Status Functions
        let systemStatusInterval;
        
        async function fetchSystemStatus() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateSystemStatusDisplay(data.data);
                    showSystemStatusContent();
                } else {
                    showSystemStatusError();
                }
            } catch (error) {
                console.error('Error fetching system status:', error);
                showSystemStatusError();
            }
        }
        
        function updateSystemStatusDisplay(status) {
            // Update health status
            const healthText = document.getElementById('healthText');
            const healthIndicator = document.getElementById('healthIndicator');
            
            if (healthText && healthIndicator) {
                healthText.textContent = status.health;
                healthIndicator.className = 'w-2 h-2 rounded-full mr-1 ' + getHealthColor(status.health);
            }
            
            // Update database status
            const databaseText = document.getElementById('databaseText');
            const databaseIndicator = document.getElementById('databaseIndicator');
            
            if (databaseText && databaseIndicator) {
                databaseText.textContent = status.database_status ? 'Connected' : 'Disconnected';
                databaseIndicator.className = 'w-2 h-2 rounded-full mr-1 ' + 
                    (status.database_status ? 'bg-green-400' : 'bg-red-400');
            }
            
            // Update user counts
            const onlineUsersEl = document.getElementById('onlineUsers');
            if (onlineUsersEl) {
                onlineUsersEl.textContent = status.users_online || '--';
            }
            
            // Update uptime
            const uptimeEl = document.getElementById('systemUptime');
            if (uptimeEl) {
                uptimeEl.textContent = formatUptime(status.uptime);
            }
            
            // Update system metrics
            const cpuEl = document.getElementById('cpuUsage');
            if (cpuEl) {
                cpuEl.textContent = status.cpu_usage ? `${status.cpu_usage}%` : '--';
            }
            
            const memoryEl = document.getElementById('memoryUsage');
            if (memoryEl) {
                memoryEl.textContent = status.memory_usage ? `${status.memory_usage}%` : '--';
            }
            
            // Update last activity
            const lastActivityEl = document.getElementById('lastActivity');
            if (lastActivityEl) {
                lastActivityEl.textContent = status.last_activity ? formatTimeAgo(status.last_activity) : '--';
            }
        }
        
        function getHealthColor(health) {
            switch (health?.toLowerCase()) {
                case 'optimal':
                case 'good':
                    return 'bg-green-400 notification-dot';
                case 'warning':
                case 'moderate':
                    return 'bg-yellow-400 notification-dot';
                case 'critical':
                case 'poor':
                    return 'bg-red-400 notification-dot';
                default:
                    return 'bg-gray-400';
            }
        }
        
        function formatUptime(seconds) {
            if (!seconds) return '--';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}d ${hours}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        function formatTimeAgo(dateString) {
            if (!dateString) return '--';
            
            // Use timezone-aware time ago if available
            if (window.TimezoneUtils && window.TimezoneUtils.getTimeAgo) {
                return window.TimezoneUtils.getTimeAgo(dateString);
            }
            
            // Fallback to local calculation
            const now = new Date();
            const activityTime = new Date(dateString);
            const diffSeconds = Math.floor((now - activityTime) / 1000);
            
            if (diffSeconds < 60) {
                return 'Just now';
            } else if (diffSeconds < 3600) {
                const minutes = Math.floor(diffSeconds / 60);
                return `${minutes}m ago`;
            } else if (diffSeconds < 86400) {
                const hours = Math.floor(diffSeconds / 3600);
                return `${hours}h ago`;
            } else {
                const days = Math.floor(diffSeconds / 86400);
                return `${days}d ago`;
            }
        }
        
        function showSystemStatusContent() {
            const loading = document.getElementById('systemStatusLoading');
            const error = document.getElementById('systemStatusError');
            const content = document.getElementById('systemStatusContent');
            
            if (loading) loading.classList.add('hidden');
            if (error) error.classList.add('hidden');
            if (content) content.classList.remove('hidden');
        }
        
        function showSystemStatusError() {
            const loading = document.getElementById('systemStatusLoading');
            const content = document.getElementById('systemStatusContent');
            const error = document.getElementById('systemStatusError');
            
            if (loading) loading.classList.add('hidden');
            if (content) content.classList.add('hidden');
            if (error) error.classList.remove('hidden');
        }
        
        function refreshSystemStatus() {
            const refreshIcon = document.getElementById('refreshIcon');
            if (refreshIcon) {
                refreshIcon.classList.add('animate-spin');
            }
            
            // Show loading state briefly
            const content = document.getElementById('systemStatusContent');
            const error = document.getElementById('systemStatusError');
            const loading = document.getElementById('systemStatusLoading');
            
            if (content) content.classList.add('hidden');
            if (error) error.classList.add('hidden');
            if (loading) loading.classList.remove('hidden');
            
            setTimeout(() => {
                fetchSystemStatus().finally(() => {
                    if (refreshIcon) {
                        refreshIcon.classList.remove('animate-spin');
                    }
                });
            }, 500); // Brief delay for visual feedback
        }
        
        function startSystemStatusUpdates() {
            // Initial fetch
            fetchSystemStatus();
            
            // Set up periodic updates every 30 seconds
            systemStatusInterval = setInterval(fetchSystemStatus, 30000);
        }
        
        function stopSystemStatusUpdates() {
            if (systemStatusInterval) {
                clearInterval(systemStatusInterval);
                systemStatusInterval = null;
            }
        }

        // Support Ticket Count Functions
        let supportTicketCountInterval;
        
        async function fetchSupportTicketCount() {
            try {
                const response = await fetch('/api/support-tickets/count');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateSupportTicketDisplay(data.data);
                } else {
                    console.error('Failed to fetch support ticket count:', data.message);
                    // Don't show error state, just keep current count
                }
            } catch (error) {
                console.error('Error fetching support ticket count:', error);
                // Don't show error state, just keep current count
            }
        }
        
        function updateSupportTicketDisplay(data) {
            const ticketCountEl = document.getElementById('ticketCount');
            if (ticketCountEl) {
                const openCount = data.open || 0;
                const urgentCount = data.urgent || 0;
                
                // Update the count display
                ticketCountEl.textContent = openCount;
                
                // Update styling based on urgency
                if (urgentCount > 0) {
                    // Red for urgent tickets
                    ticketCountEl.className = 'ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse';
                } else if (openCount > 0) {
                    // Orange/yellow for open tickets
                    ticketCountEl.className = 'ml-auto bg-orange-500 text-white text-xs px-2 py-1 rounded-full';
                } else {
                    // Green for no open tickets
                    ticketCountEl.className = 'ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full';
                }
                
                // Add tooltip information if available
                let tooltipText = `Total: ${data.total || 0}, Open: ${openCount}`;
                if (urgentCount > 0) {
                    tooltipText += `, Urgent: ${urgentCount}`;
                }
                ticketCountEl.title = tooltipText;
            }
        }
        
        function startSupportTicketCountUpdates() {
            // Initial fetch
            fetchSupportTicketCount();
            
            // Set up periodic updates every 60 seconds (less frequent than system status)
            supportTicketCountInterval = setInterval(fetchSupportTicketCount, 60000);
        }
        
        function stopSupportTicketCountUpdates() {
            if (supportTicketCountInterval) {
                clearInterval(supportTicketCountInterval);
                supportTicketCountInterval = null;
            }
        }

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');

        mobileMenuBtn?.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            mobileMenuOverlay.classList.remove('hidden');
        });

        mobileMenuOverlay?.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            mobileMenuOverlay.classList.add('hidden');
        });

        // Navigation functionality
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-white/10', 'border', 'border-white/20', 'text-white');
                item.classList.add('text-slate-300', 'hover:text-white', 'hover:bg-white/10');
            });

            const activeNav = document.getElementById(`nav-${sectionName}`);
            if (activeNav) {
                activeNav.classList.remove('text-slate-300', 'hover:text-white', 'hover:bg-white/10');
                activeNav.classList.add('bg-white/10', 'border', 'border-white/20', 'text-white');
            }

            // Update page title
            const titles = {
                'dashboard': 'Dashboard Overview',
                'user-management': 'User Management',
                'employee-management': 'Employee Management',
                'announcements': 'Announcements',
                'reviews': 'Reviews Management',
                'support': 'Support Tickets',
                'faq': 'FAQ Management',
                'email-management': 'Email Management',
                'contact-details': 'Contact Details',
                'legal-documents': 'Legal Documents'
            };

            const subtitles = {
                'dashboard': 'Manage your bakery analytics system',
                'user-management': 'Manage user accounts, roles, and permissions',
                'employee-management': 'Manage employee records, work assignments, and user account linking',
                'announcements': 'Create and manage system announcements',
                'reviews': 'Monitor and manage customer reviews',
                'support': 'Handle customer support tickets',
                'faq': 'Manage frequently asked questions',
                'email-management': 'Manage email alerts and PDF attachments',
                'contact-details': 'Manage contact information and support channels',
                'legal-documents': 'Manage privacy policy, terms of service, and compliance documents'
            };

            document.getElementById('pageTitle').textContent = titles[sectionName] || 'Dashboard';
            document.getElementById('pageSubtitle').textContent = subtitles[sectionName] || 'System management';
            currentSection = sectionName;

            // Load section data
            loadSectionData(sectionName);

            // Close mobile menu
            sidebar.classList.add('-translate-x-full');
            mobileMenuOverlay.classList.add('hidden');
        }

        // Load section-specific data
        async function loadSectionData(sectionName) {
            showLoading();
            try {
                switch (sectionName) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'user-management':
                        await loadUsers();
                        await loadWeeks();
                        break;
                    case 'employee-management':
                        await loadEmployees();
                        break;
                    case 'announcements':
                        await loadAnnouncements();
                        break;
                    case 'reviews':
                        await loadReviews();
                        break;
                    case 'support':
                        await loadSupportTickets();
                        break;
                    case 'faq':
                        await loadFAQs();
                        break;
                    case 'email-management':
                        await loadEmailRecipients();
                        await loadEmailWeeks();
                        await loadEmailActivityLog();
                        break;
                    case 'contact-details':
                        await loadContactList();
                        await loadContactStats();
                        break;
                    case 'legal-documents':
                        await loadLegalDocuments();
                        break;
                }
            } catch (error) {
                console.error('Error loading section data:', error);
                showError('Failed to load data');
            } finally {
                hideLoading();
            }
        }

        // Dashboard data loading
        async function loadDashboardData() {
            try {
                // Load user count
                const usersRes = await fetch('/api/users');
                const usersData = await usersRes.json();
                document.getElementById('totalUsers').textContent = usersData.users?.length || 0;
                document.getElementById('onlineUsers').textContent = Math.floor(Math.random() * 10) + 1;

                // Load other stats
                document.getElementById('totalAnnouncements').textContent = allAnnouncements.length;
                document.getElementById('totalTickets').textContent = allTickets.length;
                document.getElementById('totalReviews').textContent = allReviews.length;
                document.getElementById('ticketCount').textContent = allTickets.filter(t => t.status === 'open').length;

                // Load recent activity
                loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function loadRecentActivity() {
            const activities = [
                { icon: 'user-plus', text: 'New user registered', time: '2 hours ago', color: 'text-green-600' },
                { icon: 'megaphone', text: 'New announcement posted', time: '4 hours ago', color: 'text-blue-600' },
                { icon: 'life-buoy', text: 'Support ticket resolved', time: '6 hours ago', color: 'text-purple-600' },
                { icon: 'star', text: 'New 5-star review received', time: '8 hours ago', color: 'text-yellow-600' }
            ];

            const container = document.getElementById('recentActivity');
            container.innerHTML = activities.map(activity => `
                <div class="flex items-center space-x-4 p-4 bg-gray-50/50 rounded-xl">
                    <div class="p-2 bg-white rounded-lg">
                        <i data-lucide="${activity.icon}" class="w-5 h-5 ${activity.color}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${activity.text}</p>
                        <p class="text-xs text-gray-500">${activity.time}</p>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // Load users data
        async function loadUsers() {
            try {
                // Add cache-busting parameter to ensure fresh data
                const response = await fetch(`/api/users?_t=${Date.now()}`);
                const data = await response.json();

                if (data.success || data.users) {
                    allUsers = data.users || [];
                    renderUsers(allUsers);
                    updateUserStats();
                } else {
                    throw new Error(data.message || 'Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users');
            }
        }

        // Format last login date properly
        function formatLastLogin(lastLogin) {
            // Check if lastLogin is null, undefined, empty string, or "Invalid Date"
            if (!lastLogin || 
                lastLogin === 'null' || 
                lastLogin === 'undefined' || 
                lastLogin === '' ||
                lastLogin === 'Invalid Date') {
                return 'Not logged in';
            }
            
            try {
                const date = new Date(lastLogin);
                // Check if the date is valid
                if (isNaN(date.getTime())) {
                    return 'Not logged in';
                }
                
                // Format as: Aug 21, 2025, 3:42 PM
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (error) {
                console.warn('Error formatting last login date:', error);
                return 'Not logged in';
            }
        }

        // Helper function to format role names for display
        function formatRoleName(role) {
            if (!role) return 'User';
            
            // Capitalize first letter and handle common role names
            const roleMap = {
                'admin': 'Administrator',
                'administrator': 'Administrator', 
                'supervisor': 'Supervisor',
                'user': 'User',
                'manager': 'Manager',
                'moderator': 'Moderator',
                'staff': 'Staff'
            };
            
            const lowerRole = role.toLowerCase();
            return roleMap[lowerRole] || role.charAt(0).toUpperCase() + role.slice(1).toLowerCase();
        }

        // Helper function to get role CSS class
        function getRoleClass(role) {
            if (!role) return 'role-user';
            
            const lowerRole = role.toLowerCase();
            if (lowerRole === 'admin' || lowerRole === 'administrator') {
                return 'role-admin';
            } else if (lowerRole === 'supervisor' || lowerRole === 'manager') {
                return 'role-supervisor';
            }
            return 'role-user';
        }

        // Helper function to get role icon
        function getRoleIcon(role) {
            if (!role) return 'user';
            
            const lowerRole = role.toLowerCase();
            if (lowerRole === 'admin' || lowerRole === 'administrator') {
                return 'shield';
            } else if (lowerRole === 'supervisor' || lowerRole === 'manager') {
                return 'user-check';
            }
            return 'user';
        }

        // Helper function to format phone number display
        function formatPhoneDisplay(user) {
            // Debug: Log user object to see what fields are available for specific user
            if (user && (user.email === 'geraldnyah4@gmail.com' || user.first === 'Tchouminyi')) {
                console.log('User object for phone debug:', user);
                console.log('Available fields:', Object.keys(user));
                console.log('Phone field value:', user.phone);
            }
            
            // Try different possible phone field names (common variations)
            const phone = user.phone || 
                         user.phone_number || 
                         user.phoneNumber || 
                         user.Phone || 
                         user.mobile || 
                         user.mobile_number || 
                         user.cellphone || 
                         user.contact_number ||
                         user.tel ||
                         user.telephone ||
                         '';
                         
            // Return phone if it exists and is not empty/null
            if (phone && phone.trim() !== '') {
                return phone.trim();
            }
            
            return 'No phone';
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            const emptyState = document.getElementById('emptyState');

            if (users.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tbody.innerHTML = users.map(user => `
        <tr id="user-row-${user.id}" class="user-row ${!user.is_active ? 'inactive' : ''} hover:bg-blue-50/50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold">
                            ${(user.first_name || user.first || '').charAt(0).toUpperCase()}
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">
                            ${user.first_name || user.first || ''} ${user.last_name || user.last || ''}
                        </div>
                        <div class="text-sm text-gray-500">${formatPhoneDisplay(user)}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${user.email}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${getRoleClass(user.role)}">
                    <i data-lucide="${getRoleIcon(user.role)}" class="w-3 h-3 mr-1"></i>
                    ${formatRoleName(user.role)}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span id="status-badge-${user.id}" class="status-badge inline-flex px-3 py-1 text-xs font-semibold rounded-full ${user.is_active ? 'status-active' : 'status-inactive'}">
                    <i data-lucide="${user.is_active ? 'check-circle' : 'x-circle'}" class="w-3 h-3 mr-1"></i>
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatLastLogin(user.last_login)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <div class="flex items-center justify-center space-x-4">
                    <button onclick="editUser('${user.id}')" 
                        class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit User">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                    </button>
                    <div class="status-checkbox-wrapper" 
                         data-tooltip="${user.is_active ? 'Deactivate user' : 'Activate user'}">
                        <input type="checkbox" 
                               class="status-checkbox" 
                               id="checkbox-${user.id}"
                               ${user.is_active ? 'checked' : ''} 
                               onchange="toggleUserStatusCheckbox('${user.id}', this.checked, event)"
                               onkeydown="handleCheckboxKeydown(event, '${user.id}')"
                               aria-label="${user.is_active ? 'Deactivate user' : 'Activate user'}"
                               title="${user.is_active ? 'Deactivate user' : 'Activate user'}"
                               tabindex="0">
                    </div>
                </div>
            </td>
        </tr>
    `).join('');

            lucide.createIcons();
        }

        // Update individual user row instantly (optimistic UI)
        function updateUserRowInstantly(userId, newStatus) {
            const row = document.getElementById(`user-row-${userId}`);
            const badge = document.getElementById(`status-badge-${userId}`);
            const checkbox = document.getElementById(`checkbox-${userId}`);
            const wrapper = checkbox?.closest('.status-checkbox-wrapper');
            
            if (!row || !badge) return;

            // Update row styling with smooth transition
            if (newStatus) {
                row.classList.remove('inactive');
            } else {
                row.classList.add('inactive');
            }

            // Update status badge
            badge.className = `status-badge inline-flex px-3 py-1 text-xs font-semibold rounded-full ${newStatus ? 'status-active' : 'status-inactive'}`;
            badge.innerHTML = `
                <i data-lucide="${newStatus ? 'check-circle' : 'x-circle'}" class="w-3 h-3 mr-1"></i>
                ${newStatus ? 'Active' : 'Inactive'}
            `;

            // Update tooltip
            if (wrapper) {
                const newTooltip = newStatus ? 'Deactivate user' : 'Activate user';
                wrapper.setAttribute('data-tooltip', newTooltip);
                checkbox.setAttribute('aria-label', newTooltip);
                checkbox.setAttribute('title', newTooltip);
            }

            // Recreate icons for the updated badge
            lucide.createIcons();
        }

        // Add updating state to row
        function setUserRowUpdating(userId, isUpdating) {
            const row = document.getElementById(`user-row-${userId}`);
            const badge = document.getElementById(`status-badge-${userId}`);
            const checkbox = document.getElementById(`checkbox-${userId}`);
            
            if (row) {
                if (isUpdating) {
                    row.classList.add('updating');
                } else {
                    row.classList.remove('updating');
                }
            }
            
            if (badge) {
                if (isUpdating) {
                    badge.classList.add('updating');
                } else {
                    badge.classList.remove('updating');
                }
            }
            
            if (checkbox) {
                checkbox.disabled = isUpdating;
            }
        }

        // Revert user row to previous state (on error)
        function revertUserRow(userId, originalStatus) {
            const checkbox = document.getElementById(`checkbox-${userId}`);
            if (checkbox) {
                checkbox.checked = originalStatus;
            }
            updateUserRowInstantly(userId, originalStatus);
        }

        // Announce message to screen readers
        function announceToScreenReader(message) {
            const announcer = document.getElementById('accessibilityAnnouncements');
            if (announcer) {
                announcer.textContent = message;
                // Clear after a short delay to allow for repeated announcements
                setTimeout(() => {
                    announcer.textContent = '';
                }, 1000);
            }
        }

        // Update user statistics
        function updateUserStats() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(user => user.is_active).length;
            const adminUsers = allUsers.filter(user => {
                const role = (user.role || '').toLowerCase();
                return role === 'admin' || role === 'administrator';
            }).length;

            document.getElementById('totalUsersUM').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('adminUsers').textContent = adminUsers;
        }

        // Password functionality
        function generateSecurePassword() {
            // Generate a simple temporary password for admin-created accounts
            const simplePasswords = [
                'temp123', 'user123', 'pass123', 'admin123', 
                'welcome', 'password', 'temp2024', 'user2024',
                'start123', 'login123', 'access123', 'begin123'
            ];
            
            const password = simplePasswords[Math.floor(Math.random() * simplePasswords.length)];
            
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (passwordInput) passwordInput.value = password;
            if (confirmPasswordInput) confirmPasswordInput.value = password;
            
            checkPasswordStrength(password);
            checkPasswordMatch();
        }

        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrengthProgress');
            const strengthText = document.getElementById('passwordStrength');
            
            // For admin-created temporary passwords, always show as acceptable
            strengthBar.style.width = '100%';
            strengthBar.style.backgroundColor = '#10b981';
            strengthText.textContent = 'Temporary Password';
            strengthText.style.color = '#10b981';
            
            // Always return true - no restrictions for admin-created passwords
            return true;
        }

        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchStatus = document.getElementById('passwordMatchStatus');
            
            if (confirmPassword === '') {
                matchStatus.textContent = '';
                return false;
            }
            
            if (password === confirmPassword) {
                matchStatus.textContent = 'âœ“ Passwords match';
                matchStatus.style.color = '#10b981';
                return true;
            } else {
                matchStatus.textContent = 'âœ— Passwords do not match';
                matchStatus.style.color = '#ef4444';
                return false;
            }
        }

        // Add event listeners for password validation
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    checkPasswordStrength(this.value);
                    if (confirmPasswordInput.value) {
                        checkPasswordMatch();
                    }
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
        });

        // Show add user modal
        function showAddUserModal() {
            currentEditingUserId = null;
            document.getElementById('modalTitle').textContent = 'Add New User';
            document.getElementById('submitButtonText').textContent = 'Create User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordInfo').style.display = 'block';
            
            // Show password fields for new users
            const passwordSection = document.querySelector('.space-y-4:has(#password)');
            if (passwordSection) passwordSection.style.display = 'block';
            
            // Reset password strength indicators
            document.getElementById('passwordStrength').textContent = '';
            document.getElementById('passwordStrengthProgress').style.width = '0%';
            document.getElementById('passwordMatchStatus').textContent = '';
            
            // Initialize modal for new user creation
            setTimeout(() => {
                // Auto-generate password when modal opens
                generateSecurePassword();
            }, 100);
            
            document.getElementById('userModal').classList.remove('hidden');
        }

        // Edit user
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            currentEditingUserId = userId;
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('submitButtonText').textContent = 'Update User';
            document.getElementById('userId').value = userId;
            document.getElementById('firstName').value = user.first_name || user.first || '';
            document.getElementById('lastName').value = user.last_name || user.last || '';
            document.getElementById('email').value = user.email;
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('role').value = user.role;
            document.getElementById('isActive').checked = user.is_active;

            // Hide password fields and info for editing
            const passwordSection = document.querySelector('.space-y-4:has(#password)');
            if (passwordSection) passwordSection.style.display = 'none';
            document.getElementById('passwordInfo').style.display = 'none';

            // Initialize modal for editing user
            setTimeout(() => {
                // Modal is ready for user interaction
            }, 100);

            document.getElementById('userModal').classList.remove('hidden');
        }

        // Close user modal
        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
            currentEditingUserId = null;
            
            // Reset password fields and validation indicators
            document.getElementById('password').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordStrength').textContent = '';
            document.getElementById('passwordStrengthProgress').style.width = '0%';
            document.getElementById('passwordMatchStatus').textContent = '';
            
            // Reset password inputs to text type (since we removed toggle functionality)
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (passwordInput) passwordInput.type = 'text';
            if (confirmPasswordInput) confirmPasswordInput.type = 'text';
            
            // Reinitialize lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Settings Dropdown Functions
        function toggleSettingsDropdown() {
            const dropdown = document.getElementById('settingsDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('settingsDropdown');
            const button = document.getElementById('settingsDropdownBtn');
            if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Settings Modal Functions
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            updateTimezonePreview();
            loadSavedSettings();
            // Reinitialize lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function updateTimezonePreview() {
            const timezone = document.getElementById('timezoneSelect').value;
            const preview = document.getElementById('timezonePreview');
            
            try {
                const now = new Date();
                const options = {
                    timeZone: timezone,
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                };
                preview.textContent = now.toLocaleString('en-US', options);
            } catch (error) {
                preview.textContent = 'Invalid timezone';
            }
        }

        function loadSavedSettings() {
            // Load settings from the database
            fetch('/api/user-settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.settings) {
                        // Load timezone if saved
                        if (data.settings.timezone) {
                            document.getElementById('timezoneSelect').value = data.settings.timezone.value;
                            updateTimezonePreview();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                    // Fallback to localStorage if API fails
                    const savedTimezone = localStorage.getItem('userTimezone');
                    if (savedTimezone) {
                        document.getElementById('timezoneSelect').value = savedTimezone;
                        updateTimezonePreview();
                    }
                });
        }

        function saveSettings() {
            const timezone = document.getElementById('timezoneSelect').value;
            
            // Prepare settings data
            const settingsData = {
                timezone: timezone
            };
            
            console.log('Saving settings:', settingsData);
            
            // Save to database
            fetch('/api/user-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settingsData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Also save to localStorage as backup
                    localStorage.setItem('userTimezone', timezone);
                    
                    // Clear ALL timezone warning flags from sessionStorage
                    const sessionKeys = Object.keys(sessionStorage);
                    sessionKeys.forEach(key => {
                        if (key.startsWith('lastTimezoneWarning_')) {
                            sessionStorage.removeItem(key);
                            console.log('Cleared session flag:', key);
                        }
                    });
                    
                    // Reset warning count
                    sessionStorage.removeItem('timezoneWarningCount');
                    
                    console.log('âœ… Timezone saved successfully:', timezone);
                    
                    // Reload timezone utilities to use new timezone
                    if (window.TimezoneUtils && window.TimezoneUtils.reloadTimezone) {
                        window.TimezoneUtils.reloadTimezone().then(() => {
                            console.log('ðŸ”„ Timezone utilities reloaded with new timezone');
                        });
                    }
                    
                    // Show success message
                    showSuccess('Settings saved successfully!');
                    
                    // Close modal
                    closeSettingsModal();
                    
                    // Re-check timezone after save to verify it matches now
                    console.log('ðŸ”„ Settings saved, re-checking timezone in 700ms...');
                    setTimeout(() => {
                        checkTimezoneOnLogin();
                    }, 700); // Slightly longer delay to allow modal close + state updates
                } else {
                    showError('Failed to save settings: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                showError('Failed to save settings. Please try again.');
            });
        }

        // Detect user's system timezone
        function getSystemTimezone() {
            return Intl.DateTimeFormat().resolvedOptions().timeZone;
        }

        // Map timezone to closest standard timezone in our list
        function mapToStandardTimezone(detectedTz) {
            // Common timezone mappings
            const timezoneMap = {
                // US timezones
                'America/New_York': 'America/New_York',
                'America/Detroit': 'America/New_York',
                'America/Kentucky/Louisville': 'America/New_York',
                'America/Indiana/Indianapolis': 'America/New_York',
                'America/Chicago': 'America/Chicago',
                'America/Denver': 'America/Denver',
                'America/Phoenix': 'America/Denver',
                'America/Los_Angeles': 'America/Los_Angeles',
                'America/Anchorage': 'America/Anchorage',
                'Pacific/Honolulu': 'Pacific/Honolulu',
                // International
                'UTC': 'UTC',
                'Europe/London': 'Europe/London',
                'Europe/Paris': 'Europe/Paris',
                'Europe/Berlin': 'Europe/Paris',
                'Asia/Tokyo': 'Asia/Tokyo',
                'Australia/Sydney': 'Australia/Sydney'
            };
            
            return timezoneMap[detectedTz] || detectedTz;
        }

        // Check timezone and show warning if mismatch
        async function checkTimezoneOnLogin() {
            const systemTimezone = getSystemTimezone();
            const standardTimezone = mapToStandardTimezone(systemTimezone);
            
            console.log('=== Timezone Check Started ===');
            console.log('Detected system timezone:', systemTimezone);
            console.log('Mapped to standard timezone:', standardTimezone);

            try {
                // Fetch user's saved timezone setting
                const response = await fetch('/api/user-settings/timezone');
                const data = await response.json();

                let savedTimezone = null;
                if (data.success && data.setting_value) {
                    savedTimezone = data.setting_value;
                    console.log('Saved timezone from database:', savedTimezone);
                } else {
                    // No saved timezone, check localStorage
                    savedTimezone = localStorage.getItem('userTimezone');
                    console.log('No database timezone, checked localStorage:', savedTimezone);
                }

                // Compare timezones
                if (!savedTimezone || savedTimezone !== standardTimezone) {
                    console.log('ðŸš¨ TIMEZONE MISMATCH DETECTED!');
                    console.log('System:', standardTimezone, 'vs Saved:', savedTimezone || 'none');
                    console.log('Showing warning modal...');
                    
                    // Increment warning count to track how many times we've shown it
                    let warningCount = parseInt(sessionStorage.getItem('timezoneWarningCount') || '0');
                    warningCount++;
                    sessionStorage.setItem('timezoneWarningCount', warningCount.toString());
                    
                    showTimezoneWarning(systemTimezone, standardTimezone, savedTimezone, warningCount);
                } else {
                    console.log('âœ… Timezone matches! No warning needed.');
                    console.log('System:', standardTimezone, '=== Saved:', savedTimezone);
                    // Reset warning count when timezone finally matches
                    sessionStorage.removeItem('timezoneWarningCount');
                }
                
                console.log('=== Timezone Check Complete ===');
            } catch (error) {
                console.error('âŒ Error checking timezone:', error);
                // Don't show warning if there's an error checking
            }
        }

        // Show timezone warning modal
        function showTimezoneWarning(detectedTz, standardTz, savedTz, warningCount = 1) {
            console.log('ðŸ“¢ Opening timezone warning modal (attempt #' + warningCount + ')...');

            // Pre-select the detected timezone
            document.getElementById('timezoneSelect').value = standardTz;
            updateTimezonePreview();

            // Open settings modal
            openSettingsModal();

            // Add warning message to the modal with escalating emphasis
            const timezoneSection = document.querySelector('#settingsModal .space-y-6 > .border.border-gray-200.rounded-2xl');
            
            // Check if warning already exists
            let warningDiv = document.getElementById('timezoneWarning');
            
            // Determine warning intensity based on count
            let warningClass = 'bg-amber-50 border-2 border-amber-400';
            let warningIcon = 'alert-triangle';
            let warningTitle = 'âš ï¸ Timezone Mismatch Detected';
            let emphasizedText = '';
            
            if (warningCount === 1) {
                warningClass = 'bg-amber-50 border-2 border-amber-400';
                warningTitle = 'âš ï¸ Timezone Mismatch Detected';
                emphasizedText = 'âœ… We have automatically selected the recommended timezone for your location.';
            } else if (warningCount === 2) {
                warningClass = 'bg-orange-100 border-2 border-orange-500';
                warningTitle = 'âš ï¸ Important: Timezone Still Incorrect';
                emphasizedText = 'âš ï¸ <strong>PLEASE UPDATE YOUR TIMEZONE</strong> to ensure accurate time display throughout the application.';
            } else {
                warningClass = 'bg-red-100 border-3 border-red-600';
                warningTitle = 'ðŸš¨ CRITICAL: Timezone Mismatch Persists';
                emphasizedText = 'ðŸš¨ <strong class="text-red-900">ACTION REQUIRED:</strong> Your timezone setting does not match your current location. This will cause incorrect time displays. Please save the recommended timezone now.';
            }
            
            if (warningDiv) {
                // Update existing warning
                warningDiv.className = `mb-4 ${warningClass} rounded-xl p-4 animate-pulse-subtle`;
                warningDiv.innerHTML = `
                    <div class="flex items-start">
                        <i data-lucide="${warningIcon}" class="w-7 h-7 ${warningCount > 2 ? 'text-red-600' : warningCount > 1 ? 'text-orange-600' : 'text-amber-600'} mr-3 flex-shrink-0 mt-0.5"></i>
                        <div class="flex-1">
                            <h5 class="font-bold ${warningCount > 2 ? 'text-red-900' : warningCount > 1 ? 'text-orange-900' : 'text-amber-900'} mb-2 text-lg">${warningTitle}</h5>
                            <p class="text-sm ${warningCount > 2 ? 'text-red-800' : warningCount > 1 ? 'text-orange-800' : 'text-amber-800'} mb-2">
                                Your system timezone (<strong>${detectedTz}</strong>) is different from your saved timezone setting${savedTz ? ` (<strong>${savedTz}</strong>)` : ''}.
                            </p>
                            <p class="text-sm ${warningCount > 2 ? 'text-red-800' : warningCount > 1 ? 'text-orange-800' : 'text-amber-800'} font-medium">
                                ${emphasizedText}
                            </p>
                            ${warningCount > 1 ? `
                            <div class="mt-3 p-2 bg-white bg-opacity-50 rounded border ${warningCount > 2 ? 'border-red-300' : 'border-orange-300'}">
                                <p class="text-xs ${warningCount > 2 ? 'text-red-700' : 'text-orange-700'} font-semibold">
                                    ðŸ’¡ This is reminder #${warningCount}. The recommended timezone (<strong>${standardTz}</strong>) has been pre-selected. Click "Save Settings" below.
                                </p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                warningDiv = document.createElement('div');
                warningDiv.id = 'timezoneWarning';
                warningDiv.className = `mb-4 ${warningClass} rounded-xl p-4 animate-pulse-subtle`;
                warningDiv.innerHTML = `
                    <div class="flex items-start">
                        <i data-lucide="${warningIcon}" class="w-7 h-7 ${warningCount > 2 ? 'text-red-600' : warningCount > 1 ? 'text-orange-600' : 'text-amber-600'} mr-3 flex-shrink-0 mt-0.5"></i>
                        <div class="flex-1">
                            <h5 class="font-bold ${warningCount > 2 ? 'text-red-900' : warningCount > 1 ? 'text-orange-900' : 'text-amber-900'} mb-2 text-lg">${warningTitle}</h5>
                            <p class="text-sm ${warningCount > 2 ? 'text-red-800' : warningCount > 1 ? 'text-orange-800' : 'text-amber-800'} mb-2">
                                Your system timezone (<strong>${detectedTz}</strong>) is different from your saved timezone setting${savedTz ? ` (<strong>${savedTz}</strong>)` : ''}.
                            </p>
                            <p class="text-sm ${warningCount > 2 ? 'text-red-800' : warningCount > 1 ? 'text-orange-800' : 'text-amber-800'} font-medium">
                                ${emphasizedText}
                            </p>
                            ${warningCount > 1 ? `
                            <div class="mt-3 p-2 bg-white bg-opacity-50 rounded border ${warningCount > 2 ? 'border-red-300' : 'border-orange-300'}">
                                <p class="text-xs ${warningCount > 2 ? 'text-red-700' : 'text-orange-700'} font-semibold">
                                    ðŸ’¡ This is reminder #${warningCount}. The recommended timezone (<strong>${standardTz}</strong>) has been pre-selected. Click "Save Settings" below.
                                </p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Insert warning at the beginning of the timezone section
                if (timezoneSection) {
                    const spaceyDiv = timezoneSection.querySelector('.space-y-4');
                    if (spaceyDiv) {
                        spaceyDiv.insertBefore(warningDiv, spaceyDiv.firstChild);
                    }
                }
            }

            // Update save button to be more prominent based on warning count
            const saveButton = document.querySelector('#settingsModal button[onclick="saveSettings()"]');
            if (saveButton) {
                if (warningCount === 1) {
                    saveButton.innerHTML = `
                        <i data-lucide="save" class="w-5 h-5 mr-3 inline"></i>
                        Save Timezone Settings (Recommended)
                    `;
                    saveButton.className = saveButton.className.replace('btn-primary', 'bg-amber-600 hover:bg-amber-700');
                } else if (warningCount === 2) {
                    saveButton.innerHTML = `
                        <i data-lucide="alert-circle" class="w-5 h-5 mr-3 inline"></i>
                        Save Correct Timezone (Important)
                    `;
                    saveButton.className = saveButton.className.replace(/bg-\w+-\d+/g, 'bg-orange-600 hover:bg-orange-700');
                } else {
                    saveButton.innerHTML = `
                        <i data-lucide="alert-triangle" class="w-6 h-6 mr-3 inline animate-pulse"></i>
                        SAVE TIMEZONE NOW (Required)
                    `;
                    saveButton.className = saveButton.className.replace(/bg-\w+-\d+/g, 'bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/50');
                }
            }

            // Reinitialize lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }

            // Add special styling to highlight this is important
            const modal = document.getElementById('settingsModal');
            modal.setAttribute('data-timezone-warning', 'true');
            modal.setAttribute('data-warning-count', warningCount.toString());
        }

        // Override closeSettingsModal to remove warning
        const originalCloseSettingsModal = closeSettingsModal;
        closeSettingsModal = function() {
            console.log('ðŸ”’ Closing settings modal...');
            
            // Remove warning div if it exists
            const warningDiv = document.getElementById('timezoneWarning');
            if (warningDiv) {
                warningDiv.remove();
            }
            
            // Restore save button text and styling
            const saveButton = document.querySelector('#settingsModal button[onclick="saveSettings()"]');
            if (saveButton) {
                saveButton.innerHTML = `
                    <i data-lucide="save" class="w-5 h-5 mr-3 inline"></i>
                    Save Settings
                `;
                saveButton.className = 'btn-primary px-8 py-3.5 rounded-xl text-base font-medium';
                // Reinitialize icons
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }
            
            // Remove warning attributes
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.removeAttribute('data-timezone-warning');
                modal.removeAttribute('data-warning-count');
            }
            
            // Call original close function
            originalCloseSettingsModal();

            // Re-check timezone after modal closes to ensure continuous enforcement
            console.log('ðŸ”„ Modal closed, re-checking timezone in 500ms...');
            setTimeout(() => {
                checkTimezoneOnLogin();
            }, 500); // Small delay to allow modal to fully close
        };

        // Toggle user status
        async function toggleUserStatus(userId, newStatus) {
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_active: newStatus })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                    await loadUsers();
                } else {
                    throw new Error(data.message || 'Failed to update user status');
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                showError('Failed to update user status');
            }
        }

        // Handle keyboard interactions for checkbox
        function handleCheckboxKeydown(event, userId) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                const checkbox = event.target;
                checkbox.checked = !checkbox.checked;
                
                // Create a synthetic event object for consistency
                const syntheticEvent = { target: checkbox };
                toggleUserStatusCheckbox(userId, checkbox.checked, syntheticEvent);
            }
        }

        // Manual trigger for testing timezone check (can be called from console)
        window.forceTimezoneCheck = function() {
            console.log('ðŸ”„ Forcing timezone check...');
            // Clear all timezone warning flags
            const sessionKeys = Object.keys(sessionStorage);
            sessionKeys.forEach(key => {
                if (key.startsWith('lastTimezoneWarning_')) {
                    sessionStorage.removeItem(key);
                }
            });
            // Run the check
            checkTimezoneOnLogin();
        };

        // Toggle user status via checkbox
        async function toggleUserStatusCheckbox(userId, isChecked, event) {
            // Store the original state for potential rollback
            const originalStatus = !isChecked;
            
            // Check for self-deactivation (only block deactivation attempts)
            if (!isChecked && userId === currentUserId) {
                // Revert checkbox immediately
                const checkbox = event ? event.target : document.getElementById(`checkbox-${userId}`);
                if (checkbox) {
                    checkbox.checked = originalStatus;
                }
                
                // Show warning message
                const warningMessage = "You can't deactivate your own admin account while you're signed in.";
                showError(warningMessage);
                
                // Announce to screen readers
                announceToScreenReader(warningMessage);
                
                return; // Exit function early
            }
            
            try {
                // Get the checkbox element
                const checkbox = event ? event.target : document.getElementById(`checkbox-${userId}`);
                
                // 1. OPTIMISTIC UI UPDATE: Update UI instantly
                updateUserRowInstantly(userId, isChecked);
                
                // 2. Set updating state (disable checkbox, show loading)
                setUserRowUpdating(userId, true);

                // Find the user data from our local cache
                const user = allUsers.find(u => u.id == userId);
                if (!user) {
                    throw new Error('User not found in local data');
                }

                // Update local data optimistically
                user.is_active = isChecked;

                // Update stats immediately
                updateUserStats();

                // Prepare the full user data for PUT request
                const userData = {
                    first_name: user.first_name || user.first || '',
                    last_name: user.last_name || user.last || '',
                    email: user.email,
                    phone: user.phone || '',
                    role: user.role,
                    is_active: isChecked
                };

                // 3. Send API request
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // 4. Success: Remove updating state and show success message
                    setUserRowUpdating(userId, false);
                    showSuccess(`User ${isChecked ? 'activated' : 'deactivated'} successfully!`);
                    
                    // Add a brief visual feedback to checkbox
                    if (checkbox) {
                        checkbox.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            checkbox.style.transform = 'scale(1)';
                        }, 150);
                    }
                    
                } else {
                    throw new Error(data.message || 'Failed to update user status');
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                showError('Failed to update user status: ' + error.message);
                
                // 5. ERROR: Revert optimistic changes
                setUserRowUpdating(userId, false);
                
                // Revert local data
                const user = allUsers.find(u => u.id == userId);
                if (user) {
                    user.is_active = originalStatus;
                }
                
                // Revert UI
                revertUserRow(userId, originalStatus);
                
                // Update stats to reflect reverted state
                updateUserStats();
            }
        }

        // Delete user
        // Delete user function (Note: No longer used in UI - replaced with activate/deactivate checkbox)
        function deleteUser(userId, userName) {
            console.log('Attempting to delete user with ID:', userId, 'Name:', userName);
            
            // Validate UUID format on frontend
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(userId)) {
                showError(`Invalid user ID format: ${userId}. Please refresh the page and try again.`);
                return;
            }
            
            showDeleteModal(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`, async () => {
                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('User deleted successfully!');
                        await loadUsers();
                    } else {
                        throw new Error(data.message || 'Failed to delete user');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showError(`Failed to delete user: ${error.message}`);
                }
            });
        }

        // Form submission
        document.getElementById('userForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Validate passwords for new users - minimal validation only
            if (!currentEditingUserId) {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!password || !confirmPassword) {
                    showError('Password and confirm password are required for new users');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }
                
                // No minimum length or complexity requirements for admin-created accounts
                // Users will set their own secure password on first login
            }

            const formData = {
                first_name: document.getElementById('firstName').value.trim(),
                last_name: document.getElementById('lastName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim() || null,
                role: document.getElementById('role').value,
                is_active: document.getElementById('isActive').checked
            };

            // Add password only for new users
            if (!currentEditingUserId) {
                formData.password = document.getElementById('password').value;
            }

            // Debug logging
            console.log('Form data being sent:', formData);
            console.log('Current editing user ID:', currentEditingUserId);

            try {
                const url = currentEditingUserId ? `/api/users/${currentEditingUserId}` : '/api/users';
                const method = currentEditingUserId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    // Try to get the error message from the response
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || `HTTP error! status: ${response.status}`;
                        console.error('Server error response:', errorData);
                    } catch (e) {
                        errorMessage = `HTTP error! status: ${response.status}`;
                        console.error('Failed to parse error response as JSON');
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (data.success) {
                    showSuccess(`User ${currentEditingUserId ? 'updated' : 'created'} successfully!`);
                    closeUserModal();
                    await loadUsers();
                } else {
                    throw new Error(data.message || `Failed to ${currentEditingUserId ? 'update' : 'create'} user`);
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showError(`Failed to ${currentEditingUserId ? 'update' : 'create'} user: ${error.message}`);
            }
        });

        // Search and filter functionality
        document.getElementById('userSearchInput').addEventListener('input', function () {
            filterUsers();
        });

        document.getElementById('userRoleFilter').addEventListener('change', function () {
            filterUsers();
        });

        document.getElementById('userStatusFilter').addEventListener('change', function () {
            filterUsers();
        });

        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const roleFilter = document.getElementById('userRoleFilter').value;
            const statusFilter = document.getElementById('userStatusFilter').value;

            const filtered = allUsers.filter(user => {
                const fullName = `${user.first_name || user.first || ''} ${user.last_name || user.last || ''}`.toLowerCase();
                const matchesSearch = fullName.includes(searchTerm) || user.email.toLowerCase().includes(searchTerm);
                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesStatus = statusFilter === '' || user.is_active.toString() === statusFilter;

                return matchesSearch && matchesRole && matchesStatus;
            });

            renderUsers(filtered);
        }

        // ========================================
        // EMPLOYEE MANAGEMENT FUNCTIONS
        // ========================================

        let allEmployees = [];
        let currentEditingEmployeeId = null;

        // Load all employees
        async function loadEmployees() {
            try {
                console.log('Loading employees...'); // Debug log
                const response = await fetch('/api/employees');
                const data = await response.json();
                
                console.log('API Response:', data); // Debug log

                if (data.success) {
                    allEmployees = data.employees || [];
                    console.log('All employees:', allEmployees); // Debug log
                    renderEmployees(allEmployees);
                    updateEmployeeStats();
                    populateEmployeeFilters();
                } else {
                    console.error('Failed to load employees:', data.message); // Debug log
                    showError(data.message || 'Failed to load employees');
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                showError('Failed to load employees: ' + error.message);
            }
        }

        // Render employees table
        function renderEmployees(employees) {
            const tbody = document.getElementById('employeesTableBody');
            const emptyState = document.getElementById('employeesEmptyState');
            
            console.log('Rendering employees:', employees); // Debug log

            if (!employees || employees.length === 0) {
                tbody.innerHTML = '';
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            }

            if (emptyState) emptyState.classList.add('hidden');

            tbody.innerHTML = employees.map(emp => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                                ${(emp.firstname?.charAt(0) || '') + (emp.lastname?.charAt(0) || '')}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">${emp.firstname || ''} ${emp.lastname || ''}</div>
                                <div class="text-sm text-gray-500">ID: ${emp.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${emp.email || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${emp.phonenumber || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${emp.department || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${emp.role || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            emp.shift === 'First' ? 'bg-blue-100 text-blue-800' :
                            emp.shift === 'Second' ? 'bg-purple-100 text-purple-800' :
                            emp.shift === 'Night' ? 'bg-indigo-100 text-indigo-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${emp.shift || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${emp.workline || 'N/A'}</div>
                        <div class="text-xs text-gray-500">${emp.workarea || ''}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="editEmployee(${emp.id})"
                                class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                title="Edit employee">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteEmployee(${emp.id}, '${emp.firstname} ${emp.lastname}')"
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Delete employee">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Reinitialize lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Update employee statistics
        function updateEmployeeStats() {
            const totalEmployees = allEmployees.length;
            const departments = new Set(allEmployees.filter(e => e.department).map(e => e.department));
            const workLines = new Set(allEmployees.filter(e => e.workline).map(e => e.workline));
            const shifts = new Set(allEmployees.filter(e => e.shift).map(e => e.shift));

            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('totalDepartments').textContent = departments.size;
            document.getElementById('totalWorkLines').textContent = workLines.size;
            document.getElementById('totalShifts').textContent = shifts.size;
        }

        // Populate filter dropdowns
        function populateEmployeeFilters() {
            const departments = [...new Set(allEmployees.filter(e => e.department).map(e => e.department))].sort();
            const shifts = [...new Set(allEmployees.filter(e => e.shift).map(e => e.shift))].sort();
            const workLines = [...new Set(allEmployees.filter(e => e.workline).map(e => e.workline))].sort();

            const deptFilter = document.getElementById('employeeDepartmentFilter');
            const shiftFilter = document.getElementById('employeeShiftFilter');
            const workLineFilter = document.getElementById('employeeWorkLineFilter');

            if (deptFilter) {
                deptFilter.innerHTML = '<option value="">All Departments</option>' +
                    departments.map(d => `<option value="${d}">${d}</option>`).join('');
            }

            if (shiftFilter) {
                shiftFilter.innerHTML = '<option value="">All Shifts</option>' +
                    shifts.map(s => `<option value="${s}">${s}</option>`).join('');
            }

            if (workLineFilter) {
                workLineFilter.innerHTML = '<option value="">All Work Lines</option>' +
                    workLines.map(w => `<option value="${w}">${w}</option>`).join('');
            }
        }

        // Vacation Schedule Management
        let vacationScheduleData = [];

        function addVacationScheduleRow(year = '', hours = '') {
            // Check if Maximum Accumulated Hours has a value
            const maxAccumulatedHours = document.getElementById('empMaxAccumulatedHours');
            const warningDiv = document.getElementById('vacationScheduleWarning');
            
            if (!maxAccumulatedHours.value || maxAccumulatedHours.value.trim() === '' || parseFloat(maxAccumulatedHours.value) <= 0) {
                // Show warning message
                if (warningDiv) {
                    warningDiv.classList.remove('hidden');
                    // Re-initialize icons for the warning
                    lucide.createIcons();
                    
                    // Scroll to warning message
                    warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add a pulse animation to draw attention
                    warningDiv.classList.add('animate-pulse');
                    setTimeout(() => {
                        warningDiv.classList.remove('animate-pulse');
                    }, 2000);
                }
                
                // Focus on the Maximum Accumulated Hours field
                maxAccumulatedHours.focus();
                maxAccumulatedHours.classList.add('border-orange-400', 'ring-2', 'ring-orange-200');
                setTimeout(() => {
                    maxAccumulatedHours.classList.remove('border-orange-400', 'ring-2', 'ring-orange-200');
                }, 3000);
                
                return; // Prevent adding the row
            }
            
            // Hide warning if it was visible
            if (warningDiv) {
                warningDiv.classList.add('hidden');
            }
            
            const container = document.getElementById('vacationScheduleRows');
            const rowId = `vacation-row-${Date.now()}-${Math.random()}`;
            
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'grid grid-cols-12 gap-3 p-2 bg-white rounded-xl border border-indigo-100 hover:border-indigo-300 transition-colors';
            row.innerHTML = `
                <div class="col-span-5">
                    <input type="number" class="form-input text-sm" placeholder="Year (e.g., 1, 2, 3)" 
                        min="1" step="1" value="${year}"
                        onchange="updateVacationScheduleData()">
                </div>
                <div class="col-span-6">
                    <input type="number" class="form-input text-sm" placeholder="Hours (e.g., 80, 100, 120)" 
                        min="0" step="1" value="${hours}"
                        onchange="updateVacationScheduleData()">
                </div>
                <div class="col-span-1 flex items-center justify-center">
                    <button type="button" onclick="removeVacationScheduleRow('${rowId}')" 
                        class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                        title="Remove">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(row);
            lucide.createIcons();
            updateVacationScheduleVisibility();
            updateVacationScheduleData();
        }

        function removeVacationScheduleRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateVacationScheduleVisibility();
                updateVacationScheduleData();
            }
        }

        function updateVacationScheduleVisibility() {
            const container = document.getElementById('vacationScheduleRows');
            const emptyState = document.getElementById('vacationScheduleEmpty');
            const hasRows = container.children.length > 0;
            
            if (hasRows) {
                emptyState.classList.add('hidden');
            } else {
                emptyState.classList.remove('hidden');
            }
        }

        function updateVacationScheduleData() {
            const container = document.getElementById('vacationScheduleRows');
            vacationScheduleData = [];
            
            Array.from(container.children).forEach(row => {
                const inputs = row.querySelectorAll('input');
                const year = parseInt(inputs[0].value);
                const hours = parseInt(inputs[1].value);
                
                if (!isNaN(year) && !isNaN(hours)) {
                    vacationScheduleData.push({ year, hours });
                }
            });
            
            // Recalculate allocated vacation hours when schedule changes
            calculateAllocatedVacationHours();
        }

        function calculateAllocatedVacationHours() {
            const dateOfEmployment = document.getElementById('empDateOfEmployment').value;
            
            if (!dateOfEmployment || vacationScheduleData.length === 0) {
                document.getElementById('empVacationHours').value = '';
                return;
            }
            
            // Calculate years of service
            const employmentDate = new Date(dateOfEmployment);
            const today = new Date();
            const diffTime = today - employmentDate;
            const diffYears = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 365.25));
            
            // If less than 1 year of service, allocate 0 hours
            if (diffYears < 1) {
                document.getElementById('empVacationHours').value = 0;
                return;
            }
            
            // Calculate years of service (minimum 1 year if >= 1 year)
            const yearsOfService = diffYears + 1;
            
            // Sort schedule by year ascending
            const sortedSchedule = [...vacationScheduleData].sort((a, b) => a.year - b.year);
            
            // Find matching vacation hours for current year of service
            let allocatedHours = 0;
            
            for (let i = sortedSchedule.length - 1; i >= 0; i--) {
                if (yearsOfService >= sortedSchedule[i].year) {
                    allocatedHours = sortedSchedule[i].hours;
                    break;
                }
            }
            
            // If no match found but schedule exists, use the first year's hours
            if (allocatedHours === 0 && sortedSchedule.length > 0) {
                allocatedHours = sortedSchedule[0].hours;
            }
            
            document.getElementById('empVacationHours').value = allocatedHours;
        }

        function clearVacationSchedule() {
            const container = document.getElementById('vacationScheduleRows');
            container.innerHTML = '';
            vacationScheduleData = [];
            updateVacationScheduleVisibility();
        }

        function hideVacationScheduleWarning() {
            const maxAccumulatedHours = document.getElementById('empMaxAccumulatedHours');
            const warningDiv = document.getElementById('vacationScheduleWarning');
            
            // Hide warning if a valid value is entered
            if (warningDiv && maxAccumulatedHours.value && maxAccumulatedHours.value.trim() !== '' && parseFloat(maxAccumulatedHours.value) > 0) {
                warningDiv.classList.add('hidden');
            }
        }

        function loadVacationSchedule(years, hours) {
            clearVacationSchedule();
            
            if (years && hours && years.length === hours.length) {
                for (let i = 0; i < years.length; i++) {
                    addVacationScheduleRow(years[i], hours[i]);
                }
            }
            
            updateVacationScheduleVisibility();
            // Trigger recalculation after loading schedule
            calculateAllocatedVacationHours();
        }

        // Show add employee modal
        async function showAddEmployeeModal() {
            currentEditingEmployeeId = null;
            document.getElementById('employeeModalTitle').textContent = 'Add New Employee';
            document.getElementById('employeeSubmitButtonText').textContent = 'Create Employee';
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = '';
            
            // Clear vacation schedule
            clearVacationSchedule();
            
            // Hide warning message
            const warningDiv = document.getElementById('vacationScheduleWarning');
            if (warningDiv) {
                warningDiv.classList.add('hidden');
            }

            // Load users for linking
            await populateUserDropdown();
            
            // Load supervisors and managers
            await populateSupervisorDropdown();
            await populateManagerDropdown();
            
            // Load assets data for dropdowns
            await populateEmployeeDropdowns();

            document.getElementById('employeeModal').classList.remove('hidden');
        }
        
        // Populate employee form dropdowns from assets
        async function populateEmployeeDropdowns() {
            try {
                const response = await fetch('/api/assets');
                const data = await response.json();
                
                console.log('Assets API response:', data); // Debug log

                if (data.success && data.assets) {
                    const assets = data.assets;
                    
                    // Populate Departments dropdown (use camelCase as returned by API)
                    const deptSelect = document.getElementById('empDepartment');
                    if (deptSelect && assets.departments && assets.departments.length > 0) {
                        deptSelect.innerHTML = '<option value="">Select Department</option>' +
                            assets.departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
                    }
                    
                    // Populate Roles dropdown (use camelCase: workRoles)
                    const roleSelect = document.getElementById('empRole');
                    if (roleSelect && assets.workRoles && assets.workRoles.length > 0) {
                        roleSelect.innerHTML = '<option value="">Select Role</option>' +
                            assets.workRoles.map(role => `<option value="${role}">${role}</option>`).join('');
                    }
                    
                    // Populate Shifts dropdown (use camelCase: shiftsNames)
                    const shiftSelect = document.getElementById('empShift');
                    if (shiftSelect && assets.shiftsNames && assets.shiftsNames.length > 0) {
                        shiftSelect.innerHTML = '<option value="">Select Shift</option>' +
                            assets.shiftsNames.map(shift => `<option value="${shift}">${shift}</option>`).join('');
                    }
                    
                    // Populate Work Lines dropdown (use camelCase: workLines)
                    const workLineSelect = document.getElementById('empWorkLine');
                    if (workLineSelect && assets.workLines && assets.workLines.length > 0) {
                        workLineSelect.innerHTML = '<option value="">Select Work Line</option>' +
                            assets.workLines.map(line => `<option value="${line}">${line}</option>`).join('');
                    }
                    
                    // Populate Work Areas dropdown (use camelCase: workAreas)
                    const workAreaSelect = document.getElementById('empWorkArea');
                    if (workAreaSelect && assets.workAreas && assets.workAreas.length > 0) {
                        workAreaSelect.innerHTML = '<option value="">Select Work Area</option>' +
                            assets.workAreas.map(area => `<option value="${area}">${area}</option>`).join('');
                    }
                    
                    console.log('Dropdowns populated successfully'); // Debug log
                } else {
                    console.warn('No assets data found or API call failed'); // Debug log
                }
            } catch (error) {
                console.error('Error loading assets for employee form:', error);
            }
        }

        // Close employee modal
        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
            currentEditingEmployeeId = null;
            
            // Hide warning message
            const warningDiv = document.getElementById('vacationScheduleWarning');
            if (warningDiv) {
                warningDiv.classList.add('hidden');
            }

            // Reinitialize lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Populate user dropdown for linking
        async function populateUserDropdown() {
            try {
                console.log('Loading users for employee linking...'); // Debug log
                // Filter to show users with role='user' or role='employee' for employee linking
                const response = await fetch('/api/users?role=user,employee');
                const data = await response.json();
                
                console.log('Users API response (role=user,employee):', data); // Debug log

                if (data.success) {
                    const users = data.users || [];
                    const dropdown = document.getElementById('empUserId');
                    
                    console.log('Found users with role=user or employee:', users.length); // Debug log

                    if (users.length > 0) {
                        dropdown.innerHTML = '<option value="">No user account linked</option>' +
                            users.map(u => `<option value="${u.id}">${u.email} - ${u.first_name} ${u.last_name}</option>`).join('');
                        console.log('User dropdown populated with', users.length, 'user/employee accounts'); // Debug log
                    } else {
                        dropdown.innerHTML = '<option value="">No user account linked</option><option disabled>No users available</option>';
                        console.warn('No users with role=user or employee found in database'); // Debug log
                    }
                } else {
                    console.error('Failed to load users:', data.message); // Debug log
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Populate supervisor dropdown
        async function populateSupervisorDropdown() {
            try {
                console.log('Loading supervisors...'); // Debug log
                const response = await fetch('/api/users?role=supervisor');
                const data = await response.json();
                
                console.log('Supervisors API response:', data); // Debug log

                if (data.success) {
                    const supervisors = data.users || [];
                    const dropdown = document.getElementById('empSupervisor');
                    
                    console.log('Found supervisors:', supervisors.length); // Debug log

                    if (supervisors.length > 0) {
                        dropdown.innerHTML = '<option value="">Select Supervisor</option>' +
                            supervisors.map(s => `<option value="${s.first_name} ${s.last_name}">${s.first_name} ${s.last_name}</option>`).join('');
                        console.log('Supervisor dropdown populated with', supervisors.length, 'supervisors'); // Debug log
                    } else {
                        dropdown.innerHTML = '<option value="">Select Supervisor</option><option disabled>No supervisors available</option>';
                        console.warn('No supervisors found in database'); // Debug log
                    }
                } else {
                    console.error('Failed to load supervisors:', data.message); // Debug log
                }
            } catch (error) {
                console.error('Error loading supervisors:', error);
            }
        }

        // Populate manager dropdown
        async function populateManagerDropdown() {
            try {
                console.log('Loading managers (admins)...'); // Debug log
                const response = await fetch('/api/users?role=admin');
                const data = await response.json();
                
                console.log('Managers API response (role=admin):', data); // Debug log

                if (data.success) {
                    const managers = data.users || [];
                    const dropdown = document.getElementById('empManager');
                    
                    console.log('Found managers (admins):', managers.length); // Debug log

                    if (managers.length > 0) {
                        dropdown.innerHTML = '<option value="">Select Manager</option>' +
                            managers.map(m => `<option value="${m.first_name} ${m.last_name}">${m.first_name} ${m.last_name}</option>`).join('');
                        console.log('Manager dropdown populated with', managers.length, 'admins'); // Debug log
                    } else {
                        dropdown.innerHTML = '<option value="">Select Manager</option><option disabled>No managers available</option>';
                        console.warn('No admins found in database'); // Debug log
                    }
                } else {
                    console.error('Failed to load managers:', data.message); // Debug log
                }
            } catch (error) {
                console.error('Error loading managers:', error);
            }
        }

        // Edit employee
        async function editEmployee(employeeId) {
            try {
                const response = await fetch(`/api/employees/${employeeId}`);
                const data = await response.json();

                if (data.success && data.employee) {
                    const emp = data.employee;
                    currentEditingEmployeeId = employeeId;

                    document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
                    document.getElementById('employeeSubmitButtonText').textContent = 'Update Employee';
                    document.getElementById('employeeId').value = emp.id;
                    
                    // Load dropdowns first
                    await populateUserDropdown();
                    await populateSupervisorDropdown();
                    await populateManagerDropdown();
                    await populateEmployeeDropdowns();
                    
                    // Then populate form fields
                    document.getElementById('empFirstName').value = emp.firstname || '';
                    document.getElementById('empLastName').value = emp.lastname || '';
                    document.getElementById('empEmail').value = emp.email || '';
                    document.getElementById('empPhone').value = emp.phonenumber || '';
                    document.getElementById('empDepartment').value = emp.department || '';
                    document.getElementById('empRole').value = emp.role || '';
                    document.getElementById('empShift').value = emp.shift || '';
                    document.getElementById('empWorkLine').value = emp.workline || '';
                    document.getElementById('empWorkArea').value = emp.workarea || '';
                    document.getElementById('empSupervisor').value = emp.supervisor || '';
                    document.getElementById('empManager').value = emp.manager || '';

                    // Employment details
                    document.getElementById('empDateOfEmployment').value = emp.dateOfEmployment || emp.date_of_employment || '';
                    document.getElementById('empVacationHours').value = emp.vacationHours || emp.vacation_hours || 0;
                    document.getElementById('empMaxAccumulatedHours').value = emp.maxAccumulatedHours || emp.max_accumulated_hours || '';

                    // Load vacation schedule
                    const years = emp.vacationScheduleYears || emp.vacation_schedule_years || [];
                    const hours = emp.vacationScheduleHours || emp.vacation_schedule_hours || [];
                    loadVacationSchedule(years, hours);

                    // Set selected user if linked
                    if (emp.user_id) {
                        document.getElementById('empUserId').value = emp.user_id;
                    }

                    document.getElementById('employeeModal').classList.remove('hidden');
                } else {
                    showError('Failed to load employee details');
                }
            } catch (error) {
                console.error('Error loading employee:', error);
                showError('Failed to load employee details');
            }
        }

        // Delete employee
        function deleteEmployee(employeeId, employeeName) {
            showDeleteModal(`Are you sure you want to delete employee "${employeeName}"? This action cannot be undone.`, async () => {
                try {
                    const response = await fetch(`/api/employees/${employeeId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Employee deleted successfully!');
                        await loadEmployees();
                    } else {
                        throw new Error(data.message || 'Failed to delete employee');
                    }
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    showError('Failed to delete employee: ' + error.message);
                }
            });
        }

        // Employee form submission
        document.getElementById('employeeForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Update vacation schedule data before submitting
            updateVacationScheduleData();

            const employeeId = document.getElementById('employeeId').value;
            
            // Extract vacation schedule arrays
            const vacationYears = vacationScheduleData.map(item => item.year);
            const vacationHours = vacationScheduleData.map(item => item.hours);
            
            const employeeData = {
                firstname: document.getElementById('empFirstName').value,
                lastname: document.getElementById('empLastName').value,
                email: document.getElementById('empEmail').value || null,
                phonenumber: document.getElementById('empPhone').value || null,
                department: document.getElementById('empDepartment').value || null,
                role: document.getElementById('empRole').value || null,
                shift: document.getElementById('empShift').value || null,
                workline: document.getElementById('empWorkLine').value || null,
                workarea: document.getElementById('empWorkArea').value || null,
                supervisor: document.getElementById('empSupervisor').value || null,
                manager: document.getElementById('empManager').value || null,
                user_id: document.getElementById('empUserId').value || null,
                date_of_employment: document.getElementById('empDateOfEmployment').value || null,
                vacation_hours: document.getElementById('empVacationHours').value || null,
                max_accumulated_hours: document.getElementById('empMaxAccumulatedHours').value || null,
                vacation_schedule_years: vacationYears,
                vacation_schedule_hours: vacationHours
            };

            try {
                const url = employeeId ? `/api/employees/${employeeId}` : '/api/employees';
                const method = employeeId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(employeeData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(employeeId ? 'Employee updated successfully!' : 'Employee created successfully!');
                    closeEmployeeModal();
                    await loadEmployees();
                } else {
                    throw new Error(data.message || 'Failed to save employee');
                }
            } catch (error) {
                console.error('Error saving employee:', error);
                showError('Failed to save employee: ' + error.message);
            }
        });

        // Add event listener for Date of Employment to auto-calculate vacation hours
        document.getElementById('empDateOfEmployment')?.addEventListener('change', function() {
            calculateAllocatedVacationHours();
        });

        // Employee search and filter
        document.getElementById('employeeSearchInput')?.addEventListener('input', filterEmployees);
        document.getElementById('employeeDepartmentFilter')?.addEventListener('change', filterEmployees);
        document.getElementById('employeeShiftFilter')?.addEventListener('change', filterEmployees);
        document.getElementById('employeeWorkLineFilter')?.addEventListener('change', filterEmployees);

        function filterEmployees() {
            const searchTerm = document.getElementById('employeeSearchInput').value.toLowerCase();
            const deptFilter = document.getElementById('employeeDepartmentFilter').value;
            const shiftFilter = document.getElementById('employeeShiftFilter').value;
            const workLineFilter = document.getElementById('employeeWorkLineFilter').value;

            const filtered = allEmployees.filter(emp => {
                const fullName = `${emp.firstname || ''} ${emp.lastname || ''}`.toLowerCase();
                const matchesSearch = fullName.includes(searchTerm) || 
                                     (emp.email && emp.email.toLowerCase().includes(searchTerm)) ||
                                     (emp.phonenumber && emp.phonenumber.toLowerCase().includes(searchTerm));
                const matchesDept = !deptFilter || emp.department === deptFilter;
                const matchesShift = !shiftFilter || emp.shift === shiftFilter;
                const matchesWorkLine = !workLineFilter || emp.workline === workLineFilter;

                return matchesSearch && matchesDept && matchesShift && matchesWorkLine;
            });

            renderEmployees(filtered);
        }

        // ========================================
        // ASSETS MANAGEMENT FUNCTIONS
        // ========================================

        let currentAssetsData = null;

        // Show manage assets modal
        async function showManageAssetsModal() {
            try {
                showLoading('Loading assets configuration...');
                
                // Fetch current assets
                const response = await fetch('/api/assets');
                const data = await response.json();
                
                if (data.success && data.assets) {
                    currentAssetsData = data.assets;
                    
                    // Populate form with current values
                    document.getElementById('assetsWorkRoles').value = (data.assets.workRoles || []).join('\n');
                    document.getElementById('assetsWorkLines').value = (data.assets.workLines || []).join('\n');
                    document.getElementById('assetsWorkAreas').value = (data.assets.workAreas || []).join('\n');
                    document.getElementById('assetsDepartments').value = (data.assets.departments || []).join('\n');
                    document.getElementById('assetsShiftsNames').value = (data.assets.shiftsNames || []).join('\n');
                    document.getElementById('assetsNotes').value = '';
                    document.getElementById('assetsVersion').textContent = data.assets.version || 1;
                    
                    // Update counts
                    updateAssetsCounts();
                } else {
                    // No assets found, start fresh
                    document.getElementById('assetsForm').reset();
                    document.getElementById('assetsVersion').textContent = 1;
                    updateAssetsCounts();
                }
                
                document.getElementById('assetsModal').classList.remove('hidden');
                hideLoading();
                lucide.createIcons();
                
            } catch (error) {
                hideLoading();
                console.error('Error loading assets:', error);
                showError('Failed to load assets configuration');
            }
        }

        // Close assets modal
        function closeAssetsModal() {
            document.getElementById('assetsModal').classList.add('hidden');
            document.getElementById('assetsForm').reset();
            currentAssetsData = null;
        }

        // Update counts for each asset type
        function updateAssetsCounts() {
            const workRoles = document.getElementById('assetsWorkRoles').value
                .split('\n')
                .filter(line => line.trim() !== '');
            document.getElementById('workRolesCount').textContent = workRoles.length;

            const workLines = document.getElementById('assetsWorkLines').value
                .split('\n')
                .filter(line => line.trim() !== '');
            document.getElementById('workLinesCount').textContent = workLines.length;

            const workAreas = document.getElementById('assetsWorkAreas').value
                .split('\n')
                .filter(line => line.trim() !== '');
            document.getElementById('workAreasCount').textContent = workAreas.length;

            const departments = document.getElementById('assetsDepartments').value
                .split('\n')
                .filter(line => line.trim() !== '');
            document.getElementById('departmentsCount').textContent = departments.length;

            const shiftsNames = document.getElementById('assetsShiftsNames').value
                .split('\n')
                .filter(line => line.trim() !== '');
            document.getElementById('shiftsNamesCount').textContent = shiftsNames.length;
        }

        // Add event listeners for real-time count updates
        document.addEventListener('DOMContentLoaded', function() {
            const assetFields = [
                'assetsWorkRoles',
                'assetsWorkLines',
                'assetsWorkAreas',
                'assetsDepartments',
                'assetsShiftsNames'
            ];

            assetFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateAssetsCounts);
                }
            });
        });

        // Assets form submission
        document.getElementById('assetsForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            try {
                showLoading('Saving assets configuration...');

                // Parse textarea values into arrays
                const workRoles = document.getElementById('assetsWorkRoles').value
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line !== '');

                const workLines = document.getElementById('assetsWorkLines').value
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line !== '');

                const workAreas = document.getElementById('assetsWorkAreas').value
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line !== '');

                const departments = document.getElementById('assetsDepartments').value
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line !== '');

                const shiftsNames = document.getElementById('assetsShiftsNames').value
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line !== '');

                const notes = document.getElementById('assetsNotes').value.trim();

                // Validate at least one item in each category
                if (workRoles.length === 0 || workLines.length === 0 || workAreas.length === 0 || 
                    departments.length === 0 || shiftsNames.length === 0) {
                    hideLoading();
                    showError('Each category must have at least one item');
                    return;
                }

                const payload = {
                    workRoles,
                    workLines,
                    workAreas,
                    departments,
                    shiftsNames,
                    notes: notes || undefined
                };

                const response = await fetch('/api/assets', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    hideLoading();
                    showSuccess('Assets configuration saved successfully!');
                    closeAssetsModal();
                    
                    // Reload employees to refresh dropdowns if on that section
                    if (currentSection === 'employee-management') {
                        await loadEmployees();
                    }
                } else {
                    hideLoading();
                    showError(data.error || 'Failed to save assets configuration');
                }

            } catch (error) {
                hideLoading();
                console.error('Error saving assets:', error);
                showError('Failed to save assets configuration');
            }
        });

        // Week Management Functions
        async function loadWeeks() {
            try {
                const res = await fetch('/api/weeks');
                const data = await res.json();

                if (data.success) {
                    allWeeks = data.weeks || [];
                    renderActiveWeeks(allWeeks);
                } else {
                    showError(data.message || 'Failed to load weeks');
                }
            } catch (error) {
                console.error('Error loading weeks:', error);
                showError('Failed to load weeks');
            }
        }

        function renderActiveWeeks(weeks) {
            console.log('Rendering weeks:', weeks);
            const container = document.getElementById('activeWeeksList');
            const noWeeksState = document.getElementById('noWeeksState');

            container.innerHTML = '';

            if (weeks.length === 0) {
                noWeeksState.classList.remove('hidden');
                return;
            }

            noWeeksState.classList.add('hidden');

            weeks.forEach(week => {
                console.log('Processing week:', week);
                const weekDiv = document.createElement('div');
                weekDiv.className = 'flex items-center justify-between p-4 bg-white/60 rounded-xl hover:bg-white/80 transition-all border border-gray-200/50';
                weekDiv.innerHTML = `
            <div class="flex-1">
                <div class="font-medium text-gray-900">${week.week_name}</div>
                <div class="text-sm text-gray-600">${week.start_date} to ${week.end_date}</div>
                <div class="text-xs text-gray-500 mt-1">Created: ${week.created_at}</div>
            </div>
            <button onclick="deleteWeek('${week.id}')" 
                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" 
                title="Delete Week">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        `;
                container.appendChild(weekDiv);
            });

            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // Week form functionality
        document.getElementById('weekStartDate')?.addEventListener('change', updateWeekName);
        document.getElementById('weekEndDate')?.addEventListener('change', updateWeekName);

        function updateWeekName() {
            const startDate = document.getElementById('weekStartDate').value;
            const endDate = document.getElementById('weekEndDate').value;

            if (startDate && endDate) {
                // Parse dates manually to avoid timezone issues
                const [startYear, startMonth, startDay] = startDate.split('-').map(Number);
                const [endYear, endMonth, endDay] = endDate.split('-').map(Number);

                // Create Date objects in local timezone (month is 0-based)
                const start = new Date(startYear, startMonth - 1, startDay);
                const end = new Date(endYear, endMonth - 1, endDay);

                // Format for display: "Aug 04, 2025 - Aug 08, 2025"
                const options = { month: 'short', day: '2-digit', year: 'numeric' };
                const startFormatted = start.toLocaleDateString('en-US', options);
                const endFormatted = end.toLocaleDateString('en-US', options);
                const weekName = `${startFormatted} - ${endFormatted}`;

                document.getElementById('generatedWeekName').value = weekName;
            }
        }

        document.getElementById('addWeekForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Get dates from input (YYYY-MM-DD format)
            const startDateInput = document.getElementById('weekStartDate').value;
            const endDateInput = document.getElementById('weekEndDate').value;

            // Parse dates manually to avoid timezone issues
            const [startYear, startMonth, startDay] = startDateInput.split('-').map(Number);
            const [endYear, endMonth, endDay] = endDateInput.split('-').map(Number);

            // Create Date objects in local timezone
            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);

            // Format dates as MM-DD-YYYY for backend
            const startFormatted = `${(startDate.getMonth() + 1).toString().padStart(2, '0')}-${startDate.getDate().toString().padStart(2, '0')}-${startDate.getFullYear()}`;
            const endFormatted = `${(endDate.getMonth() + 1).toString().padStart(2, '0')}-${endDate.getDate().toString().padStart(2, '0')}-${endDate.getFullYear()}`;

            const formData = {
                start_date: startFormatted,
                end_date: endFormatted,
                week_name: document.getElementById('generatedWeekName').value
            };

            try {
                const res = await fetch('/api/weeks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await res.json();

                if (data.success) {
                    showSuccess('Week added successfully!');
                    document.getElementById('addWeekForm').reset();
                    document.getElementById('generatedWeekName').value = '';
                    await loadWeeks();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error adding week:', error);
                showError('Failed to add week');
            }
        });

        async function deleteWeek(weekId) {
            console.log('Attempting to delete week with ID:', weekId);
            
            // Validate UUID format on frontend
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(weekId)) {
                showError(`Invalid week ID format: ${weekId}. Please refresh the page and try again.`);
                return;
            }
            
            showDeleteModal('Are you sure you want to delete this week? This action cannot be undone.', async () => {
                try {
                    const res = await fetch(`/api/weeks/${weekId}`, {
                        method: 'DELETE'
                    });

                    const data = await res.json();

                    if (data.success) {
                        showSuccess('Week deleted successfully!');
                        await loadWeeks();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error deleting week:', error);
                    showError('Failed to delete week');
                }
            });
        }

        // Announcements functionality
        async function loadAnnouncements() {
            try {
                const res = await fetch('/api/announcements');
                const data = await res.json();
                
                if (data.success) {
                    allAnnouncements = data.announcements || [];
                    renderAnnouncements(allAnnouncements);
                    
                    // Update dashboard announcement count if on dashboard
                    if (currentSection === 'dashboard') {
                        document.getElementById('totalAnnouncements').textContent = allAnnouncements.length;
                    }
                } else {
                    throw new Error(data.message || 'Failed to load announcements');
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                showError(`Failed to load announcements: ${error.message}`);
                // Show empty state on error
                allAnnouncements = [];
                renderAnnouncements(allAnnouncements);
            }
        }

        function renderAnnouncements(announcements) {
            const container = document.getElementById('announcementsList');

            if (announcements.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                            <i data-lucide="megaphone" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No announcements found</h3>
                        <p class="text-gray-500 mb-6">Create your first announcement to get started.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Debug: Log the first announcement to see its structure
            console.log('ðŸ” DEBUG: First announcement data:', announcements[0]);
            console.log('ðŸ” DEBUG: is_global_announcement value:', announcements[0]?.is_global_announcement);

            container.innerHTML = announcements.map(announcement => {
                return `
                <div class="border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="text-lg font-semibold text-gray-900">${announcement.title}</h4>
                                ${announcement.is_featured ? '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Featured</span>' : ''}
                            </div>
                            <p class="text-gray-600 mb-3">${announcement.content}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="flex items-center">
                                    <i data-lucide="user" class="w-4 h-4 mr-1"></i>
                                    ${announcement.author || 'Admin'}
                                </span>
                                <span class="flex items-center">
                                    <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                                    ${new Date(announcement.created_at).toLocaleDateString()}
                                </span>
                                <span class="flex items-center">
                                    <i data-lucide="flag" class="w-4 h-4 mr-1"></i>
                                    <span class="capitalize">${announcement.priority}</span>
                                </span>
                                ${announcement.announcement_type ? `
                                    <span class="flex items-center">
                                        <i data-lucide="tag" class="w-4 h-4 mr-1"></i>
                                        <span class="capitalize">${announcement.announcement_type}</span>
                                    </span>
                                ` : ''}
                                ${announcement.view_count ? `
                                    <span class="flex items-center">
                                        <i data-lucide="eye" class="w-4 h-4 mr-1"></i>
                                        ${announcement.view_count} views
                                    </span>
                                ` : ''}
                            </div>
                            ${announcement.expires_at ? `
                                <div class="mt-2 text-xs text-orange-600">
                                    <i data-lucide="clock" class="w-3 h-3 mr-1 inline"></i>
                                    Expires: ${new Date(announcement.expires_at).toLocaleDateString()}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${announcement.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${announcement.is_active ? 'Active' : 'Inactive'}
                            </span>
                            
                            <!-- Global Announcement Toggle -->
                            <div class="flex items-center space-x-2 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="globe" class="w-4 h-4 text-blue-600"></i>
                                    <label class="text-sm font-medium text-blue-900">Global:</label>
                                </div>
                                <button onclick="toggleGlobalAnnouncement('${announcement.id}', ${!announcement.is_global_announcement})" 
                                        class="px-4 py-2 text-sm font-bold rounded-lg border-2 transition-all hover:shadow-md transform hover:scale-105 ${announcement.is_global_announcement ? 'bg-green-500 text-white border-green-600 hover:bg-green-600' : 'bg-gray-300 text-gray-700 border-gray-400 hover:bg-gray-400'}">
                                    ${announcement.is_global_announcement ? 'âœ… ON' : 'âŒ OFF'}
                                </button>
                                <span class="text-sm font-medium ${announcement.is_global_announcement ? 'text-green-700' : 'text-gray-600'}">
                                    ${announcement.is_global_announcement ? 'Enabled' : 'Disabled'}
                                </span>
                            </div>
                            
                            <button onclick="viewAnnouncement('${announcement.id}')"
                                class="p-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors" title="View">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteAnnouncement(${announcement.id})"
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            lucide.createIcons();
        }

        // View announcement function
        function viewAnnouncement(id) {
            const announcement = allAnnouncements.find(a => {
                return String(a.id) === String(id);
            });
            
            if (!announcement) {
                showError('Announcement not found');
                return;
            }

            // Populate modal with announcement data
            document.getElementById('viewAnnouncementTitle').textContent = announcement.title || '';
            document.getElementById('viewAnnouncementContent').textContent = announcement.content || '';
            document.getElementById('viewAnnouncementType').textContent = announcement.announcement_type || 'general';
            document.getElementById('viewAnnouncementPriority').textContent = announcement.priority || 'medium';
            document.getElementById('viewAnnouncementAuthor').textContent = announcement.author || 'Admin';
            document.getElementById('viewAnnouncementCreated').textContent = announcement.created_at ? new Date(announcement.created_at).toLocaleString() : 'Unknown';
            document.getElementById('viewAnnouncementStatus').textContent = announcement.is_active ? 'Active' : 'Inactive';
            document.getElementById('viewAnnouncementStatus').className = announcement.is_active ? 'px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800' : 'px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800';
            
            if (announcement.expires_at) {
                document.getElementById('viewAnnouncementExpires').textContent = new Date(announcement.expires_at).toLocaleString();
                document.getElementById('viewAnnouncementExpiresRow').style.display = 'flex';
            } else {
                document.getElementById('viewAnnouncementExpiresRow').style.display = 'none';
            }

            // Show modal
            const modal = document.getElementById('viewAnnouncementModal');
            modal.classList.remove('hidden');
        }

        function closeViewAnnouncementModal() {
            document.getElementById('viewAnnouncementModal').classList.add('hidden');
        }

        // Reviews functionality
        async function loadReviews() {
            console.log('ðŸ”„ Loading reviews...');
            try {
                const res = await fetch('/api/admin/reviews');
                console.log('ðŸ“¡ API Response status:', res.status);
                const data = await res.json();
                console.log('ðŸ“Š API Response data:', data);
                
                if (data.success) {
                    allReviews = data.reviews || [];
                    console.log('âœ… Reviews loaded successfully:', allReviews.length, 'reviews');
                    updateReviewStats(data.stats);
                    
                    // Apply current filters after loading
                    filterReviews();
                } else {
                    console.error('âŒ API returned error:', data.message);
                    throw new Error(data.message || 'Failed to load reviews');
                }
            } catch (error) {
                console.error('ðŸ’¥ Error loading reviews:', error);
                showError('Failed to load reviews');
                allReviews = [];
                renderReviews([]);
            }
        }

        function updateReviewStats(stats) {
            document.getElementById('totalReviewsRM').textContent = stats.total_reviews || 0;
            document.getElementById('approvedReviews').textContent = stats.approved_reviews || 0;
            document.getElementById('pendingReviews').textContent = stats.pending_reviews || 0;
            document.getElementById('avgRating').textContent = (stats.avg_rating || 0).toFixed(1);
        }

        function renderReviews(reviews) {
            console.log('ðŸŽ¨ Rendering reviews:', reviews.length, 'reviews');
            console.log('ðŸŽ¨ Sample review data:', reviews[0]);
            
            const container = document.getElementById('reviewsList');
            const noReviewsState = document.getElementById('noReviewsState');

            if (reviews.length === 0) {
                container.innerHTML = '';
                noReviewsState.classList.remove('hidden');
                return;
            }

            noReviewsState.classList.add('hidden');
            container.innerHTML = reviews.map(review => {
                const statusColor = review.is_approved ? 'green' : 'orange';
                const statusText = review.is_approved ? 'Approved' : 'Pending';
                const featuredBadge = review.is_featured ? 
                    '<span class="inline-flex px-2 py-1 text-xs font-semibold bg-purple-100 text-purple-800 rounded-full">Featured</span>' : '';
                
                // Safe handling of potentially null values
                const authorName = review.author_name || 'Anonymous';
                const authorEmail = review.author_email || '';
                const reviewText = review.review_text || 'No review text provided.';
                const category = review.category || 'general';
                const rating = review.rating || 0;
                
                return `
                <div class="border border-gray-200 rounded-xl p-6 hover:shadow-md transition-all">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center flex-wrap gap-3 mb-3">
                                <h4 class="font-semibold text-gray-900">${authorName}</h4>
                                ${authorEmail ? `<span class="text-sm text-gray-500">${authorEmail}</span>` : ''}
                                <div class="flex items-center">
                                    ${Array.from({ length: 5 }, (_, i) => `
                                        <i data-lucide="star" class="w-4 h-4 ${i < rating ? 'text-yellow-400 fill-current' : 'text-gray-300'}"></i>
                                    `).join('')}
                                </div>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-800 rounded-full">
                                    ${statusText}
                                </span>
                                ${featuredBadge}
                            </div>
                            <div class="mb-3">
                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded-md">
                                    ${category}
                                </span>
                            </div>
                            <p class="text-gray-700 mb-3 leading-relaxed">${reviewText}</p>
                            <div class="flex items-center justify-between text-sm text-gray-500">
                                <span>Created: ${new Date(review.created_at).toLocaleDateString()}</span>
                                ${review.approved_at ? `<span>Approved: ${new Date(review.approved_at).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end space-x-2 pt-4 border-t border-gray-100">
                        ${!review.is_approved ? `
                            <button onclick="approveReview('${review.id}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-green-700 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                                <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                Approve
                            </button>
                        ` : ''}
                        <button onclick="toggleFeaturedReview('${review.id}', ${!review.is_featured})" 
                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                            <i data-lucide="star" class="w-4 h-4 mr-1"></i>
                            ${review.is_featured ? 'Unfeature' : 'Feature'}
                        </button>
                        ${review.is_approved ? `
                            <button onclick="unapproveReview('${review.id}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-orange-700 bg-orange-50 hover:bg-orange-100 rounded-lg transition-colors">
                                <i data-lucide="x" class="w-4 h-4 mr-1"></i>
                                Unapprove
                            </button>
                        ` : ''}
                        <button onclick="deleteReviewConfirm('${review.id}', '${authorName}')" 
                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-red-700 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            lucide.createIcons();
        }

        // Review management functions
        async function approveReview(reviewId) {
            try {
                const res = await fetch(`/api/admin/reviews/${reviewId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_approved: true })
                });

                const data = await res.json();
                if (data.success) {
                    showSuccess('Review approved successfully!');
                    await loadReviews();
                } else {
                    throw new Error(data.message || 'Failed to approve review');
                }
            } catch (error) {
                console.error('Error approving review:', error);
                showError('Failed to approve review');
            }
        }

        async function unapproveReview(reviewId) {
            try {
                const res = await fetch(`/api/admin/reviews/${reviewId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_approved: false })
                });

                const data = await res.json();
                if (data.success) {
                    showSuccess('Review unapproved successfully!');
                    await loadReviews();
                } else {
                    throw new Error(data.message || 'Failed to unapprove review');
                }
            } catch (error) {
                console.error('Error unapproving review:', error);
                showError('Failed to unapprove review');
            }
        }

        async function toggleFeaturedReview(reviewId, featured) {
            try {
                const res = await fetch(`/api/admin/reviews/${reviewId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_featured: featured })
                });

                const data = await res.json();
                if (data.success) {
                    showSuccess(`Review ${featured ? 'featured' : 'unfeatured'} successfully!`);
                    await loadReviews();
                } else {
                    throw new Error(data.message || 'Failed to update review');
                }
            } catch (error) {
                console.error('Error updating review:', error);
                showError('Failed to update review');
            }
        }

        function deleteReviewConfirm(reviewId, authorName) {
            showDeleteModal(
                `Are you sure you want to delete the review by "${authorName}"? This action cannot be undone.`,
                async () => {
                    try {
                        const res = await fetch(`/api/admin/reviews/${reviewId}`, {
                            method: 'DELETE'
                        });

                        const data = await res.json();
                        if (data.success) {
                            showSuccess('Review deleted successfully!');
                            await loadReviews();
                        } else {
                            throw new Error(data.message || 'Failed to delete review');
                        }
                    } catch (error) {
                        console.error('Error deleting review:', error);
                        showError('Failed to delete review');
                    }
                }
            );
        }

        // Review filtering functions
        function filterReviews() {
            console.log('ðŸ” Filtering reviews...');
            
            // Check if allReviews is available
            if (!allReviews || allReviews.length === 0) {
                console.log('âš ï¸ No reviews to filter');
                renderReviews([]);
                return;
            }

            // Get filter elements with error handling
            const statusFilterEl = document.getElementById('reviewsStatusFilter');
            const ratingFilterEl = document.getElementById('reviewsRatingFilter');
            const searchInputEl = document.getElementById('reviewsSearch');

            if (!statusFilterEl || !ratingFilterEl || !searchInputEl) {
                console.log('âš ï¸ Filter elements not found, displaying all reviews');
                renderReviews(allReviews);
                return;
            }

            const statusFilter = statusFilterEl.value || '';
            const ratingFilter = ratingFilterEl.value || '';
            const searchTerm = (searchInputEl.value || '').toLowerCase();

            console.log('ðŸ” Filter values:', { statusFilter, ratingFilter, searchTerm });

            const filtered = allReviews.filter(review => {
                // Status filtering
                let matchesStatus = true;
                if (statusFilter === 'approved') {
                    matchesStatus = review.is_approved === true;
                } else if (statusFilter === 'pending') {
                    matchesStatus = review.is_approved === false;
                } else if (statusFilter === 'featured') {
                    matchesStatus = review.is_featured === true;
                }
                // If statusFilter is empty, matchesStatus stays true

                // Rating filtering
                let matchesRating = true;
                if (ratingFilter && ratingFilter !== '') {
                    matchesRating = review.rating === parseInt(ratingFilter);
                }
                
                // Search filtering with null safety
                let matchesSearch = true;
                if (searchTerm && searchTerm !== '') {
                    matchesSearch = 
                        (review.author_name && review.author_name.toLowerCase().includes(searchTerm)) ||
                        (review.author_email && review.author_email.toLowerCase().includes(searchTerm)) ||
                        (review.review_text && review.review_text.toLowerCase().includes(searchTerm)) ||
                        (review.category && review.category.toLowerCase().includes(searchTerm));
                }

                const matches = matchesStatus && matchesRating && matchesSearch;
                console.log(`Review ${review.id}: status=${matchesStatus}, rating=${matchesRating}, search=${matchesSearch}, final=${matches}`);
                return matches;
            });

            console.log('ðŸ” Filtered reviews:', filtered.length, 'out of', allReviews.length);
            renderReviews(filtered);
        }

        // Clear all review filters
        function clearReviewFilters() {
            console.log('ðŸ§¹ Clearing review filters...');
            
            // Reset all filter inputs with error handling
            const statusFilter = document.getElementById('reviewsStatusFilter');
            const ratingFilter = document.getElementById('reviewsRatingFilter');
            const searchInput = document.getElementById('reviewsSearch');

            if (statusFilter) statusFilter.value = '';
            if (ratingFilter) ratingFilter.value = '';
            if (searchInput) searchInput.value = '';

            // Apply filters (which will now show all reviews)
            filterReviews();
        }

        // Support Tickets functionality
        let currentPage = 1;
        const ticketsPerPage = 10;

        async function loadSupportTickets(page = 1, filters = {}) {
            try {
                // Build query parameters
                const params = new URLSearchParams({
                    page: page,
                    limit: ticketsPerPage
                });
                
                if (filters.status) params.append('status', filters.status);
                if (filters.priority) params.append('priority', filters.priority);
                if (filters.search) params.append('search', filters.search);
                
                const res = await fetch(`/api/support-tickets?${params}`);
                const data = await res.json();
                
                if (data.success) {
                    allTickets = data.tickets || [];
                    renderSupportTickets(allTickets);
                    renderPagination(data.pagination);
                } else {
                    throw new Error(data.message || 'Failed to load tickets');
                }
            } catch (error) {
                console.error('Error loading support tickets:', error);
                showError('Failed to load support tickets: ' + error.message);
            }
        }

        function renderSupportTickets(tickets) {
            const container = document.getElementById('ticketsList');

            if (tickets.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="inbox" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                        <p class="text-gray-500 text-lg">No support tickets found</p>
                        <p class="text-gray-400 text-sm">Try adjusting your filters or search terms</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="text-lg font-semibold text-gray-900 truncate">${escapeHtml(ticket.subject)}</h4>
                                <span class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded">${ticket.ticket_number}</span>
                            </div>
                            <p class="text-gray-600 mb-3 line-clamp-2">${escapeHtml(ticket.description)}</p>
                            <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                                <span class="flex items-center gap-1">
                                    <i data-lucide="user" class="w-4 h-4"></i>
                                    ${escapeHtml(ticket.user_name)}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i data-lucide="mail" class="w-4 h-4"></i>
                                    ${escapeHtml(ticket.user_email)}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i data-lucide="folder" class="w-4 h-4"></i>
                                    ${escapeHtml(ticket.category_name)}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                    ${ticket.created_date}
                                </span>
                                <span class="flex items-center gap-1 text-gray-400">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                    ${ticket.time_ago}
                                </span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2 ml-4">
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 text-xs font-medium rounded-full ${getStatusColor(ticket.status)}">
                                    ${ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1).replace('_', ' ')}
                                </span>
                                <span class="px-3 py-1 text-xs font-medium rounded-full ${getPriorityColor(ticket.priority)}">
                                    ${ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ticket Actions -->
                    <div class="flex flex-wrap items-center gap-2 pt-4 border-t border-gray-100">
                        <button onclick="updateTicketStatus(${ticket.id}, 'in_progress')" 
                            class="inline-flex items-center px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors"
                            ${ticket.status === 'in_progress' ? 'disabled' : ''}>
                            <i data-lucide="play" class="w-3 h-3 mr-1"></i>
                            In Progress
                        </button>
                        <button onclick="updateTicketStatus(${ticket.id}, 'resolved')" 
                            class="inline-flex items-center px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors"
                            ${ticket.status === 'resolved' ? 'disabled' : ''}>
                            <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                            Resolve
                        </button>
                        <button onclick="updateTicketStatus(${ticket.id}, 'waiting')" 
                            class="inline-flex items-center px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium transition-colors"
                            ${ticket.status === 'waiting' ? 'disabled' : ''}>
                            <i data-lucide="pause" class="w-3 h-3 mr-1"></i>
                            Waiting
                        </button>
                        <button onclick="updateTicketStatus(${ticket.id}, 'closed')" 
                            class="inline-flex items-center px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition-colors"
                            ${ticket.status === 'closed' ? 'disabled' : ''}>
                            <i data-lucide="x" class="w-3 h-3 mr-1"></i>
                            Close
                        </button>
                        <button onclick="viewTicketDetails('${ticket.id}')" 
                            class="inline-flex items-center px-3 py-1.5 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg text-sm font-medium transition-colors">
                            <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                            View Details
                        </button>
                        <button onclick="deleteTicket(${ticket.id})" 
                            class="inline-flex items-center px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors ml-auto">
                            <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (text == null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Render pagination controls
        function renderPagination(pagination) {
            const container = document.getElementById('ticketsPagination');
            if (!container) return;

            if (pagination.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '<div class="flex items-center justify-between mt-6">';
            
            // Previous button
            paginationHTML += `
                <button onclick="changePage(${pagination.page - 1})" 
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-colors ${!pagination.has_prev ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${!pagination.has_prev ? 'disabled' : ''}>
                    <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>
                    Previous
                </button>
            `;
            
            // Page info
            paginationHTML += `
                <span class="text-sm text-gray-700">
                    Page ${pagination.page} of ${pagination.total_pages} 
                    (${pagination.total} total tickets)
                </span>
            `;
            
            // Next button
            paginationHTML += `
                <button onclick="changePage(${pagination.page + 1})" 
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-colors ${!pagination.has_next ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${!pagination.has_next ? 'disabled' : ''}>
                    Next
                    <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                </button>
            `;
            
            paginationHTML += '</div>';
            container.innerHTML = paginationHTML;
            lucide.createIcons();
        }

        // Change page function
        function changePage(page) {
            if (page < 1) return;
            currentPage = page;
            const filters = getCurrentFilters();
            loadSupportTickets(page, filters);
        }

        // Get current filter values
        function getCurrentFilters() {
            return {
                status: document.getElementById('ticketsFilter')?.value || '',
                search: document.getElementById('ticketsSearch')?.value || ''
            };
        }

        function getStatusColor(status) {
            const colors = {
                'open': 'status-open',
                'in_progress': 'status-in_progress',
                'waiting': 'status-waiting',
                'resolved': 'status-resolved',
                'closed': 'status-closed'
            };
            return colors[status] || 'status-closed';
        }

        function getPriorityColor(priority) {
            const colors = {
                'low': 'priority-low',
                'medium': 'priority-medium',
                'high': 'priority-high',
                'urgent': 'priority-urgent',
                'critical': 'priority-urgent'
            };
            return colors[priority] || 'priority-medium';
        }

        // Support ticket management functions
        let currentTicketId = null;

        async function updateTicketStatus(ticketId, newStatus) {
            try {
                showLoading(`Updating ticket status to ${newStatus}...`);
                
                const res = await fetch(`/api/support-tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await res.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    loadSupportTickets(currentPage, getCurrentFilters());
                } else {
                    showError(data.message || 'Failed to update ticket status');
                }
            } catch (error) {
                console.error('Error updating ticket status:', error);
                showError('Failed to update ticket status');
            } finally {
                hideLoading();
            }
        }

        async function deleteTicket(ticketId) {
            if (!confirm('Are you sure you want to delete this support ticket? This action cannot be undone.')) {
                return;
            }

            try {
                showLoading('Deleting ticket...');
                
                const res = await fetch(`/api/support-tickets/${ticketId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await res.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    loadSupportTickets(currentPage, getCurrentFilters());
                } else {
                    showError(data.message || 'Failed to delete ticket');
                }
            } catch (error) {
                console.error('Error deleting ticket:', error);
                showError('Failed to delete ticket');
            } finally {
                hideLoading();
            }
        }

        async function viewTicketDetails(ticketId) {
            try {
                currentTicketId = ticketId;
                showLoading('Loading ticket details...');
                
                // Find ticket in current list for basic info
                const ticket = allTickets.find(t => t.id === ticketId);
                if (!ticket) {
                    showError('Ticket not found');
                    return;
                }
                
                // Open modal with basic info
                openTicketModal(ticket);
                
                // Fetch additional details if needed
                await loadFullTicketDetails(ticketId);
                
            } catch (error) {
                console.error('Error viewing ticket details:', error);
                showError('Failed to load ticket details');
            } finally {
                hideLoading();
            }
        }

        function openTicketModal(ticket) {
            const modal = document.getElementById('ticketDetailsModal');
            
            // Populate modal with ticket data
            document.getElementById('modalTicketNumber').textContent = ticket.ticket_number;
            document.getElementById('modalTicketSubject').textContent = ticket.subject;
            document.getElementById('modalTicketStatus').textContent = ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1).replace('_', ' ');
            document.getElementById('modalTicketStatus').className = `px-4 py-2 text-sm font-bold rounded-xl shadow-sm ${getStatusColor(ticket.status)}`;
            document.getElementById('modalTicketPriority').textContent = ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1);
            document.getElementById('modalTicketPriority').className = `px-4 py-2 text-sm font-bold rounded-xl shadow-sm ${getPriorityColor(ticket.priority)}`;
            document.getElementById('modalTicketCategory').textContent = ticket.category_name;
            document.getElementById('modalUserName').textContent = ticket.user_name;
            document.getElementById('modalUserEmail').textContent = ticket.user_email;
            document.getElementById('modalTicketDescription').textContent = ticket.full_description || ticket.description;
            document.getElementById('modalCreatedDate').textContent = ticket.created_date;
            document.getElementById('modalUpdatedDate').textContent = ticket.created_date; // Will be updated with real data
            
            // Update button states based on current status
            updateModalButtonStates(ticket.status);
            
            // Show modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Refresh icons
            lucide.createIcons();
        }

        function updateModalButtonStates(currentStatus) {
            const buttons = {
                'modalBtnInProgress': 'in_progress',
                'modalBtnWaiting': 'waiting', 
                'modalBtnResolved': 'resolved',
                'modalBtnClosed': 'closed'
            };
            
            Object.entries(buttons).forEach(([buttonId, status]) => {
                const button = document.getElementById(buttonId);
                if (button) {
                    if (status === currentStatus) {
                        button.disabled = true;
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        button.disabled = false;
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });
        }

        async function loadFullTicketDetails(ticketId) {
            try {
                const res = await fetch(`/api/support/tickets/${ticketId}`, {
                    credentials: 'include'
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.ticket) {
                        // Update modal with additional details
                        document.getElementById('modalUpdatedDate').textContent = data.ticket.updated_date;
                        // Add any other additional details here
                    }
                }
            } catch (error) {
                console.warn('Could not load additional ticket details:', error);
                // Don't show error - modal still works with basic info
            }
        }

        function closeTicketModal() {
            const modal = document.getElementById('ticketDetailsModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentTicketId = null;
        }

        // Contact Details Management Functions
        let currentContactId = null;

        // Load and display contact statistics
        async function loadContactStats() {
            try {
                const response = await fetch('/api/contact-information/stats');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('totalContacts').textContent = data.stats.total || 0;
                        document.getElementById('phoneContacts').textContent = data.stats.phone || 0;
                        document.getElementById('emailContacts').textContent = data.stats.email || 0;
                        document.getElementById('chatContacts').textContent = data.stats.chat || 0;
                    }
                }
            } catch (error) {
                console.error('Error loading contact stats:', error);
            }
        }

        // Load contact list
        async function loadContactList() {
            const loadingElement = document.getElementById('contactListLoading');
            const listElement = document.getElementById('contactList');
            const emptyElement = document.getElementById('contactListEmpty');

            // Show loading state
            loadingElement.classList.remove('hidden');
            listElement.classList.add('hidden');
            emptyElement.classList.add('hidden');

            try {
                const response = await fetch('/api/contact-information');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        if (data.contacts && data.contacts.length > 0) {
                            displayContactList(data.contacts);
                            listElement.classList.remove('hidden');
                        } else {
                            emptyElement.classList.remove('hidden');
                        }
                        // Update contact type dropdown options
                        updateContactTypeOptions();
                    } else {
                        throw new Error(data.message || 'Failed to load contacts');
                    }
                } else {
                    throw new Error('Failed to fetch contacts');
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                showError('Error loading contacts: ' + error.message);
                emptyElement.classList.remove('hidden');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        // Display contact list
        function displayContactList(contacts) {
            const container = document.getElementById('contactList');
            container.innerHTML = '';

            contacts.forEach(contact => {
                const contactCard = createContactCard(contact);
                container.appendChild(contactCard);
            });

            // Reinitialize Lucide icons for the new content
            lucide.createIcons();
        }

        // Create contact card element
        function createContactCard(contact) {
            const card = document.createElement('div');
            card.className = 'glass-card hover-lift p-6 rounded-2xl transition-all duration-200';
            
            const iconColors = {
                phone: 'from-blue-500 to-indigo-600',
                email: 'from-green-500 to-emerald-600',
                chat: 'from-purple-500 to-pink-600'
            };

            const statusColor = contact.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            const statusText = contact.is_active ? 'Active' : 'Inactive';

            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-gradient-to-r ${iconColors[contact.contact_type] || 'from-gray-500 to-gray-600'} rounded-xl flex items-center justify-center">
                            <i data-lucide="${contact.icon}" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${escapeHtml(contact.title)}</h4>
                            <p class="text-sm text-gray-600 capitalize">${escapeHtml(contact.contact_type)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${statusText}</span>
                        ${contact.is_primary ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Primary</span>' : ''}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Contact Value</label>
                        <p class="text-sm font-medium text-gray-900 mt-1">${escapeHtml(contact.value)}</p>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Availability</label>
                        <p class="text-sm text-gray-700 mt-1">${escapeHtml(contact.availability || 'Not specified')}</p>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <div class="text-xs text-gray-500">
                        Order: ${contact.sort_order} | Created: ${new Date(contact.created_at).toLocaleDateString()}
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="viewContactDetails(${contact.id})" 
                            class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                            <i data-lucide="eye" class="w-3 h-3 mr-1 inline"></i>
                            View
                        </button>
                        <button onclick="deleteContact(${contact.id})" 
                            class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                            <i data-lucide="trash-2" class="w-3 h-3 mr-1 inline"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Update contact type dropdown based on existing contacts
        async function updateContactTypeOptions() {
            try {
                const response = await fetch('/api/contact-information');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const existingTypes = data.contacts.map(contact => contact.contact_type);
                        const contactTypeSelect = document.getElementById('contactType');
                        
                        if (contactTypeSelect) {
                            const options = contactTypeSelect.querySelectorAll('option:not([value=""])');
                            let availableOptionsCount = 0;
                            
                            options.forEach(option => {
                                // Clean up option text first
                                option.textContent = option.textContent.replace(' (Already exists)', '');
                                
                                if (existingTypes.includes(option.value)) {
                                    // Hide options that already exist instead of disabling them
                                    option.style.display = 'none';
                                    option.disabled = true;
                                } else {
                                    // Show available options
                                    option.style.display = '';
                                    option.disabled = false;
                                    option.style.color = '';
                                    availableOptionsCount++;
                                }
                            });
                            
                            // Update the placeholder text based on availability
                            const placeholderOption = contactTypeSelect.querySelector('option[value=""]');
                            const noTypesMessage = document.getElementById('noContactTypesMessage');
                            
                            if (placeholderOption) {
                                if (availableOptionsCount === 0) {
                                    placeholderOption.textContent = 'All contact types already exist';
                                    contactTypeSelect.disabled = true;
                                    if (noTypesMessage) {
                                        noTypesMessage.classList.remove('hidden');
                                    }
                                } else {
                                    placeholderOption.textContent = 'Select contact type...';
                                    contactTypeSelect.disabled = false;
                                    if (noTypesMessage) {
                                        noTypesMessage.classList.add('hidden');
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating contact type options:', error);
            }
        }

        // Check if contact type already exists
        async function checkContactTypeExists(contactType) {
            try {
                // Always fetch fresh data from server
                const response = await fetch('/api/contact-information');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Count existing contacts of this type
                        const existingCount = data.contacts.filter(contact => 
                            contact.contact_type === contactType
                        ).length;
                        console.log(`Contact type ${contactType} exists: ${existingCount > 0} (count: ${existingCount})`);
                        return existingCount > 0;
                    }
                }
                console.log(`Failed to check contact type ${contactType}`);
                return false;
            } catch (error) {
                console.error('Error checking contact types:', error);
                return false;
            }
        }

        // Add new contact
        async function submitContactForm(event) {
            event.preventDefault();

            const contactType = document.getElementById('contactType').value;
            
            // Check if a contact type is selected
            if (!contactType) {
                showError('Please select a contact type.');
                return;
            }
            
            const formData = {
                contact_type: contactType,
                title: document.getElementById('contactTitle').value,
                value: document.getElementById('contactValue').value,
                description: document.getElementById('contactDescription').value,
                icon: document.getElementById('contactIcon').value,
                availability: document.getElementById('contactAvailability').value,
                response_time: document.getElementById('contactResponseTime').value,
                is_active: document.getElementById('contactActive').checked,
                is_primary: document.getElementById('contactPrimary').checked,
                sort_order: 0  // Add default sort order
            };

            try {
                // Check if this contact type already exists
                const typeExists = await checkContactTypeExists(contactType);
                if (typeExists) {
                    const typeNames = {
                        'phone': 'Phone Support',
                        'email': 'Email Support', 
                        'chat': 'Live Chat'
                    };
                    showError(`${typeNames[contactType]} contact already exists! Only one contact of each type is allowed.`);
                    return;
                }

                const response = await fetch('/api/contact-information', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                console.log('Form data sent:', formData);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showSuccess('Contact information added successfully!');
                    resetContactForm();
                    loadContactList();
                    loadContactStats();
                } else {
                    throw new Error(data.message || 'Failed to add contact');
                }
            } catch (error) {
                console.error('Error adding contact:', error);
                showError('Error adding contact: ' + error.message);
            }
        }

        // Reset contact form
        function resetContactForm() {
            document.getElementById('contactForm').reset();
            document.getElementById('contactActive').checked = true;
            document.getElementById('contactPrimary').checked = false;
            // Refresh the contact type options
            updateContactTypeOptions();
        }

        // View contact details
        async function viewContactDetails(contactId) {
            try {
                const response = await fetch(`/api/contact-information/${contactId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        populateContactModal(data.contact);
                        openContactModal();
                    } else {
                        throw new Error(data.message || 'Failed to load contact details');
                    }
                } else {
                    throw new Error('Failed to fetch contact details');
                }
            } catch (error) {
                console.error('Error loading contact details:', error);
                showError('Error loading contact details: ' + error.message);
            }
        }

        // Populate contact modal with data
        function populateContactModal(contact) {
            currentContactId = contact.id;
            
            // Update modal title and icon
            document.getElementById('contactModalTitle').textContent = 'Contact Details';
            
            // Update icon safely
            const iconContainer = document.getElementById('contactModalIcon');
            const iconElement = iconContainer ? iconContainer.querySelector('i') : null;
            if (iconElement && contact.icon) {
                iconElement.setAttribute('data-lucide', contact.icon);
            }
            
            // Update display elements safely
            const elements = {
                'contactModalDisplayTitle': contact.title || 'No Title',
                'contactModalDisplayType': contact.contact_type || 'Unknown',
                'contactModalValue': contact.value || 'Not specified',
                'contactModalAvailability': contact.availability || 'Not specified',
                'contactModalResponseTime': contact.response_time || 'Not specified',
                'contactModalDescription': contact.description || 'No description provided',
                'contactModalSortOrder': contact.sort_order || '0',
                'contactModalCreatedAt': contact.created_at ? 
                    new Date(contact.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Unknown'
            };

            // Safely update each element
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });

            // Update status badges
            const statusElement = document.getElementById('contactModalStatus');
            const primaryElement = document.getElementById('contactModalPrimary');
            
            if (statusElement) {
                if (contact.is_active) {
                    statusElement.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100/80 text-green-700 backdrop-blur-sm';
                    statusElement.textContent = 'Active';
                } else {
                    statusElement.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-100/80 text-red-700 backdrop-blur-sm';
                    statusElement.textContent = 'Inactive';
                }
            }

            if (primaryElement) {
                if (contact.is_primary) {
                    primaryElement.classList.remove('hidden');
                } else {
                    primaryElement.classList.add('hidden');
                }
            }

            // Refresh icons
            lucide.createIcons();
        }

        // Open contact modal
        function openContactModal() {
            const modal = document.getElementById('contactModal');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Ensure view mode is visible
                const viewMode = document.getElementById('contactViewMode');
                if (viewMode) {
                    viewMode.classList.remove('hidden');
                }
            }
        }

        // Close contact modal
        function closeContactModal() {
            const modal = document.getElementById('contactModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                currentContactId = null;
            }
        }

        // Delete contact
        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact information? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/contact-information/${contactId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showSuccess('Contact information deleted successfully!');
                    loadContactList();
                    loadContactStats();
                } else {
                    throw new Error(data.message || 'Failed to delete contact');
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                showError('Error deleting contact: ' + error.message);
            }
        }

        // Confirm delete from modal
        function confirmDeleteContact() {
            if (currentContactId) {
                deleteContact(currentContactId).then(() => {
                    closeContactModal();
                });
            }
        }

        // Refresh contact list
        function refreshContactList() {
            loadContactList();
            loadContactStats();
        }

        // Filter contacts
        function filterContacts() {
            const typeFilter = document.getElementById('contactTypeFilter').value;
            const statusFilter = document.getElementById('contactStatusFilter').value;
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase();

            const cards = document.querySelectorAll('#contactList .glass-card');
            cards.forEach(card => {
                const titleElement = card.querySelector('h4');
                const typeElement = card.querySelector('p');
                const statusElement = card.querySelector('.px-2');
                
                if (!titleElement || !typeElement || !statusElement) return;

                const title = titleElement.textContent.toLowerCase();
                const type = typeElement.textContent.toLowerCase();
                const isActive = statusElement.textContent.toLowerCase() === 'active';

                let showCard = true;

                // Apply type filter
                if (typeFilter && type !== typeFilter) {
                    showCard = false;
                }

                // Apply status filter
                if (statusFilter === 'active' && !isActive) {
                    showCard = false;
                } else if (statusFilter === 'inactive' && isActive) {
                    showCard = false;
                }

                // Apply search filter
                if (searchTerm && !title.includes(searchTerm)) {
                    showCard = false;
                }

                card.style.display = showCard ? 'block' : 'none';
            });
        }

        // Admin Profile Modal Functions
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Load admin profile data
            loadAdminProfile();
            
            // Refresh icons
            lucide.createIcons();
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Clear password fields
            document.getElementById('passwordResetForm').reset();
        }

        async function loadAdminProfile() {
            try {
                const response = await fetch('/api/admin/profile', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.admin) {
                        const admin = data.admin;
                        
                        // Update profile information
                        document.getElementById('profileFullName').textContent = admin.full_name || 'Admin User';
                        document.getElementById('profileEmail').textContent = admin.email || 'admin@bakery.com';
                        document.getElementById('profileRole').textContent = admin.role || 'Administrator';
                        
                        // Format creation date
                        if (admin.created_at) {
                            const date = new Date(admin.created_at);
                            document.getElementById('profileCreatedDate').textContent = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        } else {
                            document.getElementById('profileCreatedDate').textContent = 'Unknown';
                        }
                        
                        // Update profile image with first letter of name
                        if (admin.full_name) {
                            const firstLetter = admin.full_name.charAt(0).toUpperCase();
                            const profileImg = document.getElementById('profileImage');
                            profileImg.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23667eea'/%3E%3Ctext x='50' y='58' text-anchor='middle' fill='white' font-size='36' font-family='Arial'%3E${firstLetter}%3C/text%3E%3C/svg%3E`;
                        }
                    } else {
                        throw new Error(data.message || 'Failed to load profile');
                    }
                } else {
                    throw new Error('Failed to fetch profile data');
                }
            } catch (error) {
                console.error('Error loading admin profile:', error);
                showError('Failed to load profile data: ' + error.message);
                
                // Set fallback values
                document.getElementById('profileFullName').textContent = 'Admin User';
                document.getElementById('profileEmail').textContent = 'admin@bakery.com';
                document.getElementById('profileRole').textContent = 'Administrator';
                document.getElementById('profileCreatedDate').textContent = 'Unknown';
            }
        }

        // Password Reset Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const passwordForm = document.getElementById('passwordResetForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', handlePasswordReset);
            }
        });

        async function handlePasswordReset(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match!');
                return;
            }
            
            // Enhanced password validation with stronger requirements
            if (newPassword.length < 6) {
                showError('New password must be at least 6 characters long!');
                return;
            }
            
            if (!/[A-Z]/.test(newPassword)) {
                showError('New password must contain at least one uppercase letter!');
                return;
            }
            
            if (!/[a-z]/.test(newPassword)) {
                showError('New password must contain at least one lowercase letter!');
                return;
            }
            
            if (!/\d/.test(newPassword)) {
                showError('New password must contain at least one number!');
                return;
            }
            
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword)) {
                showError('New password must contain at least one special character!');
                return;
            }
            
            try {
                showLoading('Updating password...');
                
                const response = await fetch('/api/admin/reset-password', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showSuccess('Password updated successfully!');
                    document.getElementById('passwordResetForm').reset();
                } else {
                    throw new Error(data.message || 'Failed to update password');
                }
            } catch (error) {
                console.error('Error updating password:', error);
                showError('Failed to update password: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Password Toggle Visibility Functions
        function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const toggleIcon = document.getElementById(fieldId + 'Toggle');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.setAttribute('data-lucide', 'eye-off');
            } else {
                passwordField.type = 'password';
                toggleIcon.setAttribute('data-lucide', 'eye');
            }
            
            // Refresh the icon
            lucide.createIcons();
        }

        // Password Strength Checker
        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            // Check individual requirements
            const hasLength = password.length >= 6;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            
            // Update checklist indicators
            updateRequirementCheck('lengthCheck', hasLength);
            updateRequirementCheck('upperCheck', hasUpper);
            updateRequirementCheck('lowerCheck', hasLower);
            updateRequirementCheck('numberCheck', hasNumber);
            updateRequirementCheck('specialCheck', hasSpecial);
            
            // Calculate strength score
            const requirements = [hasLength, hasUpper, hasLower, hasNumber, hasSpecial];
            const score = requirements.filter(req => req).length;
            
            // Update strength bar and text
            let strength = 'Weak';
            let color = 'bg-red-400';
            let width = '0%';
            
            if (score === 0) {
                strength = 'Very Weak';
                color = 'bg-red-500';
                width = '10%';
            } else if (score === 1) {
                strength = 'Weak';
                color = 'bg-red-400';
                width = '20%';
            } else if (score === 2) {
                strength = 'Fair';
                color = 'bg-orange-400';
                width = '40%';
            } else if (score === 3) {
                strength = 'Good';
                color = 'bg-yellow-400';
                width = '60%';
            } else if (score === 4) {
                strength = 'Strong';
                color = 'bg-blue-400';
                width = '80%';
            } else if (score === 5) {
                strength = 'Very Strong';
                color = 'bg-green-400';
                width = '100%';
            }
            
            // Update UI
            strengthBar.className = `h-full transition-all duration-300 rounded-full ${color}`;
            strengthBar.style.width = width;
            strengthText.textContent = strength;
            
            // Update text color based on strength
            if (score <= 1) {
                strengthText.className = 'text-xs font-bold text-red-500';
            } else if (score === 2) {
                strengthText.className = 'text-xs font-bold text-orange-500';
            } else if (score === 3) {
                strengthText.className = 'text-xs font-bold text-yellow-600';
            } else if (score === 4) {
                strengthText.className = 'text-xs font-bold text-blue-600';
            } else {
                strengthText.className = 'text-xs font-bold text-green-600';
            }
            
            // Also check password match when new password changes
            checkPasswordMatch();
        }

        function updateRequirementCheck(checkId, isValid) {
            const checkElement = document.getElementById(checkId);
            const icon = checkElement.querySelector('[data-lucide]');
            const text = checkElement.querySelector('span');
            
            if (isValid) {
                icon.setAttribute('data-lucide', 'check');
                icon.className = 'w-3 h-3 text-green-500';
                text.className = 'text-green-600 font-medium';
            } else {
                icon.setAttribute('data-lucide', 'x');
                icon.className = 'w-3 h-3 text-red-500';
                text.className = 'text-gray-600';
            }
            
            // Refresh icons
            lucide.createIcons();
        }

        // Password Match Checker
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const indicator = document.getElementById('passwordMatchIndicator');
            const matchIcon = document.getElementById('matchIcon');
            const matchText = document.getElementById('matchText');
            
            if (confirmPassword.length > 0) {
                indicator.classList.remove('hidden');
                
                if (newPassword === confirmPassword) {
                    matchIcon.setAttribute('data-lucide', 'check');
                    matchIcon.className = 'w-3 h-3 text-green-500';
                    matchText.textContent = 'Passwords match';
                    matchText.className = 'text-green-600 font-medium';
                } else {
                    matchIcon.setAttribute('data-lucide', 'x');
                    matchIcon.className = 'w-3 h-3 text-red-500';
                    matchText.textContent = 'Passwords do not match';
                    matchText.className = 'text-red-500';
                }
                
                // Refresh icons
                lucide.createIcons();
            } else {
                indicator.classList.add('hidden');
            }
        }

        async function updateTicketStatusFromModal(newStatus) {
            if (!currentTicketId) return;
            
            await updateTicketStatus(currentTicketId, newStatus);
            
            // Update modal display
            const ticket = allTickets.find(t => t.id === currentTicketId);
            if (ticket) {
                ticket.status = newStatus;
                updateModalButtonStates(newStatus);
                document.getElementById('modalTicketStatus').textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1).replace('_', ' ');
                document.getElementById('modalTicketStatus').className = `px-4 py-2 text-sm font-bold rounded-xl shadow-sm ${getStatusColor(newStatus)}`;
            }
        }

        async function deleteTicketFromModal() {
            if (!currentTicketId) return;
            
            if (!confirm('Are you sure you want to delete this support ticket? This action cannot be undone.')) {
                return;
            }
            
            await deleteTicket(currentTicketId);
            closeTicketModal();
        }

        // Loading and notification functions
        function showLoading(message = 'Loading...') {
            // Create or update loading overlay
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.className = 'fixed inset-0 bg-gradient-to-br from-blue-500/20 to-indigo-600/30 backdrop-blur-md flex items-center justify-center z-50';
                overlay.innerHTML = `
                    <div class="bg-white rounded-xl p-6 text-center shadow-2xl">
                        <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-gray-700 font-medium" id="loadingMessage">${message}</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                document.getElementById('loadingMessage').textContent = message;
                overlay.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Add event listeners for filters
        document.getElementById('ticketsFilter')?.addEventListener('change', function() {
            currentPage = 1;
            loadSupportTickets(currentPage, getCurrentFilters());
        });

        document.getElementById('ticketsSearch')?.addEventListener('input', function() {
            // Debounce search
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadSupportTickets(currentPage, getCurrentFilters());
            }, 500);
        });

        // FAQ functionality
        async function loadFAQs() {
            try {
                const res = await fetch('/api/faqs');
                const data = await res.json();
                allFAQs = data.faqs || [];
                renderFAQs(allFAQs);
                updateFAQCategories();
            } catch (error) {
                console.error('Error loading FAQs:', error);
                showError('Failed to load FAQs');
            }
        }

        function renderFAQs(faqs) {
            const container = document.getElementById('faqList');

            if (faqs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No FAQs found</p>';
                return;
            }

            container.innerHTML = faqs.map(faq => `
                <div class="border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">${faq.question}</h4>
                            <p class="text-gray-600 mb-3">${faq.answer}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="flex items-center">
                                    <i data-lucide="tag" class="w-4 h-4 mr-1"></i>
                                    ${faq.category || 'General'}
                                </span>
                                <span class="flex items-center">
                                    <i data-lucide="hash" class="w-4 h-4 mr-1"></i>
                                    Order: ${faq.order || 0}
                                </span>
                                <span class="flex items-center">
                                    <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                                    ${new Date(faq.created_at).toLocaleDateString()}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${faq.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${faq.is_active ? 'Active' : 'Inactive'}
                            </span>
                            <button onclick="editFAQ('${faq.id}')"
                                class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="View/Edit FAQ">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteFAQ('${faq.id}')"
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete FAQ">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        async function updateFAQCategories() {
            try {
                const response = await fetch('/api/faqs/categories');
                const data = await response.json();
                
                if (data.success && data.categories) {
                    const select = document.getElementById('faqCategoryFilter');
                    select.innerHTML = '<option value="">All Categories</option>' +
                        data.categories.map(cat => `<option value="${cat.value}">${cat.label} (${cat.count})</option>`).join('');
                } else {
                    // Fallback to extracting from loaded FAQs if API fails
                    const categories = [...new Set(allFAQs.map(faq => faq.category))];
                    const select = document.getElementById('faqCategoryFilter');
                    select.innerHTML = '<option value="">All Categories</option>' +
                        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading FAQ categories:', error);
                // Fallback to extracting from loaded FAQs if API fails
                const categories = [...new Set(allFAQs.map(faq => faq.category))];
                const select = document.getElementById('faqCategoryFilter');
                select.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            }
        }

        // Form submissions
        document.getElementById('announcementForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = {
                title: document.getElementById('announcementTitle').value.trim(),
                content: document.getElementById('announcementContent').value.trim(),
                announcement_type: document.getElementById('announcementType').value,
                priority: document.getElementById('announcementPriority').value,
                icon: document.getElementById('announcementIcon').value,
                color_scheme: 'blue', // Default color scheme
                is_active: document.getElementById('announcementActive').checked,
                is_featured: false, // Default not featured
                expires_at: null // No expiration by default
            };

            // Validate required fields
            if (!formData.title) {
                showError('Title is required');
                return;
            }
            if (!formData.content) {
                showError('Content is required');
                return;
            }

            try {
                const res = await fetch('/api/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await res.json();

                if (data.success) {
                    showSuccess('Announcement created successfully!');
                    this.reset();
                    await loadAnnouncements();
                } else {
                    throw new Error(data.message || 'Failed to create announcement');
                }
            } catch (error) {
                console.error('Error creating announcement:', error);
                showError(`Failed to create announcement: ${error.message}`);
            }
        });

        document.getElementById('faqForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = {
                question: document.getElementById('faqQuestion').value,
                answer: document.getElementById('faqAnswer').value,
                category: document.getElementById('faqCategory').value,
                order: parseInt(document.getElementById('faqOrder').value),
                is_active: document.getElementById('faqActive').checked
            };

            try {
                const res = await fetch('/api/faqs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (res.ok) {
                    showSuccess('FAQ added successfully!');
                    this.reset();
                    await loadFAQs();
                } else {
                    throw new Error('Failed to add FAQ');
                }
            } catch (error) {
                console.error('Error adding FAQ:', error);
                showError('Failed to add FAQ');
            }
        });

        // CRUD operations
        async function deleteAnnouncement(id) {
            showDeleteModal('Are you sure you want to delete this announcement?', async () => {
                try {
                    const res = await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
                    const data = await res.json();
                    
                    if (data.success) {
                        showSuccess('Announcement deleted successfully!');
                        await loadAnnouncements();
                    } else {
                        throw new Error(data.message || 'Failed to delete announcement');
                    }
                } catch (error) {
                    console.error('Error deleting announcement:', error);
                    showError(`Failed to delete announcement: ${error.message}`);
                }
            });
        }

        async function deleteReview(id) {
            showDeleteModal('Are you sure you want to delete this review?', async () => {
                try {
                    const res = await fetch(`/api/reviews/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showSuccess('Review deleted successfully!');
                        await loadReviews();
                    } else {
                        throw new Error('Failed to delete review');
                    }
                } catch (error) {
                    console.error('Error deleting review:', error);
                    showError('Failed to delete review');
                }
            });
        }

        async function deleteFAQ(id) {
            showDeleteModal('Are you sure you want to delete this FAQ?', async () => {
                try {
                    const res = await fetch(`/api/faqs/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showSuccess('FAQ deleted successfully!');
                        await loadFAQs();
                    } else {
                        throw new Error('Failed to delete FAQ');
                    }
                } catch (error) {
                    console.error('Error deleting FAQ:', error);
                    showError('Failed to delete FAQ');
                }
            });
        }

        // Toggle global announcement function
        async function toggleGlobalAnnouncement(id, isGlobal) {
            console.log('ðŸ”§ toggleGlobalAnnouncement called:', { id, isGlobal });
            
            // Find the button element
            const button = document.querySelector(`button[onclick*="toggleGlobalAnnouncement('${id}',"]`);
            const originalText = button ? button.textContent : '';
            
            // Show loading state
            if (button) {
                button.disabled = true;
                button.textContent = 'â³ Updating...';
            }
            
            try {
                const res = await fetch(`/api/announcements/${id}/toggle-global`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_global: isGlobal })
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                
                if (data.success) {
                    showSuccess(`Announcement ${isGlobal ? 'enabled' : 'disabled'} as global announcement!`);
                    
                    // Update the announcement in our local array
                    const announcement = allAnnouncements.find(a => String(a.id) === String(id));
                    if (announcement) {
                        announcement.is_global_announcement = isGlobal;
                    }
                    
                    // Refresh the announcements display
                    loadAnnouncements();
                } else {
                    throw new Error(data.message || 'Failed to toggle global announcement');
                }
            } catch (error) {
                console.error('Error toggling global announcement:', error);
                showError(`Failed to toggle global announcement: ${error.message}`);
                
                // Revert button state on error
                if (button) {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }
        }

        // Debug: Test function availability
        console.log('ðŸ”§ toggleGlobalAnnouncement function defined:', typeof toggleGlobalAnnouncement);

        // Search and filter functionality
        // Announcement search functionality
        document.getElementById('announcementSearch')?.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const filtered = allAnnouncements.filter(announcement =>
                announcement.title.toLowerCase().includes(searchTerm) ||
                announcement.content.toLowerCase().includes(searchTerm)
            );
            renderAnnouncements(filtered);
        });

        document.getElementById('ticketsSearch')?.addEventListener('input', function () {
            filterTickets();
        });

        document.getElementById('ticketsFilter')?.addEventListener('change', function () {
            filterTickets();
        });

        function filterTickets() {
            const searchTerm = document.getElementById('ticketsSearch').value.toLowerCase();
            const statusFilter = document.getElementById('ticketsFilter').value;

            const filtered = allTickets.filter(ticket => {
                const matchesSearch = ticket.subject.toLowerCase().includes(searchTerm) ||
                    ticket.description.toLowerCase().includes(searchTerm) ||
                    (ticket.user_name && ticket.user_name.toLowerCase().includes(searchTerm));
                const matchesStatus = !statusFilter || ticket.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            renderSupportTickets(filtered);
        }

        document.getElementById('faqSearch')?.addEventListener('input', function () {
            filterFAQs();
        });

        document.getElementById('faqCategoryFilter')?.addEventListener('change', function () {
            filterFAQs();
        });

        // Contact Details Event Listeners
        document.getElementById('contactForm')?.addEventListener('submit', submitContactForm);
        
        document.getElementById('contactTypeFilter')?.addEventListener('change', filterContacts);
        document.getElementById('contactStatusFilter')?.addEventListener('change', filterContacts);
        document.getElementById('contactSearch')?.addEventListener('input', filterContacts);

        function filterFAQs() {
            const searchTerm = document.getElementById('faqSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('faqCategoryFilter').value;

            const filtered = allFAQs.filter(faq => {
                const matchesSearch = faq.question.toLowerCase().includes(searchTerm) ||
                    faq.answer.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || faq.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            renderFAQs(filtered);
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showSuccess(message, duration = 3000) {
            const toast = document.getElementById('successToast');
            const messageEl = document.getElementById('successMessage');
            messageEl.textContent = message;

            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, duration);
        }

        function showError(message) {
            const toast = document.getElementById('errorToast');
            const messageEl = document.getElementById('errorMessage');
            messageEl.textContent = message;

            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        function showDeleteModal(message, confirmCallback) {
            const modal = document.getElementById('deleteModal');
            const messageEl = document.getElementById('deleteModalText');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            messageEl.textContent = message;
            modal.classList.remove('hidden');

            confirmBtn.onclick = () => {
                closeDeleteModal();
                confirmCallback();
            };
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        // Edit announcement function
        function editAnnouncement(id) {
            const announcement = allAnnouncements.find(a => a.id === parseInt(id));
            if (!announcement) {
                showError('Announcement not found');
                return;
            }
            
            // Populate form with existing data
            document.getElementById('announcementTitle').value = announcement.title;
            document.getElementById('announcementContent').value = announcement.content;
            document.getElementById('announcementPriority').value = announcement.priority;
            document.getElementById('announcementActive').checked = announcement.is_active;
            
            // Scroll to form
            document.getElementById('announcementForm').scrollIntoView({ behavior: 'smooth' });
            
            // Show success message
            showSuccess('Announcement data loaded for editing. Modify and submit to update.');
        }

        function editFAQ(id) {
            const faq = allFAQs.find(f => f.id === id);
            if (!faq) return;

            document.getElementById('faqModalTitle').textContent = 'Edit FAQ';
            document.getElementById('faqEditId').value = id;
            document.getElementById('faqEditQuestion').value = faq.question;
            document.getElementById('faqEditAnswer').value = faq.answer;
            document.getElementById('faqEditCategory').value = faq.category || '';
            document.getElementById('faqEditOrder').value = faq.order || 0;
            document.getElementById('faqEditActive').checked = faq.is_active;

            document.getElementById('faqModal').classList.remove('hidden');
        }

        function closeFAQModal() {
            document.getElementById('faqModal').classList.add('hidden');
        }

        // FAQ Edit Form submission
        document.getElementById('faqEditForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            const faqId = document.getElementById('faqEditId').value;
            const formData = {
                question: document.getElementById('faqEditQuestion').value.trim(),
                answer: document.getElementById('faqEditAnswer').value.trim(),
                category: document.getElementById('faqEditCategory').value.trim() || 'general',
                order: parseInt(document.getElementById('faqEditOrder').value) || 0,
                is_active: document.getElementById('faqEditActive').checked
            };

            // Enhanced validation
            if (!formData.question) {
                showError('Question is required');
                return;
            }
            if (!formData.answer) {
                showError('Answer is required');
                return;
            }
            if (!faqId) {
                showError('FAQ ID is missing');
                return;
            }

            console.log('Updating FAQ with data:', formData);
            console.log('FAQ ID:', faqId);

            try {
                showLoading();
                
                const res = await fetch(`/api/faqs/${faqId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', res.status);
                console.log('Response headers:', res.headers);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`HTTP ${res.status}: ${errorText || 'Server error'}`);
                }

                const data = await res.json();
                console.log('Response data:', data);

                if (data.success) {
                    showSuccess('FAQ updated successfully!');
                    closeFAQModal();
                    await loadFAQs();
                } else {
                    throw new Error(data.message || 'Update failed - no success flag');
                }
            } catch (error) {
                console.error('Error updating FAQ:', error);
                showError(`Failed to update FAQ: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize review filter event listeners
            const statusFilter = document.getElementById('reviewsStatusFilter');
            const ratingFilter = document.getElementById('reviewsRatingFilter');
            const searchInput = document.getElementById('reviewsSearch');

            if (statusFilter) {
                statusFilter.addEventListener('change', filterReviews);
                console.log('âœ… Status filter event listener added');
            }
            
            if (ratingFilter) {
                ratingFilter.addEventListener('change', filterReviews);
                console.log('âœ… Rating filter event listener added');
            }
            
            if (searchInput) {
                searchInput.addEventListener('input', filterReviews);
                console.log('âœ… Search input event listener added');
            }

            // Start system status updates
            startSystemStatusUpdates();
            console.log('âœ… System status monitoring started');

            // Start support ticket count updates
            startSupportTicketCountUpdates();
            console.log('âœ… Support ticket count monitoring started');

            // Check timezone on login (after successful authentication)
            checkTimezoneOnLogin();
            console.log('âœ… Timezone check initiated');

            showSection('dashboard');
        });

        // Handle window resize for mobile menu
        window.addEventListener('resize', function () {
            if (window.innerWidth >= 1024) {
                sidebar.classList.remove('-translate-x-full');
                mobileMenuOverlay.classList.add('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        });

        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function () {
            stopSystemStatusUpdates();
            stopSupportTicketCountUpdates();
        });

        // Close modals when clicking outside
        document.getElementById('userModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeUserModal();
            }
        });

        document.getElementById('settingsModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });

        document.getElementById('faqModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeFAQModal();
            }
        });

        // Handle form validation
        document.getElementById('userForm')?.addEventListener('input', function (e) {
            const field = e.target;
            const isValid = field.checkValidity();

            // Remove existing validation classes
            field.classList.remove('border-red-300', 'border-green-300');

            // Add validation classes
            if (field.value && !isValid) {
                field.classList.add('border-red-300');
            } else if (field.value && isValid) {
                field.classList.add('border-green-300');
            }
        });

        // ========================================================
        // LEGAL DOCUMENTS MANAGEMENT FUNCTIONS
        // ========================================================

        // Global variables for legal documents
        let currentDocumentType = 'privacy';
        let legalDocuments = {
            privacy: null,
            terms: null,
            cookie: null,
            security: null,
            compliance: null
        };

        // Calculate next version number from server
        async function getNextVersion() {
            try {
                const response = await fetch('/api/legal-documents/next-version');
                if (response.ok) {
                    const data = await response.json();
                    return data.next_version;
                } else {
                    console.error('Failed to get next version from server');
                    // Fallback to local calculation
                    return getNextVersionLocal();
                }
            } catch (error) {
                console.error('Error getting next version:', error);
                // Fallback to local calculation
                return getNextVersionLocal();
            }
        }

        // Fallback local version calculation
        function getNextVersionLocal() {
            let maxVersion = 0;
            
            // Check all document types for their current versions
            Object.values(legalDocuments).forEach(doc => {
                if (doc && doc.version) {
                    const version = parseFloat(doc.version);
                    if (!isNaN(version) && version > maxVersion) {
                        maxVersion = version;
                    }
                }
            });
            
            // Increment by 0.1 and format to one decimal place
            return (maxVersion + 0.1).toFixed(1);
        }

        // Load all legal documents
        async function loadLegalDocuments() {
            try {
                await Promise.all([
                    loadDocument('privacy'),
                    loadDocument('terms'),
                    loadDocument('cookie'),
                    loadDocument('security'),
                    loadDocument('compliance')
                ]);
                
                // Show first tab
                showDocumentTab('privacy');
                
                // Update stats
                updateLegalDocumentsStats();
            } catch (error) {
                console.error('Error loading legal documents:', error);
                showError('Failed to load legal documents');
            }
        }

        // Load individual document
        async function loadDocument(type) {
            try {
                const response = await fetch(`/api/legal-documents/${type}`);
                if (response.ok) {
                    const data = await response.json();
                    legalDocuments[type] = data;
                    updateDocumentDisplay(type, data);
                } else {
                    console.error(`Failed to load ${type} document:`, response.statusText);
                }
            } catch (error) {
                console.error(`Error loading ${type} document:`, error);
            }
        }

        // Update document display
        function updateDocumentDisplay(type, docData) {
            const contentElement = document.getElementById(`${type}-current-content`);
            if (contentElement && docData) {
                // Convert markdown to HTML for display (simple conversion)
                const htmlContent = docData.content
                    .replace(/^# (.*$)/gim, '<h1 class="text-xl font-bold mb-4">$1</h1>')
                    .replace(/^## (.*$)/gim, '<h2 class="text-lg font-semibold mb-3">$1</h2>')
                    .replace(/^### (.*$)/gim, '<h3 class="text-base font-semibold mb-2">$1</h3>')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gim, '<em>$1</em>')
                    .replace(/\n\n/gim, '</p><p class="mb-2">')
                    .replace(/^(.*)$/gim, '<p class="mb-2">$1</p>');
                
                contentElement.innerHTML = htmlContent;
            }
        }

        // Update stats display
        function updateLegalDocumentsStats() {
            const documentTypes = ['privacy', 'terms', 'cookie', 'security', 'compliance'];
            
            documentTypes.forEach(type => {
                const docData = legalDocuments[type];
                const versionElement = document.getElementById(`${type}Version`);
                const statusElement = document.getElementById(`${type}Status`);
                
                if (docData && versionElement && statusElement) {
                    versionElement.textContent = `v${docData.version}`;
                    statusElement.textContent = docData.is_active ? 'Active' : 'Inactive';
                    statusElement.className = document.is_active 
                        ? statusElement.className.replace(/text-gray-\d+/, 'text-green-600')
                        : statusElement.className.replace(/text-green-\d+/, 'text-gray-500');
                } else if (versionElement && statusElement) {
                    versionElement.textContent = 'N/A';
                    statusElement.textContent = 'Not Found';
                    statusElement.className = statusElement.className.replace(/text-\w+-\d+/, 'text-red-500');
                }
            });
        }

        // Show document tab
        function showDocumentTab(type) {
            currentDocumentType = type;
            
            // Update tab styles
            document.querySelectorAll('.document-tab').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600', 'border-green-500', 'text-green-600', 
                                   'border-orange-500', 'text-orange-600', 'border-purple-500', 'text-purple-600',
                                   'border-indigo-500', 'text-indigo-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show active tab
            const activeTab = document.getElementById(`tab-${type}`);
            if (activeTab) {
                activeTab.classList.remove('border-transparent', 'text-gray-500');
                const colors = {
                    privacy: ['border-blue-500', 'text-blue-600'],
                    terms: ['border-green-500', 'text-green-600'],
                    cookie: ['border-orange-500', 'text-orange-600'],
                    security: ['border-purple-500', 'text-purple-600'],
                    compliance: ['border-indigo-500', 'text-indigo-600']
                };
                activeTab.classList.add(...colors[type]);
            }
            
            // Show/hide panels
            document.querySelectorAll('.document-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            const activePanel = document.getElementById(`${type}-panel`);
            if (activePanel) {
                activePanel.classList.remove('hidden');
            }
        }

        // Toggle edit mode
        async function toggleEditMode(type) {
            const display = document.getElementById(`${type}-display`);
            const form = document.getElementById(`${type}-form`);
            const editBtn = document.getElementById(`edit-${type}-btn`);
            
            if (form.classList.contains('hidden')) {
                // Enter edit mode
                form.classList.remove('hidden');
                display.classList.add('hidden');
                editBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i> Cancel';
                editBtn.onclick = () => cancelEdit(type);
                
                // Populate form with current data
                const docData = legalDocuments[type];
                if (docData) {
                    // Auto-populate with next version number
                    const nextVersion = await getNextVersion();
                    document.getElementById(`${type}-version`).value = nextVersion;
                    document.getElementById(`${type}-date`).value = new Date().toISOString().split('T')[0]; // Today's date
                    document.getElementById(`${type}-title`).value = docData.title;
                    document.getElementById(`${type}-content`).value = docData.content;
                }
            } else {
                // Exit edit mode
                cancelEdit(type);
            }
        }

        // Cancel edit mode
        function cancelEdit(type) {
            const display = document.getElementById(`${type}-display`);
            const form = document.getElementById(`${type}-form`);
            const editBtn = document.getElementById(`edit-${type}-btn`);
            
            form.classList.add('hidden');
            display.classList.remove('hidden');
            editBtn.innerHTML = '<i data-lucide="edit" class="w-4 h-4"></i> Edit';
            editBtn.onclick = () => toggleEditMode(type);
            
            // Reset form
            form.reset();
        }

        // Preview document
        function previewDocument(type) {
            const docData = legalDocuments[type];
            if (docData) {
                // Open in new window/tab for preview
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${docData.title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                            h1 { color: #333; border-bottom: 2px solid #3B82F6; padding-bottom: 10px; }
                            h2 { color: #555; margin-top: 30px; }
                            h3 { color: #666; margin-top: 20px; }
                            p { line-height: 1.6; margin-bottom: 10px; }
                        </style>
                    </head>
                    <body>
                        ${docData.content.replace(/\n/g, '<br>')}
                    </body>
                    </html>
                `);
                previewWindow.document.close();
            }
        }

        // Refresh all legal documents
        async function refreshAllLegalDocuments() {
            showLoading();
            try {
                await loadLegalDocuments();
                showSuccess('Legal documents refreshed successfully');
            } catch (error) {
                console.error('Error refreshing legal documents:', error);
                showError('Failed to refresh legal documents');
            } finally {
                hideLoading();
            }
        }

        // Setup form event listeners for legal documents
        document.addEventListener('DOMContentLoaded', function() {
            // Privacy Policy form
            const privacyForm = document.getElementById('privacy-form');
            if (privacyForm) {
                privacyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveDocument('privacy');
                });
            }

            // Terms of Service form
            const termsForm = document.getElementById('terms-form');
            if (termsForm) {
                termsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveDocument('terms');
                });
            }

            // Cookie Policy form
            const cookieForm = document.getElementById('cookie-form');
            if (cookieForm) {
                cookieForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveDocument('cookie');
                });
            }

            // Security Policy form
            const securityForm = document.getElementById('security-form');
            if (securityForm) {
                securityForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveDocument('security');
                });
            }

            // Compliance Policy form
            const complianceForm = document.getElementById('compliance-form');
            if (complianceForm) {
                complianceForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveDocument('compliance');
                });
            }
        });

        // Save document
        async function saveDocument(type) {
            try {
                const formData = {
                    version: document.getElementById(`${type}-version`).value,
                    title: document.getElementById(`${type}-title`).value,
                    content: document.getElementById(`${type}-content`).value,
                    effective_date: document.getElementById(`${type}-date`).value
                };

                const response = await fetch(`/api/legal-documents/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const updatedDocument = await response.json();
                    legalDocuments[type] = updatedDocument;
                    updateDocumentDisplay(type, updatedDocument);
                    updateLegalDocumentsStats();
                    cancelEdit(type);
                    showSuccess(`${type.charAt(0).toUpperCase() + type.slice(1)} policy updated successfully!`);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save document');
                }
            } catch (error) {
                console.error(`Error saving ${type} document:`, error);
                showError(`Failed to save ${type} policy: ${error.message}`);
            }
        }

        // Email Management Functions
        async function loadEmailRecipients() {
            try {
                const response = await fetch('/api/email-recipients');
                const data = await response.json();
                
                console.log('Email Recipients API Response:', data); // Debug log
                
                if (data.success && data.users) {
                    const recipientsList = document.getElementById('emailRecipientsList');
                    const checkboxContainer = document.getElementById('recipientCheckboxes');
                    
                    // Update recipients list display
                    recipientsList.innerHTML = data.users.map(user => {
                        const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email;
                        const isEnabled = user.email_notifications_enabled;
                        return `
                        <div class="flex items-center justify-between bg-white p-2 rounded-lg border">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="user" class="w-4 h-4 text-blue-600"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-900">${fullName}</span>
                                    <div class="text-xs text-gray-500">${user.email}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs ${isEnabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'} rounded-full">
                                    ${isEnabled ? 'Notifications On' : 'Notifications Off'}
                                </span>
                            </div>
                        </div>
                        `;
                    }).join('');
                    
                    // Update checkboxes with current preferences
                    checkboxContainer.innerHTML = data.users.map(user => {
                        const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email;
                        const isEnabled = user.email_notifications_enabled;
                        return `
                        <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer">
                            <input type="checkbox" value="${user.id}" class="recipient-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${isEnabled ? 'checked' : ''}>
                            <div class="ml-3 flex items-center gap-2">
                                <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="user" class="w-3 h-3 text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${fullName}</div>
                                    <div class="text-xs text-gray-500">${user.email}</div>
                                </div>
                            </div>
                        </label>
                        `;
                    }).join('');
                    
                    lucide.createIcons();
                } else {
                    console.error('No users found in email recipients API response:', data);
                    showError('No email recipients data received from server');
                }
            } catch (error) {
                console.error('Error loading email recipients:', error);
                showError('Failed to load email recipients: ' + error.message);
            }
        }

        async function loadEmailWeeks() {
            try {
                const response = await fetch('/api/weeks');
                const data = await response.json();
                
                if (data.success && data.weeks) {
                    const weekSelect = document.getElementById('emailWeekSelect');
                    weekSelect.innerHTML = '<option value="">Select a week...</option>' + 
                        data.weeks.map(week => `<option value="${week.week_name}">${week.week_name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading weeks:', error);
                showError('Failed to load weeks');
            }
        }

        function selectAllRecipients() {
            const checkboxes = document.querySelectorAll('.recipient-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function deselectAllRecipients() {
            const checkboxes = document.querySelectorAll('.recipient-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        async function saveRecipientSelection() {
            const checkboxes = document.querySelectorAll('.recipient-checkbox');
            const preferences = Array.from(checkboxes).map(checkbox => ({
                user_id: checkbox.value,
                enabled: checkbox.checked
            }));
            
            try {
                const response = await fetch('/api/email-recipients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preferences: preferences })
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('Email preferences saved successfully!');
                    // Reload the recipients to show updated status
                    await loadEmailRecipients();
                } else {
                    throw new Error(data.message || 'Failed to save email preferences');
                }
            } catch (error) {
                console.error('Error saving email preferences:', error);
                showError('Failed to save email preferences: ' + error.message);
            }
        }

        async function sendManualEmail() {
            const week = document.getElementById('emailWeekSelect').value;
            const day = document.getElementById('emailDaySelect').value;
            const includeDailyPDF = document.getElementById('includeDailyPDF').checked;
            const includeWeeklyPDF = document.getElementById('includeWeeklyPDF').checked;
            
            if (!week || !day) {
                showError('Please select both week and day');
                return;
            }
            
            const selectedRecipients = Array.from(document.querySelectorAll('.recipient-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedRecipients.length === 0) {
                showError('Please select at least one recipient');
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>Sending...';
            
            try {
                const response = await fetch('/api/send-manual-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        week_name: week,
                        day_of_week: day,
                        recipient_ids: selectedRecipients,
                        include_daily_pdf: includeDailyPDF,
                        include_weekly_pdf: includeWeeklyPDF
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess(`Email alert sent successfully to ${selectedRecipients.length} recipients!`);
                    loadEmailActivityLog(); // Refresh the activity log
                } else {
                    throw new Error(data.message || 'Failed to send email alert');
                }
            } catch (error) {
                console.error('Error sending manual email:', error);
                showError('Failed to send email alert: ' + error.message);
            } finally {
                // Restore button
                button.disabled = false;
                button.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        let currentEmailLogPage = 1;
        const emailLogPerPage = 5;

        async function loadEmailActivityLog(page = 1) {
            try {
                const response = await fetch(`/api/email-activity-log?page=${page}&per_page=${emailLogPerPage}`);
                const data = await response.json();
                
                if (data.success && data.activities) {
                    const logContainer = document.getElementById('emailActivityLog');
                    
                    if (data.activities.length === 0) {
                        logContainer.innerHTML = `
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-sm text-gray-500 text-center italic">
                                    No email activity yet
                                </td>
                            </tr>
                        `;
                    } else {
                        logContainer.innerHTML = data.activities.map(activity => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${activity.sent_date}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getTypeColor(activity.type_raw)}">
                                        ${activity.type}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${activity.recipients_count} recipients
                                    <div class="text-xs text-gray-500 truncate max-w-xs" title="${activity.recipients}">
                                        ${activity.recipients}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${activity.week_name}
                                    ${activity.sent_by_name ? `<div class="text-xs text-gray-500">by ${activity.sent_by_name}</div>` : ''}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(activity.status)}">
                                        ${activity.status.charAt(0).toUpperCase() + activity.status.slice(1)}
                                    </span>
                                    ${activity.error_message ? `<div class="text-xs text-red-500 mt-1" title="${activity.error_message}">Error: ${activity.error_message.substring(0, 30)}...</div>` : ''}
                                </td>
                            </tr>
                        `).join('');
                    }
                    
                    // Update pagination
                    updateEmailLogPagination(data.pagination);
                    currentEmailLogPage = page;
                }
            } catch (error) {
                console.error('Error loading email activity log:', error);
                const logContainer = document.getElementById('emailActivityLog');
                logContainer.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-sm text-red-500 text-center">
                            Error loading email activity log
                        </td>
                    </tr>
                `;
            }
        }

        function getTypeColor(type) {
            const colors = {
                'automatic': 'bg-blue-100 text-blue-800',
                'manual': 'bg-purple-100 text-purple-800',
                'test': 'bg-gray-100 text-gray-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function getStatusColor(status) {
            const colors = {
                'sent': 'bg-green-100 text-green-800',
                'failed': 'bg-red-100 text-red-800',
                'pending': 'bg-yellow-100 text-yellow-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function updateEmailLogPagination(pagination) {
            // Update pagination info and controls if they exist
            const paginationContainer = document.getElementById('emailLogPagination');
            if (paginationContainer) {
                paginationContainer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Showing page ${pagination.page} of ${pagination.total_pages} (${pagination.total} total records)
                        </div>
                        <div class="flex gap-2">
                            <button onclick="loadEmailActivityLog(${pagination.page - 1})" 
                                    ${!pagination.has_prev ? 'disabled' : ''} 
                                    class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <button onclick="loadEmailActivityLog(${pagination.page + 1})" 
                                    ${!pagination.has_next ? 'disabled' : ''} 
                                    class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                        </div>
                    </div>
                `;
            }
        }
    </script>

    <!-- Support Ticket Details Modal -->
    <div id="ticketDetailsModal" class="fixed inset-0 z-50 hidden">
        <!-- Enhanced Glassy Blueish Backdrop -->
        <div class="fixed inset-0 bg-gradient-to-br from-blue-500/30 via-indigo-500/20 to-purple-500/30 backdrop-blur-md transition-all duration-300" onclick="closeTicketModal()"></div>
        
        <!-- Modal Content -->
        <div class="fixed inset-0 flex items-center justify-center p-4 transition-all duration-300">
            <div class="glass-card bg-white/95 rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden transform transition-all duration-300 scale-100 hover:scale-[1.01]">
                <!-- Enhanced Modern Modal Header -->
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 text-white px-6 py-5 relative overflow-hidden">
                    <!-- Animated Background Pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="absolute top-0 left-0 w-32 h-32 bg-white rounded-full -translate-x-16 -translate-y-16 animate-pulse"></div>
                        <div class="absolute bottom-0 right-0 w-24 h-24 bg-white rounded-full translate-x-12 translate-y-12 animate-pulse delay-300"></div>
                    </div>
                    
                    <div class="flex items-center justify-between relative z-10">
                        <div class="flex items-center gap-4">
                            <div class="p-2 bg-white/20 rounded-xl backdrop-blur-sm">
                                <i data-lucide="ticket" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold" id="modalTicketNumber">Loading...</h2>
                                <p class="text-blue-100 text-sm font-medium" id="modalTicketSubject">Loading...</p>
                            </div>
                        </div>
                        <button onclick="closeTicketModal()" class="p-2 hover:bg-white/20 rounded-xl transition-all duration-200 hover:rotate-90">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="overflow-y-auto max-h-[calc(90vh-200px)]">
                    <div class="p-6">
                        <!-- Enhanced Ticket Status and Priority -->
                        <div class="flex flex-wrap items-center gap-3 mb-6 p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-2xl border border-blue-100">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-700 flex items-center gap-1">
                                    <i data-lucide="activity" class="w-4 h-4 text-blue-600"></i>
                                    Status:
                                </span>
                                <span id="modalTicketStatus" class="px-4 py-2 text-sm font-bold rounded-xl bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 shadow-sm">Loading...</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-700 flex items-center gap-1">
                                    <i data-lucide="flag" class="w-4 h-4 text-purple-600"></i>
                                    Priority:
                                </span>
                                <span id="modalTicketPriority" class="px-4 py-2 text-sm font-bold rounded-xl bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 shadow-sm">Loading...</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-700 flex items-center gap-1">
                                    <i data-lucide="folder" class="w-4 h-4 text-indigo-600"></i>
                                    Category:
                                </span>
                                <span id="modalTicketCategory" class="px-4 py-2 text-sm font-bold rounded-xl bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 shadow-sm">Loading...</span>
                            </div>
                        </div>

                        <!-- Enhanced User Information -->
                        <div class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 rounded-2xl p-6 mb-6 border border-purple-100 shadow-sm">
                            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                                <div class="p-2 bg-gradient-to-r from-purple-500 to-blue-600 rounded-xl shadow-lg">
                                    <i data-lucide="user" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">Customer Information</span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white/70 backdrop-blur-sm rounded-xl p-4 border border-white/40 shadow-sm">
                                    <span class="text-sm font-semibold text-gray-600 flex items-center gap-2 mb-2">
                                        <i data-lucide="user-circle" class="w-4 h-4 text-purple-600"></i>
                                        Full Name:
                                    </span>
                                    <p id="modalUserName" class="text-gray-900 font-bold text-lg">Loading...</p>
                                </div>
                                <div class="bg-white/70 backdrop-blur-sm rounded-xl p-4 border border-white/40 shadow-sm">
                                    <span class="text-sm font-semibold text-gray-600 flex items-center gap-2 mb-2">
                                        <i data-lucide="mail" class="w-4 h-4 text-blue-600"></i>
                                        Email Address:
                                    </span>
                                    <p id="modalUserEmail" class="text-gray-900 font-bold text-lg break-all">Loading...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Ticket Description -->
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                                <div class="p-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl shadow-lg">
                                    <i data-lucide="file-text" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">Ticket Description</span>
                            </h3>
                            <div id="modalTicketDescription" class="bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 border-2 border-green-100 rounded-2xl p-6 text-gray-800 leading-relaxed shadow-sm min-h-[120px] font-medium">
                                Loading ticket description...
                            </div>
                        </div>

                        <!-- Enhanced Timestamps -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-100 rounded-2xl p-5 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center gap-3 text-amber-700 mb-3">
                                    <div class="p-2 bg-gradient-to-r from-amber-500 to-orange-500 rounded-lg shadow-sm">
                                        <i data-lucide="calendar-plus" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <span class="text-sm font-bold">Created On</span>
                                </div>
                                <p id="modalCreatedDate" class="text-gray-900 font-bold text-lg">Loading...</p>
                            </div>
                            <div class="bg-gradient-to-br from-violet-50 to-purple-50 border-2 border-violet-100 rounded-2xl p-5 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center gap-3 text-violet-700 mb-3">
                                    <div class="p-2 bg-gradient-to-r from-violet-500 to-purple-500 rounded-lg shadow-sm">
                                        <i data-lucide="calendar-clock" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <span class="text-sm font-bold">Last Updated</span>
                                </div>
                                <p id="modalUpdatedDate" class="text-gray-900 font-bold text-lg">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Modern Modal Footer -->
                <div class="bg-gradient-to-r from-gray-50 via-blue-50 to-indigo-50 px-6 py-5 border-t-2 border-gray-100">
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- Enhanced Status Update Buttons -->
                        <button id="modalBtnInProgress" onclick="updateTicketStatusFromModal('in_progress')" 
                            class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                            In Progress
                        </button>
                        <button id="modalBtnWaiting" onclick="updateTicketStatusFromModal('waiting')" 
                            class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="pause" class="w-4 h-4 mr-2"></i>
                            Waiting
                        </button>
                        <button id="modalBtnResolved" onclick="updateTicketStatusFromModal('resolved')" 
                            class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="check" class="w-4 h-4 mr-2"></i>
                            Resolve
                        </button>
                        <button id="modalBtnClosed" onclick="updateTicketStatusFromModal('closed')" 
                            class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                            Close
                        </button>
                        
                        <!-- Spacer -->
                        <div class="flex-1"></div>
                        
                        <!-- Enhanced Delete Button -->
                        <button id="modalBtnDelete" onclick="deleteTicketFromModal()" 
                            class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Delete Ticket
                        </button>
                        
                        <!-- Enhanced Close Button -->
                        <button onclick="closeTicketModal()" 
                            class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-slate-400 to-slate-500 hover:from-slate-500 hover:to-slate-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>
                            Close Modal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Details Modal -->
    <!-- Contact Details Modal -->
    <div id="contactModal" class="fixed inset-0 bg-blue-900/20 backdrop-blur-md flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Modal Content -->
            <div class="bg-white/90 backdrop-blur-xl border border-white/20 shadow-2xl p-8 rounded-3xl">
                <!-- Header -->
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                            <i data-lucide="phone" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 id="contactModalTitle" class="text-2xl font-bold text-gray-900">Contact Details</h3>
                            <p class="text-sm text-gray-600">View contact information</p>
                        </div>
                    </div>
                    <button onclick="closeContactModal()"
                        class="p-3 hover:bg-white/50 rounded-2xl transition-all hover:scale-105 backdrop-blur-sm">
                        <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                    </button>
                </div>

                <!-- Contact Information Display -->
                <div id="contactViewMode" class="space-y-6">
                    <!-- Contact Header -->
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between p-6 bg-gradient-to-r from-blue-50/80 to-indigo-50/80 backdrop-blur-sm rounded-2xl border border-blue-200/50">
                        <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                            <div id="contactModalIcon" class="w-16 h-16 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i data-lucide="phone" class="w-8 h-8 text-white"></i>
                            </div>
                            <div>
                                <h4 id="contactModalDisplayTitle" class="text-xl font-bold text-gray-900">Phone Support</h4>
                                <p id="contactModalDisplayType" class="text-sm text-gray-600 capitalize">phone</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="contactModalStatus" class="px-3 py-1 rounded-full text-xs font-medium bg-green-100/80 text-green-700 backdrop-blur-sm">Active</span>
                            <span id="contactModalPrimary" class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100/80 text-blue-700 backdrop-blur-sm hidden">Primary</span>
                        </div>
                    </div>

                    <!-- Contact Details Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="p-4 bg-white/50 backdrop-blur-sm rounded-xl border border-white/30 shadow-sm">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">Contact Value</label>
                                <p id="contactModalValue" class="text-lg font-semibold text-gray-900 break-all">--</p>
                            </div>
                            <div class="p-4 bg-white/50 backdrop-blur-sm rounded-xl border border-white/30 shadow-sm">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">Availability</label>
                                <p id="contactModalAvailability" class="text-gray-900">--</p>
                            </div>
                            <div class="p-4 bg-white/50 backdrop-blur-sm rounded-xl border border-white/30 shadow-sm">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">Response Time</label>
                                <p id="contactModalResponseTime" class="text-gray-900">--</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="p-4 bg-white/50 backdrop-blur-sm rounded-xl border border-white/30 shadow-sm">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">Description</label>
                                <p id="contactModalDescription" class="text-gray-900">--</p>
                            </div>
                            <div class="p-4 bg-white/50 backdrop-blur-sm rounded-xl border border-white/30 shadow-sm">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">Sort Order</label>
                                <p id="contactModalSortOrder" class="text-gray-900">--</p>
                            </div>
                            <div class="p-4 bg-white/50 backdrop-blur-sm rounded-xl border border-white/30 shadow-sm">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">Created At</label>
                                <p id="contactModalCreatedAt" class="text-gray-900">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row items-center justify-between pt-6 border-t border-gray-200/50 space-y-3 sm:space-y-0">
                        <button onclick="closeContactModal()" 
                            class="w-full sm:w-auto px-6 py-3 border border-gray-300/50 text-gray-700 rounded-xl font-medium hover:bg-white/50 transition-colors backdrop-blur-sm">
                            <i data-lucide="x" class="w-4 h-4 mr-2 inline"></i>
                            Close
                        </button>
                        <div class="flex items-center space-x-3 w-full sm:w-auto">
                            <button onclick="confirmDeleteContact()" 
                                class="flex-1 sm:flex-none px-6 py-3 bg-red-500/90 text-white rounded-xl font-medium hover:bg-red-600/90 transition-colors backdrop-blur-sm shadow-lg">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2 inline"></i>
                                Delete Contact
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Profile Modal -->
    <div id="profileModal" class="fixed inset-0 z-50 hidden">
        <!-- Enhanced Glassy Blueish Backdrop -->
        <div class="fixed inset-0 bg-gradient-to-br from-purple-500/30 via-blue-500/20 to-indigo-500/30 backdrop-blur-md transition-all duration-300" onclick="closeProfileModal()"></div>
        
        <!-- Modal Content -->
        <div class="fixed inset-0 flex items-center justify-center p-4 transition-all duration-300">
            <div class="glass-card bg-white/95 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden transform transition-all duration-300 scale-100 hover:scale-[1.01]">
                
                <!-- Enhanced Modern Modal Header -->
                <div class="bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-700 text-white px-6 py-5 relative overflow-hidden">
                    <!-- Animated Background Pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="absolute top-0 left-0 w-32 h-32 bg-white rounded-full -translate-x-16 -translate-y-16 animate-pulse"></div>
                        <div class="absolute bottom-0 right-0 w-24 h-24 bg-white rounded-full translate-x-12 translate-y-12 animate-pulse delay-300"></div>
                    </div>
                    
                    <div class="flex items-center justify-between relative z-10">
                        <div class="flex items-center gap-4">
                            <div class="p-2 bg-white/20 rounded-xl backdrop-blur-sm">
                                <i data-lucide="user-circle" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">Admin Profile</h2>
                                <p class="text-blue-100 text-sm font-medium">Manage your account settings</p>
                            </div>
                        </div>
                        <button onclick="closeProfileModal()" class="p-2 hover:bg-white/20 rounded-xl transition-all duration-200 hover:rotate-90">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="overflow-y-auto max-h-[calc(90vh-200px)] p-6">
                    
                    <!-- Profile Information Section -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                            <div class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg">
                                <i data-lucide="user" class="w-6 h-6 text-white"></i>
                            </div>
                            <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Profile Information</span>
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Profile Picture -->
                            <div class="col-span-full flex justify-center mb-6">
                                <div class="relative">
                                    <img id="profileImage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23667eea'/%3E%3Ctext x='50' y='58' text-anchor='middle' fill='white' font-size='36' font-family='Arial'%3EA%3C/text%3E%3C/svg%3E"
                                        class="w-24 h-24 rounded-full border-4 border-white shadow-xl" alt="Admin Avatar" />
                                    <div class="absolute -bottom-2 -right-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full p-2 shadow-lg">
                                        <i data-lucide="check" class="w-4 h-4 text-white"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Personal Information -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-5 border border-blue-100 shadow-sm">
                                <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                                    <i data-lucide="user" class="w-4 h-4 text-blue-600"></i>
                                    Full Name
                                </label>
                                <p id="profileFullName" class="text-gray-900 font-bold text-lg">Loading...</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-2xl p-5 border border-purple-100 shadow-sm">
                                <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                                    <i data-lucide="mail" class="w-4 h-4 text-purple-600"></i>
                                    Email Address
                                </label>
                                <p id="profileEmail" class="text-gray-900 font-bold text-lg break-all">Loading...</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-5 border border-green-100 shadow-sm">
                                <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                                    <i data-lucide="shield" class="w-4 h-4 text-green-600"></i>
                                    Role
                                </label>
                                <p id="profileRole" class="text-gray-900 font-bold text-lg">Administrator</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-5 border border-amber-100 shadow-sm">
                                <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                                    <i data-lucide="calendar" class="w-4 h-4 text-amber-600"></i>
                                    Member Since
                                </label>
                                <p id="profileCreatedDate" class="text-gray-900 font-bold text-lg">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Password Reset Section -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                            <div class="p-2 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl shadow-lg">
                                <i data-lucide="lock" class="w-6 h-6 text-white"></i>
                            </div>
                            <span class="bg-gradient-to-r from-red-600 to-pink-600 bg-clip-text text-transparent">Password Security</span>
                        </h3>
                        
                        <div class="bg-gradient-to-br from-red-50 via-pink-50 to-rose-50 rounded-2xl p-6 border-2 border-red-100 shadow-sm">
                            <form id="passwordResetForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="key" class="w-4 h-4 text-red-600"></i>
                                        Current Password
                                    </label>
                                    <div class="relative">
                                        <input id="currentPassword" type="password" required
                                            class="w-full px-4 py-3 pr-12 border-2 border-red-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                                            placeholder="Enter your current password">
                                        <button type="button" onclick="togglePasswordVisibility('currentPassword')"
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600 transition-colors">
                                            <i data-lucide="eye" class="w-5 h-5" id="currentPasswordToggle"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="lock" class="w-4 h-4 text-red-600"></i>
                                        New Password
                                    </label>
                                    <div class="relative">
                                        <input id="newPassword" type="password" required
                                            class="w-full px-4 py-3 pr-12 border-2 border-red-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                                            placeholder="Enter your new password"
                                            oninput="checkPasswordStrength()">
                                        <button type="button" onclick="togglePasswordVisibility('newPassword')"
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600 transition-colors">
                                            <i data-lucide="eye" class="w-5 h-5" id="newPasswordToggle"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Password Strength Bar -->
                                    <div class="mt-3">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-xs font-semibold text-gray-600">Password Strength:</span>
                                            <span id="strengthText" class="text-xs font-bold text-red-500">Weak</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                            <div id="strengthBar" class="h-full bg-red-400 transition-all duration-300 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Password Requirements Checklist -->
                                    <div class="mt-4 p-3 bg-white/70 rounded-xl border border-red-100">
                                        <h4 class="text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                            <i data-lucide="shield-check" class="w-3 h-3"></i>
                                            Password Requirements:
                                        </h4>
                                        <div class="space-y-1">
                                            <div id="lengthCheck" class="flex items-center gap-2 text-xs">
                                                <i data-lucide="x" class="w-3 h-3 text-red-500"></i>
                                                <span class="text-gray-600">At least 6 characters</span>
                                            </div>
                                            <div id="upperCheck" class="flex items-center gap-2 text-xs">
                                                <i data-lucide="x" class="w-3 h-3 text-red-500"></i>
                                                <span class="text-gray-600">At least one uppercase letter</span>
                                            </div>
                                            <div id="lowerCheck" class="flex items-center gap-2 text-xs">
                                                <i data-lucide="x" class="w-3 h-3 text-red-500"></i>
                                                <span class="text-gray-600">At least one lowercase letter</span>
                                            </div>
                                            <div id="numberCheck" class="flex items-center gap-2 text-xs">
                                                <i data-lucide="x" class="w-3 h-3 text-red-500"></i>
                                                <span class="text-gray-600">At least one number</span>
                                            </div>
                                            <div id="specialCheck" class="flex items-center gap-2 text-xs">
                                                <i data-lucide="x" class="w-3 h-3 text-red-500"></i>
                                                <span class="text-gray-600">At least one special character</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-red-600"></i>
                                        Confirm New Password
                                    </label>
                                    <div class="relative">
                                        <input id="confirmPassword" type="password" required
                                            class="w-full px-4 py-3 pr-12 border-2 border-red-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                                            placeholder="Confirm your new password"
                                            oninput="checkPasswordMatch()">
                                        <button type="button" onclick="togglePasswordVisibility('confirmPassword')"
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600 transition-colors">
                                            <i data-lucide="eye" class="w-5 h-5" id="confirmPasswordToggle"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Password Match Indicator -->
                                    <div id="passwordMatchIndicator" class="mt-2 hidden">
                                        <div class="flex items-center gap-2 text-xs">
                                            <i id="matchIcon" data-lucide="x" class="w-3 h-3 text-red-500"></i>
                                            <span id="matchText" class="text-gray-600">Passwords do not match</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="pt-4">
                                    <button type="submit" 
                                        class="w-full inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                        <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i>
                                        Update Password
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="bg-gradient-to-r from-gray-50 via-blue-50 to-indigo-50 px-6 py-4 border-t-2 border-gray-100">
                    <div class="flex justify-end gap-3">
                        <button onclick="closeProfileModal()" 
                            class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-slate-400 to-slate-500 hover:from-slate-500 hover:to-slate-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility announcements -->
    <div aria-live="assertive" aria-atomic="true" class="sr-only" id="accessibilityAnnouncements"></div>

</body>

</html>