<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacation Management Dashboard</title>
    <!-- Tailwind CSS -->
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet" />
    <style>
        /* Custom animations and styles */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Hamburger Menu Animation */
        .hamburger {
            width: 24px;
            height: 20px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Hide hamburger on large screens */
        @media (min-width: 1024px) {
            .hamburger {
                display: none !important;
            }
        }

        .hamburger span {
            display: block;
            height: 2px;
            width: 100%;
            background-color: #334155;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background-color: white;
            z-index: 100;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-menu.active {
            left: 0;
        }

        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Hide mobile menu on large screens */
        @media (min-width: 1024px) {
            .mobile-menu,
            .mobile-overlay {
                display: none !important;
            }
        }

        /* Glassy Navbar Effect */
        .glass-navbar {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* Enhanced Search Field */
        .glass-search {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .glass-search:focus {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-1px);
        }

        /* Avatar styles */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Status indicator pulse */
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Toast Animations */
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .toast {
            animation: toastSlideIn 0.3s ease-out;
        }

        .toast.removing {
            animation: toastSlideOut 0.3s ease-in;
        }

        /* Modal Animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-backdrop {
            animation: modalFadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: modalSlideIn 0.2s ease-out;
        }

        /* Logout Modal Styles - Glass Morphism */
        .logout-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 9999;
            animation: modalFadeIn 0.3s ease-out;
            padding: 1rem;
        }

        .logout-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-modal {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.25) 0%, 
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
            padding: 2.5rem 2rem;
            text-align: center;
            max-width: 420px;
            width: 100%;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        .logout-modal h2 {
            color: white;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .logout-modal p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.05rem;
            margin-bottom: 1.5rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Gradient Spinner Animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .logout-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #60a5fa 0deg,
                #a78bfa 90deg,
                #f0abfc 180deg,
                #60a5fa 360deg
            );
            animation: spin 1s linear infinite;
            margin: 0 auto;
            position: relative;
        }

        .logout-spinner::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            backdrop-filter: blur(10px);
        }

        /* Decorative dots */
        .logout-dots {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .logout-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .logout-dot:nth-child(2) {
            animation-delay: 0.3s;
        }

        .logout-dot:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.4;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .logout-modal {
                padding: 2rem 1.5rem;
                border-radius: 1.25rem;
                max-width: 90%;
            }
            
            .logout-modal h2 {
                font-size: 1.5rem;
            }
            
            .logout-modal p {
                font-size: 0.95rem;
            }
            
            .logout-spinner {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body class="bg-slate-50 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500">
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center gap-3">
                <div class="avatar bg-blue-500 text-white">{{ user_initials }}</div>
                <div>
                    <div class="text-sm font-semibold text-slate-900">{{ user_full_name }}</div>
                    <div class="text-xs text-slate-500">{{ user_role }}</div>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-1">
            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('overview', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span>Overview</span>
                <span id="mobileOverviewCount" class="ml-auto inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">0</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('employees', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span>Employees</span>
                <span id="mobileEmployeesCount" class="ml-auto inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700">0</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('requests', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <span>Requests</span>
                <span id="mobileRequestsCount" class="ml-auto inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700">0</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('create', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span>Create Request</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('constraints', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                <span>Constraints</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-700 hover:text-slate-900 font-medium" onclick="showSection('activity', event); toggleMobileMenu();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                </svg>
                <span>Activity Log</span>
            </a>
        </div>

        <div class="p-4 border-t border-slate-200 mt-4">
            <h3 class="text-xs font-semibold text-slate-500 uppercase mb-3 px-4">Quick Stats</h3>
            <div class="space-y-3 px-4" id="quickStats">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">Total Requests</span>
                    <span class="font-bold text-slate-900" id="statTotalRequests">--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">Pending</span>
                    <span class="font-bold text-yellow-600" id="statPending">--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">Approved</span>
                    <span class="font-bold text-green-600" id="statApproved">--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">Denied</span>
                    <span class="font-bold text-red-600" id="statDenied">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[9999] space-y-2"></div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 z-[10002] flex items-center justify-center p-4" style="backdrop-filter: blur(8px); background-color: rgba(219, 234, 254, 0.5);">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-slate-900">My Profile</h2>
                <button onclick="closeProfileModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 space-y-6">
                <!-- Profile Information -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-100">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="avatar bg-blue-500 text-white text-2xl w-16 h-16 flex items-center justify-center">
                            {{ user_initials }}
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900" id="profileFullName">{{ user_full_name }}</h3>
                            <p class="text-sm text-slate-600" id="profileEmail">{{ session.get('email', '') }}</p>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700 mt-1" id="profileRole">
                                {{ user_role }}
                            </span>
                        </div>
                    </div>

                    <!-- Employee Details Grid -->
                    <div id="employeeDetails" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Loading state -->
                        <div class="col-span-2 text-center py-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="text-sm text-slate-500 mt-2">Loading profile information...</p>
                        </div>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="border-t border-slate-200 pt-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Change Password</h3>
                    
                    <form id="changePasswordForm" onsubmit="handlePasswordChange(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Current Password</label>
                            <input 
                                type="password" 
                                id="currentPassword" 
                                name="current_password"
                                required
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter your current password"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">New Password</label>
                            <input 
                                type="password" 
                                id="newPassword" 
                                name="new_password"
                                required
                                minlength="8"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter new password (min 8 characters)"
                            >
                            <p class="mt-1 text-xs text-slate-500">Password must be at least 8 characters long</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Confirm New Password</label>
                            <input 
                                type="password" 
                                id="confirmPassword" 
                                name="confirm_password"
                                required
                                minlength="8"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Confirm your new password"
                            >
                        </div>

                        <div id="passwordError" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="ml-3 text-sm text-red-800" id="passwordErrorMessage"></p>
                            </div>
                        </div>

                        <div id="passwordSuccess" class="hidden bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="ml-3 text-sm text-green-800">Password changed successfully!</p>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button 
                                type="submit" 
                                id="changePasswordBtn"
                                class="flex-1 bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                            >
                                Change Password
                            </button>
                            <button 
                                type="button"
                                onclick="closeProfileModal()"
                                class="px-6 py-2.5 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors font-medium"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-blue-50/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900" id="confirmationTitle">Confirm Action</h3>
            </div>
            <p class="text-gray-600 mb-6" id="confirmationMessage">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="confirmationCancel" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Cancel</button>
                <button type="button" id="confirmationConfirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="inputModal" class="fixed inset-0 bg-blue-50/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900" id="inputTitle">Input Required</h3>
            </div>
            <p class="text-gray-600 mb-4" id="inputMessage">Please enter the required information:</p>
            <textarea id="inputField" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Enter your input..."></textarea>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" id="inputCancel" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Cancel</button>
                <button type="button" id="inputConfirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Submit</button>
            </div>
        </div>
    </div>

    <!-- Vacation Details Modal -->
    <div id="vacationDetailsModal" class="fixed inset-0 bg-blue-50/80 backdrop-blur-sm z-50 flex items-center justify-center hidden p-2 sm:p-4" onclick="event.target === this && closeVacationDetailsModal()">
        <div class="bg-white rounded-lg p-4 sm:p-6 max-w-2xl w-full mx-auto shadow-xl max-h-[95vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 sm:mb-6 sticky top-0 bg-white pb-2 border-b sm:border-0 sm:pb-0">
                <h3 class="text-lg sm:text-xl font-bold text-slate-900">Vacation Request Details</h3>
                <button type="button" onclick="closeVacationDetailsModal()" class="text-slate-400 hover:text-slate-600 flex-shrink-0 ml-2">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div id="vacationDetailsContent" class="space-y-3 sm:space-y-4">
                <!-- Content will be populated dynamically -->
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vacation Request Modal -->
    <div id="editRequestModal" class="fixed inset-0 bg-blue-50/80 backdrop-blur-sm z-50 flex items-center justify-center hidden p-2 sm:p-4" onclick="event.target === this && closeEditRequestModal()">
        <div class="bg-white rounded-lg p-4 sm:p-6 max-w-2xl w-full mx-auto shadow-xl max-h-[95vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 sm:mb-6 sticky top-0 bg-white pb-2 border-b sm:border-0 sm:pb-0">
                <h3 class="text-lg sm:text-xl font-bold text-slate-900">Edit Vacation Request</h3>
                <button type="button" onclick="closeEditRequestModal()" class="text-slate-400 hover:text-slate-600 flex-shrink-0 ml-2">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="editRequestForm" class="space-y-4">
                <input type="hidden" id="editRequestId">
                
                <!-- Employee Info Display -->
                <div class="bg-slate-50 rounded-lg p-4">
                    <div class="flex items-center gap-4">
                        <div id="editEmployeeAvatar" class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-lg font-semibold"></div>
                        <div>
                            <h4 id="editEmployeeName" class="font-semibold text-slate-900"></h4>
                            <p id="editEmployeeDept" class="text-sm text-slate-600"></p>
                        </div>
                    </div>
                </div>

                <!-- Date Range -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Start Date *</label>
                        <input id="editStartDate" type="date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div id="editStartDatePastWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                            <div class="flex items-start gap-2">
                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="text-sm text-red-800">
                                    <span class="font-semibold">Past Date Not Allowed:</span>
                                    Start date cannot be in the past. Please select today or a future date.
                                </div>
                            </div>
                        </div>
                        <div id="editStartDateWeekendWarning" class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                            <div class="flex items-start gap-2">
                                <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="text-sm text-amber-800">
                                    <span class="font-semibold">Weekend Selected:</span>
                                    <span id="editStartDateWeekendDay"></span> is not a working day. Vacation days are counted Monday-Friday only.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">End Date *</label>
                        <input id="editEndDate" type="date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div id="editEndDatePastWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                            <div class="flex items-start gap-2">
                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="text-sm text-red-800">
                                    <span class="font-semibold">Past Date Not Allowed:</span>
                                    End date cannot be in the past. Please select today or a future date.
                                </div>
                            </div>
                        </div>
                        <div id="editEndDateWeekendWarning" class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                            <div class="flex items-start gap-2">
                                <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="text-sm text-amber-800">
                                    <span class="font-semibold">Weekend Selected:</span>
                                    <span id="editEndDateWeekendDay"></span> is not a working day. Vacation days are counted Monday-Friday only.
                                </div>
                            </div>
                        </div>
                        <div id="editEndDateBeforeStartWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                            <div class="flex items-start gap-2">
                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="text-sm text-red-800">
                                    <span class="font-semibold">Invalid Date Range:</span>
                                    End date must be after or equal to start date.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto Return Date -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Auto Return Date *</label>
                    <input id="editAutoReturnDate" type="date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-slate-500 mt-1">First working day after vacation ends (auto-calculated)</p>
                    <div id="editAutoReturnWarning" class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <div class="text-sm text-amber-800">
                                <span class="font-semibold">Note:</span>
                                <span id="editAutoReturnWarningText"></span>
                            </div>
                        </div>
                    </div>
                    <div id="editAutoReturnManualChange" class="hidden mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="text-sm text-blue-800">
                                <span class="font-semibold">Manual Override:</span>
                                You have manually changed the auto return date. The system calculated <span id="editAutoReturnOriginalDate" class="font-medium"></span>, but you selected <span id="editAutoReturnNewDate" class="font-medium"></span>.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duration Display -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-700">Duration</span>
                        <span id="editDurationDisplay" class="text-lg font-bold text-blue-600">0 days</span>
                    </div>
                </div>

                <!-- Leave Type -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Leave Type *</label>
                    <select id="editLeaveType" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="vacation">Vacation</option>
                    </select>
                </div>

                <!-- Reason -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Reason (Optional)</label>
                    <textarea id="editReason" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Add any additional details..."></textarea>
                </div>

                <!-- Error Message -->
                <div id="editRequestError" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm text-red-800" id="editRequestErrorText"></div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeEditRequestModal()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="editRequestSubmitBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Vacation Settings Modal -->
    <div id="editSettingsModal" class="fixed inset-0 bg-blue-50/80 backdrop-blur-sm z-50 flex items-center justify-center hidden" onclick="event.target === this && closeEditSettingsModal()">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900">Edit Vacation Settings</h3>
                <button type="button" onclick="closeEditSettingsModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="editSettingsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Minimum Notice (days)</label>
                    <input type="number" id="editMinimumNotice" min="0" max="90" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Max Consecutive (days)</label>
                    <input type="number" id="editMaxConsecutive" min="0" max="60" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Min Team Coverage (%)</label>
                    <input type="number" id="editMinCoverage" min="0" max="100" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="editCriticalCoverage" class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                    <label for="editCriticalCoverage" class="ml-2 text-sm text-slate-700">Require critical role coverage</label>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditSettingsModal()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Blackout Period Modal (Add/Edit) -->
    <div id="blackoutPeriodModal" class="fixed inset-0 bg-blue-50/80 backdrop-blur-sm z-50 flex items-center justify-center hidden" onclick="event.target === this && closeBlackoutPeriodModal()">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 id="blackoutPeriodModalTitle" class="text-xl font-bold text-slate-900">Add Blackout Period</h3>
                <button type="button" onclick="closeBlackoutPeriodModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="blackoutPeriodForm" class="space-y-4">
                <input type="hidden" id="blackoutPeriodId">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Period Name</label>
                    <input type="text" id="blackoutPeriodName" placeholder="e.g., Year-End Close" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                        <input type="date" id="blackoutPeriodStartDate" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                        <input type="date" id="blackoutPeriodEndDate" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="blackoutPeriodDescription" rows="3" placeholder="Brief description of this blackout period..." class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required></textarea>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="blackoutPeriodActive" checked class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                    <label for="blackoutPeriodActive" class="ml-2 text-sm text-slate-700">Active</label>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
                        <span id="blackoutPeriodSubmitText">Add Period</span>
                    </button>
                    <button type="button" onclick="closeBlackoutPeriodModal()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Work Area Setting Modal -->
    <div id="workAreaSettingModal" class="fixed inset-0 bg-blue-50/80 backdrop-blur-sm z-50 flex items-center justify-center hidden" onclick="event.target === this && closeWorkAreaSettingModal()">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 id="workAreaSettingModalTitle" class="text-xl font-bold text-slate-900">Add Work Area Setting</h3>
                <button type="button" onclick="closeWorkAreaSettingModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="workAreaSettingForm" class="space-y-4">
                <input type="hidden" id="workAreaSettingId">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Work Line</label>
                    <select id="workAreaSettingWorkLine" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                        <option value="">Select a work line...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Select the production line</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Work Area</label>
                    <select id="workAreaSettingWorkArea" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                        <option value="">Select a work area...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Select the work area or department</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Max Simultaneous Absences</label>
                    <input type="number" id="workAreaSettingMaxAbsences" min="1" max="20" value="1" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" required>
                    <p class="text-xs text-slate-500 mt-1">Maximum number of people who can be on leave at the same time in this area</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Description (Optional)</label>
                    <textarea id="workAreaSettingDescription" rows="3" placeholder="e.g., Critical production line with limited backup staff" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100"></textarea>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="workAreaSettingActive" checked class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                    <label for="workAreaSettingActive" class="ml-2 text-sm text-slate-700">Active</label>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
                        <span id="workAreaSettingSubmitText">Add Setting</span>
                    </button>
                    <button type="button" onclick="closeWorkAreaSettingModal()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Top Navigation Bar -->
    <div class="glass-navbar sticky top-0 z-50">
        <!-- Top Row: Logo, Search, User -->
        <div class="flex items-center justify-between px-4 lg:px-6 py-3 border-b border-slate-100/60">
            <div class="flex items-center gap-4">
                <div class="hamburger lg:hidden" id="hamburgerBtn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <h1 class="text-xl lg:text-2xl font-bold text-slate-900">DASHMET</h1>
                <span class="hidden lg:inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">Supervisor View</span>
            </div>
            
            <div class="flex items-center gap-2 lg:gap-4">
                <!-- Global Search - Hidden on mobile, shown on larger screens -->
                <div class="relative hidden md:block">
                    <input type="text" placeholder="Search..." 
                           class="glass-search pl-10 pr-4 py-2.5 rounded-xl w-48 lg:w-80 focus:outline-none" 
                           id="globalSearch">
                    <svg class="absolute left-3 top-3 w-5 h-5 text-indigo-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>

                <!-- User Menu -->
                <div class="flex items-center gap-2 lg:gap-3">
                    <!-- Notification Bell -->
                    <div class="relative">
                        <button id="notificationBell" onclick="toggleNotifications()" class="relative p-2 hover:bg-slate-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5 lg:w-6 lg:h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                            <span id="notificationBadge" class="absolute top-1 right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center font-semibold hidden">0</span>
                        </button>
                        
                        <!-- Notification Dropdown -->
                        <div id="notificationDropdown" class="hidden fixed lg:absolute right-2 lg:right-0 top-16 lg:top-auto lg:mt-2 w-[calc(100vw-1rem)] sm:w-96 lg:w-96 bg-white rounded-lg shadow-xl border border-slate-200 z-[9998] max-h-[calc(100vh-5rem)] lg:max-h-[32rem] overflow-hidden flex flex-col">
                            <!-- Header -->
                            <div class="p-3 lg:p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50">
                                <h3 class="text-base lg:text-lg font-semibold text-slate-900">Notifications</h3>
                                <div class="flex gap-2">
                                    <button onclick="markAllNotificationsRead()" class="text-xs text-blue-600 hover:text-blue-700 font-medium whitespace-nowrap">Mark all read</button>
                                </div>
                            </div>
                            
                            <!-- Notifications List -->
                            <div id="notificationsList" class="overflow-y-auto flex-1" style="max-height: 26rem;">
                                <div class="flex items-center justify-center py-12">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Menu with Dropdown -->
                    <div class="relative">
                        <button id="userMenuButton" onclick="toggleUserDropdown()" class="flex items-center gap-2 lg:gap-3 cursor-pointer hover:bg-slate-50 rounded-lg p-2 transition-colors">
                            <div class="avatar bg-blue-500 text-white text-sm lg:text-base">{{ user_initials }}</div>
                            <div class="hidden lg:block text-left">
                                <div class="text-sm font-semibold text-slate-900">{{ user_full_name }}</div>
                                <div class="text-xs text-slate-500">{{ user_role }}</div>
                            </div>
                            <svg class="hidden lg:block w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 z-[10001]">
                            <div class="p-3 border-b border-slate-100">
                                <div class="text-sm font-semibold text-slate-900">{{ user_full_name }}</div>
                                <div class="text-xs text-slate-500">{{ session.get('email', '') }}</div>
                            </div>
                            <div class="py-1">
                                <button onclick="openProfileModal()" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-3">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    <span>My Profile</span>
                                </button>
                                <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs Row - Desktop Only -->
        <div class="hidden lg:flex items-center justify-between px-6 py-2">
            <div class="flex items-center gap-1 overflow-x-auto">
                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 border-b-2 border-blue-700" onclick="showSection('overview', event)" data-section="overview">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Overview</span>
                    <span id="navBadgeOverview" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 ml-1">--</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('employees', event)" data-section="employees">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <span>Employees</span>
                    <span id="navBadgeEmployees" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-700 ml-1">--</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('requests', event)" data-section="requests">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <span>Requests</span>
                    <span id="navBadgeRequests" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700 ml-1">--</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('create', event)" data-section="create">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span>Create Request</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('constraints', event)" data-section="constraints">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span>Constraints</span>
                </a>

                <a href="#" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100" onclick="showSection('activity', event)" data-section="activity">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span>Activity Log</span>
                </a>
            </div>

            <div class="hidden lg:flex items-center gap-2 ml-4">
                <input type="date" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" id="dateFilterStart">
                <span class="text-slate-400 text-sm">to</span>
                <input type="date" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" id="dateFilterEnd">
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="p-4 lg:p-8">
        <!-- Overview Section -->
        <div id="overview-section" class="animate-slide-in">
            <!-- KPIs -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 lg:p-3 bg-blue-100 rounded-lg">
                            <svg class="w-5 h-5 lg:w-6 lg:h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                        </div>
                        <span class="text-xs lg:text-sm font-semibold text-slate-400" id="dashEmployeesTrend"></span>
                    </div>
                    <div class="text-xl lg:text-2xl font-bold text-slate-900 mb-1" id="dashTotalEmployees">--</div>
                    <div class="text-xs lg:text-sm text-slate-600">Total Employees</div>
                </div>

                <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 lg:p-3 bg-yellow-100 rounded-lg">
                            <svg class="w-5 h-5 lg:w-6 lg:h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <span class="text-xs lg:text-sm font-semibold text-yellow-600">Review</span>
                    </div>
                    <div class="text-xl lg:text-2xl font-bold text-slate-900 mb-1" id="dashPendingCount">--</div>
                    <div class="text-xs lg:text-sm text-slate-600">Pending Requests</div>
                </div>

                <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 lg:p-3 bg-green-100 rounded-lg">
                            <svg class="w-5 h-5 lg:w-6 lg:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <span class="text-xs lg:text-sm font-semibold text-slate-400" id="dashApprovedTrend"></span>
                    </div>
                    <div class="text-xl lg:text-2xl font-bold text-slate-900 mb-1" id="dashApprovedMonthCount">--</div>
                    <div class="text-xs lg:text-sm text-slate-600">Approved This Month</div>
                </div>

                <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 lg:p-3 bg-purple-100 rounded-lg">
                            <svg class="w-5 h-5 lg:w-6 lg:h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <span class="text-xs lg:text-sm font-semibold text-slate-400" id="dashDaysUsedComparison">vs --</span>
                    </div>
                    <div class="text-xl lg:text-2xl font-bold text-slate-900 mb-1" id="dashDaysUsedYTD">--</div>
                    <div class="text-xs lg:text-sm text-slate-600">Days Used (YTD)</div>
                </div>
            </div>

            <!-- Tabs for Panels -->
            <div class="mb-6 flex gap-2 bg-slate-100 p-1 rounded-lg overflow-x-auto">
                <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium bg-white text-slate-900 shadow-sm" onclick="showTab('upcoming')">Upcoming</button>
                <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium text-slate-700 hover:text-slate-900" onclick="showTab('pending')">Pending</button>
                <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium text-slate-700 hover:text-slate-900" onclick="showTab('recent')">Recent</button>
                <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium text-slate-700 hover:text-slate-900" onclick="showTab('conflicts')">Conflicts</button>
            </div>

            <!-- Tab Content: Upcoming Vacations -->
            <div id="upcoming-tab" class="tab-content bg-white rounded-lg shadow p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4 lg:mb-6 gap-3">
                    <h2 class="text-lg lg:text-xl font-bold text-slate-900">Upcoming Vacations (Next 30 Days)</h2>
                    <div class="flex items-center gap-2">
                        <label for="upcoming-rows-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="upcoming-rows-per-page" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeRowsPerPage('upcoming', this.value)">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </div>
                <div id="upcoming-content" class="space-y-4">
                    <!-- Will be populated dynamically from database by JavaScript -->
                </div>
                <div id="upcoming-pagination" class="mt-6"></div>
            </div>

            <!-- Tab Content: Pending Approvals -->
            <div id="pending-tab" class="tab-content bg-white rounded-lg shadow p-4 lg:p-6 hidden">
                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4 lg:mb-6 gap-3">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg lg:text-xl font-bold text-slate-900">Requests Pending Your Approval</h2>
                        <div id="pendingRefreshIndicator" class="hidden">
                            <svg class="w-4 h-4 text-blue-500 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="pending-rows-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="pending-rows-per-page" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeRowsPerPage('pending', this.value)">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </div>
                <div id="pending-content" class="space-y-4">
                    <!-- Will be populated dynamically from database by JavaScript -->
                </div>
                <div id="pending-pagination" class="mt-6"></div>
            </div>

            <!-- Tab Content: Recent Activity -->
            <div id="recent-tab" class="tab-content bg-white rounded-lg shadow p-4 lg:p-6 hidden">
                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4 lg:mb-6 gap-3">
                    <h2 class="text-lg lg:text-xl font-bold text-slate-900">Recent Activity (Last 30 Days)</h2>
                    <div class="flex items-center gap-2">
                        <label for="recent-rows-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="recent-rows-per-page" class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeRowsPerPage('recent', this.value)">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </div>
                <div id="recent-content" class="space-y-4">
                    <!-- Will be populated dynamically by JavaScript -->
                </div>
                <div id="recent-pagination" class="mt-6"></div>
            </div>

            <!-- Tab Content: Conflicts -->
            <div id="conflicts-tab" class="tab-content bg-white rounded-lg shadow p-4 lg:p-6 hidden">
                <h2 class="text-lg lg:text-xl font-bold text-slate-900 mb-4 lg:mb-6">Scheduling Conflicts & Warnings</h2>
                
                <!-- Loading State -->
                <div id="conflictsLoading" class="flex items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>

                <!-- Conflicts Container -->
                <div id="conflictsContainer" class="space-y-4 hidden">
                    <!-- Will be populated dynamically by JavaScript -->
                </div>

                <!-- Empty State -->
                <div id="conflictsEmpty" class="hidden text-center py-12">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-2">No Conflicts Detected</h3>
                    <p class="text-slate-600">All vacation requests are properly scheduled with no team coverage issues.</p>
                </div>
            </div>
        </div>

        <!-- Employees Section -->
        <div id="employees-section" class="hidden">
            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-6 gap-4">
                    <h2 class="text-xl lg:text-2xl font-bold text-slate-900">Employee Directory</h2>
                    <div class="flex flex-col lg:flex-row gap-3 w-full lg:w-auto">
                        <select id="employeeDepartmentFilter" onchange="loadEmployeeDirectory()" class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="all">All Work Roles</option>
                            <!-- Will be populated dynamically -->
                        </select>
                        <select id="employeeStatusFilter" onchange="loadEmployeeDirectory()" class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="all">All Status</option>
                            <option value="available">Available</option>
                            <option value="on_vacation">On Vacation</option>
                            <option value="upcoming">Upcoming Vacation</option>
                        </select>
                    </div>
                </div>

                <div id="employeeDirectoryGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    
                    <!-- Employee cards will be dynamically generated here -->
                    <div class="col-span-full flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <p class="ml-3 text-sm text-slate-500">Loading employees...</p>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-4 border-t border-slate-200">
                    <div class="flex items-center gap-2">
                        <label for="employeeRowsPerPage" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="employeeRowsPerPage" onchange="changeEmployeeRowsPerPage()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-blue-500">
                            <option value="6">6</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="employeePrevBtn" onclick="previousEmployeePage()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <div id="employeePageInfo" class="text-sm text-slate-600">
                            Page 1 of 1
                        </div>
                        <button id="employeeNextBtn" onclick="nextEmployeePage()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Requests Section -->
        <div id="requests-section" class="hidden">
            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-6 gap-4">
                    <h2 class="text-xl lg:text-2xl font-bold text-slate-900">All Vacation Requests</h2>
                    <div class="flex flex-col lg:flex-row gap-3 w-full lg:w-auto">
                        <select id="requestsStatusFilter" onchange="loadVacationRequests()" class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="denied">Denied</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="px-4 py-2 text-slate-700 bg-white border border-slate-300 rounded-lg font-medium hover:bg-slate-50">Export</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b-2 border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Employee</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase hidden lg:table-cell">Department</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Dates</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase hidden md:table-cell">Days</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase hidden lg:table-cell">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vacationRequestsTableBody" class="divide-y divide-slate-200">
                            <!-- Will be populated dynamically from database -->
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                    <p class="mt-2 text-sm text-slate-500">Loading vacation requests...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create Request Section -->
        <div id="create-section" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Main Form -->
                <div class="lg:col-span-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-6">Create Vacation Request</h2>
                        
                        <form id="createRequestForm" class="space-y-6">
                            <!-- Employee & Request Type -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Employee *</label>
                                    <select id="vacationEmployeeSelect" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select employee...</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Request Type *</label>
                                    <select id="vacationLeaveType" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select type...</option>
                                        <option value="vacation">Vacation</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Date Range -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Start Date *</label>
                                    <input id="vacationStartDate" type="date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <div id="startDatePastWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Past Date Not Allowed:</span>
                                                Start date cannot be in the past. Please select today or a future date.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="startDateNoticeWarning" class="hidden mt-2 p-3 bg-orange-50 border border-orange-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div class="text-sm text-orange-800">
                                                <span class="font-semibold">Insufficient Notice:</span>
                                                <span id="startDateNoticeMessage"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="startDateWeekendWarning" class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                            </svg>
                                            <div class="text-sm text-amber-800">
                                                <span class="font-semibold">Weekend Selected:</span>
                                                <span id="startDateWeekendDay"></span> is not a working day. Vacation days are counted Monday-Friday only.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="startDateBlackoutWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Blackout Period:</span>
                                                <span id="startDateBlackoutMessage"></span>
                                                <div class="mt-2 text-xs">
                                                    Please choose a different date or contact your direct Manager if you believe this is a mistake.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">End Date *</label>
                                    <input id="vacationEndDate" type="date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <div id="endDatePastWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Past Date Not Allowed:</span>
                                                End date cannot be in the past. Please select today or a future date.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="endDateWeekendWarning" class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                            </svg>
                                            <div class="text-sm text-amber-800">
                                                <span class="font-semibold">Weekend Selected:</span>
                                                <span id="endDateWeekendDay"></span> is not a working day. Vacation days are counted Monday-Friday only.
                                            </div>
                                        </div>
                                    </div>
                                    <div id="endDateBlackoutWarning" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <div class="flex items-start gap-2">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
                                            </svg>
                                            <div class="text-sm text-red-800">
                                                <span class="font-semibold">Blackout Period:</span>
                                                <span id="endDateBlackoutMessage"></span>
                                                <div class="mt-2 text-xs">
                                                    Please choose a different date or contact your direct Manager if you believe this is a mistake.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                    <!-- Vacation Days Summary -->
                                    <div id="vacationDaysSummary" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4">
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                            <div>
                                                <div class="text-xs font-semibold text-slate-600 mb-1">WORKING DAYS</div>
                                                <div id="workingDaysCount" class="text-2xl font-bold text-blue-900">0</div>
                                            </div>
                                            <div>
                                                <div class="text-xs font-semibold text-slate-600 mb-1">WEEKEND DAYS</div>
                                                <div id="weekendDaysCount" class="text-2xl font-bold text-slate-600">0</div>
                                            </div>
                                            <div id="blackoutDaysSection" class="hidden">
                                                <div class="text-xs font-semibold text-slate-600 mb-1">BLACKOUT DAYS</div>
                                                <div id="blackoutDaysCount" class="text-2xl font-bold text-red-700">0</div>
                                            </div>
                                            <div>
                                                <div class="text-xs font-semibold text-slate-600 mb-1">AUTO RETURN DATE</div>
                                                <div id="returnToWorkDate" class="text-sm font-bold text-green-900">--</div>
                                            </div>
                                        </div>
                                    </div>

                            <!-- Return to Work Date -->
                            <div id="returnToWorkContainer" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    Return to Work Date
                                    <span class="ml-2 text-xs text-slate-500 font-normal">(Auto-filled, editable)</span>
                                </label>
                                <input id="vacationReturnDate" type="date" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">                                        <!-- Heads-up message for gap days -->
                                        <div id="returnDateGapWarning" class="hidden mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                            <div class="flex items-start gap-2">
                                                <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <div class="text-sm text-blue-800">
                                                    <span class="font-semibold">Heads-Up:</span>
                                                    There are <span id="gapDaysCount" class="font-bold">0</span> working day(s) between the requested end date and return to work date. 
                                                    Please check with the employee to contact HR to clarify the status of these days (unpaid leave, sick leave, FMLA, etc.).
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                            <!-- Reason -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Reason *</label>
                                <textarea id="vacationReason" rows="4" placeholder="Enter reason for vacation request..." required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                            </div>

                            <!-- Coverage Plan & Emergency Contact -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Coverage Plan</label>
                                    <textarea id="vacationCoveragePlan" rows="4" placeholder="Who will cover responsibilities..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">
                                            Emergency Contact
                                            <span class="ml-2 text-xs text-slate-500 font-normal">(Optional)</span>
                                        </label>
                                        <input id="vacationEmergencyPhone" type="tel" placeholder="Phone number" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <input id="vacationEmergencyEmail" type="email" placeholder="Email address" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>

                            <!-- Auto-approve Checkbox -->
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="vacationAutoApprove" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </div>
                                    <span class="ml-3 text-sm font-medium text-slate-700">Auto-approve this request (supervisor privilege)</span>
                                </label>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-slate-200">
                                <button type="submit" id="createRequestSubmitBtn" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors flex items-center justify-center gap-2">
                                    <svg id="createRequestSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span id="createRequestBtnText">Create Request</span>
                                </button>
                                <button type="button" onclick="showSection('overview', event)" class="flex-1 px-6 py-3 text-slate-700 bg-white border border-slate-300 rounded-lg font-medium hover:bg-slate-50 transition-colors">
                                    Cancel
                                </button>
                            </div>
                                </form>
                            </div>
                        </div>

                        <!-- Right Column - Live Dashboard (4 columns on large screens) -->
                        <div class="lg:col-span-4 space-y-6">
                            <!-- Quick Stats Card -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/50 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-slate-900">Quick Stats</h3>
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4">
                                        <div class="text-sm text-blue-700 font-medium mb-1">Pending Requests</div>
                                        <div id="createSidebarPending" class="text-3xl font-bold text-blue-900">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                        </div>
                                    </div>
                                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-4">
                                        <div class="text-sm text-green-700 font-medium mb-1">Approved This Month</div>
                                        <div id="createSidebarApproved" class="text-3xl font-bold text-green-900">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
                                        </div>
                                    </div>
                                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4">
                                        <div class="text-sm text-purple-700 font-medium mb-1">Days Used (YTD)</div>
                                        <div id="createSidebarDaysUsed" class="text-3xl font-bold text-purple-900">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upcoming Vacations Card -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/50 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-slate-900">Upcoming Leaves</h3>
                                    <div class="w-8 h-8 bg-gradient-to-br from-amber-100 to-orange-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div id="createSidebarUpcoming" class="space-y-3 max-h-80 overflow-y-auto">
                                    <div class="text-center py-8 text-slate-400">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                        <p class="text-sm">Loading...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Blackout Periods Card -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/50 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-slate-900">Blackout Periods</h3>
                                    <div class="w-8 h-8 bg-gradient-to-br from-red-100 to-pink-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div id="createSidebarBlackouts" class="space-y-3">
                                    <div class="text-center py-8 text-slate-400">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                        <p class="text-sm">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Constraints Section -->
        <div id="constraints-section" class="hidden px-4 lg:px-6">
            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                <h2 class="text-xl lg:text-2xl font-bold text-slate-900 mb-6">Vacation Rules & Limits</h2>
                
                <div class="space-y-6">
                    <div class="border border-slate-200 rounded-lg p-4 lg:p-5">
                        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4 gap-3">
                            <h3 class="text-lg font-semibold text-slate-900">Annual Leave Limits</h3>
                            <button onclick="editVacationSettings('annual')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Edit</button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-slate-600 mb-1">Minimum Notice</div>
                                <div id="minimumNotice" class="text-2xl font-bold text-slate-900">Loading...</div>
                            </div>
                            <div>
                                <div class="text-sm text-slate-600 mb-1">Max Consecutive</div>
                                <div id="maxConsecutive" class="text-2xl font-bold text-slate-900">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-lg p-4 lg:p-5">
                        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4 gap-3">
                            <h3 class="text-lg font-semibold text-slate-900">Team Coverage Rules</h3>
                            <button onclick="editVacationSettings('coverage')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Edit</button>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded">
                                <span class="text-sm text-slate-700">Minimum team members present</span>
                                <span id="minTeamCoverage" class="font-semibold text-slate-900">Loading...</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded">
                                <span class="text-sm text-slate-700">Critical role coverage required</span>
                                <span id="criticalCoverage" class="font-semibold text-green-600">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-lg p-4 lg:p-5">
                        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4 gap-3">
                            <h3 class="text-lg font-semibold text-slate-900">Work Area Absence Limits</h3>
                            <button onclick="addWorkAreaSetting()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Add Work Area</button>
                        </div>
                        <div id="workAreaSettingsContainer" class="space-y-3">
                            <!-- Work area settings will be loaded here dynamically -->
                            <div class="text-center py-8 text-slate-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="mt-2 text-sm">Loading work area settings...</p>
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-lg p-4 lg:p-5">
                        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4 gap-3">
                            <h3 class="text-lg font-semibold text-slate-900">Blackout Periods</h3>
                            <button onclick="addBlackoutPeriod()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Add Period</button>
                        </div>
                        <div id="blackoutPeriodsContainer" class="space-y-3">
                            <!-- Blackout periods will be loaded here dynamically -->
                            <div class="text-center py-8 text-slate-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="mt-2 text-sm">Loading blackout periods...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log Section -->
        <div id="activity-section" class="hidden px-4 lg:px-6">
            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-6 gap-4">
                    <h2 class="text-xl lg:text-2xl font-bold text-slate-900">Activity Log</h2>
                    <div class="flex flex-col lg:flex-row gap-3 w-full lg:w-auto">
                        <select id="activityTypeFilter" onchange="loadActivityLog()" class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="all">All Activities</option>
                            <option value="approvals">Approvals</option>
                            <option value="denials">Denials</option>
                            <option value="modifications">Modifications</option>
                            <option value="new_requests">New Requests</option>
                        </select>
                        <button class="px-4 py-2 text-slate-700 bg-white border border-slate-300 rounded-lg font-medium hover:bg-slate-50">Export Log</button>
                    </div>
                </div>

                <div id="activityLogContainer" class="space-y-4 mb-4">
                    <!-- Activity items will be loaded here dynamically -->
                    <div class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-4 border-t border-slate-200">
                    <div class="flex items-center gap-2">
                        <label for="activityRowsPerPage" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="activityRowsPerPage" onchange="changeActivityRowsPerPage()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-blue-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="activityPrevBtn" onclick="previousActivityPage()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <div id="activityPageInfo" class="text-sm text-slate-600">
                            Page 1 of 1
                        </div>
                        <button id="activityNextBtn" onclick="nextActivityPage()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timezone Utilities -->
    <script src="{{ url_for('static', filename='js/timezone-utils.js') }}"></script>

    <script>
        // Pagination State Management
        const paginationState = {
            upcoming: { currentPage: 1, rowsPerPage: 10, allData: [] },
            pending: { currentPage: 1, rowsPerPage: 10, allData: [] },
            recent: { currentPage: 1, rowsPerPage: 10, allData: [] }
        };

        /**
         * Parse a date string in local time (YYYY-MM-DD) without timezone conversion
         * This prevents the date from shifting due to timezone offset
         */
        function parseLocalDate(dateString) {
            if (!dateString) return null;
            
            // If it's already a Date object, return it
            if (dateString instanceof Date) return dateString;
            
            // For YYYY-MM-DD format, create date in local timezone
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Months are 0-indexed
                const day = parseInt(parts[2], 10);
                return new Date(year, month, day);
            }
            
            // Fallback to regular Date parsing
            return new Date(dateString);
        }

        // Pagination Functions
        function changeRowsPerPage(tab, value) {
            paginationState[tab].rowsPerPage = parseInt(value);
            paginationState[tab].currentPage = 1;
            renderPaginatedData(tab);
        }

        function goToPage(tab, page) {
            const state = paginationState[tab];
            const totalPages = Math.ceil(state.allData.length / state.rowsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            state.currentPage = page;
            renderPaginatedData(tab);
        }

        function renderPaginationControls(tab) {
            const state = paginationState[tab];
            const totalPages = Math.ceil(state.allData.length / state.rowsPerPage);
            const paginationContainer = document.getElementById(`${tab}-pagination`);
            
            if (!paginationContainer || totalPages <= 1) {
                if (paginationContainer) paginationContainer.innerHTML = '';
                return;
            }
            
            const currentPage = state.currentPage;
            const maxVisiblePages = 5;
            
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            let paginationHTML = `
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 border-t border-slate-200 pt-4">
                    <div class="text-sm text-slate-600">
                        Showing ${Math.min((currentPage - 1) * state.rowsPerPage + 1, state.allData.length)} to ${Math.min(currentPage * state.rowsPerPage, state.allData.length)} of ${state.allData.length} results
                    </div>
                    <div class="flex items-center gap-2">
                        <button 
                            onclick="goToPage('${tab}', 1)" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === 1 ? 'disabled' : ''}
                        >
                            First
                        </button>
                        <button 
                            onclick="goToPage('${tab}', ${currentPage - 1})" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === 1 ? 'disabled' : ''}
                        >
                            Previous
                        </button>
                        <div class="flex gap-1">
            `;
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button 
                        onclick="goToPage('${tab}', ${i})" 
                        class="px-3 py-1.5 text-sm border rounded-lg ${i === currentPage ? 'bg-blue-600 text-white border-blue-600' : 'border-slate-300 hover:bg-slate-50'}"
                    >
                        ${i}
                    </button>
                `;
            }
            
            paginationHTML += `
                        </div>
                        <button 
                            onclick="goToPage('${tab}', ${currentPage + 1})" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === totalPages ? 'disabled' : ''}
                        >
                            Next
                        </button>
                        <button 
                            onclick="goToPage('${tab}', ${totalPages})" 
                            class="px-3 py-1.5 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${currentPage === totalPages ? 'disabled' : ''}
                        >
                            Last
                        </button>
                    </div>
                </div>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        function renderPaginatedData(tab) {
            const state = paginationState[tab];
            const startIndex = (state.currentPage - 1) * state.rowsPerPage;
            const endIndex = startIndex + state.rowsPerPage;
            const paginatedData = state.allData.slice(startIndex, endIndex);
            
            // Call the appropriate render function based on tab
            if (tab === 'upcoming') {
                renderUpcomingVacations(paginatedData);
            } else if (tab === 'pending') {
                renderPendingVacations(paginatedData);
            } else if (tab === 'recent') {
                renderRecentVacations(paginatedData);
            }
            
            renderPaginationControls(tab);
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const hamburger = document.getElementById('hamburgerBtn');
            
            mobileMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // Section Navigation
        function showSection(sectionName, event) {
            if (event) event.preventDefault();
            
            // Update current section tracker
            currentSection = sectionName;
            
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            // Update desktop nav items
            document.querySelectorAll('.nav-tab').forEach(item => {
                item.classList.remove('bg-blue-50', 'text-blue-700', 'border-b-2', 'border-blue-700');
                item.classList.add('text-slate-700', 'hover:bg-slate-100');
            });
            
            // Find and activate the clicked nav item
            const activeTab = document.querySelector(`.nav-tab[data-section="${sectionName}"]`);
            if (activeTab) {
                activeTab.classList.remove('text-slate-700', 'hover:bg-slate-100');
                activeTab.classList.add('bg-blue-50', 'text-blue-700', 'border-b-2', 'border-blue-700');
            }

            // Load section-specific data
            if (sectionName === 'overview') {
                // Load vacation stats
                loadVacationStats();
                // Load pending vacations
                loadPendingVacations();
                // Show the first tab (upcoming) by default
                const upcomingTab = document.querySelector('.tab-btn[onclick*="upcoming"]');
                if (upcomingTab) {
                    upcomingTab.click();
                }
            } else if (sectionName === 'activity') {
                loadActivityLog();
            } else if (sectionName === 'constraints') {
                loadVacationSettings();
                loadBlackoutPeriods();
                loadWorkAreaSettings();
            } else if (sectionName === 'requests') {
                loadVacationRequests();
            } else if (sectionName === 'employees') {
                loadEmployeeDirectory();
            } else if (sectionName === 'conflicts') {
                loadConflicts();
            } else if (sectionName === 'create') {
                loadCreateSidebarData();
                loadBlackoutPeriodsForValidation(); // Pre-load blackout periods for validation
                loadVacationSettingsForValidation(); // Pre-load vacation settings for validation
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Toast Functionality
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            // Determine toast styling based on type
            let bgColor, iconColor, iconPath;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-600';
                    iconColor = 'text-white';
                    iconPath = 'M5 13l4 4L19 7';
                    break;
                case 'error':
                    bgColor = 'bg-red-600';
                    iconColor = 'text-white';
                    iconPath = 'M6 18L18 6M6 6l12 12';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-600';
                    iconColor = 'text-white';
                    iconPath = 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.863-.833-2.633 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z';
                    break;
                default: // info
                    bgColor = 'bg-blue-600';
                    iconColor = 'text-white';
                    iconPath = 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
            }
            
            toast.className = `toast flex items-center p-4 ${bgColor} text-white rounded-lg shadow-lg max-w-sm`;
            toast.innerHTML = `
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/>
                    </svg>
                </div>
                <div class="ml-3 text-sm font-medium">${message}</div>
                <button class="ml-auto -mx-1.5 -my-1.5 text-white hover:text-gray-200 focus:outline-none" onclick="removeToast(this.parentElement)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove toast after duration
            setTimeout(() => {
                removeToast(toast);
            }, duration);
        }
        
        function removeToast(toast) {
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // Confirmation Modal Functionality
        function showConfirmation(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmationModal');
                const titleElement = document.getElementById('confirmationTitle');
                const messageElement = document.getElementById('confirmationMessage');
                const confirmBtn = document.getElementById('confirmationConfirm');
                const cancelBtn = document.getElementById('confirmationCancel');
                
                titleElement.textContent = title;
                messageElement.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;
                
                modal.classList.remove('hidden');
                modal.classList.add('modal-backdrop');
                modal.querySelector('.bg-white').classList.add('modal-content');
                
                // Handle confirm
                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(true);
                };
                
                // Handle cancel
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(false);
                };
                
                // Handle escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        handleCancel();
                    }
                };
                
                // Cleanup function
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleBackdropClick);
                    document.removeEventListener('keydown', handleEscape);
                };
                
                // Handle backdrop click
                const handleBackdropClick = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };
                
                // Add event listeners
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleBackdropClick);
                document.addEventListener('keydown', handleEscape);
            });
        }

        // Input Modal Functionality
        function showInputDialog(title, message, placeholder = '', required = true) {
            return new Promise((resolve) => {
                const modal = document.getElementById('inputModal');
                const titleElement = document.getElementById('inputTitle');
                const messageElement = document.getElementById('inputMessage');
                const inputElement = document.getElementById('inputField');
                const confirmBtn = document.getElementById('inputConfirm');
                const cancelBtn = document.getElementById('inputCancel');
                
                titleElement.textContent = title;
                messageElement.textContent = message;
                inputElement.placeholder = placeholder;
                inputElement.value = '';
                
                modal.classList.remove('hidden');
                modal.classList.add('modal-backdrop');
                modal.querySelector('.bg-white').classList.add('modal-content');
                
                // Focus on input
                setTimeout(() => inputElement.focus(), 100);
                
                // Handle confirm
                const handleConfirm = () => {
                    const value = inputElement.value.trim();
                    if (required && !value) {
                        showToast('This field is required', 'warning');
                        return;
                    }
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(value || null);
                };
                
                // Handle cancel
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(null);
                };
                
                // Handle escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        handleCancel();
                    } else if (e.key === 'Enter' && e.ctrlKey) {
                        handleConfirm();
                    }
                };
                
                // Cleanup function
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleBackdropClick);
                    document.removeEventListener('keydown', handleEscape);
                };
                
                // Handle backdrop click
                const handleBackdropClick = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };
                
                // Add event listeners
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleBackdropClick);
                document.addEventListener('keydown', handleEscape);
            });
        }

        // Tab Navigation within Overview
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab content
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-slate-900', 'shadow-sm');
                btn.classList.add('text-slate-700', 'hover:text-slate-900');
            });
            
            event.target.classList.remove('text-slate-700', 'hover:text-slate-900');
            event.target.classList.add('bg-white', 'text-slate-900', 'shadow-sm');

            // Load data for specific tabs
            if (tabName === 'pending') {
                loadPendingVacations();
            } else if (tabName === 'conflicts') {
                loadConflicts();
            } else if (tabName === 'constraints') {
                loadWorkAreaSettings();
            }
        }

        // Weekend detection and working days calculation
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // 0 = Sunday, 6 = Saturday
        }

        function getDayName(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        function parseLocalDateTime(datetimeString) {
            // Parse datetime string to local datetime without timezone issues
            // Supports formats: "2025-11-04 14:31:00" or "2025-11-04T14:31:00"
            if (!datetimeString) {
                return new Date(); // Return current date if undefined
            }
            
            // Replace 'T' with space to handle ISO format
            const normalizedString = datetimeString.replace('T', ' ');
            
            // Split by space to get date and time parts
            const parts = normalizedString.split(' ');
            if (parts.length < 2) {
                // If no time part, just parse the date
                return new Date(datetimeString);
            }
            
            const [datePart, timePart] = parts;
            const [year, month, day] = datePart.split('-').map(num => parseInt(num, 10));
            const timeComponents = timePart.split(':').map(num => parseInt(num, 10));
            const [hour, minute, second] = [...timeComponents, 0, 0].slice(0, 3); // Default to 0 if missing
            
            return new Date(year, month - 1, day, hour, minute, second);
        }

        // Global Search Functionality
        let globalSearchData = {
            employees: [],
            vacations: [],
            upcomingVacations: []
        };

        function initGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', debounce(performGlobalSearch, 300));
            searchInput.addEventListener('focus', showSearchResults);
            
            // Close search results when clicking outside
            document.addEventListener('click', function(e) {
                const searchContainer = searchInput.closest('.relative');
                const resultsContainer = document.getElementById('globalSearchResults');
                if (resultsContainer && !searchContainer.contains(e.target)) {
                    resultsContainer.remove();
                }
            });

            // Load search data
            loadGlobalSearchData();
        }

        async function loadGlobalSearchData() {
            try {
                // Load employees
                const empResponse = await fetch('/api/employees');
                const empData = await empResponse.json();
                if (empData.success) {
                    globalSearchData.employees = empData.employees || [];
                }

                // Load all vacation requests
                const vacResponse = await fetch('/api/vacation/requests?status=all');
                const vacData = await vacResponse.json();
                if (vacData.success) {
                    globalSearchData.vacations = vacData.requests || [];
                }

                // Load upcoming vacations
                const upcomingResponse = await fetch('/api/vacation/upcoming');
                const upcomingData = await upcomingResponse.json();
                if (upcomingData.success) {
                    globalSearchData.upcomingVacations = upcomingData.vacations || [];
                }
            } catch (error) {
                console.error('Error loading search data:', error);
            }
        }

        function performGlobalSearch(e) {
            const searchTerm = e.target.value.trim().toLowerCase();
            
            if (searchTerm.length < 2) {
                removeSearchResults();
                return;
            }

            const results = {
                employees: [],
                vacations: []
            };

            // Search employees
            results.employees = globalSearchData.employees.filter(emp => {
                const fullName = `${emp.firstname || ''} ${emp.lastname || ''}`.toLowerCase();
                const department = (emp.workarea || '').toLowerCase();
                const role = (emp.role || '').toLowerCase();
                return fullName.includes(searchTerm) || department.includes(searchTerm) || role.includes(searchTerm);
            }).slice(0, 5);

            // Search vacations
            results.vacations = globalSearchData.vacations.filter(vac => {
                const employeeName = (vac.employee_name || '').toLowerCase();
                const leaveType = (vac.leave_type || '').toLowerCase();
                const status = (vac.status || '').toLowerCase();
                return employeeName.includes(searchTerm) || leaveType.includes(searchTerm) || status.includes(searchTerm);
            }).slice(0, 5);

            displaySearchResults(results, searchTerm);
        }

        function displaySearchResults(results, searchTerm) {
            removeSearchResults();

            const searchInput = document.getElementById('globalSearch');
            const searchContainer = searchInput.closest('.relative');
            
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'globalSearchResults';
            resultsDiv.className = 'absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-xl border border-slate-200 z-50 max-h-96 overflow-y-auto';

            let html = '';

            // Employees Section
            if (results.employees.length > 0) {
                html += `
                    <div class="p-3 border-b border-slate-200">
                        <h4 class="text-xs font-semibold text-slate-500 uppercase">Employees</h4>
                    </div>
                `;
                results.employees.forEach(emp => {
                    const fullName = `${emp.firstname || ''} ${emp.lastname || ''}`;
                    const initials = `${emp.firstname?.[0] || ''}${emp.lastname?.[0] || ''}`.toUpperCase();
                    html += `
                        <div class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 transition-colors" onclick="navigateToEmployees()">
                            <div class="flex items-center gap-3">
                                <div class="avatar bg-indigo-500 text-white text-sm">${initials}</div>
                                <div>
                                    <div class="font-medium text-slate-900">${fullName}</div>
                                    <div class="text-xs text-slate-500">${emp.workarea || 'N/A'}  ${emp.role || 'Employee'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // Vacations Section
            if (results.vacations.length > 0) {
                html += `
                    <div class="p-3 border-b border-slate-200 ${results.employees.length > 0 ? 'mt-2' : ''}">
                        <h4 class="text-xs font-semibold text-slate-500 uppercase">Vacation Requests</h4>
                    </div>
                `;
                results.vacations.forEach(vac => {
                    const startDate = parseLocalDate(vac.start_date);
                    const endDate = parseLocalDate(vac.end_date);
                    const formattedDates = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    const statusColors = {
                        'pending': 'bg-yellow-100 text-yellow-700',
                        'approved': 'bg-green-100 text-green-700',
                        'denied': 'bg-red-100 text-red-700'
                    };
                    const statusClass = statusColors[vac.status] || 'bg-slate-100 text-slate-700';
                    html += `
                        <div class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 transition-colors" onclick="viewVacationDetails(${vac.id})">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium text-slate-900">${vac.employee_name || 'Unknown'}</div>
                                    <div class="text-xs text-slate-500">${formattedDates}  ${vac.leave_type || 'N/A'}</div>
                                </div>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                    ${vac.status.charAt(0).toUpperCase() + vac.status.slice(1)}
                                </span>
                            </div>
                        </div>
                    `;
                });
            }

            // No Results
            if (results.employees.length === 0 && results.vacations.length === 0) {
                html = `
                    <div class="p-8 text-center text-slate-500">
                        <svg class="w-12 h-12 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <p class="text-sm">No results found for "${searchTerm}"</p>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
            searchContainer.appendChild(resultsDiv);
        }

        function showSearchResults() {
            const searchInput = document.getElementById('globalSearch');
            if (searchInput.value.trim().length >= 2) {
                performGlobalSearch({ target: searchInput });
            }
        }

        function removeSearchResults() {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (resultsDiv) {
                resultsDiv.remove();
            }
        }

        function navigateToEmployees() {
            removeSearchResults();
            const employeesTab = document.querySelector('[onclick*="showSection"][onclick*="employees"]');
            if (employeesTab) {
                employeesTab.click();
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function calculateWorkingDays(startDate, endDate) {
            let count = 0;
            let weekendCount = 0;
            let blackoutCount = 0;
            const current = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

            while (current <= end) {
                if (isWeekend(current)) {
                    weekendCount++;
                } else if (isBlackoutDay(current)) {
                    // Exclude blackout days from working days count
                    blackoutCount++;
                } else {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }

            return { workingDays: count, weekendDays: weekendCount, blackoutDays: blackoutCount };
        }

        function getReturnToWorkDate(endDate) {
            // Return date is the next day after end date
            const returnDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            returnDate.setDate(returnDate.getDate() + 1);
            
            // Skip weekends for return date
            while (isWeekend(returnDate)) {
                returnDate.setDate(returnDate.getDate() + 1);
            }
            
            return returnDate;
        }

        // Cache for blackout periods
        let cachedBlackoutPeriods = null;

        // Function to load and cache blackout periods
        async function loadBlackoutPeriodsForValidation() {
            try {
                const response = await fetch('/api/vacation/blackout-periods');
                const data = await response.json();
                
                if (data.success && data.periods) {
                    cachedBlackoutPeriods = data.periods.filter(period => period.is_active);
                    return cachedBlackoutPeriods;
                }
                return [];
            } catch (error) {
                console.error('Error loading blackout periods:', error);
                return [];
            }
        }

        // Function to check if a date falls within any blackout period
        function checkDateAgainstBlackouts(dateToCheck) {
            if (!cachedBlackoutPeriods) {
                return null;
            }

            for (const period of cachedBlackoutPeriods) {
                const periodStart = parseLocalDate(period.start_date);
                const periodEnd = parseLocalDate(period.end_date);
                
                if (dateToCheck >= periodStart && dateToCheck <= periodEnd) {
                    return {
                        name: period.name,
                        description: period.description,
                        start: periodStart,
                        end: periodEnd
                    };
                }
            }
            return null;
        }

        // Helper function to check if a date is a blackout day (returns boolean)
        function isBlackoutDay(dateToCheck) {
            return checkDateAgainstBlackouts(dateToCheck) !== null;
        }

        // Function to check if date range overlaps with any blackout period
        function checkRangeAgainstBlackouts(startDate, endDate) {
            if (!cachedBlackoutPeriods) {
                return null;
            }

            for (const period of cachedBlackoutPeriods) {
                const periodStart = parseLocalDate(period.start_date);
                const periodEnd = parseLocalDate(period.end_date);
                
                // Check if ranges overlap
                if (startDate <= periodEnd && endDate >= periodStart) {
                    return {
                        name: period.name,
                        description: period.description,
                        start: periodStart,
                        end: periodEnd
                    };
                }
            }
            return null;
        }

        // Cache for vacation settings
        let cachedVacationSettings = null;

        // Function to load and cache vacation settings
        async function loadVacationSettingsForValidation() {
            try {
                const response = await fetch('/api/vacation/settings');
                const data = await response.json();
                
                if (data.success && data.settings) {
                    cachedVacationSettings = data.settings;
                    return cachedVacationSettings;
                }
                return null;
            } catch (error) {
                console.error('Error loading vacation settings:', error);
                return null;
            }
        }

        // Function to calculate working days from today to a given date
        function calculateWorkingDaysFromToday(targetDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const target = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            
            if (target <= today) {
                return 0;
            }
            
            let count = 0;
            let current = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            current.setDate(current.getDate() + 1); // Start from tomorrow
            
            while (current < target) {
                if (!isWeekend(current)) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }

        // Function to check if start date meets minimum notice requirement
        function checkMinimumNotice(startDate) {
            if (!cachedVacationSettings || !cachedVacationSettings.minimum_notice_days) {
                return null; // No validation if settings not loaded
            }
            
            const workingDaysFromToday = calculateWorkingDaysFromToday(startDate);
            const requiredNoticeDays = cachedVacationSettings.minimum_notice_days;
            
            if (workingDaysFromToday < requiredNoticeDays) {
                return {
                    required: requiredNoticeDays,
                    actual: workingDaysFromToday,
                    shortfall: requiredNoticeDays - workingDaysFromToday
                };
            }
            
            return null;
        }

        async function validateAndUpdateDates() {
            const startDateInput = document.getElementById('vacationStartDate');
            const endDateInput = document.getElementById('vacationEndDate');
            const startPastWarning = document.getElementById('startDatePastWarning');
            const endPastWarning = document.getElementById('endDatePastWarning');
            const startNoticeWarning = document.getElementById('startDateNoticeWarning');
            const startNoticeMessage = document.getElementById('startDateNoticeMessage');
            const startWarning = document.getElementById('startDateWeekendWarning');
            const endWarning = document.getElementById('endDateWeekendWarning');
            const startBlackoutWarning = document.getElementById('startDateBlackoutWarning');
            const endBlackoutWarning = document.getElementById('endDateBlackoutWarning');
            const startBlackoutMessage = document.getElementById('startDateBlackoutMessage');
            const endBlackoutMessage = document.getElementById('endDateBlackoutMessage');
            const startWeekendDay = document.getElementById('startDateWeekendDay');
            const endWeekendDay = document.getElementById('endDateWeekendDay');
            const summaryDiv = document.getElementById('vacationDaysSummary');
            const returnDateInput = document.getElementById('vacationReturnDate');
            const returnDateContainer = document.getElementById('returnToWorkContainer');

            // Load blackout periods if not already cached
            if (!cachedBlackoutPeriods) {
                await loadBlackoutPeriodsForValidation();
            }

            // Load vacation settings if not already cached
            if (!cachedVacationSettings) {
                await loadVacationSettingsForValidation();
            }

            if (!startDateInput.value || !endDateInput.value) {
                startPastWarning.classList.add('hidden');
                endPastWarning.classList.add('hidden');
                startNoticeWarning.classList.add('hidden');
                startWarning.classList.add('hidden');
                endWarning.classList.add('hidden');
                startBlackoutWarning.classList.add('hidden');
                endBlackoutWarning.classList.add('hidden');
                summaryDiv.classList.add('hidden');
                returnDateContainer.classList.add('hidden');
                return;
            }

            // Parse dates properly to avoid timezone issues
            const startDate = parseLocalDate(startDateInput.value);
            const endDate = parseLocalDate(endDateInput.value);
            
            // Get today's date at midnight for comparison
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            console.log('Start Date:', startDate, 'Day:', getDayName(startDate));
            console.log('End Date:', endDate, 'Day:', getDayName(endDate));
            console.log('Today:', today);

            // Check if start date is in the past
            let hasError = false;
            if (startDate < today) {
                startPastWarning.classList.remove('hidden');
                startDateInput.classList.add('border-red-500');
                startDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                startPastWarning.classList.add('hidden');
                startDateInput.classList.remove('border-red-500');
                startDateInput.classList.add('border-slate-300');
            }

            // Check if end date is in the past
            if (endDate < today) {
                endPastWarning.classList.remove('hidden');
                endDateInput.classList.add('border-red-500');
                endDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                endPastWarning.classList.add('hidden');
                endDateInput.classList.remove('border-red-500');
                endDateInput.classList.add('border-slate-300');
            }

            // Check minimum notice days requirement
            const noticeViolation = checkMinimumNotice(startDate);
            if (noticeViolation) {
                startNoticeMessage.textContent = `Vacation requests must be submitted at least ${noticeViolation.required} working days in advance. This date is only ${noticeViolation.actual} working day${noticeViolation.actual !== 1 ? 's' : ''} away (${noticeViolation.shortfall} day${noticeViolation.shortfall !== 1 ? 's' : ''} short). Please select a later start date.`;
                startNoticeWarning.classList.remove('hidden');
                startDateInput.classList.add('border-orange-500');
                startDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                startNoticeWarning.classList.add('hidden');
                if (!hasError) {
                    startDateInput.classList.remove('border-orange-500');
                }
            }

            // Check for blackout periods
            const startBlackout = checkDateAgainstBlackouts(startDate);
            if (startBlackout) {
                const startFormatted = startBlackout.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endFormatted = startBlackout.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                startBlackoutMessage.textContent = `This date falls within the "${startBlackout.name}" blackout period (${startFormatted} - ${endFormatted}). ${startBlackout.description || ''}`;
                startBlackoutWarning.classList.remove('hidden');
                startDateInput.classList.add('border-red-500');
                startDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                startBlackoutWarning.classList.add('hidden');
            }

            const endBlackout = checkDateAgainstBlackouts(endDate);
            if (endBlackout) {
                const startFormatted = endBlackout.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endFormatted = endBlackout.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                endBlackoutMessage.textContent = `This date falls within the "${endBlackout.name}" blackout period (${startFormatted} - ${endFormatted}). ${endBlackout.description || ''}`;
                endBlackoutWarning.classList.remove('hidden');
                endDateInput.classList.add('border-red-500');
                endDateInput.classList.remove('border-slate-300');
                hasError = true;
            } else {
                endBlackoutWarning.classList.add('hidden');
            }

            // If there are errors (past dates or blackout periods), don't proceed with other validations
            if (hasError) {
                startWarning.classList.add('hidden');
                endWarning.classList.add('hidden');
                summaryDiv.classList.add('hidden');
                returnDateContainer.classList.add('hidden');
                return;
            }

            // Check if start date is weekend
            if (isWeekend(startDate)) {
                startWarning.classList.remove('hidden');
                startWeekendDay.textContent = getDayName(startDate);
            } else {
                startWarning.classList.add('hidden');
            }

            // Check if end date is weekend
            if (isWeekend(endDate)) {
                endWarning.classList.remove('hidden');
                endWeekendDay.textContent = getDayName(endDate);
            } else {
                endWarning.classList.add('hidden');
            }

            // Calculate working days
            if (endDate >= startDate) {
                const { workingDays, weekendDays, blackoutDays } = calculateWorkingDays(startDate, endDate);
                const returnDate = getReturnToWorkDate(endDate);

                console.log('Working Days:', workingDays, 'Weekend Days:', weekendDays, 'Blackout Days:', blackoutDays, 'Return:', returnDate);

                // Update summary display
                summaryDiv.classList.remove('hidden');
                document.getElementById('workingDaysCount').textContent = workingDays;
                document.getElementById('weekendDaysCount').textContent = weekendDays;
                
                // Show/hide blackout days section based on whether there are any blackout days
                const blackoutDaysSection = document.getElementById('blackoutDaysSection');
                if (blackoutDays > 0) {
                    document.getElementById('blackoutDaysCount').textContent = blackoutDays;
                    blackoutDaysSection.classList.remove('hidden');
                } else {
                    blackoutDaysSection.classList.add('hidden');
                }
                
                document.getElementById('returnToWorkDate').textContent = returnDate.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });

                // Auto-fill return to work date input field
                const returnDateString = returnDate.toISOString().split('T')[0]; // Format as YYYY-MM-DD
                returnDateInput.value = returnDateString;
                returnDateContainer.classList.remove('hidden');

                // Check for gap days when return date is auto-filled
                checkReturnDateGap();
            } else {
                summaryDiv.classList.add('hidden');
                returnDateContainer.classList.add('hidden');
            }
        }

        function checkReturnDateGap() {
            const endDateInput = document.getElementById('vacationEndDate');
            const returnDateInput = document.getElementById('vacationReturnDate');
            const gapWarning = document.getElementById('returnDateGapWarning');
            const gapDaysCount = document.getElementById('gapDaysCount');

            if (!endDateInput.value || !returnDateInput.value) {
                gapWarning.classList.add('hidden');
                return;
            }

            const endDate = parseLocalDate(endDateInput.value);
            const returnDate = parseLocalDate(returnDateInput.value);
            const expectedReturnDate = getReturnToWorkDate(endDate);

            // Only show warning if return date is AFTER the expected return date
            if (returnDate > expectedReturnDate) {
                // Calculate working days between expected return and actual return date
                const gapStart = new Date(expectedReturnDate.getFullYear(), expectedReturnDate.getMonth(), expectedReturnDate.getDate());
                const gapEnd = new Date(returnDate.getFullYear(), returnDate.getMonth(), returnDate.getDate());
                gapEnd.setDate(gapEnd.getDate() - 1); // Don't include the actual return date

                const { workingDays } = calculateWorkingDays(gapStart, gapEnd);

                if (workingDays > 0) {
                    gapDaysCount.textContent = workingDays;
                    gapWarning.classList.remove('hidden');
                } else {
                    gapWarning.classList.add('hidden');
                }
            } else {
                gapWarning.classList.add('hidden');
            }
        }

        // Add event listeners for date inputs
        document.getElementById('vacationStartDate')?.addEventListener('change', validateAndUpdateDates);
        document.getElementById('vacationEndDate')?.addEventListener('change', validateAndUpdateDates);
        document.getElementById('vacationReturnDate')?.addEventListener('change', checkReturnDateGap);

        // Form Submission
        document.getElementById('createRequestForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check for blackout period violations before submitting
            const startDate = parseLocalDate(document.getElementById('vacationStartDate').value);
            const endDate = parseLocalDate(document.getElementById('vacationEndDate').value);
            
            // Check minimum notice requirement
            const noticeViolation = checkMinimumNotice(startDate);
            if (noticeViolation) {
                showToast(`Cannot submit request: Vacation requests must be submitted at least ${noticeViolation.required} working days in advance. Please select a later start date.`, 'error');
                return;
            }
            
            const startBlackout = checkDateAgainstBlackouts(startDate);
            const endBlackout = checkDateAgainstBlackouts(endDate);
            
            if (startBlackout || endBlackout) {
                showToast('Cannot submit request: Selected dates fall within a blackout period. Please choose different dates or contact your Manager.', 'error');
                return;
            }
            
            // Get button elements
            const submitBtn = document.getElementById('createRequestSubmitBtn');
            const submitBtnText = document.getElementById('createRequestBtnText');
            const submitSpinner = document.getElementById('createRequestSpinner');
            
            // Set loading state
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
            submitBtnText.textContent = 'Submitting...';
            submitSpinner.classList.remove('hidden');
            
            try {
                // Get form values
                const employeeId = document.getElementById('vacationEmployeeSelect').value;
                const leaveType = document.getElementById('vacationLeaveType').value;
                const startDate = document.getElementById('vacationStartDate').value;
                const endDate = document.getElementById('vacationEndDate').value;
                const returnToWork = document.getElementById('vacationReturnDate').value;
                const reason = document.getElementById('vacationReason').value;
                const coveragePlan = document.getElementById('vacationCoveragePlan').value;
                const emergencyPhone = document.getElementById('vacationEmergencyPhone').value;
                const emergencyEmail = document.getElementById('vacationEmergencyEmail').value;
                const autoApprove = document.getElementById('vacationAutoApprove').checked;
                
                // Validate required fields
                if (!employeeId || !leaveType || !startDate || !endDate || !reason) {
                    showToast('Please fill in all required fields', 'warning');
                    return;
                }
                
                // Validate date range
                if (new Date(endDate) < new Date(startDate)) {
                    showToast('End date cannot be before start date', 'warning');
                    return;
                }

                // Check for past dates
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0);
                const endDateObj = new Date(endDate);
                endDateObj.setHours(0, 0, 0, 0);

                if (startDateObj < today) {
                    showToast('Cannot submit: Start date cannot be in the past', 'error');
                    return;
                }

                if (endDateObj < today) {
                    showToast('Cannot submit: End date cannot be in the past', 'error');
                    return;
                }

                // Check for weekend warnings
                const startWarning = document.getElementById('startDateWeekendWarning');
                const endWarning = document.getElementById('endDateWeekendWarning');
                
                if (!startWarning.classList.contains('hidden') || !endWarning.classList.contains('hidden')) {
                    showToast('Cannot submit: Weekend dates are not allowed. Please select working days (Monday-Friday) only.', 'error');
                    return;
                }
                
                // Prepare request data
                const requestData = {
                    employee_id: parseInt(employeeId),
                    leave_type: leaveType,
                    start_date: startDate,
                    end_date: endDate,
                    return_to_work: returnToWork || null,
                    reason: reason,
                    coverage_plan: coveragePlan || null,
                    emergency_phone: emergencyPhone || null,
                    emergency_email: emergencyEmail || null,
                    auto_approve: autoApprove
                };
                
                console.log('Submitting vacation request:', requestData);
                
                const response = await fetch('/api/vacation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.success) {
                    showToast('Vacation request created successfully!', 'success');
                    // Reset form
                    document.getElementById('createRequestForm').reset();
                    // Reload employee dropdown
                    populateEmployeeDropdown();
                    // Navigate to overview
                    showSection('overview', null);
                } else {
                    showToast('Error: ' + (data.message || 'Failed to create vacation request'), 'error');
                }
            } catch (error) {
                console.error('Error submitting vacation request:', error);
                showToast('Error submitting request. Please try again.', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                submitBtnText.textContent = 'Create Request';
                submitSpinner.classList.add('hidden');
            }
        });

        // Global Search
        document.getElementById('globalSearch')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            // In a real app, this would filter results
            console.log('Searching for:', searchTerm);
        });

        // Populate employee dropdown from database
        async function populateEmployeeDropdown() {
            try {
                console.log('Loading employees for vacation request...');
                const response = await fetch('/api/employees');
                const data = await response.json();
                
                console.log('Employees API response:', data);

                if (data.success && data.employees) {
                    const employees = data.employees;
                    const dropdown = document.getElementById('vacationEmployeeSelect');
                    
                    console.log('Found employees:', employees.length);

                    if (employees.length > 0) {
                        dropdown.innerHTML = '<option value="">Select employee...</option>' +
                            employees.map(emp => {
                                const fullName = `${emp.firstname} ${emp.lastname}`;
                                const role = emp.role || 'Employee';
                                return `<option value="${emp.id}">${fullName} - ${role}</option>`;
                            }).join('');
                        console.log('Employee dropdown populated with', employees.length, 'employees');
                    } else {
                        dropdown.innerHTML = '<option value="">Select employee...</option><option disabled>No employees available</option>';
                        console.warn('No employees found in database');
                    }
                } else {
                    console.error('Failed to load employees:', data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                const dropdown = document.getElementById('vacationEmployeeSelect');
                dropdown.innerHTML = '<option value="">Select employee...</option><option disabled>Error loading employees</option>';
            }
        }

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                // Close mobile menu if window becomes large
                if (window.innerWidth >= 1024) {
                    const mobileMenu = document.getElementById('mobileMenu');
                    const mobileOverlay = document.getElementById('mobileOverlay');
                    const hamburger = document.getElementById('hamburgerBtn');
                    
                    if (mobileMenu.classList.contains('active')) {
                        mobileMenu.classList.remove('active');
                        mobileOverlay.classList.remove('active');
                        hamburger.classList.remove('active');
                    }
                }
            }, 250);
        });

        // Load Mobile Menu Stats
        async function loadMobileMenuStats() {
            try {
                // Load total pending requests for Overview badge
                const requestsResponse = await fetch('/api/vacation/requests');
                if (requestsResponse.ok) {
                    const requestsData = await requestsResponse.json();
                    if (requestsData.success && requestsData.requests) {
                        const pendingCount = requestsData.requests.filter(r => r.status === 'pending').length;
                        document.getElementById('mobileOverviewCount').textContent = pendingCount;
                    }
                }

                // Load total employees count for Employees badge
                const employeesResponse = await fetch('/api/employees');
                if (employeesResponse.ok) {
                    const employeesData = await employeesResponse.json();
                    if (employeesData.success && employeesData.employees) {
                        document.getElementById('mobileEmployeesCount').textContent = employeesData.employees.length;
                    }
                }

                // Load pending requests count for Requests badge
                const statsResponse = await fetch('/api/vacation/stats');
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    if (statsData.success && statsData.stats) {
                        document.getElementById('mobileRequestsCount').textContent = statsData.stats.pending || 0;
                    }
                }
            } catch (error) {
                console.error('Error loading mobile menu stats:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Vacation Dashboard loaded');
            // Load all data when page loads
            populateEmployeeDropdown();
            loadVacationStats();
            loadUpcomingVacations();
            loadPendingVacations();
            loadRecentVacations();
            loadActivityLog();
            loadDepartments(); // Load department filter options
            loadMobileMenuStats(); // Load mobile menu badge counts
        });

        // Activity Log Management
        let activityCurrentPage = 1;
        let activityRowsPerPage = 10;
        let allActivities = [];

        function changeActivityRowsPerPage() {
            activityRowsPerPage = parseInt(document.getElementById('activityRowsPerPage').value);
            activityCurrentPage = 1; // Reset to first page
            renderActivityPage();
        }

        function previousActivityPage() {
            if (activityCurrentPage > 1) {
                activityCurrentPage--;
                renderActivityPage();
            }
        }

        function nextActivityPage() {
            const totalPages = Math.ceil(allActivities.length / activityRowsPerPage);
            if (activityCurrentPage < totalPages) {
                activityCurrentPage++;
                renderActivityPage();
            }
        }

        function renderActivityPage() {
            const container = document.getElementById('activityLogContainer');
            const startIndex = (activityCurrentPage - 1) * activityRowsPerPage;
            const endIndex = startIndex + activityRowsPerPage;
            const pageActivities = allActivities.slice(startIndex, endIndex);
            const totalPages = Math.ceil(allActivities.length / activityRowsPerPage);

            if (pageActivities.length === 0 && allActivities.length > 0) {
                // If current page is empty but we have data, go to last page
                activityCurrentPage = totalPages;
                renderActivityPage();
                return;
            }

            if (pageActivities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-lg font-medium text-slate-500">No activity to display</p>
                        <p class="text-sm text-slate-400 mt-2">There are no vacation activities matching your filter.</p>
                    </div>
                `;
                document.getElementById('activityPageInfo').textContent = 'Page 0 of 0';
                document.getElementById('activityPrevBtn').disabled = true;
                document.getElementById('activityNextBtn').disabled = true;
                return;
            }

            const activityHTML = pageActivities.map(activity => {
                const activityDate = parseLocalDateTime(activity.activity_timestamp);
                const formattedDate = activityDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                }) + ' at ' + activityDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });

                // Use parseLocalDate to avoid timezone issues
                const startDate = parseLocalDate(activity.start_date);
                const endDate = parseLocalDate(activity.end_date);
                const formattedStartDate = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const formattedEndDate = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                // Capitalize leave type for display
                const leaveTypeDisplay = activity.leave_type 
                    ? activity.leave_type.charAt(0).toUpperCase() + activity.leave_type.slice(1) 
                    : 'N/A';

                // Determine icon and styling based on activity type
                let iconBg, iconColor, iconPath, activityTitle, activityDescription;
                
                switch (activity.activity_type) {
                    case 'approved':
                        iconBg = 'bg-green-100';
                        iconColor = 'text-green-600';
                        iconPath = 'M5 13l4 4L19 7';
                        activityTitle = 'Vacation Request Approved';
                        activityDescription = `<span class="font-medium">${activity.approved_by_username || 'Supervisor'}</span> approved <span class="font-medium">${activity.firstname} ${activity.lastname}'s</span> vacation request for ${formattedStartDate} - ${formattedEndDate}`;
                        break;
                    case 'denied':
                        iconBg = 'bg-red-100';
                        iconColor = 'text-red-600';
                        iconPath = 'M6 18L18 6M6 6l12 12';
                        activityTitle = 'Vacation Request Denied';
                        activityDescription = `<span class="font-medium">${activity.approved_by_username || 'Supervisor'}</span> denied <span class="font-medium">${activity.firstname} ${activity.lastname}'s</span> vacation request for ${formattedStartDate} - ${formattedEndDate}`;
                        break;
                    case 'modified':
                        iconBg = 'bg-purple-100';
                        iconColor = 'text-purple-600';
                        iconPath = 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z';
                        activityTitle = 'Vacation Request Modified';
                        activityDescription = `<span class="font-medium">${activity.firstname} ${activity.lastname}</span> updated vacation dates to ${formattedStartDate} - ${formattedEndDate}`;
                        break;
                    case 'new_request':
                    default:
                        iconBg = 'bg-blue-100';
                        iconColor = 'text-blue-600';
                        iconPath = 'M12 4v16m8-8H4';
                        activityTitle = 'New Vacation Request';
                        activityDescription = `<span class="font-medium">${activity.firstname} ${activity.lastname}</span> submitted a vacation request for ${formattedStartDate} - ${formattedEndDate}`;
                        break;
                }

                // Status badge
                let statusBadge = '';
                if (activity.status === 'pending') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700">Pending</span>';
                }

                // Decision reason
                let decisionReason = '';
                if (activity.decision_reason && activity.activity_type === 'denied') {
                    decisionReason = `<div class="text-xs text-slate-500 italic mb-2">Reason: ${activity.decision_reason}</div>`;
                }

                return `
                    <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-10 h-10 ${iconBg} rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-2 gap-2">
                                    <div class="font-semibold text-slate-900">${activityTitle}</div>
                                    <span class="text-xs text-slate-500">${formattedDate}</span>
                                </div>
                                <div class="text-sm text-slate-600 mb-2">
                                    ${activityDescription}
                                </div>
                                ${decisionReason}
                                <div class="flex flex-wrap gap-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">${activity.duration_days || 0} day${activity.duration_days !== 1 ? 's' : ''}</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700">${leaveTypeDisplay}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = activityHTML;

            // Update pagination info
            document.getElementById('activityPageInfo').textContent = `Page ${activityCurrentPage} of ${totalPages || 1}`;
            
            // Update button states
            const prevBtn = document.getElementById('activityPrevBtn');
            const nextBtn = document.getElementById('activityNextBtn');
            prevBtn.disabled = activityCurrentPage === 1;
            nextBtn.disabled = activityCurrentPage >= totalPages;
        }

        // Load activity log with filtering
        async function loadActivityLog(reset = true) {
            try {
                const activityType = document.getElementById('activityTypeFilter').value;
                const response = await fetch(`/api/vacation/activity?type=${activityType}&limit=1000&offset=0`);
                const data = await response.json();
                
                const container = document.getElementById('activityLogContainer');
                
                if (data.success && data.activities) {
                    allActivities = data.activities;
                    
                    if (allActivities.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-slate-500">No activity found</p>
                            </div>
                        `;
                        document.getElementById('activityPageInfo').textContent = 'Page 0 of 0';
                        document.getElementById('activityPrevBtn').disabled = true;
                        document.getElementById('activityNextBtn').disabled = true;
                        return;
                    }
                    
                    // Reset to first page when filters change
                    activityCurrentPage = 1;
                    renderActivityPage();
                } else {
                    console.error('Failed to load activity log:', data.message);
                    allActivities = [];
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-slate-500">No activity found</p>
                        </div>
                    `;
                    document.getElementById('activityPageInfo').textContent = 'Page 0 of 0';
                    document.getElementById('activityPrevBtn').disabled = true;
                    document.getElementById('activityNextBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error loading activity log:', error);
                allActivities = [];
                const container = document.getElementById('activityLogContainer');
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <p class="text-slate-500">Error loading activity log</p>
                    </div>
                `;
                document.getElementById('activityPageInfo').textContent = 'Page 0 of 0';
                document.getElementById('activityPrevBtn').disabled = true;
                document.getElementById('activityNextBtn').disabled = true;
            }
        }

        // Load vacation settings (constraints)
        async function loadVacationSettings() {
            try {
                const response = await fetch('/api/vacation/settings');
                const data = await response.json();
                
                if (data.success && data.settings) {
                    const settings = data.settings;
                    
                    // Cache settings for editing
                    currentVacationSettings = settings;
                    
                    // Update Annual Leave Limits
                    document.getElementById('minimumNotice').textContent = `${settings.minimum_notice_days} days`;
                    document.getElementById('maxConsecutive').textContent = `${settings.max_consecutive_days} days`;
                    
                    // Update Team Coverage Rules
                    document.getElementById('minTeamCoverage').textContent = `${settings.min_team_coverage_percent}%`;
                    
                    const criticalCoverageEl = document.getElementById('criticalCoverage');
                    if (settings.critical_role_coverage_required) {
                        criticalCoverageEl.textContent = 'Yes';
                        criticalCoverageEl.className = 'font-semibold text-green-600';
                    } else {
                        criticalCoverageEl.textContent = 'No';
                        criticalCoverageEl.className = 'font-semibold text-red-600';
                    }
                } else {
                    console.error('Failed to load vacation settings:', data.message);
                }
            } catch (error) {
                console.error('Error loading vacation settings:', error);
            }
        }

        // Load blackout periods
        async function loadBlackoutPeriods() {
            try {
                const response = await fetch('/api/vacation/blackout-periods');
                const data = await response.json();
                
                const container = document.getElementById('blackoutPeriodsContainer');
                
                if (data.success && data.periods) {
                    const periods = data.periods;
                    
                    if (periods.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8 text-slate-500">
                                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p class="text-lg font-medium">No blackout periods defined</p>
                                <p class="text-sm text-slate-400 mt-2">Click "Add Period" to create a new blackout period.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const periodsHTML = periods.map(period => {
                        const startDate = parseLocalDate(period.start_date);
                        const endDate = parseLocalDate(period.end_date);
                        const formattedStart = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const formattedEnd = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        
                        return `
                            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between p-3 bg-red-50 rounded border border-red-200 gap-3">
                                <div>
                                    <div class="font-semibold text-slate-900">${period.name}</div>
                                    <div class="text-sm text-slate-600">${formattedStart} - ${formattedEnd}</div>
                                    ${period.description ? `<div class="text-xs text-slate-500 mt-1">${period.description}</div>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editBlackoutPeriod(${period.id})" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Edit</button>
                                    <button onclick="removeBlackoutPeriod(${period.id})" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Remove</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    container.innerHTML = periodsHTML;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-slate-500">
                            <svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-slate-600">Error loading blackout periods</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading blackout periods:', error);
                const container = document.getElementById('blackoutPeriodsContainer');
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <p class="text-slate-600">Error loading blackout periods</p>
                    </div>
                `;
            }
        }

        // Edit blackout period
        function editBlackoutPeriod(periodId) {
            // Find the period data from the loaded periods
            fetch(`/api/vacation/blackout-periods`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.periods) {
                        const period = data.periods.find(p => p.id === periodId);
                        if (period) {
                            // Populate the form with existing data
                            document.getElementById('blackoutPeriodModalTitle').textContent = 'Edit Blackout Period';
                            document.getElementById('blackoutPeriodSubmitText').textContent = 'Save Changes';
                            document.getElementById('blackoutPeriodId').value = period.id;
                            document.getElementById('blackoutPeriodName').value = period.name;
                            document.getElementById('blackoutPeriodStartDate').value = period.start_date;
                            document.getElementById('blackoutPeriodEndDate').value = period.end_date;
                            document.getElementById('blackoutPeriodDescription').value = period.description || '';
                            document.getElementById('blackoutPeriodActive').checked = period.is_active;
                            
                            // Show modal
                            document.getElementById('blackoutPeriodModal').classList.remove('hidden');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading blackout period:', error);
                    showToast('Error loading blackout period', 'error');
                });
        }

        // Add new blackout period
        function addBlackoutPeriod() {
            // Reset form for new entry
            document.getElementById('blackoutPeriodModalTitle').textContent = 'Add Blackout Period';
            document.getElementById('blackoutPeriodSubmitText').textContent = 'Add Period';
            document.getElementById('blackoutPeriodForm').reset();
            document.getElementById('blackoutPeriodId').value = '';
            document.getElementById('blackoutPeriodActive').checked = true;
            
            // Show modal
            document.getElementById('blackoutPeriodModal').classList.remove('hidden');
        }

        // Close blackout period modal
        function closeBlackoutPeriodModal() {
            document.getElementById('blackoutPeriodModal').classList.add('hidden');
            document.getElementById('blackoutPeriodForm').reset();
        }

        // Remove blackout period
        async function removeBlackoutPeriod(periodId) {
            const confirmed = await showConfirmation(
                'Remove Blackout Period',
                'Are you sure you want to remove this blackout period? This action cannot be undone.',
                'Remove',
                'Cancel'
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/vacation/blackout-periods/${periodId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Blackout period removed successfully', 'success');
                    loadBlackoutPeriods(); // Reload the list
                } else {
                    showToast(data.message || 'Failed to remove blackout period', 'error');
                }
            } catch (error) {
                console.error('Error removing blackout period:', error);
                showToast('Error removing blackout period', 'error');
            }
        }

        // Current vacation settings (cached)
        let currentVacationSettings = null;

        // Work Area Settings Management Functions
        let workLinesAndAreas = { work_lines: [], work_areas: [] };

        // Load work lines and areas from assets table
        async function loadWorkLinesAndAreas() {
            try {
                const response = await fetch('/api/assets/work-lines-areas');
                const data = await response.json();
                
                if (data.success) {
                    workLinesAndAreas = {
                        work_lines: data.work_lines || [],
                        work_areas: data.work_areas || []
                    };
                    return workLinesAndAreas;
                }
            } catch (error) {
                console.error('Error loading work lines and areas:', error);
            }
            return workLinesAndAreas;
        }

        // Populate work line and area dropdowns
        function populateWorkAreaDropdowns() {
            const workLineSelect = document.getElementById('workAreaSettingWorkLine');
            const workAreaSelect = document.getElementById('workAreaSettingWorkArea');
            
            // Populate work lines
            workLineSelect.innerHTML = '<option value="">Select a work line...</option>' +
                workLinesAndAreas.work_lines.map(line => 
                    `<option value="${line}">${line}</option>`
                ).join('');
            
            // Populate work areas
            workAreaSelect.innerHTML = '<option value="">Select a work area...</option>' +
                workLinesAndAreas.work_areas.map(area => 
                    `<option value="${area}">${area}</option>`
                ).join('');
        }

        async function loadWorkAreaSettings() {
            try {
                const response = await fetch('/api/work-area-settings');
                const data = await response.json();
                
                const container = document.getElementById('workAreaSettingsContainer');
                
                if (data.success && data.settings && data.settings.length > 0) {
                    container.innerHTML = data.settings.map(setting => {
                        // Display work_line and work_area_name if available, fallback to work_area
                        const displayName = setting.work_line && setting.work_area_name 
                            ? `${setting.work_line} - ${setting.work_area_name}`
                            : setting.work_area;
                        
                        return `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                            <div class="flex-1">
                                <div class="font-medium text-slate-900">${displayName}</div>
                                <div class="text-sm text-slate-600 mt-1">Max ${setting.max_simultaneous_absences} ${setting.max_simultaneous_absences === 1 ? 'person' : 'people'} simultaneously</div>
                                ${setting.description ? `<div class="text-xs text-slate-500 mt-1">${setting.description}</div>` : ''}
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick='editWorkAreaSetting(${JSON.stringify(setting).replace(/'/g, "&apos;")})' 
                                    class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="removeWorkAreaSetting(${setting.id}, '${displayName.replace(/'/g, "&apos;")}')" 
                                    class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Remove">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-slate-500">
                            <svg class="w-12 h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <p class="text-sm font-medium">No work area settings configured</p>
                            <p class="text-xs mt-1">Click "Add Work Area" to create one</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading work area settings:', error);
                document.getElementById('workAreaSettingsContainer').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="text-sm">Failed to load work area settings</p>
                    </div>
                `;
            }
        }

        // Add new work area setting
        async function addWorkAreaSetting() {
            // Load work lines and areas first
            await loadWorkLinesAndAreas();
            
            document.getElementById('workAreaSettingModalTitle').textContent = 'Add Work Area Setting';
            document.getElementById('workAreaSettingSubmitText').textContent = 'Add Setting';
            document.getElementById('workAreaSettingForm').reset();
            document.getElementById('workAreaSettingId').value = '';
            document.getElementById('workAreaSettingActive').checked = true;
            
            // Populate dropdowns
            populateWorkAreaDropdowns();
            
            document.getElementById('workAreaSettingModal').classList.remove('hidden');
        }

        // Edit work area setting
        async function editWorkAreaSetting(setting) {
            // Load work lines and areas first
            await loadWorkLinesAndAreas();
            
            document.getElementById('workAreaSettingModalTitle').textContent = 'Edit Work Area Setting';
            document.getElementById('workAreaSettingSubmitText').textContent = 'Update Setting';
            document.getElementById('workAreaSettingId').value = setting.id;
            
            // Populate dropdowns
            populateWorkAreaDropdowns();
            
            // Set selected values
            document.getElementById('workAreaSettingWorkLine').value = setting.work_line || '';
            document.getElementById('workAreaSettingWorkArea').value = setting.work_area_name || '';
            document.getElementById('workAreaSettingMaxAbsences').value = setting.max_simultaneous_absences;
            document.getElementById('workAreaSettingDescription').value = setting.description || '';
            document.getElementById('workAreaSettingActive').checked = setting.is_active;
            
            document.getElementById('workAreaSettingModal').classList.remove('hidden');
        }

        // Close work area setting modal
        function closeWorkAreaSettingModal() {
            document.getElementById('workAreaSettingModal').classList.add('hidden');
            document.getElementById('workAreaSettingForm').reset();
        }

        // Remove work area setting
        async function removeWorkAreaSetting(settingId, workArea) {
            const confirmed = await showConfirmation(
                'Remove Work Area Setting',
                `Are you sure you want to remove the setting for "${workArea}"? This action cannot be undone.`,
                'Remove',
                'Cancel'
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/work-area-settings/${settingId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Work area setting removed successfully', 'success');
                    loadWorkAreaSettings();
                } else {
                    showToast(data.message || 'Failed to remove work area setting', 'error');
                }
            } catch (error) {
                console.error('Error removing work area setting:', error);
                showToast('Error removing work area setting', 'error');
            }
        }

        // Edit vacation settings
        function editVacationSettings(type) {
            if (!currentVacationSettings) {
                showToast('Please wait for settings to load', 'info');
                return;
            }

            // Populate the form with current values
            document.getElementById('editMinimumNotice').value = currentVacationSettings.minimum_notice_days;
            document.getElementById('editMaxConsecutive').value = currentVacationSettings.max_consecutive_days;
            document.getElementById('editMinCoverage').value = currentVacationSettings.min_team_coverage_percent;
            document.getElementById('editCriticalCoverage').checked = currentVacationSettings.critical_role_coverage_required;

            // Show the modal
            document.getElementById('editSettingsModal').classList.remove('hidden');
        }

        // Close edit settings modal
        function closeEditSettingsModal() {
            document.getElementById('editSettingsModal').classList.add('hidden');
        }

        // Handle edit settings form submission
        document.addEventListener('DOMContentLoaded', function() {
            const editForm = document.getElementById('editSettingsForm');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const updatedSettings = {
                        minimum_notice_days: parseInt(document.getElementById('editMinimumNotice').value),
                        max_consecutive_days: parseInt(document.getElementById('editMaxConsecutive').value),
                        min_team_coverage_percent: parseInt(document.getElementById('editMinCoverage').value),
                        critical_role_coverage_required: document.getElementById('editCriticalCoverage').checked
                    };

                    try {
                        const response = await fetch('/api/vacation/settings', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updatedSettings)
                        });

                        const data = await response.json();

                        if (data.success) {
                            showToast('Settings updated successfully', 'success');
                            closeEditSettingsModal();
                            loadVacationSettings(); // Reload to show updated values
                        } else {
                            showToast(data.message || 'Failed to update settings', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating settings:', error);
                        showToast('Error updating settings', 'error');
                    }
                });
            }
            
            // Blackout Period Form Handler
            const blackoutPeriodForm = document.getElementById('blackoutPeriodForm');
            if (blackoutPeriodForm) {
                blackoutPeriodForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const periodId = document.getElementById('blackoutPeriodId').value;
                    const periodData = {
                        name: document.getElementById('blackoutPeriodName').value,
                        start_date: document.getElementById('blackoutPeriodStartDate').value,
                        end_date: document.getElementById('blackoutPeriodEndDate').value,
                        description: document.getElementById('blackoutPeriodDescription').value,
                        is_active: document.getElementById('blackoutPeriodActive').checked
                    };

                    try {
                        let response;
                        if (periodId) {
                            // Update existing period
                            response = await fetch(`/api/vacation/blackout-periods/${periodId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(periodData)
                            });
                        } else {
                            // Create new period
                            response = await fetch('/api/vacation/blackout-periods', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(periodData)
                            });
                        }

                        const data = await response.json();

                        if (data.success) {
                            showToast(periodId ? 'Blackout period updated successfully' : 'Blackout period added successfully', 'success');
                            closeBlackoutPeriodModal();
                            loadBlackoutPeriods(); // Reload the list
                        } else {
                            showToast(data.message || 'Failed to save blackout period', 'error');
                        }
                    } catch (error) {
                        console.error('Error saving blackout period:', error);
                        showToast('Error saving blackout period', 'error');
                    }
                });
            }

            // Work Area Setting Form Handler
            const workAreaSettingForm = document.getElementById('workAreaSettingForm');
            if (workAreaSettingForm) {
                workAreaSettingForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const settingId = document.getElementById('workAreaSettingId').value;
                    const settingData = {
                        work_line: document.getElementById('workAreaSettingWorkLine').value,
                        work_area_name: document.getElementById('workAreaSettingWorkArea').value,
                        max_simultaneous_absences: parseInt(document.getElementById('workAreaSettingMaxAbsences').value),
                        description: document.getElementById('workAreaSettingDescription').value,
                        is_active: document.getElementById('workAreaSettingActive').checked
                    };

                    try {
                        let response;
                        if (settingId) {
                            // Update existing setting
                            response = await fetch(`/api/work-area-settings/${settingId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(settingData)
                            });
                        } else {
                            // Create new setting
                            response = await fetch('/api/work-area-settings', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(settingData)
                            });
                        }

                        const data = await response.json();

                        if (data.success) {
                            showToast(settingId ? 'Work area setting updated successfully' : 'Work area setting added successfully', 'success');
                            closeWorkAreaSettingModal();
                            loadWorkAreaSettings(); // Reload the list
                        } else {
                            showToast(data.message || 'Failed to save work area setting', 'error');
                        }
                    } catch (error) {
                        console.error('Error saving work area setting:', error);
                        showToast('Error saving work area setting', 'error');
                    }
                });
            }
        });

        // Load vacation dashboard statistics
        async function loadVacationStats() {
            try {
                const response = await fetch('/api/vacation/stats');
                const data = await response.json();
                
                if (data.success && data.stats) {
                    const stats = data.stats;
                    
                    // Update Quick Stats (sidebar)
                    document.getElementById('statTotalRequests').textContent = stats.total_requests || 0;
                    document.getElementById('statPending').textContent = stats.pending || 0;
                    document.getElementById('statApproved').textContent = stats.approved || 0;
                    document.getElementById('statDenied').textContent = stats.denied || 0;
                    
                    // Update Dashboard Cards (Overview section)
                    document.getElementById('dashTotalEmployees').textContent = stats.total_employees || 0;
                    document.getElementById('dashPendingCount').textContent = stats.pending || 0;
                    document.getElementById('dashApprovedMonthCount').textContent = stats.approved_this_month || 0;
                    document.getElementById('dashDaysUsedYTD').textContent = stats.days_used_ytd || 0;
                    
                    // Update Navigation Badges
                    document.getElementById('navBadgeOverview').textContent = stats.approved_this_month || 0; // Show approved this month
                    document.getElementById('navBadgeEmployees').textContent = stats.total_employees || 0;
                    document.getElementById('navBadgeRequests').textContent = stats.pending || 0; // Show pending requests
                    
                    console.log('Vacation stats loaded successfully');
                } else {
                    console.error('Failed to load vacation stats:', data.message);
                }
            } catch (error) {
                console.error('Error loading vacation stats:', error);
            }
        }

        // Load all vacation requests
        async function loadVacationRequests() {
            try {
                const statusFilter = document.getElementById('requestsStatusFilter')?.value || 'all';
                const response = await fetch(`/api/vacation/requests?status=${statusFilter}`);
                const data = await response.json();
                
                const tbody = document.getElementById('vacationRequestsTableBody');
                
                if (data.success && data.requests) {
                    const requests = data.requests;
                    
                    if (requests.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="px-4 py-12 text-center">
                                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <p class="text-lg font-medium text-slate-600">No vacation requests found</p>
                                    <p class="text-sm text-slate-400 mt-2">Try changing the status filter</p>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const avatarColors = ['blue', 'purple', 'indigo', 'pink', 'teal', 'green', 'yellow', 'red', 'orange'];
                    
                    // Helper function to get consistent color for employee
                    const getEmployeeColor = (employeeName) => {
                        let hash = 0;
                        for (let i = 0; i < employeeName.length; i++) {
                            hash = employeeName.charCodeAt(i) + ((hash << 5) - hash);
                        }
                        return avatarColors[Math.abs(hash) % avatarColors.length];
                    };
                    
                    tbody.innerHTML = requests.map((req) => {
                        const color = getEmployeeColor(req.employee_name);
                        
                        // Use parseLocalDate to avoid timezone issues
                        const startDate = parseLocalDate(req.start_date);
                        const endDate = parseLocalDate(req.end_date);
                        const formattedStart = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const formattedEnd = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const leaveTypeDisplay = req.leave_type.charAt(0).toUpperCase() + req.leave_type.slice(1);
                        
                        // Status badge configuration
                        let statusBadge, statusBg, statusText, statusDot;
                        if (req.status === 'pending') {
                            statusBg = 'bg-yellow-100';
                            statusText = 'text-yellow-700';
                            statusDot = 'bg-yellow-500';
                            statusBadge = 'Pending';
                        } else if (req.status === 'approved') {
                            statusBg = 'bg-green-100';
                            statusText = 'text-green-700';
                            statusDot = 'bg-green-500';
                            statusBadge = 'Approved';
                        } else if (req.status === 'denied') {
                            statusBg = 'bg-red-100';
                            statusText = 'text-red-700';
                            statusDot = 'bg-red-500';
                            statusBadge = 'Denied';
                        } else {
                            statusBg = 'bg-slate-100';
                            statusText = 'text-slate-700';
                            statusDot = 'bg-slate-500';
                            statusBadge = 'Cancelled';
                        }
                        
                        // Action buttons - Edit only available for pending requests
                        let actionButtons = '';
                        if (req.status === 'pending') {
                            actionButtons = `
                                <div class="flex items-center gap-2">
                                    <button onclick="editVacationRequest(${req.id})" class="text-purple-600 hover:text-purple-700 text-sm font-medium">Edit</button>
                                    <span class="text-slate-300">|</span>
                                    <button onclick="viewVacationDetails(${req.id})" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Review</button>
                                </div>
                            `;
                        } else {
                            actionButtons = `
                                <div class="flex items-center gap-2">
                                    <button onclick="viewVacationDetails(${req.id})" class="text-blue-600 hover:text-blue-700 text-sm font-medium">View</button>
                                </div>
                            `;
                        }
                        
                        // Leave type badge color
                        let typeBg, typeText;
                        if (req.leave_type === 'vacation') {
                            typeBg = 'bg-purple-100';
                            typeText = 'text-purple-700';
                        } else if (req.leave_type === 'personal') {
                            typeBg = 'bg-indigo-100';
                            typeText = 'text-indigo-700';
                        } else if (req.leave_type === 'sick') {
                            typeBg = 'bg-red-100';
                            typeText = 'text-red-700';
                        } else if (req.leave_type === 'emergency') {
                            typeBg = 'bg-orange-100';
                            typeText = 'text-orange-700';
                        } else if (req.leave_type === 'bereavement') {
                            typeBg = 'bg-slate-100';
                            typeText = 'text-slate-700';
                        } else {
                            typeBg = 'bg-blue-100';
                            typeText = 'text-blue-700';
                        }
                        
                        return `
                            <tr class="hover:bg-slate-50">
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="avatar bg-${color}-500 text-white text-sm">${req.initials}</div>
                                        <span class="font-medium text-slate-900">${req.employee_name}</span>
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-600 hidden lg:table-cell">${req.department || 'N/A'}</td>
                                <td class="px-4 py-4 text-sm text-slate-900">${formattedStart}-${formattedEnd}</td>
                                <td class="px-4 py-4 text-sm font-semibold text-slate-900 hidden md:table-cell">${req.duration_days || 0}</td>
                                <td class="px-4 py-4 hidden lg:table-cell">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium ${typeBg} ${typeText}">${leaveTypeDisplay}</span>
                                </td>
                                <td class="px-4 py-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusBg} ${statusText}">
                                        <span class="status-indicator ${statusDot}"></span>
                                        ${statusBadge}
                                    </span>
                                </td>
                                <td class="px-4 py-4">
                                    ${actionButtons}
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center">
                                <svg class="w-16 h-16 mx-auto mb-4 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <p class="text-slate-600">Error loading vacation requests</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading vacation requests:', error);
                const tbody = document.getElementById('vacationRequestsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-12 text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-slate-600">Error loading vacation requests</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Load work roles for filter dropdown from assets table
        async function loadDepartments() {
            try {
                const response = await fetch('/api/assets');
                const data = await response.json();
                
                if (data.success && data.assets && data.assets.workRoles) {
                    const select = document.getElementById('employeeDepartmentFilter');
                    if (select) {
                        // Keep the "All Work Roles" option
                        select.innerHTML = '<option value="all">All Work Roles</option>';
                        
                        // Add each work role from assets
                        data.assets.workRoles.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role;
                            option.textContent = role;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading work roles:', error);
            }
        }

        // Load conflicts and warnings
        async function loadConflicts() {
            const loadingEl = document.getElementById('conflictsLoading');
            const containerEl = document.getElementById('conflictsContainer');
            const emptyEl = document.getElementById('conflictsEmpty');

            try {
                // Show loading state
                loadingEl?.classList.remove('hidden');
                containerEl?.classList.add('hidden');
                emptyEl?.classList.add('hidden');

                const response = await fetch('/api/vacation/conflicts');
                const data = await response.json();

                loadingEl?.classList.add('hidden');

                if (data.success && data.conflicts && data.conflicts.length > 0) {
                    containerEl.innerHTML = '';
                    
                    data.conflicts.forEach(conflict => {
                        const conflictCard = createConflictCard(conflict);
                        containerEl.innerHTML += conflictCard;
                    });
                    
                    containerEl?.classList.remove('hidden');
                } else {
                    emptyEl?.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading conflicts:', error);
                loadingEl?.classList.add('hidden');
                containerEl.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <p>Error loading conflicts. Please try again.</p>
                    </div>
                `;
                containerEl?.classList.remove('hidden');
            }
        }

        // Create conflict card HTML
        function createConflictCard(conflict) {
            const isWarning = conflict.severity === 'warning';
            const borderColor = isWarning ? 'border-orange-200' : 'border-red-200';
            const bgColor = isWarning ? 'bg-orange-50' : 'bg-red-50';
            const iconBg = isWarning ? 'bg-orange-100' : 'bg-red-100';
            const iconColor = isWarning ? 'text-orange-600' : 'text-red-600';
            const icon = isWarning ? 
                'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' :
                'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';

            const buttonColor = isWarning ? 'bg-orange-600 hover:bg-orange-700' : 'bg-red-600 hover:bg-red-700';

            let detailsHtml = '';
            if (conflict.conflicting_requests && conflict.conflicting_requests.length > 0) {
                detailsHtml = `
                    <div class="bg-white rounded-lg p-3 mb-3">
                        <div class="text-xs font-semibold text-slate-600 mb-2">CONFLICTING REQUESTS</div>
                        <div class="space-y-2">
                            ${conflict.conflicting_requests.map(req => `
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-700">${req.employee_name}</span>
                                    <span class="text-slate-600">${formatDateRange(req.start_date, req.end_date)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (conflict.details) {
                detailsHtml = `
                    <div class="bg-white rounded-lg p-3 mb-3">
                        <div class="text-xs font-semibold text-slate-600 mb-2">DETAILS</div>
                        <div class="space-y-2 text-sm">
                            ${Object.entries(conflict.details).map(([key, value]) => `
                                <div class="flex justify-between">
                                    <span class="text-slate-600">${key}:</span>
                                    <span class="text-slate-900 font-medium">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="border-2 ${borderColor} ${bgColor} rounded-lg p-4 lg:p-5">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 ${iconBg} rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-slate-900 mb-2">${conflict.title}</div>
                            <div class="text-sm text-slate-700 mb-3">${conflict.description}</div>
                            ${detailsHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to format date range
        // Helper function to format date ranges
        function formatDateRange(start, end) {
            const startDate = parseLocalDate(start);
            const endDate = parseLocalDate(end);
            const options = { month: 'short', day: 'numeric' };
            const startStr = startDate.toLocaleDateString('en-US', options);
            
            // If same month and year, show condensed format
            if (startDate.getMonth() === endDate.getMonth() && startDate.getFullYear() === endDate.getFullYear()) {
                return `${startStr} - ${endDate.getDate()}`;
            }
            
            const endStr = endDate.toLocaleDateString('en-US', options);
            return `${startStr} - ${endStr}`;
        }

        // Employee Directory Pagination Variables
        let employeeCurrentPage = 1;
        let employeeRowsPerPage = 6;
        let allEmployees = [];

        function changeEmployeeRowsPerPage() {
            employeeRowsPerPage = parseInt(document.getElementById('employeeRowsPerPage').value);
            employeeCurrentPage = 1; // Reset to first page
            renderEmployeePage();
        }

        function previousEmployeePage() {
            if (employeeCurrentPage > 1) {
                employeeCurrentPage--;
                renderEmployeePage();
            }
        }

        function nextEmployeePage() {
            const totalPages = Math.ceil(allEmployees.length / employeeRowsPerPage);
            if (employeeCurrentPage < totalPages) {
                employeeCurrentPage++;
                renderEmployeePage();
            }
        }

        function renderEmployeePage() {
            const grid = document.getElementById('employeeDirectoryGrid');
            const startIndex = (employeeCurrentPage - 1) * employeeRowsPerPage;
            const endIndex = startIndex + employeeRowsPerPage;
            const pageEmployees = allEmployees.slice(startIndex, endIndex);
            const totalPages = Math.ceil(allEmployees.length / employeeRowsPerPage);

            if (pageEmployees.length === 0 && allEmployees.length > 0) {
                // If current page is empty but we have data, go to last page
                employeeCurrentPage = totalPages;
                renderEmployeePage();
                return;
            }

            const avatarColors = ['indigo', 'pink', 'teal', 'purple', 'blue', 'green', 'orange', 'red', 'yellow'];
            
            // Map color names to actual hex values for inline styles
            const colorMap = {
                'indigo': '#6366f1',
                'pink': '#ec4899',
                'teal': '#14b8a6',
                'purple': '#a855f7',
                'blue': '#3b82f6',
                'green': '#22c55e',
                'orange': '#f97316',
                'red': '#ef4444',
                'yellow': '#eab308'
            };
            
            grid.innerHTML = pageEmployees.map((emp, index) => {
                const globalIndex = startIndex + index;
                const colorName = avatarColors[globalIndex % avatarColors.length];
                const bgColor = colorMap[colorName];
                const initials = `${emp.firstname?.[0] || ''}${emp.lastname?.[0] || ''}`.toUpperCase();
                const fullName = `${emp.firstname || ''} ${emp.lastname || ''}`.trim();
                
                // Determine status
                let statusBadge, statusBg, statusText, statusDot;
                if (emp.current_status === 'on_vacation') {
                    statusBg = 'bg-blue-100';
                    statusText = 'text-blue-700';
                    statusDot = 'bg-blue-500';
                    statusBadge = 'On Vacation';
                } else if (emp.upcoming_vacation) {
                    statusBg = 'bg-green-100';
                    statusText = 'text-green-700';
                    statusDot = 'bg-green-500';
                    statusBadge = 'Available';
                } else {
                    statusBg = 'bg-green-100';
                    statusText = 'text-green-700';
                    statusDot = 'bg-green-500';
                    statusBadge = 'Available';
                }
                
                // Calculate vacation usage
                const totalDays = emp.vacation_balance_days || 25;
                const usedDays = emp.vacation_days_used || 0;
                
                // Format upcoming or pending vacation
                let vacationInfo = '';
                if (emp.current_status === 'on_vacation' && emp.return_date) {
                    // Use parseLocalDate only if the date string exists
                    const returnDate = emp.return_date ? parseLocalDate(emp.return_date) : new Date(emp.return_date);
                    const formattedReturn = returnDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    vacationInfo = `
                        <div>
                            <span class="text-slate-500">Returns:</span>
                            <span class="font-semibold text-blue-600">${formattedReturn}</span>
                        </div>
                    `;
                }
                
                // Show upcoming vacation info even if currently on vacation
                if (emp.upcoming_vacation && emp.upcoming_start && emp.upcoming_end) {
                    // Use parseLocalDate only if the date strings exist
                    const startDate = parseLocalDate(emp.upcoming_start);
                    const endDate = parseLocalDate(emp.upcoming_end);
                    const formattedDates = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}-${endDate.toLocaleDateString('en-US', { day: 'numeric' })}`;
                    const isPending = emp.upcoming_status === 'pending';
                    vacationInfo = `
                        <div>
                            <span class="text-slate-500">${isPending ? 'Pending:' : 'Upcoming:'}</span>
                            <span class="font-semibold ${isPending ? 'text-yellow-600' : 'text-blue-600'}">${formattedDates}</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="flex items-center gap-4 p-4 border border-slate-200 rounded-lg hover:border-blue-300 transition-colors">
                        <div class="avatar text-white" style="background-color: ${bgColor};">${initials}</div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <div class="font-semibold text-slate-900">${fullName}</div>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusBg} ${statusText}">
                                    <span class="status-indicator ${statusDot}"></span>
                                    ${statusBadge}
                                </span>
                            </div>
                            <div class="text-sm text-slate-600">${emp.workarea || 'N/A'}  ${emp.role || 'Employee'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update pagination info
            document.getElementById('employeePageInfo').textContent = `Page ${employeeCurrentPage} of ${totalPages || 1}`;
            
            // Update button states
            const prevBtn = document.getElementById('employeePrevBtn');
            const nextBtn = document.getElementById('employeeNextBtn');
            prevBtn.disabled = employeeCurrentPage === 1;
            nextBtn.disabled = employeeCurrentPage >= totalPages;
        }

        // Load employee directory
        async function loadEmployeeDirectory() {
            try {
                const departmentFilter = document.getElementById('employeeDepartmentFilter')?.value || 'all';
                const statusFilter = document.getElementById('employeeStatusFilter')?.value || 'all';
                
                const response = await fetch(`/api/employees/directory?department=${departmentFilter}&status=${statusFilter}`);
                const data = await response.json();
                
                const grid = document.getElementById('employeeDirectoryGrid');
                
                if (data.success && data.employees) {
                    allEmployees = data.employees;
                    
                    if (allEmployees.length === 0) {
                        grid.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                                <p class="text-lg font-medium text-slate-600">No employees found</p>
                                <p class="text-sm text-slate-400 mt-2">Try changing the filters</p>
                            </div>
                        `;
                        // Update pagination info for empty state
                        document.getElementById('employeePageInfo').textContent = 'Page 0 of 0';
                        document.getElementById('employeePrevBtn').disabled = true;
                        document.getElementById('employeeNextBtn').disabled = true;
                        return;
                    }
                    
                    // Reset to first page when filters change
                    employeeCurrentPage = 1;
                    renderEmployeePage();
                } else {
                    allEmployees = [];
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-slate-600">Error loading employees</p>
                        </div>
                    `;
                    document.getElementById('employeePageInfo').textContent = 'Page 0 of 0';
                    document.getElementById('employeePrevBtn').disabled = true;
                    document.getElementById('employeeNextBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error loading employee directory:', error);
                allEmployees = [];
                const grid = document.getElementById('employeeDirectoryGrid');
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <p class="text-slate-600">Error loading employees</p>
                    </div>
                `;
                document.getElementById('employeePageInfo').textContent = 'Page 0 of 0';
                document.getElementById('employeePrevBtn').disabled = true;
                document.getElementById('employeeNextBtn').disabled = true;
            }
        }

        // Load Create Sidebar Data (stats, upcoming, blackouts)
        async function loadCreateSidebarData() {
            try {
                // Load stats
                const statsResponse = await fetch('/api/vacation/stats');
                const statsData = await statsResponse.json();
                
                if (statsData.success && statsData.stats) {
                    // Update Quick Stats with real database values
                    const pendingEl = document.getElementById('createSidebarPending');
                    const approvedEl = document.getElementById('createSidebarApproved');
                    const daysUsedEl = document.getElementById('createSidebarDaysUsed');
                    
                    if (pendingEl) pendingEl.textContent = statsData.stats.pending || 0;
                    if (approvedEl) approvedEl.textContent = statsData.stats.approved_this_month || 0;
                    if (daysUsedEl) daysUsedEl.textContent = statsData.stats.days_used_ytd || 0;
                }
                
                // Load upcoming vacations (next 30 days)
                const upcomingResponse = await fetch('/api/vacation/upcoming');
                const upcomingData = await upcomingResponse.json();
                
                const upcomingContainer = document.getElementById('createSidebarUpcoming');
                if (upcomingContainer && upcomingData.success && upcomingData.vacations) {
                    if (upcomingData.vacations.length === 0) {
                        upcomingContainer.innerHTML = `
                            <div class="text-center py-8 text-slate-400">
                                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p class="text-sm">No upcoming leaves</p>
                            </div>
                        `;
                    } else {
                        // Limit to first 5 vacations
                        const displayVacations = upcomingData.vacations.slice(0, 5);
                        upcomingContainer.innerHTML = displayVacations.map(vac => {
                            const initials = `${vac.firstname?.[0] || ''}${vac.lastname?.[0] || ''}`.toUpperCase();
                            const fullName = `${vac.firstname || ''} ${vac.lastname || ''}`.trim();
                            
                            // Use parseLocalDate to avoid timezone issues
                            const startDate = parseLocalDate(vac.start_date);
                            const endDate = parseLocalDate(vac.end_date);
                            const dateRange = formatDateRange(startDate, endDate);
                            
                            return `
                                <div class="flex items-start gap-3 p-3 bg-gradient-to-r from-slate-50 to-white rounded-lg border border-slate-100 hover:shadow-md transition-shadow">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm flex-shrink-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        ${initials}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-slate-900 text-sm truncate">${fullName}</p>
                                        <p class="text-xs text-slate-600 mt-0.5">${dateRange}</p>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 mt-1">
                                            ${vac.leave_type || 'Vacation'}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else if (upcomingContainer) {
                    upcomingContainer.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-sm">Error loading upcoming leaves</p>
                        </div>
                    `;
                }
                
                // Load active blackout periods
                const blackoutResponse = await fetch('/api/vacation/blackout-periods');
                const blackoutData = await blackoutResponse.json();
                
                const blackoutContainer = document.getElementById('createSidebarBlackouts');
                if (blackoutContainer && blackoutData.success && blackoutData.periods) {
                    if (blackoutData.periods.length === 0) {
                        blackoutContainer.innerHTML = `
                            <div class="text-center py-8 text-slate-400">
                                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="text-sm">No active blackout periods</p>
                            </div>
                        `;
                    } else {
                        blackoutContainer.innerHTML = blackoutData.periods.map(period => {
                            const startDate = parseLocalDate(period.start_date);
                            const endDate = parseLocalDate(period.end_date);
                            const dateRange = formatDateRange(startDate, endDate);
                            
                            return `
                                <div class="p-3 bg-gradient-to-r from-red-50 to-orange-50 rounded-lg border-l-4 border-red-500">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
                                        </svg>
                                        <div class="flex-1">
                                            <p class="font-semibold text-slate-900 text-sm">${period.name || 'Blackout Period'}</p>
                                            <p class="text-xs text-slate-600 mt-0.5">${dateRange}</p>
                                            ${period.description ? `<p class="text-xs text-slate-500 mt-1">${period.description}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else if (blackoutContainer) {
                    blackoutContainer.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-sm">Error loading blackout periods</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading create sidebar data:', error);
                console.error('Error stack:', error.stack);
                
                // Show error states
                const upcomingContainer = document.getElementById('createSidebarUpcoming');
                const blackoutContainer = document.getElementById('createSidebarBlackouts');
                
                const errorHTML = `
                    <div class="text-center py-8 text-red-400">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <p class="text-sm">Error loading data</p>
                    </div>
                `;
                
                if (upcomingContainer) upcomingContainer.innerHTML = errorHTML;
                if (blackoutContainer) blackoutContainer.innerHTML = errorHTML;
            }
        }

        // Helper function to format date ranges
        // Load upcoming vacations (approved, next 30 days)
        async function loadUpcomingVacations() {
            try {
                const response = await fetch('/api/vacation/upcoming');
                const data = await response.json();
                
                if (data.success && data.vacations) {
                    // Store data in pagination state
                    paginationState.upcoming.allData = data.vacations;
                    paginationState.upcoming.currentPage = 1;
                    renderPaginatedData('upcoming');
                } else {
                    console.error('Failed to load upcoming vacations:', data.message);
                }
            } catch (error) {
                console.error('Error loading upcoming vacations:', error);
            }
        }

        // Render upcoming vacations in the UI
        function renderUpcomingVacations(vacations) {
            const container = document.getElementById('upcoming-content');
            if (!container) return;
            
            if (paginationState.upcoming.allData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-lg font-medium">No upcoming vacations</p>
                        <p class="text-sm">No approved vacation requests in the next 30 days</p>
                    </div>
                `;
                return;
            }
            
            // Helper function to get consistent color for employee
            const getEmployeeColor = (employeeName) => {
                const avatarColors = ['indigo', 'pink', 'teal', 'purple', 'blue', 'green', 'orange', 'red', 'yellow'];
                let hash = 0;
                for (let i = 0; i < employeeName.length; i++) {
                    hash = employeeName.charCodeAt(i) + ((hash << 5) - hash);
                }
                return avatarColors[Math.abs(hash) % avatarColors.length];
            };
            
            container.innerHTML = vacations.map(vac => {
                const initials = `${vac.firstname?.[0] || ''}${vac.lastname?.[0] || ''}`.toUpperCase();
                const fullName = `${vac.firstname || ''} ${vac.lastname || ''}`.trim();
                const color = getEmployeeColor(fullName);
                
                // Use parseLocalDate to avoid timezone issues
                const startDate = parseLocalDate(vac.start_date);
                const endDate = parseLocalDate(vac.end_date);
                const formattedStartDate = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formattedEndDate = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const leaveTypeDisplay = vac.leave_type.charAt(0).toUpperCase() + vac.leave_type.slice(1);
                
                return `
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors cursor-pointer gap-3">
                        <div class="flex items-center gap-4">
                            <div class="avatar bg-${color}-500 text-white">${initials}</div>
                            <div>
                                <div class="font-semibold text-slate-900">${fullName}</div>
                                <div class="text-sm text-slate-600">${vac.department || 'N/A'}  ${vac.role || 'Employee'}</div>
                            </div>
                        </div>
                        <div class="flex flex-col lg:flex-row items-start lg:items-center gap-3 lg:gap-6">
                            <div class="text-left lg:text-right">
                                <div class="text-sm font-medium text-slate-900">${formattedStartDate} - ${formattedEndDate}</div>
                                <div class="text-xs text-slate-500">${vac.duration_days || 0} days  ${leaveTypeDisplay}</div>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                <span class="status-indicator bg-green-500"></span>
                                Approved
                            </span>
                            <button onclick="viewVacationDetails(${vac.id})" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 w-full lg:w-auto">View Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load pending vacations
        async function loadPendingVacations() {
            const indicator = document.getElementById('pendingRefreshIndicator');
            
            try {
                // Show refresh indicator
                if (indicator) {
                    indicator.classList.remove('hidden');
                }
                
                console.log('Fetching pending vacations from API...');
                const response = await fetch('/api/vacation/pending');
                const data = await response.json();
                
                console.log('API response:', data);
                
                if (data.success && data.vacations) {
                    console.log('Pending vacations received:', data.vacations.length);
                    // Store data in pagination state
                    paginationState.pending.allData = data.vacations;
                    paginationState.pending.currentPage = 1;
                    renderPaginatedData('pending');
                } else {
                    console.error('Failed to load pending vacations:', data.message);
                    // Show empty state
                    const container = document.getElementById('pending-content');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center py-12 text-slate-500">
                                <p class="text-lg font-medium">Unable to load pending requests</p>
                                <p class="text-sm">${data.message || 'Please try again later'}</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading pending vacations:', error);
                // Show error state
                const container = document.getElementById('pending-content');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-slate-500">
                            <p class="text-lg font-medium">Error loading requests</p>
                            <p class="text-sm">${error.message}</p>
                        </div>
                    `;
                }
            } finally {
                // Hide refresh indicator after a brief moment
                setTimeout(() => {
                    if (indicator) {
                        indicator.classList.add('hidden');
                    }
                }, 500);
            }
        }

        // Auto-refresh for pending vacations
        let pendingVacationsRefreshInterval = null;
        let currentSection = 'overview'; // Track current section
        
        function startPendingVacationsAutoRefresh() {
            // Clear any existing interval
            if (pendingVacationsRefreshInterval) {
                clearInterval(pendingVacationsRefreshInterval);
            }
            
            // Refresh every 10 seconds (10000 ms)
            pendingVacationsRefreshInterval = setInterval(() => {
                // Only refresh if on the overview section
                if (currentSection === 'overview') {
                    loadPendingVacations();
                    // Also refresh stats to keep counts updated
                    loadVacationStats();
                }
            }, 10000);
            
            console.log('Auto-refresh started for pending vacations (10 seconds interval)');
        }
        
        function stopPendingVacationsAutoRefresh() {
            if (pendingVacationsRefreshInterval) {
                clearInterval(pendingVacationsRefreshInterval);
                pendingVacationsRefreshInterval = null;
                console.log('Auto-refresh stopped for pending vacations');
            }
        }

        // Render pending vacations in the UI
        function renderPendingVacations(vacations) {
            const container = document.getElementById('pending-content');
            if (!container) {
                console.error('pending-content container not found');
                return;
            }
            
            // Validate vacations is an array
            if (!vacations || !Array.isArray(vacations) || vacations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-lg font-medium">All caught up!</p>
                        <p class="text-sm">No vacation requests pending approval</p>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering pending vacations:', vacations.length);
            
            container.innerHTML = vacations.map(vac => {
                const initials = `${vac.firstname?.[0] || ''}${vac.lastname?.[0] || ''}`.toUpperCase();
                const fullName = `${vac.firstname || ''} ${vac.lastname || ''}`.trim();
                const colors = ['blue', 'purple', 'teal', 'indigo'];
                const color = colors[vac.id % colors.length];
                // Use parseLocalDate to avoid timezone issues
                const startDate = parseLocalDate(vac.start_date);
                const endDate = parseLocalDate(vac.end_date);
                const formattedStartDate = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formattedEndDate = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const leaveTypeDisplay = vac.leave_type.charAt(0).toUpperCase() + vac.leave_type.slice(1);
                const timeAgo = getTimeAgo(parseLocalDateTime(vac.created_at));
                
                return `
                    <div class="border-2 border-yellow-200 bg-yellow-50 rounded-lg p-4 lg:p-5">
                        <div class="flex flex-col lg:flex-row lg:items-start justify-between mb-4 gap-3">
                            <div class="flex items-center gap-4">
                                <div class="avatar bg-${color}-500 text-white">${initials}</div>
                                <div>
                                    <div class="font-semibold text-slate-900">${fullName}</div>
                                    <div class="text-sm text-slate-600">${vac.department || 'N/A'}  ${vac.role || 'Employee'}</div>
                                    <div class="text-xs text-slate-500 mt-1">Submitted ${timeAgo}</div>
                                </div>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">
                                <span class="status-indicator bg-yellow-500"></span>
                                Pending Review
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4 text-sm">
                            <div>
                                <div class="text-slate-600 mb-1">Dates Requested</div>
                                <div class="font-semibold text-slate-900">${formattedStartDate} - ${formattedEndDate}</div>
                            </div>
                            <div>
                                <div class="text-slate-600 mb-1">Duration</div>
                                <div class="font-semibold text-slate-900">${vac.duration_days || 0} days</div>
                            </div>
                            <div>
                                <div class="text-slate-600 mb-1">Type</div>
                                <div class="font-semibold text-slate-900">${leaveTypeDisplay}</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg p-3 mb-4">
                            <div class="text-xs font-semibold text-slate-600 mb-1">REASON</div>
                            <div class="text-sm text-slate-700">${vac.reason || 'No reason provided'}</div>
                        </div>

                        <div class="flex flex-col lg:flex-row items-stretch lg:items-center gap-3 mb-4">
                            <div class="flex-1 bg-white rounded-lg p-3">
                                <div class="text-xs font-semibold text-slate-600 mb-1">COVERAGE</div>
                                <div class="text-sm font-bold ${vac.coverage_plan ? 'text-green-600' : 'text-yellow-600'}">${vac.coverage_plan ? ' Provided' : ' Not provided'}</div>
                            </div>
                            <div class="flex-1 bg-white rounded-lg p-3">
                                <div class="text-xs font-semibold text-slate-600 mb-1">CONTACTS</div>
                                <div class="text-sm font-bold text-slate-900">${(vac.emergency_phone || vac.emergency_email) ? ' Provided' : 'None'}</div>
                            </div>
                        </div>

                        <div class="flex flex-col lg:flex-row gap-3">
                            <button class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700" onclick="approveVacationRequest(${vac.id}, '${fullName}')">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Approve
                            </button>
                            <button class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700" onclick="denyVacationRequest(${vac.id}, '${fullName}')">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                Deny
                            </button>
                            <button onclick="viewVacationDetails(${vac.id})" class="px-4 py-2 text-slate-700 bg-white border border-slate-300 rounded-lg font-medium hover:bg-slate-50">More Info</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load recent vacations
        async function loadRecentVacations() {
            try {
                const response = await fetch('/api/vacation/recent');
                const data = await response.json();
                
                if (data.success && data.vacations) {
                    // Store data in pagination state
                    paginationState.recent.allData = data.vacations;
                    paginationState.recent.currentPage = 1;
                    renderPaginatedData('recent');
                } else {
                    console.error('Failed to load recent vacations:', data.message);
                }
            } catch (error) {
                console.error('Error loading recent vacations:', error);
            }
        }

        // Render recent vacations
        function renderRecentVacations(vacations) {
            const container = document.getElementById('recent-content');
            if (!container) return;
            
            if (paginationState.recent.allData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-lg font-medium">No recent activity</p>
                        <p class="text-sm">No vacation requests processed in the last 30 days</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = vacations.map(vac => {
                const initials = `${vac.firstname?.[0] || ''}${vac.lastname?.[0] || ''}`.toUpperCase();
                const fullName = `${vac.firstname || ''} ${vac.lastname || ''}`.trim();
                const isApproved = vac.status === 'approved';
                const statusClass = isApproved ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const statusIndicator = isApproved ? 'bg-green-500' : 'bg-red-500';
                const statusText = isApproved ? 'Approved' : 'Denied';
                const formattedDate = parseLocalDateTime(vac.decided_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                return `
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between p-4 bg-slate-50 rounded-lg gap-3">
                        <div class="flex items-center gap-4">
                            <div class="avatar bg-indigo-500 text-white">${initials}</div>
                            <div>
                                <div class="font-semibold text-slate-900">${fullName}</div>
                                <div class="text-sm text-slate-600">${vac.department || 'N/A'}</div>
                                <div class="text-xs text-slate-500 mt-1">Decided on ${formattedDate}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                <span class="status-indicator ${statusIndicator}"></span>
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Approve vacation request
        async function approveVacationRequest(vacationId, employeeName) {
            const confirmed = await showConfirmation(
                'Approve Vacation Request', 
                `Are you sure you want to approve the vacation request for ${employeeName}?`,
                'Approve',
                'Cancel'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`/api/vacation/${vacationId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: 'Approved by supervisor' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Request approved for ${employeeName}`, 'success');
                    // Reload data
                    loadVacationStats();
                    loadPendingVacations();
                    loadUpcomingVacations();
                    loadRecentVacations();
                } else {
                    showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error approving vacation:', error);
                showToast('Error approving request. Please try again.', 'error');
            }
        }

        // Deny vacation request
        async function denyVacationRequest(vacationId, employeeName) {
            const reason = await showInputDialog(
                'Deny Vacation Request',
                `Please enter the reason for denying ${employeeName}'s vacation request:`,
                'Enter denial reason...',
                true
            );
            
            if (!reason) {
                return; // User cancelled or didn't provide input
            }
            
            try {
                const response = await fetch(`/api/vacation/${vacationId}/deny`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Request denied for ${employeeName}`, 'success');
                    // Reload data
                    loadVacationStats();
                    loadPendingVacations();
                    loadRecentVacations();
                } else {
                    showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error denying vacation:', error);
                showToast('Error denying request. Please try again.', 'error');
            }
        }

        // View vacation details (placeholder)
        async function viewVacationDetails(vacationId) {
            try {
                const modal = document.getElementById('vacationDetailsModal');
                const content = document.getElementById('vacationDetailsContent');
                
                // Show modal with loading state
                modal.classList.remove('hidden');
                modal.classList.add('modal-backdrop');
                modal.querySelector('.bg-white').classList.add('modal-content');
                
                content.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                `;
                
                // Fetch vacation details
                const response = await fetch(`/api/vacation/${vacationId}`);
                const data = await response.json();
                
                if (data.success && data.vacation) {
                    const vac = data.vacation;
                    
                    // Format dates using parseLocalDate to avoid timezone issues
                    const startDate = parseLocalDate(vac.start_date);
                    const endDate = parseLocalDate(vac.end_date);
                    const createdDate = parseLocalDateTime(vac.created_at);
                    
                    const formatDate = (date) => {
                        return date.toLocaleDateString('en-US', { 
                            weekday: 'short', 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    };
                    
                    const formatDateTime = (date) => {
                        return date.toLocaleString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };
                    
                    // Status badge color
                    let statusClass = 'bg-gray-100 text-gray-700';
                    if (vac.status === 'approved') statusClass = 'bg-green-100 text-green-700';
                    else if (vac.status === 'denied') statusClass = 'bg-red-100 text-red-700';
                    else if (vac.status === 'pending') statusClass = 'bg-yellow-100 text-yellow-700';
                    
                    // Capitalize leave type for display
                    const leaveTypeDisplay = vac.leave_type 
                        ? vac.leave_type.charAt(0).toUpperCase() + vac.leave_type.slice(1) 
                        : 'N/A';
                    
                    // Build the content
                    content.innerHTML = `
                        <!-- Employee Info -->
                        <div class="bg-slate-50 rounded-lg p-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-lg font-semibold">
                                    ${vac.firstname.charAt(0)}${vac.lastname.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-slate-900">${vac.firstname} ${vac.lastname}</h4>
                                    <p class="text-sm text-slate-600">${vac.department || 'N/A'}  ${vac.role || 'Employee'}</p>
                                    ${vac.email ? `<p class="text-sm text-slate-500">${vac.email}</p>` : ''}
                                </div>
                                <span class="ml-auto inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                    ${vac.status.charAt(0).toUpperCase() + vac.status.slice(1)}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Vacation Details -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <h5 class="font-semibold text-slate-700">Start Date</h5>
                                </div>
                                <p class="text-slate-900">${formatDate(startDate)}</p>
                            </div>
                            
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <h5 class="font-semibold text-slate-700">End Date</h5>
                                </div>
                                <p class="text-slate-900">${formatDate(endDate)}</p>
                            </div>
                            
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <h5 class="font-semibold text-slate-700">Duration</h5>
                                </div>
                                <p class="text-slate-900">${vac.duration_days || 0} day${vac.duration_days !== 1 ? 's' : ''}</p>
                            </div>
                            
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                    </svg>
                                    <h5 class="font-semibold text-slate-700">Leave Type</h5>
                                </div>
                                <p class="text-slate-900">${leaveTypeDisplay}</p>
                            </div>
                        </div>
                        
                        ${vac.reason ? `
                        <div class="border border-slate-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <h5 class="font-semibold text-slate-700">Reason</h5>
                            </div>
                            <p class="text-slate-600">${vac.reason}</p>
                        </div>
                        ` : ''}
                        
                        <!-- Timeline -->
                        <div class="border-t pt-4 mt-4">
                            <h5 class="font-semibold text-slate-700 mb-3">Timeline</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center gap-2 text-slate-600">
                                    <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                    <span class="font-medium">Requested:</span>
                                    <span>${formatDateTime(createdDate)}</span>
                                </div>
                                
                                ${vac.decided_at ? `
                                <div class="flex items-center gap-2 text-slate-600">
                                    <span class="w-2 h-2 rounded-full ${vac.status === 'approved' ? 'bg-green-500' : 'bg-red-500'}"></span>
                                    <span class="font-medium">${vac.status === 'approved' ? 'Approved' : 'Denied'}:</span>
                                    <span>${formatDateTime(parseLocalDateTime(vac.decided_at))}</span>
                                    ${vac.approved_by_username ? `<span class="ml-1 text-slate-500">by ${vac.approved_by_username}</span>` : ''}
                                </div>
                                ` : ''}
                                
                                ${vac.decision_reason ? `
                                <div class="ml-4 pl-4 border-l-2 border-slate-200 text-slate-600">
                                    <span class="font-medium">Decision Note:</span> ${vac.decision_reason}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex justify-end pt-4 border-t">
                            <button type="button" onclick="closeVacationDetailsModal()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
                                Close
                            </button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 mx-auto text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-slate-600">${data.message || 'Failed to load vacation details'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading vacation details:', error);
                const content = document.getElementById('vacationDetailsContent');
                content.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 mx-auto text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <p class="text-slate-600">Error loading vacation details</p>
                    </div>
                `;
            }
        }
        
        // Close vacation details modal
        function closeVacationDetailsModal() {
            const modal = document.getElementById('vacationDetailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('modal-backdrop');
        }

        // Edit vacation request
        async function editVacationRequest(vacationId) {
            try {
                const modal = document.getElementById('editRequestModal');
                const form = document.getElementById('editRequestForm');
                
                // Show modal
                modal.classList.remove('hidden');
                
                // Fetch vacation details
                const response = await fetch(`/api/vacation/${vacationId}`);
                const data = await response.json();
                
                if (data.success && data.vacation) {
                    const vac = data.vacation;
                    
                    // Set form values
                    document.getElementById('editRequestId').value = vac.id;
                    document.getElementById('editStartDate').value = vac.start_date;
                    document.getElementById('editEndDate').value = vac.end_date;
                    document.getElementById('editLeaveType').value = vac.leave_type || 'vacation';
                    document.getElementById('editReason').value = vac.reason || '';
                    
                    // Set employee info
                    const initials = `${vac.firstname.charAt(0)}${vac.lastname.charAt(0)}`;
                    document.getElementById('editEmployeeAvatar').textContent = initials;
                    document.getElementById('editEmployeeName').textContent = `${vac.firstname} ${vac.lastname}`;
                    document.getElementById('editEmployeeDept').textContent = `${vac.department || 'N/A'}  ${vac.role || 'Employee'}`;
                    
                    // Calculate and display duration
                    calculateEditDuration();
                    
                    // Hide any previous errors
                    document.getElementById('editRequestError').classList.add('hidden');
                } else {
                    showEditRequestError(data.message || 'Failed to load vacation details');
                }
            } catch (error) {
                console.error('Error loading vacation for edit:', error);
                showEditRequestError('Error loading vacation details');
            }
        }
        
        // Close edit request modal
        function closeEditRequestModal() {
            const modal = document.getElementById('editRequestModal');
            modal.classList.add('hidden');
            
            // Reset form
            document.getElementById('editRequestForm').reset();
            
            // Hide all warnings
            document.getElementById('editRequestError').classList.add('hidden');
            document.getElementById('editStartDatePastWarning').classList.add('hidden');
            document.getElementById('editStartDateWeekendWarning').classList.add('hidden');
            document.getElementById('editEndDatePastWarning').classList.add('hidden');
            document.getElementById('editEndDateWeekendWarning').classList.add('hidden');
            document.getElementById('editEndDateBeforeStartWarning').classList.add('hidden');
            document.getElementById('editAutoReturnWarning').classList.add('hidden');
            document.getElementById('editAutoReturnManualChange').classList.add('hidden');
        }
        
        // Store the auto-calculated return date for comparison
        let autoCalculatedReturnDate = null;
        
        // Calculate duration for edit form
        function calculateEditDuration() {
            const startDateValue = document.getElementById('editStartDate').value;
            const endDateValue = document.getElementById('editEndDate').value;
            
            // Hide all warnings initially
            document.getElementById('editStartDatePastWarning').classList.add('hidden');
            document.getElementById('editStartDateWeekendWarning').classList.add('hidden');
            document.getElementById('editEndDatePastWarning').classList.add('hidden');
            document.getElementById('editEndDateWeekendWarning').classList.add('hidden');
            document.getElementById('editEndDateBeforeStartWarning').classList.add('hidden');
            document.getElementById('editAutoReturnWarning').classList.add('hidden');
            
            if (!startDateValue || !endDateValue) {
                document.getElementById('editDurationDisplay').textContent = '0 days';
                document.getElementById('editAutoReturnDate').value = '';
                return;
            }
            
            const startDate = new Date(startDateValue + 'T00:00:00');
            const endDate = new Date(endDateValue + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Validate: End date before start date
            if (endDate < startDate) {
                document.getElementById('editDurationDisplay').textContent = 'Invalid range';
                document.getElementById('editEndDateBeforeStartWarning').classList.remove('hidden');
                document.getElementById('editAutoReturnDate').value = '';
                return;
            }
            
            // Check if start date is in the past
            if (startDate < today) {
                document.getElementById('editStartDatePastWarning').classList.remove('hidden');
            }
            
            // Check if end date is in the past
            if (endDate < today) {
                document.getElementById('editEndDatePastWarning').classList.remove('hidden');
            }
            
            // Check if start date is a weekend
            const startDay = startDate.getDay();
            if (startDay === 0 || startDay === 6) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                document.getElementById('editStartDateWeekendDay').textContent = dayNames[startDay];
                document.getElementById('editStartDateWeekendWarning').classList.remove('hidden');
            }
            
            // Check if end date is a weekend
            const endDay = endDate.getDay();
            if (endDay === 0 || endDay === 6) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                document.getElementById('editEndDateWeekendDay').textContent = dayNames[endDay];
                document.getElementById('editEndDateWeekendWarning').classList.remove('hidden');
            }
            
            // Calculate business days (INCLUSIVE - both start and end dates count)
            let count = 0;
            const current = new Date(startDate);
            while (current <= endDate) {
                const day = current.getDay();
                if (day !== 0 && day !== 6) { // Skip weekends
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            document.getElementById('editDurationDisplay').textContent = `${count} day${count !== 1 ? 's' : ''}`;
            
            // Calculate auto return date (first working day after vacation ends)
            const autoReturnDate = new Date(endDate);
            autoReturnDate.setDate(autoReturnDate.getDate() + 1);
            
            // Skip weekends for auto return date
            while (autoReturnDate.getDay() === 0 || autoReturnDate.getDay() === 6) {
                autoReturnDate.setDate(autoReturnDate.getDate() + 1);
            }
            
            // Format auto return date as YYYY-MM-DD
            const year = autoReturnDate.getFullYear();
            const month = String(autoReturnDate.getMonth() + 1).padStart(2, '0');
            const day = String(autoReturnDate.getDate()).padStart(2, '0');
            const autoReturnDateString = `${year}-${month}-${day}`;
            
            // Store the auto-calculated value for comparison
            autoCalculatedReturnDate = autoReturnDateString;
            
            document.getElementById('editAutoReturnDate').value = autoReturnDateString;
            
            // Hide manual change warning when auto-calculating
            document.getElementById('editAutoReturnManualChange').classList.add('hidden');
            
            // Show info about auto return date if it's different from end date + 1
            const nextDay = new Date(endDate);
            nextDay.setDate(nextDay.getDate() + 1);
            
            if (autoReturnDate.getTime() !== nextDay.getTime()) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                document.getElementById('editAutoReturnWarningText').textContent = 
                    `Return date adjusted to ${dayNames[autoReturnDate.getDay()]} (skipping weekend)`;
                document.getElementById('editAutoReturnWarning').classList.remove('hidden');
            }
        }
        
        // Check if auto return date was manually changed
        function checkAutoReturnManualChange() {
            const currentValue = document.getElementById('editAutoReturnDate').value;
            
            // Only show warning if we have an auto-calculated value and it differs from current
            if (autoCalculatedReturnDate && currentValue && currentValue !== autoCalculatedReturnDate) {
                // Format dates for display
                const autoDate = new Date(autoCalculatedReturnDate + 'T00:00:00');
                const manualDate = new Date(currentValue + 'T00:00:00');
                
                const formatDateForDisplay = (date) => {
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                };
                
                document.getElementById('editAutoReturnOriginalDate').textContent = formatDateForDisplay(autoDate);
                document.getElementById('editAutoReturnNewDate').textContent = formatDateForDisplay(manualDate);
                document.getElementById('editAutoReturnManualChange').classList.remove('hidden');
            } else {
                document.getElementById('editAutoReturnManualChange').classList.add('hidden');
            }
        }
        
        // Show edit request error
        function showEditRequestError(message) {
            const errorDiv = document.getElementById('editRequestError');
            const errorText = document.getElementById('editRequestErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Scroll to error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Handle edit request form submission
        document.getElementById('editRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('editRequestSubmitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <div class="flex items-center justify-center gap-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        <span>Saving...</span>
                    </div>
                `;
                
                const vacationId = document.getElementById('editRequestId').value;
                const startDate = document.getElementById('editStartDate').value;
                const endDate = document.getElementById('editEndDate').value;
                const autoReturnDate = document.getElementById('editAutoReturnDate').value;
                const leaveType = document.getElementById('editLeaveType').value;
                const reason = document.getElementById('editReason').value;
                
                // Validate dates
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');
                
                if (end < start) {
                    showEditRequestError('End date must be after or equal to start date');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                // Validate auto return date
                if (!autoReturnDate) {
                    showEditRequestError('Auto return date is required');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                // Calculate working days (excluding weekends and blackout periods)
                const durationData = calculateWorkingDays(parseLocalDate(startDate), parseLocalDate(endDate));
                const calculatedDays = durationData.workingDays;
                
                console.log('Duration calculation for edit:', {
                    start: startDate,
                    end: endDate,
                    workingDays: calculatedDays,
                    weekendDays: durationData.weekendDays,
                    blackoutDays: durationData.blackoutDays
                });
                
                // Ensure we have at least 1 day
                const finalDays = calculatedDays > 0 ? calculatedDays : 1;
                
                // Submit the update
                const response = await fetch(`/api/vacation/${vacationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        auto_return_date: autoReturnDate,
                        duration_days: finalDays,
                        leave_type: leaveType,
                        reason: reason
                    })
                });
                
                console.log('Edit request payload:', {
                    start_date: startDate,
                    end_date: endDate,
                    duration_days: finalDays
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    showToast('Vacation request updated successfully!', 'success');
                    
                    // Close modal
                    closeEditRequestModal();
                    
                    // Reload the requests table
                    await loadVacationRequests();
                    
                    // Reload dashboard stats if on overview
                    if (currentSection === 'overview') {
                        await loadDashboardData();
                        // Also refresh pending requests to show updated data
                        await loadPendingVacations();
                    }
                } else {
                    showEditRequestError(data.message || 'Failed to update vacation request');
                }
            } catch (error) {
                console.error('Error updating vacation request:', error);
                showEditRequestError('An error occurred while updating the request');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // Add event listeners for date changes in edit form
        document.getElementById('editStartDate').addEventListener('change', calculateEditDuration);
        document.getElementById('editEndDate').addEventListener('change', calculateEditDuration);
        
        // Add event listener for manual changes to auto return date
        document.getElementById('editAutoReturnDate').addEventListener('change', checkAutoReturnManualChange);
        
        // Close vacation details modal
        function closeVacationDetailsModal() {
            const modal = document.getElementById('vacationDetailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('modal-backdrop');
        }

        // Helper function to calculate time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // difference in seconds
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 2592000) return `${Math.floor(diff / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        // ==================== NOTIFICATION SYSTEM ====================

        let notificationsOpen = false;
        let browserNotificationsEnabled = false;

        // Request browser notification permission on page load
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    browserNotificationsEnabled = permission === 'granted';
                    if (browserNotificationsEnabled) {
                        console.log('Browser notifications enabled');
                    }
                } catch (error) {
                    console.error('Error requesting notification permission:', error);
                }
            } else if (Notification.permission === 'granted') {
                browserNotificationsEnabled = true;
            }
        }

        // Show browser notification
        function showBrowserNotification(title, body, icon = null) {
            if (browserNotificationsEnabled && 'Notification' in window) {
                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: icon || '/static/favicon.ico',
                        badge: '/static/favicon.ico',
                        tag: 'vacation-notification',
                        requireInteraction: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        toggleNotifications();
                        notification.close();
                    };
                } catch (error) {
                    console.error('Error showing browser notification:', error);
                }
            }
        }

        // Toggle notification dropdown
        function toggleNotifications() {
            notificationsOpen = !notificationsOpen;
            const dropdown = document.getElementById('notificationDropdown');
            
            if (notificationsOpen) {
                dropdown.classList.remove('hidden');
                loadNotifications();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Close notifications when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notificationDropdown');
            const bell = document.getElementById('notificationBell');
            
            if (notificationsOpen && !dropdown.contains(event.target) && !bell.contains(event.target)) {
                toggleNotifications();
            }
        });

        // Load notifications from API
        async function loadNotifications() {
            try {
                const response = await fetch('/api/vacation/notifications?limit=20');
                const data = await response.json();
                
                if (data.success) {
                    displayNotifications(data.notifications);
                    updateNotificationBadge(data.unreadCount);
                } else {
                    console.error('Failed to load notifications:', data.message);
                    document.getElementById('notificationsList').innerHTML = `
                        <div class="p-4 text-center text-slate-500">
                            <p class="text-red-600 font-medium">Error loading notifications</p>
                            <p class="text-sm mt-1">${data.message || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notificationsList').innerHTML = `
                    <div class="p-4 text-center text-slate-500">
                        <p class="text-red-600 font-medium">Failed to connect</p>
                        <p class="text-sm mt-1">Please check your connection and try again</p>
                    </div>
                `;
            }
        }

        // Display notifications in dropdown
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <p class="font-medium">No notifications</p>
                        <p class="text-sm mt-1">You're all caught up!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="divide-y divide-slate-100">';
            
            notifications.forEach(notif => {
                const isUnread = !notif.isRead;
                const bgClass = isUnread ? 'bg-blue-50' : 'bg-white';
                const icon = getNotificationIcon(notif.type);
                const iconColor = getNotificationIconColor(notif.type);
                const createdDate = new Date(notif.createdAt);
                const timeAgo = getTimeAgo(createdDate);
                
                // Show employee name if available (for admin/supervisor view)
                const employeeLabel = notif.employeeName ? 
                    `<span class="text-xs text-slate-500 font-medium"> ${notif.employeeName}</span>` : '';
                
                html += `
                    <div class="${bgClass} p-3 lg:p-4 hover:bg-slate-50 transition-colors relative group">
                        <div class="flex gap-2 lg:gap-3">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 lg:w-10 lg:h-10 rounded-full ${iconColor} flex items-center justify-center">
                                    ${icon}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-2 mb-1">
                                    <h4 class="font-semibold text-slate-900 text-xs lg:text-sm">${notif.title}</h4>
                                    ${isUnread ? '<span class="w-2 h-2 bg-blue-600 rounded-full flex-shrink-0 mt-1"></span>' : ''}
                                </div>
                                <p class="text-xs lg:text-sm text-slate-600 mb-2">${notif.message}</p>
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-slate-500">${timeAgo}</span>
                                        ${employeeLabel}
                                    </div>
                                    <div class="flex gap-2">
                                        ${isUnread ? `<button onclick="event.stopPropagation(); markNotificationRead(${notif.id})" class="text-xs text-blue-600 hover:text-blue-700 font-medium whitespace-nowrap">Mark read</button>` : ''}
                                        <button onclick="event.stopPropagation(); deleteNotification(${notif.id})" class="text-xs text-red-600 hover:text-red-700 font-medium whitespace-nowrap">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Get notification icon based on type
        function getNotificationIcon(type) {
            switch(type) {
                case 'vacation_approved':
                    return `<svg class="w-4 h-4 lg:w-5 lg:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>`;
                case 'vacation_denied':
                    return `<svg class="w-4 h-4 lg:w-5 lg:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>`;
                case 'vacation_upcoming':
                    return `<svg class="w-4 h-4 lg:w-5 lg:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>`;
                default:
                    return `<svg class="w-4 h-4 lg:w-5 lg:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>`;
            }
        }

        // Get notification icon color based on type
        function getNotificationIconColor(type) {
            switch(type) {
                case 'vacation_approved':
                    return 'bg-green-500';
                case 'vacation_denied':
                    return 'bg-red-500';
                case 'vacation_upcoming':
                    return 'bg-blue-500';
                default:
                    return 'bg-slate-500';
            }
        }

        // Update notification badge
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch(`/api/vacation/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    loadNotifications(); // Reload to update UI
                } else {
                    showToast(data.message || 'Failed to mark notification as read', 'error');
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showToast('Failed to mark notification as read', 'error');
            }
        }

        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/api/vacation/notifications/mark-all-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    loadNotifications(); // Reload to update UI
                    showToast('All notifications marked as read', 'success');
                } else {
                    showToast(data.message || 'Failed to mark all notifications as read', 'error');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showToast('Failed to mark all notifications as read', 'error');
            }
        }

        // Delete notification
        async function deleteNotification(notificationId) {
            try {
                const response = await fetch(`/api/vacation/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    loadNotifications(); // Reload to update UI
                    showToast('Notification deleted', 'success');
                } else {
                    showToast(data.message || 'Failed to delete notification', 'error');
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                showToast('Failed to delete notification', 'error');
            }
        }

        // Poll for new notifications every 30 seconds
        let notificationPollInterval;
        function startNotificationPolling() {
            // Initial load
            loadNotifications();
            
            // Poll every 30 seconds
            notificationPollInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/vacation/notifications?limit=1&unread_only=true');
                    const data = await response.json();
                    
                    if (data.success) {
                        // Update badge
                        updateNotificationBadge(data.unreadCount);
                        
                        // If there are new unread notifications and dropdown is open, refresh it
                        if (notificationsOpen && data.unreadCount > 0) {
                            loadNotifications();
                        }
                        
                        // Show browser notification for newest unread notification
                        if (data.notifications && data.notifications.length > 0 && !data.notifications[0].isRead) {
                            const newestNotif = data.notifications[0];
                            showBrowserNotification(newestNotif.title, newestNotif.message);
                        }
                    }
                } catch (error) {
                    console.error('Error polling notifications:', error);
                }
            }, 30000); // 30 seconds
        }

        // Stop notification polling
        function stopNotificationPolling() {
            if (notificationPollInterval) {
                clearInterval(notificationPollInterval);
            }
        }

        // Initialize notifications on page load
        document.addEventListener('DOMContentLoaded', function() {
            requestNotificationPermission();
            startNotificationPolling();
            startPendingVacationsAutoRefresh();
            initGlobalSearch();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            stopNotificationPolling();
            stopPendingVacationsAutoRefresh();
        });

        // User Dropdown Toggle
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenuButton = document.getElementById('userMenuButton');
            const dropdown = document.getElementById('userDropdownMenu');
            
            if (userMenuButton && dropdown && !userMenuButton.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Profile Modal Functions
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            const dropdown = document.getElementById('userDropdownMenu');
            
            // Close dropdown
            dropdown.classList.add('hidden');
            
            // Open modal
            modal.classList.remove('hidden');
            
            // Reset form
            document.getElementById('changePasswordForm').reset();
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordSuccess').classList.add('hidden');
            
            // Load profile data
            loadProfileData();
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('hidden');
        }

        // Load Profile Data
        async function loadProfileData() {
            const detailsContainer = document.getElementById('employeeDetails');
            
            try {
                const response = await fetch('/api/my-profile');
                const data = await response.json();
                
                if (data.success && data.profile) {
                    const profile = data.profile;
                    
                    // Build employee details HTML
                    let detailsHTML = '';
                    
                    // Personal Information
                    if (profile.phonenumber) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Phone Number</div>
                                <div class="text-sm font-medium text-slate-900">${profile.phonenumber}</div>
                            </div>
                        `;
                    }
                    
                    // Employment Details
                    if (profile.department) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Department</div>
                                <div class="text-sm font-medium text-slate-900">${profile.department}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.shift) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Shift</div>
                                <div class="text-sm font-medium text-slate-900">${profile.shift}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.workline) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Work Line</div>
                                <div class="text-sm font-medium text-slate-900">${profile.workline}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.workarea) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Work Area</div>
                                <div class="text-sm font-medium text-slate-900">${profile.workarea}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.employee_role) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Position</div>
                                <div class="text-sm font-medium text-slate-900">${profile.employee_role}</div>
                            </div>
                        `;
                    }
                    
                    // Management
                    if (profile.supervisor) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Supervisor</div>
                                <div class="text-sm font-medium text-slate-900">${profile.supervisor}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.manager) {
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Manager</div>
                                <div class="text-sm font-medium text-slate-900">${profile.manager}</div>
                            </div>
                        `;
                    }
                    
                    // Employment Duration
                    if (profile.date_of_employment) {
                        const empDate = new Date(profile.date_of_employment);
                        const formattedDate = empDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Employment Date</div>
                                <div class="text-sm font-medium text-slate-900">${formattedDate}</div>
                            </div>
                        `;
                    }
                    
                    if (profile.years_of_employment !== null && profile.years_of_employment !== undefined) {
                        const years = profile.years_of_employment;
                        const months = profile.months_of_employment || 0;
                        let durationText = '';
                        if (years > 0) {
                            durationText = `${years} ${years === 1 ? 'year' : 'years'}`;
                            if (months > 0) {
                                durationText += `, ${months} ${months === 1 ? 'month' : 'months'}`;
                            }
                        } else if (months > 0) {
                            durationText = `${months} ${months === 1 ? 'month' : 'months'}`;
                        } else {
                            durationText = 'Less than 1 month';
                        }
                        
                        detailsHTML += `
                            <div class="bg-white rounded-lg p-3 border border-blue-100">
                                <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Time with Company</div>
                                <div class="text-sm font-medium text-slate-900">${durationText}</div>
                            </div>
                        `;
                    }
                    
                    // Update the container
                    detailsContainer.innerHTML = detailsHTML || '<p class="text-sm text-slate-500 col-span-2 text-center py-4">No additional employee information available</p>';
                } else {
                    detailsContainer.innerHTML = '<p class="text-sm text-red-500 col-span-2 text-center py-4">Error loading profile information</p>';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                detailsContainer.innerHTML = '<p class="text-sm text-red-500 col-span-2 text-center py-4">Error loading profile information</p>';
            }
        }

        // Close modal when clicking outside
        document.getElementById('profileModal')?.addEventListener('click', function(event) {
            if (event.target === this) {
                closeProfileModal();
            }
        });

        // Handle Password Change
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const errorDiv = document.getElementById('passwordError');
            const errorMessage = document.getElementById('passwordErrorMessage');
            const successDiv = document.getElementById('passwordSuccess');
            const submitBtn = document.getElementById('changePasswordBtn');
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'New passwords do not match.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 8) {
                errorMessage.textContent = 'Password must be at least 8 characters long.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Validate new password is different from current
            if (currentPassword === newPassword) {
                errorMessage.textContent = 'New password must be different from current password.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.textContent = 'Changing Password...';
                
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    successDiv.classList.remove('hidden');
                    
                    // Reset form
                    document.getElementById('changePasswordForm').reset();
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeProfileModal();
                        showToast('Password changed successfully!', 'success');
                    }, 2000);
                } else {
                    errorMessage.textContent = data.message || 'Failed to change password. Please try again.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                errorMessage.textContent = 'An error occurred. Please try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Change Password';
            }
        }

        // Handle Logout
        async function handleLogout() {
            // Show logout modal
            const logoutModal = document.getElementById('logoutModal');
            logoutModal.classList.add('active');
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    // Wait a bit for user to see the message, then redirect
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    logoutModal.classList.remove('active');
                    showToast('Error logging out. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                logoutModal.classList.remove('active');
                showToast('Error logging out. Please try again.', 'error');
            }
        }
    </script>

    <!-- Logout Modal -->
    <div id="logoutModal" class="logout-modal-overlay">
        <div class="logout-modal">
            <h2>Logging You Out</h2>
            <p>Bye! See you again soon.</p>
            <div class="logout-spinner"></div>
            <div class="logout-dots">
                <div class="logout-dot"></div>
                <div class="logout-dot"></div>
                <div class="logout-dot"></div>
            </div>
        </div>
    </div>
</body>
</html>