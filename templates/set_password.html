<!--
  Professional password reset form using Tailwind CSS.
  This template is designed to integrate seamlessly with the existing
  application while preserving the IDs of the original fields (email,
  old_password, new_password, confirm_password). The form features:
  - A back arrow linking to the home page.
  - Error messages displayed from Flask's flash system.
  - Fields for email (if the user's email isn't already known), old password,
    new password, and password confirmation.
  - A real‚Äëtime password strength meter and requirement checklist.
  - A mandatory agreement to Terms of Service and Privacy Policy.
  - Links for already registered users to sign in.
  - Password visibility toggles for each password field.
-->
<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create or Reset Password</title>
  <!-- Include Tailwind CSS compiled output -->
  <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet" />
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <!-- Custom styles for enhanced password reset functionality -->
  <style>
    /* Enhanced transitions for password visibility toggles */
    .password-toggle {
      transition: all 0.2s ease-in-out;
    }
    
    .password-toggle:hover {
      transform: scale(1.1);
    }
    
    /* Smooth animations for password strength indicators */
    .criterion-item {
      transition: all 0.3s ease-in-out;
    }
    
    .criterion-item.valid {
      transform: translateX(2px);
    }
    
    /* Enhanced strength bar animations */
    #passwordStrengthBar {
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                  background-color 0.3s ease-in-out;
    }
    
    /* Input focus enhancements */
    .password-input:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }
    
    /* Enhanced button hover effects */
    .btn-primary {
      transition: all 0.3s ease-in-out;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    /* Pulse animation for critical elements */
    @keyframes pulse-gentle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .pulse-gentle {
      animation: pulse-gentle 2s infinite;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-gray-100 font-sans">
  <!-- Subtle background pattern -->
  <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.05"%3E%3Ccircle cx="30" cy="30" r="4"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] opacity-40"></div>

  <!-- Header with back arrow -->
  <header class="relative z-10 p-6">
    <div class="max-w-7xl mx-auto flex items-center">
      <a href="/" class="inline-flex items-center space-x-2 text-gray-300 hover:text-white transition-colors duration-200 group">
        <div class="p-2 rounded-lg bg-white/10 backdrop-blur-sm group-hover:bg-white/20 transition-colors duration-200">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </div>
        <span class="font-medium">Back to Home</span>
      </a>
    </div>
  </header>

  <!-- Main content -->
  <main class="relative z-10 flex items-center justify-center min-h-[calc(100vh-200px)] px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-lg space-y-8">
      <!-- Page title -->
      <div class="text-center">
        <h2 class="text-3xl font-bold text-white mb-2">
          {% if first_time %}
            üîê Set Your Password
          {% else %}
            üîê Change Password
          {% endif %}
        </h2>
        <p class="text-gray-400 text-sm leading-relaxed">
          {% if first_time %}
            Welcome! Please set a strong password for your account.<br />
            <span class="text-xs text-gray-500">This is required for your first login.</span>
          {% else %}
            Please set a strong password to secure your account.<br />
            <span class="text-xs text-gray-500">Follow the guidelines below for best results.</span>
          {% endif %}
        </p>
      </div>

      <!-- Card containing the form -->
      <div class="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 shadow-2xl p-8">
        <!-- Error messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-6 space-y-3">
          {% for category, message in messages %}
          <div class="relative {{ 'bg-green-500/20 border-green-500/30 text-green-200' if category=='success' else 'bg-red-500/20 border-red-500/30 text-red-200' }} p-4 rounded-lg backdrop-blur-sm">
            <div class="flex items-start space-x-3">
              {% if category == 'success' %}
              <svg class="w-5 h-5 text-green-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              {% else %}
              <svg class="w-5 h-5 text-red-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {% endif %}
              <span class="text-sm">{{ message }}</span>
            </div>
            <button type="button" class="absolute top-2 right-2 {{ 'text-green-300 hover:text-green-100' if category=='success' else 'text-red-300 hover:text-red-100' }} transition-colors" onclick="this.parentElement.remove()">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Password update form -->
        <form method="POST" action="{{ url_for('first_time_password_setup') if first_time else url_for('set_password') }}" class="space-y-6" novalidate>
          <!-- Email field, shown if user_email not present in session -->
          {% if not session.get('user_email') %}
          <div class="space-y-2">
            <label for="email" class="block text-sm font-semibold text-gray-200">
              Email <span class="text-red-400">*</span>
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-envelope text-gray-400"></i>
              </div>
              <input type="email" name="email" id="email" required
                     class="w-full pl-10 pr-4 py-3 bg-white/10 border border-white/20 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400 transition-all duration-200"
                     placeholder="Enter your email address" />
            </div>
          </div>
          {% endif %}

          <!-- Old password (only show if not first time) -->
          {% if not first_time %}
          <div class="space-y-2">
            <label for="old_password" class="block text-sm font-semibold text-gray-200">
              Old Password <span class="text-red-400">*</span>
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-lock text-gray-400"></i>
              </div>
              <input type="password" name="old_password" id="old_password" required
                     class="password-input w-full pl-10 pr-12 py-3 bg-white/10 border border-white/20 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400 transition-all duration-200"
                     placeholder="Enter old password" />
              <button type="button" id="toggleOld" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-200 transition-colors duration-200">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>
          {% endif %}

          <!-- New password with strength meter -->
          <div class="space-y-2">
            <label for="new_password" class="block text-sm font-semibold text-gray-200">
              New Password <span class="text-red-400">*</span>
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-lock text-gray-400"></i>
              </div>
              <input type="password" name="new_password" id="new_password" required
                     class="password-input w-full pl-10 pr-12 py-3 bg-white/10 border border-white/20 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400 transition-all duration-200"
                     placeholder="Enter new password" />
              <button type="button" id="toggleNew" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-200 transition-colors duration-200">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
            <!-- Strength bar -->
            <div class="mt-3 h-2 w-full bg-gray-700 rounded overflow-hidden">
              <div id="passwordStrengthBar" class="h-full w-0 bg-red-500 rounded transition-all duration-300 ease-in-out"></div>
            </div>
            <!-- Requirement checklist -->
            <ul class="text-xs space-y-1 mt-2" id="passwordChecklist">
              <li id="lengthCriterion" class="flex items-center space-x-2 text-red-400 transition-colors duration-200">
                <i class="fa-solid fa-circle-xmark transition-all duration-200"></i>
                <span>More than 6 characters</span>
              </li>
              <li id="uppercaseCriterion" class="flex items-center space-x-2 text-red-400 transition-colors duration-200">
                <i class="fa-solid fa-circle-xmark transition-all duration-200"></i>
                <span>At least 1 uppercase letter</span>
              </li>
              <li id="numberCriterion" class="flex items-center space-x-2 text-red-400 transition-colors duration-200">
                <i class="fa-solid fa-circle-xmark transition-all duration-200"></i>
                <span>At least 1 number</span>
              </li>
              <li id="specialCriterion" class="flex items-center space-x-2 text-red-400 transition-colors duration-200">
                <i class="fa-solid fa-circle-xmark transition-all duration-200"></i>
                <span>At least 1 special character (<span class="font-mono">! @ # $ % ^ & *</span>)</span>
              </li>
            </ul>
          </div>

          <!-- Confirm password -->
          <div class="space-y-2">
            <label for="confirm_password" class="block text-sm font-semibold text-gray-200">
              Re‚Äëenter New Password <span class="text-red-400">*</span>
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-lock text-gray-400"></i>
              </div>
              <input type="password" name="confirm_password" id="confirm_password" required
                     class="password-input w-full pl-10 pr-12 py-3 bg-white/10 border border-white/20 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400 transition-all duration-200"
                     placeholder="Confirm new password" />
              <button type="button" id="toggleConfirm" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-200 transition-colors duration-200">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>

          <!-- Terms & conditions -->
          <div class="flex items-start space-x-3">
            <div class="flex items-center h-5">
              <input id="agree_terms" name="agree_terms" type="checkbox" required
                     class="w-4 h-4 text-blue-600 bg-white/10 border border-white/20 rounded focus:ring-blue-500 focus:ring-2" />
            </div>
            <label for="agree_terms" class="text-sm text-gray-300 leading-relaxed">
              I agree to the
              <a href="/terms-of-service" class="text-blue-400 hover:text-blue-300 underline transition-colors duration-200">Terms of Service</a>
              and
              <a href="/privacy-policy" class="text-blue-400 hover:text-blue-300 underline transition-colors duration-200">Privacy Policy</a>
              <span class="text-red-400">*</span>
            </label>
          </div>

          <!-- Submit button -->
          <button type="submit" id="submitButton" disabled
                  class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-transparent disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 opacity-50 cursor-not-allowed">
            <span>‚úÖ Update Password</span>
          </button>

          <!-- Additional link for sign in -->
          <p class="text-center text-sm text-gray-400 mt-4">
            Already registered?
            <a href="{{ url_for('login') }}" class="text-blue-400 hover:text-blue-300 underline transition-colors duration-200">Sign in</a>
          </p>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="relative z-10 text-center py-8 px-4">
    <div class="max-w-4xl mx-auto">
      <div class="text-sm text-gray-500 space-y-2">
        <p>&copy; <span id="year"></span> Bakery Metrics App. Created by Gerald Nyah. All rights reserved.</p>
        <div class="flex justify-center space-x-6 text-xs">
          <a href="/privacy-policy" class="hover:text-gray-300 transition-colors duration-200">Privacy Policy</a>
          <a href="/terms-of-service" class="hover:text-gray-300 transition-colors duration-200">Terms of Service</a>
          <a href="/support" class="hover:text-gray-300 transition-colors duration-200">Support</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts: password visibility and strength meter -->
  <script>
    // Set current year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // Enhanced password visibility toggles with improved error handling
    function setupToggle(inputId, buttonId) {
      const input = document.getElementById(inputId);
      const button = document.getElementById(buttonId);
      
      // Check if elements exist before setting up event listeners
      if (!input || !button) {
        console.warn(`Toggle setup failed: ${inputId} or ${buttonId} not found`);
        return;
      }
      
      const icon = button.querySelector('i');
      if (!icon) {
        console.warn(`Icon not found for button: ${buttonId}`);
        return;
      }
      
      button.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent form submission
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
          button.setAttribute('aria-label', 'Hide password');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
          button.setAttribute('aria-label', 'Show password');
        }
      });
      
      // Set initial aria-label
      button.setAttribute('aria-label', 'Show password');
    }

    // Setup toggles for all password fields
    document.addEventListener('DOMContentLoaded', function() {
      setupToggle('old_password', 'toggleOld');
      setupToggle('new_password', 'toggleNew');
      setupToggle('confirm_password', 'toggleConfirm');
    });

    // Enhanced password strength evaluation with real-time updates
    document.addEventListener('DOMContentLoaded', function() {
      const newPasswordInput = document.getElementById('new_password');
      const strengthBar = document.getElementById('passwordStrengthBar');
      const lengthCriterion = document.getElementById('lengthCriterion');
      const uppercaseCriterion = document.getElementById('uppercaseCriterion');
      const numberCriterion = document.getElementById('numberCriterion');
      const specialCriterion = document.getElementById('specialCriterion');

      // Check if all elements exist
      if (!newPasswordInput || !strengthBar || !lengthCriterion || !uppercaseCriterion || !numberCriterion || !specialCriterion) {
        console.warn('Password strength elements not found');
        return;
      }

      function updateCriterion(element, isValid) {
        const icon = element.querySelector('i');
        if (!icon) return;
        
        // Add criterion-item class for animations
        element.classList.add('criterion-item');
        
        if (isValid) {
          element.classList.remove('text-red-400');
          element.classList.add('text-green-400', 'valid');
          icon.classList.remove('fa-circle-xmark');
          icon.classList.add('fa-circle-check');
        } else {
          element.classList.remove('text-green-400', 'valid');
          element.classList.add('text-red-400');
          icon.classList.remove('fa-circle-check');
          icon.classList.add('fa-circle-xmark');
        }
      }

      function evaluatePassword() {
        const password = newPasswordInput.value;
        
        // Password criteria checks
        const lengthValid = password.length > 6;
        const uppercaseValid = /[A-Z]/.test(password);
        const numberValid = /[0-9]/.test(password);
        const specialValid = /[!@#$%^&*]/.test(password);

        // Update visual indicators
        updateCriterion(lengthCriterion, lengthValid);
        updateCriterion(uppercaseCriterion, uppercaseValid);
        updateCriterion(numberCriterion, numberValid);
        updateCriterion(specialCriterion, specialValid);

        // Calculate strength score
        let score = 0;
        if (lengthValid) score++;
        if (uppercaseValid) score++;
        if (numberValid) score++;
        if (specialValid) score++;

        // Update strength bar
        const widths = ['0%', '25%', '50%', '75%', '100%'];
        const colors = ['bg-red-500', 'bg-red-500', 'bg-yellow-500', 'bg-yellow-500', 'bg-green-500'];
        
        // Remove all possible color classes
        strengthBar.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-green-500');
        
        // Add appropriate color class
        strengthBar.classList.add(colors[score]);
        strengthBar.style.width = widths[score];
        
        // Add smooth transition
        strengthBar.style.transition = 'width 0.3s ease-in-out, background-color 0.3s ease-in-out';
        
        // Enable/disable submit button based on password strength
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
          const allCriteriaValid = lengthValid && uppercaseValid && numberValid && specialValid;
          if (allCriteriaValid) {
            submitButton.disabled = false;
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            submitButton.classList.add('btn-primary');
          } else {
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');
            submitButton.classList.remove('btn-primary');
          }
        }
        
        // Return score for external use
        return score;
      }

      // Attach event listeners for real-time updates
      newPasswordInput.addEventListener('input', evaluatePassword);
      newPasswordInput.addEventListener('keyup', evaluatePassword);
      newPasswordInput.addEventListener('paste', function() {
        // Small delay to allow paste to complete
        setTimeout(evaluatePassword, 10);
      });
      
      // Initialize on page load
      evaluatePassword();
    });

    // Enhanced password confirmation matching with visual feedback
    document.addEventListener('DOMContentLoaded', function() {
      const newPasswordInput = document.getElementById('new_password');
      const confirmPasswordInput = document.getElementById('confirm_password');
      
      if (!newPasswordInput || !confirmPasswordInput) return;
      
      // Create match indicator
      const matchIndicator = document.createElement('div');
      matchIndicator.className = 'text-xs mt-1 transition-all duration-200';
      matchIndicator.style.minHeight = '16px'; // Reserve space
      confirmPasswordInput.parentNode.appendChild(matchIndicator);
      
      function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (confirmPassword.length > 0) {
          if (newPassword === confirmPassword) {
            confirmPasswordInput.classList.remove('border-red-500');
            confirmPasswordInput.classList.add('border-green-500');
            matchIndicator.textContent = '‚úì Passwords match';
            matchIndicator.className = 'text-xs mt-1 text-green-400 transition-all duration-200';
          } else {
            confirmPasswordInput.classList.remove('border-green-500');
            confirmPasswordInput.classList.add('border-red-500');
            matchIndicator.textContent = '‚úó Passwords do not match';
            matchIndicator.className = 'text-xs mt-1 text-red-400 transition-all duration-200';
          }
        } else {
          confirmPasswordInput.classList.remove('border-red-500', 'border-green-500');
          matchIndicator.textContent = '';
        }
      }
      
      newPasswordInput.addEventListener('input', checkPasswordMatch);
      confirmPasswordInput.addEventListener('input', checkPasswordMatch);
      confirmPasswordInput.addEventListener('keyup', checkPasswordMatch);
      confirmPasswordInput.addEventListener('paste', function() {
        setTimeout(checkPasswordMatch, 10);
      });
    });

    // Console logging for debugging (can be removed in production)
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîê Password reset page loaded');
      console.log('‚úÖ All interactive elements initialized');
    });
  </script>
</body>

</html>